<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Qchat</title>
    <meta name="theme-color" content="#FFFFFF"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/VLDv52F8/chan-21.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://unpkg.com/dompurify@2.3.8/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="manifest" href="manifest.json">

    <style>
    
@import url('https://fonts.googleapis.com/css2?family=Comfortaa:wght@600&family=Kosugi+Maru&family=Varela+Round&display=swap');

@import url('https://fonts.googleapis.com/css2?family=M+PLUS+1+Code:wght@400;600&family=Sono:wght@400;600&family=VT323&display=swap');

@import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap');
    
        /* --- 全局与主题样式 --- */
        :root {
            --bg-color: #DAF0FC;
            --primary-color: #0099FF;
            --secondary-color:#389CF4;
            --accent-color: #90caf9;
            --text-color: #444;
            --white-color: #fff;
            --border-radius: 8px;
            --phone-corner-radius: 0px;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --font-miao: 'ZCOOL KuaiLe', cursive;
            --top-pinned-bg: #EBF5FF;
            --online-status-color: #4CAF50;
        }

        html {
            height: 100%;
            overflow: hidden;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none;  /* IE and Edge */
        }
        html::-webkit-scrollbar {
            display: none; /* Chrome, Safari, and Opera */
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            background: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            overflow: hidden;
        }

        .phone-screen {
            width: 100%;
            max-width: 420px;
            height: 100%;
            max-height: 850px;
            background-color: var(--white-color);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-radius: var(--phone-corner-radius);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }


        .screen {
            display: none;
            flex-direction: column;
            width: 100%;
            height: 100%;
            animation: fadeIn 0.5s ease;
            position: relative; /* 修改：确保内部屏幕也是定位上下文 */
        }

        .screen.active {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background-color: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px) !important; 
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
            position: relative;
            z-index: 10;
        }

        .app-header .back-btn,
        .app-header .action-btn {
            background: none;
            border: none;
            font-size: 45px;
            color: var(--primary-color);
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .app-header .back-btn {
            margin-bottom: 4px;
        }        

        #cancel-multi-select-btn {
            font-size: 14px !important;
            font-weight: 500 !important;
            color: var(--white-color) !important;
            background-color: var(--primary-color) !important;
            border-radius: 10px !important;
            padding: 5px 10px !important;
            width: auto !important;
            height: auto !important;
        }

        .app-header .action-btn-group {
            display: flex;
            align-items: center;
            gap: 7px;
        }

        .app-header .action-btn-group .action-btn {
            font-size: 32px;
            padding: 0;
            width: 36px;
            height: 36px;
            background-color: transparent;
            color: var(--primary-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none; /* Ensure no border */
            cursor: pointer; /* Ensure cursor is pointer */
        }

        .app-header .action-btn-group .action-btn svg {
            width: 24px;
            height: 24px;
            fill: var(--primary-color);
        }

        .app-header .action-btn img {
            width: 24px;
            height: 24px;
        }

        .app-header .title-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .app-header .title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            margin: 0;
        }

        .app-header .subtitle {
            font-size: 12px;
            color: #888;
            display: flex;
            align-items: center;
            margin-top: 2px;
        }

        .online-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--online-status-color);
            margin-right: 5px;
        }

        .app-header .placeholder {
            width: 40px;
        }

        #home-screen {
            background-size: cover;
            background-position: center;
            transition: background-image 0.5s ease-in-out;
            padding: 45px 5px 25px;
            /* New styles for swipe functionality */
           flex-direction: column;
           overflow: hidden; /* Hide overflow for the swiper */
        }
       .home-screen-swiper {
           display: flex;
           width: 200%; /* Two pages */
           flex: 1;
           overflow: hidden;
           transition: transform 0.4s ease-in-out;
       }
       .home-screen-page {
           width: 100%;
           display: flex;
           flex-direction: column;
           justify-content: flex-start;
           align-items: center;
       }
       .page-indicator {
           position: absolute;
           bottom: 160px; /* Adjust based on dock height */
           left: 50%;
           transform: translateX(-50%);
           display: flex;
           gap: 8px;
       }
       .page-indicator .dot {
           width: 8px;
           height: 8px;
           border-radius: 50%;
           background-color: rgba(0, 0, 0, 0.25); /* 浅灰色 */
           transition: background-color 0.3s;
       }
       .page-indicator .dot.active {
           background-color: rgba(0, 0, 0, 0.374); /* 深灰色 */
       }


        #home-screen.day-mode .satellite-oval,
        #home-screen.day-mode .widget-time,        
        #home-screen.day-mode .widget-battery,
        #home-screen.day-mode .widget-signature,
        #home-screen.day-mode .app-icon .app-name{
            color: var(--white-color);
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);

        }
        
           #home-screen.day-mode .app-icon{
            color: rgba(255, 255, 255, 0.9);
        }
        
        #home-screen.day-mode .widget-date{
        color: var(--white-color);
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
        /*border-top: 1.5px dashed  var(--white-color);*/
        }
        
  #home-screen.day-mode .ins-widget-divider span {
            color: var(--white-color);         
        } 
        
             #home-screen.day-mode .ins-widget-divider {           
            border-bottom: 1.5px dashed  var(--white-color);

        }  
       #home-screen.day-mode .central-circle {
    border: 3px solid white; /* 头像边框 */}  
    
     #home-screen.day-mode .ins-widget-avatar { 
            border: 2px solid white; /* 头像边框 */
   
        }    
        
        #home-screen.day-mode .widget-battery svg{
        filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.2));}

        .app-grid {
            width: 100%;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 15px;
            justify-content: center;
            align-content: flex-start;
            margin-top: 20px;
            height: calc(100% - 280px); /* Adjust height to fit better */
        }
        .app-grid-widget-container {
            grid-column: span 2;
            grid-row: span 2;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        .app-grid-widget {
            width: 85%;
            height: 85%;
            background-color: transparent;
            border-radius: 30px;
            padding: 0; /* Remove padding */
            box-sizing: border-box;
            border: none; /* Remove border */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 0; /* Remove gap */
            transition: transform 0.2s ease;
        }
        .app-grid-widget:hover {
            transform: none; /* Remove hover effect */
        }
        .app-grid-placeholder-widget {
            grid-column: 3 / 5;
            grid-row: 3 / 5;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 18px;
            border: 2px dashed rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: rgba(0,0,0,0.4);
        }

        .widget-top-bar {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 8px;
            color: rgba(0, 0, 0, 0.4);
        }
        .widget-status-text {
            font-size: 14px;
            font-weight: 600;
        }
        .widget-icons {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .widget-icons svg {
            width: 18px;
            height: 18px;
            fill: rgba(0, 0, 0, 0.4);
        }
        .widget-main-image-container {
            position: relative;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .widget-main-image {
            width: 85%;
            padding-bottom: 85%; /* Creates a square aspect ratio */
            background-size: cover;
            background-position: center;
            border-radius: 18px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .widget-speech-bubble {
            position: absolute;
            top: 10px;
            right: 0px;
            background-color: #fff;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 12px;
            color: #555;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .widget-paw-button {
            background-color: #fff;
            border-radius: 20px;
            padding: 6px 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            display: inline-flex;
            justify-content: center;
            align-items: center;
        }
        .widget-paw-button img {
            height: 20px;
            width: auto;
        }
 

        #peek-screen .time-widget,
        #peek-screen .time-widget .date,
        #peek-screen .app-icon .app-name {
            color: var(--white-color);
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
        }

        #peek-screen .time-widget {
            text-align: center;
            margin-bottom: 40px;
        }

        #peek-screen .time-widget .time {
            font-family:'Varela Round', sans-serif;
            font-size: 60px;
            font-weight: 600;
            letter-spacing: 2px;
            line-height: 1;
        }

        #peek-screen .time-widget .date {
            font-size: 18px;
            font-weight: 400;
            opacity: 0.8;
            margin-top: 8px;
        }

        #peek-screen .app-grid {
            margin-top: 20px;
        }

        .dock {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            background-color: transparent;
            backdrop-filter: none;
            border-radius: var(--border-radius);
            margin: 0 20px;
            min-height: 80px;
            gap: 15px;
            flex-shrink: 0;
        }

        .app-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            text-decoration: none;
            color: rgba(0, 0, 0, 0.9);
        }

        .icon-img {
            width: 54px;
            height: 54px;
            border-radius: 15px;
            margin-bottom: 6px;
            filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.2));
            transition: transform 0.2s ease;
            object-fit: cover;
        }

        .app-icon:hover .icon-img {
            transform: translateY(-5px);
        }

        .app-icon .app-name {
            font-size: 12px;
            color: var(--text-color);
            font-weight: 500;
            font-family: 'ZCOOL KuaiLe', cursive;
        }


        .content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            position: relative;
        }

        .placeholder-text {
            text-align: center;
            color: #aaa;
            margin-top: 50px;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal-window {
            background: var(--white-color);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
            width: 85%;
            max-width: 340px;
            animation: slideUp 0.4s ease-out;
        }

        .modal-window h3 {
            margin-top: 0;
            text-align: center;
            color: var(--primary-color);
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        #message-edit-modal .modal-window {
            width: 90%;
            max-width: 400px;
        }

        #message-edit-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #DAF0FC;
            border-radius: 10px;
            background-color: #fff;
            transition: border-color 0.3s;
            font-family: var(--font-family);
            font-size: 15px;
            resize: vertical; /* Allow vertical resizing */
        }

        #message-edit-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        #edit-group-member-modal,
        #create-member-for-group-modal {
            z-index: 102;
        }

        #edit-group-member-modal .avatar-preview,
        #create-member-for-group-modal .avatar-preview {
            width: 80px;
            height: 80px;
        }

        .context-menu {
            position: fixed;
            z-index: 1000;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            padding: 5px 0;
            animation: fadeIn 0.1s ease;
        }

        .context-menu-item {
            padding: 10px 20px;
            cursor: pointer;
        }

        .context-menu-item:hover {
            background-color: #f5f5f5;
        }

        .context-menu-item.danger {
            color: #e53935;
        }

        .action-sheet-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 200;
            display: none;
            align-items: flex-end;
            animation: fadeIn 0.3s ease;
        }

        .action-sheet-overlay.visible {
            display: flex;
        }

        .action-sheet {
            background: #f7f7f7;
            width: 100%;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 10px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            animation: slideUp 0.3s ease-out;
        }

        .action-sheet-button {
            width: 100%;
            background: white;
            border: none;
            padding: 15px;
            font-size: 16px;
            color: var(--primary-color);
            font-weight: 500;
            cursor: pointer;
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .action-sheet-button.danger {
            color: #e53935;
        }

        .action-sheet-button:last-child {
            margin-bottom: 0;
        }

        #chat-list-screen .content,
        #world-book-screen .content {
            padding: 10px 0 0 0;
        }
        

        #chat-list-screen .app-header .action-btn svg {
            width: 24px;
            height: 24px;
            fill:none;
            stroke-width:2px;
            stroke: var(--primary-color);
            }
        
        
        .list-container {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .list-item {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
            position: relative;
        }

        .list-item:hover {
            background-color:#F0F8FD;
        }

        .chat-item.pinned {
            background-color: var(--top-pinned-bg);
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
            flex-shrink: 0;
            background-color: #eee;
        }

        .group-avatar {
            border-radius: 10px;
        }

        .item-details {
            flex-grow: 1;
            overflow: hidden;
        }

        .item-details-row {
            display: flex;
            justify-content: space-between;
            /* align-items: center;  <-- 删除这一行 */
            align-items: flex-start; /* <-- 修改成这一行 */
        }



        .item-name {
            font-weight: 600;
            color: var(--text-color);
            font-size: 16px;
        }

        .item-preview-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        .item-preview {
            font-size: 14px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
        }

        .pin-badge {
            background-color: var(--primary-color);
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 5px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        #chat-room-screen {
            background-color: #EEEDF2;
            background-size: cover;
            background-position: center;
        }

        #chat-room-screen .content {
            display: flex;
            flex-direction: column;
            padding: 0;
            padding-bottom: 0px;
            transition: padding-bottom 0.3s ease;
        }
        


        #chat-room-screen.multi-select-active .content {
            padding-bottom: 70px;
        }

        .message-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px 10px 0;
            scroll-behavior: smooth;
           /* --- 新增：隐藏滚动条 --- */
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;  
            /* Firefox */
}

/* --- 新增：隐藏滚动条 (Webkit) --- */
.message-area::-webkit-scrollbar {
    display: none;
        }

        .message-wrapper {
            display: flex;
            margin-bottom: 12px;
            align-items: flex-start;
            transition: background-color 0.2s;
            flex-direction: column;
        }

        .message-wrapper.group-message {
            margin-bottom: 18px;
        }

        .message-wrapper.sent {
            align-items: flex-end;
        }

        .message-wrapper.received {
            align-items: flex-start;
        }

        .message-wrapper.system-notification {
            align-items: center;
        }

        .message-bubble-row {
            display: flex;
            width: 100%;
            align-items: flex-start;
        }

        .message-wrapper.sent .message-bubble-row {
            flex-direction: row-reverse;
        }

        .message-wrapper.multi-select-selected {
            background-color: rgba(144, 202, 249, 0.2);
            border-radius: var(--border-radius);
        }

        .message-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .group-nickname {
            position: absolute;
            top: -15px;
            font-size: 11px;
            color: #888;
            white-space: nowrap;
            width: 70px;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
        }

        .message-time {
            font-size: 9px;
            color: #aaa;
            margin-top: 3px;
        }

        .message-bubble {
            max-width: 260px;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            word-wrap: break-word;
            line-height: 1.4;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            margin: 0 8px;
            cursor: pointer;
            font-size: 15px;
        }

        .message-bubble.sent {
            position: relative;       
            border-radius: 8px;
        }

        .message-bubble.received {
            position: relative;     
            border-radius: 8px;     
        }

        .system-notification-bubble {
            background-color: rgba(200, 200, 200, 0.5);
            color: #666;
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 10px;
            text-align: center;
        }

        /* --- 新增：撤回消息样式 --- */
        .withdrawn-message {
            color: #999;
            font-size: 12px;
            padding: 4px 10px;
            text-align: center;
            cursor: pointer; /* 新增：让提示可点击 */
            display: inline-block; /* 改为inline-block以适应内容宽度 */
            background-color: #e0e0e0; /* 新增：灰色背景 */
            border-radius: 10px; /* 新增：圆角 */
        }

        .withdrawn-content {
            font-size: 14px;
            color: #555;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 8px 12px;
            margin-top: 5px;
            border-radius: 10px;
            line-height: 1.6;
            max-width: calc(100% - 108px);
            display: none; /* 默认隐藏 */
            animation: fadeIn 0.3s ease;
            align-self: center; /* 居中显示 */
        }

        .withdrawn-content.active {
            display: block;
        }

        .image-bubble {
            max-width: 120px;
            border-radius: var(--border-radius);
            margin: 0 8px;
            padding: 4px;
            background-color: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }

        .image-bubble img {
            width: 100%;
            height: auto;
            display: block;
            border-radius: calc(var(--border-radius) - 4px);
        }

        .message-wrapper.sent .image-bubble {
            border-bottom-right-radius: 5px;
        }

        .message-wrapper.received .image-bubble {
            border-bottom-left-radius: 5px;
        }

        .voice-bubble {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            margin: 0 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 90px;
            max-width: 200px;
        }

        .message-wrapper.sent .voice-bubble {
            position: relative;          
            flex-direction: row-reverse;
        }

        .message-wrapper.received .voice-bubble {
            position: relative;        
        }

        .voice-bubble .play-icon {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .voice-bubble .duration {
            font-size: 13px;
            margin: 0 8px;
            white-space: nowrap;
        }

        .message-wrapper.sent .play-icon {
            transform: scaleX(-1);
        }

        .voice-transcript {
            font-size: 14px;
            color: #555;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 8px 12px;
            margin-top: 5px;
            margin-left: 54px;
            margin-right: 54px;
            border-radius: 10px;
            line-height: 1.6;
            max-width: calc(100% - 108px);
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .voice-transcript.active {
            display: block;
        }

        .message-wrapper.sent .voice-transcript {
            align-self: flex-end;
            margin-right: 54px;
            margin-left: auto;
        }

        .message-wrapper.received .voice-transcript {
            align-self: flex-start;
            margin-left: 54px;
            margin-right: auto;
        }

        .message-bubble.sent .quoted-message{
            background-color: rgba(255, 255, 255, 0.1);
            border-left: 3px solid rgba(255, 255, 255, 0.7);
        }
        .message-bubble.sent .quoted-message .quoted-sender{
            font-size: 14px;
            color: #ffffff !important;
        }
        .message-bubble.sent .quoted-message .quoted-text {      
            color:  rgba(255, 255, 255, 0.8) !important;
        }
        .pv-card {
            width: 230px;
            aspect-ratio: 1 / 1;
            background-color: #f0f0f0;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
            cursor: pointer;
            margin: 0 8px;
        }

        .message-wrapper.sent .pv-card {
            border-bottom-right-radius: 5px;
        }

        .message-wrapper.received .pv-card {
            border-bottom-left-radius: 5px;
        }

        .pv-card-image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            transition: opacity 0.5s ease-in-out;
            z-index: 2;
        }

        .pv-card-image-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .pv-card-content {
            padding: 15px;
            height: 100%;
            overflow-y: auto;
            color: var(--text-color);
            line-height: 1.6;
            font-size: 15px;
            background-color: white;
            position: relative;
            z-index: 1;
        }

        .pv-card-footer {
            background: linear-gradient(to top, rgba(0, 0, 0, 0.6), transparent);
            color: white;
            padding: 20px 10px 8px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 3;
            pointer-events: none;
            transition: opacity 0.5s ease-in-out;
        }

        .pv-card-footer.hidden {
            opacity: 0;
        }

        .pv-card-footer svg {
            width: 14px;
            height: 14px;
            fill: white;
            flex-shrink: 0;
        }

        .transfer-card {
            width: 240px;
            height: auto;
            border-radius: var(--border-radius);
            margin: 0 8px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            color: white;
        }

        .message-wrapper.sent .transfer-card {
            border-bottom-right-radius: 5px;
        }

        .message-wrapper.received .transfer-card {
            border-bottom-left-radius: 5px;
            cursor: pointer;
        }

        .transfer-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            filter: blur(4px);
            transform: scale(1.1);
            z-index: 1;
        }

        .transfer-card.sent-transfer::before {
            background-image: url('https://i.postimg.cc/sxN893WF/IMG-20250712.png');
        }

        .transfer-card.received-transfer::before {
            background-image: url('https://i.postimg.cc/FzR8LY7g/IMG-20250712-170703.png');
        }

        .transfer-card .overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.3);
            z-index: 2;
            transition: background-color 0.5s ease;
        }

        .transfer-card.received .overlay {
            background-color: rgba(168, 212, 255, 0.4);
        }

        .transfer-card.returned .overlay {
            background-color: rgba(100, 100, 100, 0.5);
        }

        .transfer-content {
            position: relative;
            z-index: 3;
            padding: 20px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        .transfer-title {
            font-size: 14px;
            margin: 0 0 5px 0;
            opacity: 0.9;
        }

        .transfer-amount {
            font-size: 28px;
            font-weight: bold;
            margin: 0;
        }

        .transfer-remark {
            font-size: 14px;
            margin-top: 10px;
            opacity: 0.9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .transfer-status {
            font-size: 12px;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            opacity: 0.8;
        }

        .gift-card {
            width: 230px;
            background-color: #fff;
            border: 2px solid #333;
            border-radius: var(--border-radius);
            box-shadow: 4px 4px 0px #ddd;
            padding: 10px;
            display: flex;
            align-items: center;
            cursor: pointer;
            margin: 0 8px;
            position: relative;
            overflow: hidden;
        }

        .message-wrapper.sent .gift-card {
            border-bottom-right-radius: 5px;
        }

        .message-wrapper.received .gift-card {
            border-bottom-left-radius: 5px;
        }

        .gift-card-icon {
            width: 50px;
            height: 50px;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .gift-card-text {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            font-family: 'Comic Sans MS', 'Chalkduster', 'Handwriting', cursive;
        }

        .gift-card-description {
            font-size: 14px;
            color: #555;
            background-color: rgba(240, 240, 240, 0.9);
            padding: 8px 12px;
            margin-top: 5px;
            margin-left: 54px;
            margin-right: 54px;
            border-radius: 10px;
            line-height: 1.6;
            max-width: calc(100% - 108px);
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .gift-card-description.active {
            display: block;
        }

        .message-wrapper.sent .gift-card-description {
            align-self: flex-end;
            margin-right: 54px;
            margin-left: auto;
        }

        .message-wrapper.received .gift-card-description {
            align-self: flex-start;
            margin-left: 54px;
            margin-right: auto;
        }

        .gift-card-received-stamp {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 14px;
            font-weight: bold;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            padding: 2px 6px;
            transform: rotate(15deg);
            opacity: 0;
            transition: opacity 0.3s ease;
            font-family: 'Comic Sans MS', 'Chalkduster', 'Handwriting', cursive;
        }

        .gift-card.received .gift-card-received-stamp {
            opacity: 1;
        }

        .load-more-btn {
            background-color: #e0e0e0;
            color: #757575;
            border: none;
            padding: 8px 16px;
            margin: 10px auto;
            border-radius: 15px;
            cursor: pointer;
            display: block;
            font-size: 13px;
            font-weight: 500;
        }

        .load-more-btn:hover {
            background-color: #d1d1d1;
        }

        .typing-indicator {
            text-align: center;
            color: #aaa;
            font-style: italic;
            font-size: 14px;
            padding: 10px 0;
            display: none;
        }

     #sticker-bar {
    flex-shrink: 0;
    /* 修改 3：将底部安全距离加在这里 */
    /* 上0 左右10 下(5px + 安全区域) */
    padding: 0 10px calc(5px + env(safe-area-inset-bottom)); 
    
    display: flex;
    align-items: center;
    background: rgba(255, 255, 255, 0.5);
    backdrop-filter: blur(5px);
    justify-content: space-between;
    width: 100%;
    box-sizing: border-box;
    overflow-x: auto; 
    flex-wrap: nowrap;
}

/* (可选) 新增：为了在某些浏览器上获得更好的视觉效果，可以隐藏滚动条 */
#sticker-bar::-webkit-scrollbar {
    display: none; /* 隐藏滚动条本身 */
}


        .sticker-bar-btn {
            background: none;
            border: none;
            padding: 5px;
            cursor: pointer;
        }

        .sticker-bar-btn svg {
            width: 27px;
            height: 27px;
            fill: #888;
        }

        #sticker-modal, #chat-expansion-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 35%;
            max-height: 250px;
            background: rgba(255, 255, 255, 0.98);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
            z-index: 25;
            display: none;
            flex-direction: column;
        }

        #sticker-modal.visible, #chat-expansion-panel.visible {
            display: flex;
            animation: slideUp 0.3s ease-out;
        }

        #sticker-modal .header {
            padding: 10px 15px;
            font-weight: bold;
            color: var(--text-color);
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sticker-grid {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 15px;
        }

        .sticker-item {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }
        .sticker-item.is-managing {
            cursor: pointer;
        }

        .sticker-item.is-selected::after {
            content: '✓';
            position: absolute;
            top: 2px;
            right: 2px;
            background-color: var(--primary-color);
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .sticker-item.is-managing:not(.is-selected)::before {
            content: '';
            position: absolute;
            top: 2px;
            right: 2px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid #ccc;
            background-color: rgba(255, 255, 255, 0.8);
        }
        .sticker-item img {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }

        .sticker-item span {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            text-align: center;
        }

        #add-sticker-modal .modal-window {
            max-width: 360px;
        }

        #sticker-preview {
            width: 100px;
            height: 100px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
            background-color: #f9f9f9;
        }

        #sticker-preview img {
            max-width: 100%;
            max-height: 100%;
        }

        .chat-input-wrapper {
            flex-shrink: 0;
        }

        .message-input-area {
            display: flex;
            align-items: center;
            padding: 6px 10px;
            padding-bottom: 6px;

            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(5px);
            flex-shrink: 0;
            gap: 10px;
            border-bottom-left-radius: var(--phone-corner-radius);
            border-bottom-right-radius: var(--phone-corner-radius);
            overflow: hidden;
        }

        .message-input-area input {
            font-size: 16px; 
            flex-grow: 1;
            border: none;
            padding: 10px;
            border-radius: 5px;
            background-color: #ffffff;
        }

        .message-input-area input:focus {
            font-size: 16px; 
            outline: none;
        }

        .message-input-area .icon-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            width: 40px;
            height: 40px;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .message-input-area .icon-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .message-input-area .icon-btn svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .message-input-area .icon-btn.send-btn {
            width: 60px;
            font-size: 15px;
           /* 这种方式不需要固定 height */
    padding-top: 10px;    /* 上边距小一点 */
    padding-bottom: 9px; /* 下边距大一点，把文字顶上去 */
    padding-left: 9px;
    padding-right: 10px; /* 右边距大一点，把文字顶上去 */
    line-height: 1;      /* 紧缩行高，避免行高干扰 */
        }

        #multi-select-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: transparent;
            backdrop-filter: none;
            display: none;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            border-top: 1px solid #eee;
            z-index: 20;
            border-bottom-left-radius: var(--phone-corner-radius);
            border-bottom-right-radius: var(--phone-corner-radius);
            animation: slideUp 0.3s ease-out;
        }

        #multi-select-bar.visible {
            display: flex;
        }

        .settings-sidebar {
            position: absolute;
            top: 0;
            right: -100%;
            width: 80%;
            height: 100%;
            background: #fff;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            transition: right 0.4s ease-in-out;
            z-index: 101;
            display: flex;
            flex-direction: column;
        }

        .settings-sidebar.open {
            right: 0;
        }

        .settings-sidebar .header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            font-weight: bold;
            text-align: center;
            color: var(--primary-color);
        }

        .settings-sidebar .content {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .settings-sidebar .form-group textarea {
            height: 100px;
            resize: vertical;
        }

        .settings-sidebar .avatar-setting {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .settings-sidebar .avatar-preview {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-color);
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--secondary-color);
            font-weight: 600;
        }




        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #DAF0FC;
            border-radius: 10px;
            background-color: #fff;
            transition: border-color 0.3s;
            font-family: var(--font-family);
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-group.radio-group {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .form-group.radio-group label {
            margin-bottom: 0;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-align: center;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--white-color);
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            box-shadow: 0 4px 15px rgba(56, 155, 255, 0.5);
        }

        label.btn-primary {
            color: var(--white-color) !important;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
        }

        .btn-secondary {
            background-color: var(--accent-color);
            color: var(--white-color);
            margin-bottom: 15px;
        }

        .btn-secondary:hover {
            background-color: #64b5f6;
            box-shadow: 0 4px 15px rgba(144, 202, 249, 0.5);
        }

        .btn-neutral {
            background-color: #bdbdbd;
            color: var(--white-color);
        }

        .btn-neutral:hover {
            background-color: #9e9e9e;
        }

        .btn-danger {
            background-color: #ef5350;
            color: white;
        }

        .btn .spinner {
            display: none;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-top-color: var(--white-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .btn.loading .spinner {
            display: block;
        }

        .btn.loading .btn-text {
            display: none;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .wallpaper-preview {
            width: 100%;
            aspect-ratio: 9 / 16;
            max-height: 400px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            background-size: cover;
            background-position: center;
            border: 3px dashed var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary-color);
            font-style: italic;
            background-color: #F5FBFF;
        }

        .toast {
            position: absolute;
            top: -120px; /* Start off-screen */
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 380px;
            background-color: rgba(255, 255, 255, 0.88);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            color: #333;
            padding: 12px;
            border-radius: 20px;
            font-size: 14px;
            opacity: 0;
            visibility: hidden;
            transition: top 0.5s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
            border: 1px solid rgba(130, 170, 200, 0.05);
        }

        .toast.show {
            top: 20px; /* Slide down to this position */
            opacity: 1;
            visibility: visible;
        }

.toast-spinner {
width: 18px;
height: 18px;
border: 2px solid rgba(0, 0, 0, 0.1); /* 浅灰色底环 /
border-top-color: var(--primary-color); / 主色调旋转环 */
border-radius: 50%;
animation: spin 0.8s linear infinite;
flex-shrink: 0;
}

/* --- 新增：加载中提示专用样式 (继承 .toast 的基础外观) --- */
/* --- 修复加载中提示的透明度问题 --- */
.toast.loading {
    /* 1. 强制覆盖基础样式的高不透明度，改为和 simple 一致的 0.7 */
    background-color: rgba(255, 255, 255, 0.88) !important; 
    
    /* 2. 关键：移除毛玻璃模糊效果，否则看起来像实心的 */
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important; 
    
    /* 3. 保持原本的居中定位 */
    position: fixed;
    top: 50% !important;
    left: 50%;
    transform: translate(-50%, -50%) !important;
    
    /* 4. 尺寸调整 */
    width: auto;
    min-width: 140px; 
    max-width: 80%;
    justify-content: center;
    z-index: 10001;
    
    /* 5. 确保阴影不过重，保持轻盈感 */
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1) !important;
}

/* 确保加载圈在透明白底上可见 */
.toast.loading .toast-spinner {
    border-color: rgba(0, 0, 0, 0.1);
    border-top-color: var(--primary-color);
}

/* 覆盖 .toast.show 的滑动效果，加载框只需原地显现 */
.toast.loading.show {
    opacity: 1;
    visibility: visible;
}

.temp-loading {
    display: flex;           /* 弹性布局 */
    align-items: center;     /* 垂直居中 */
    justify-content: center; /* 水平居中 */
    gap: 10px;              /* 图标和文字的间距 */
    padding: 30px 10px;
    color: #666;
    font-size: 14px;
    width: 100%;
}

        /* --- 未读消息红点样式 --- */
.unread-badge {
    position: absolute; /* 关键：使用绝对定位 */
    top: 60%;          /* 距离顶部12px */
    right: 20px;        /* 距离右侧20px */
    background-color: #ff3b30;
    color: white;
    font-size: 12px;
    font-weight: 500;
    line-height: 18px;
    min-width: 18px;
    height: 18px;
    border-radius: 9px;
    padding: 0 5px;
    text-align: center;
    z-index: 2; /* 确保红点在其他元素之上 */

    /* 使用透明度和缩放来实现平滑的显示/隐藏，避免布局抖动 */
    opacity: 0;
    transform: translateY(-60%) scale(0.5);
    transition: opacity 0.2s ease, transform 0.2s ease;
}

.unread-badge.visible {
    opacity: 1;
    transform: translateY(-60%) scale(1);
}
/* --- 样式添加结束 --- */


.unread-badge {
    background-color: #ff3b30; /* 鲜艳的红色 */
    color: white;
    font-size: 12px;
    font-weight: 500;
    line-height: 18px; /* 让文字垂直居中 */
    min-width: 18px;
    height: 18px;
    border-radius: 9px; /* 圆角 */
    padding: 0 5px; /* 左右留白，这样单个数字时也好看 */
    text-align: center;
    display: none; /* 默认隐藏 */
}

.unread-badge.visible {
    display: inline-block; /* 当有未读消息时显示 */
}
/* --- 样式添加结束 --- */

.item-time {
    font-size: 12px;
    color: #aaa;
    white-space: nowrap; /* 防止时间换行 */
}

        /* --- 这是您需要添加的代码 --- */

        /* 用于底部简单提示的样式 */
        .toast.simple {
            top: auto; /* 取消顶部的定位 */
            bottom: 90px; /* 直接定位在最终位置 */
            background-color: rgba(255, 255, 255, 0.7); /* 深色背景，更像系统提示 */
            color: white; /* 白色文字 */
            max-width: 250px; /* 可以让它窄一点 */
            backdrop-filter: none; /* 简单提示不需要毛玻璃效果 */
            -webkit-backdrop-filter: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15); /* 调整阴影 */
            /* 只对透明度进行过渡，实现淡入淡出 */
            transition: opacity 0.4s ease-out;
        }

        /* 简单提示显示时的位置 */
        .toast.simple.show {
            top: auto; /* 确保覆盖 .toast.show 的 top 样式 */
            /* bottom 属性不再需要，因为它已经在 .toast.simple 中设置好了 */
        }

        /* 简单提示不需要头像，让文字居中 */
        .toast.simple .toast-avatar {
            display: none;
        }
        .toast.simple .toast-content {
            text-align: center;
            width: 100%;
        }

        /* --- 添加代码结束 --- */


        /* --- 添加代码结束 --- */

        .toast-avatar {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            object-fit: cover;
            flex-shrink: 0;
            background-color: #eee;
        }

        .toast-content {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            gap: 2px;
        }

        .toast-name {
            font-weight: 600;
            font-size: 15px;
            color: #000;
        }

        .toast-message {
            font-size: 14px;
            color: #444;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #world-book-selection-modal,
        #invite-member-modal,
        #group-recipient-selection-modal,
        #global-pomodoro-world-book-selection-modal {
            z-index: 102;
        }

        #world-book-selection-modal .modal-window,
        #invite-member-modal .modal-window,
        #group-recipient-selection-modal .modal-window {
            width: 90%;
            max-width: 380px;
        }

        #world-book-selection-list,
        #invite-member-selection-list,
        #group-recipient-selection-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 40vh;
            overflow-y: auto;
        }

        .world-book-select-item,
        .invite-member-select-item,
        .group-recipient-select-item {
            display: flex;
            align-items: center;
            padding: 12px 5px;
            border-bottom: 1px solid #f0f0f0;
        }

        .world-book-select-item:last-child,
        .invite-member-select-item:last-child,
        .group-recipient-select-item:last-child {
            border-bottom: none;
        }

        .world-book-select-item input[type="checkbox"],
        .invite-member-select-item input[type="checkbox"],
        .group-recipient-select-item input[type="checkbox"] {
            margin-right: 15px;
            width: 20px;
            height: 20px;
        }

        .world-book-select-item label,
        .invite-member-select-item label,
        .group-recipient-select-item label {
            font-weight: 500;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .invite-member-select-item img,
        .group-recipient-select-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        /* --- Group Chat Specific Styles --- */
        .member-selection-list {
            list-style: none;
            padding: 0;
            margin: 15px 0;
            max-height: 40vh;
            overflow-y: auto;
        }

        .member-selection-item {
            display: flex;
            align-items: center;
            padding: 10px 5px;
            border-bottom: 1px solid #f0f0f0;
        }

        .member-selection-item:last-child {
            border-bottom: none;
        }

        .member-selection-item input[type="checkbox"] {
            margin-right: 15px;
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .member-selection-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
        }

        .member-selection-item label {
            font-weight: 500;
            color: var(--text-color);
        }

        #group-settings-sidebar .group-avatar-setting {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        #group-settings-sidebar .group-avatar-preview {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            object-fit: cover;
            border: 2px solid var(--primary-color);
            cursor: pointer;
        }

        #group-settings-sidebar .group-members-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        #group-settings-sidebar .group-member,
        #group-settings-sidebar .add-member-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }

        #group-settings-sidebar .group-member img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 5px;
            border: 2px solid #eee;
        }

        #group-settings-sidebar .add-member-btn .add-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #ccc;
            margin-bottom: 5px;
            transition: all 0.2s ease;
        }

        #group-settings-sidebar .add-member-btn:hover .add-icon {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        #group-settings-sidebar .group-member span,
        #group-settings-sidebar .add-member-btn span {
            font-size: 12px;
            text-align: center;
            color: var(--text-color);
        }

        #customize-screen .icon-custom-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 1px;
            border-bottom: 1px solid #f0f0f0;
        }

        #customize-screen .icon-custom-item:last-child {
            border-bottom: none;
        }

        #customize-screen .icon-preview {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            object-fit: cover;
            flex-shrink: 0;
        }

        #customize-screen .icon-details {
            flex-grow: 1;
        }

        #customize-screen .icon-details p {
            margin: 0 0 8px 0;
            font-weight: 600;
        }

        #customize-screen .icon-details input {
            width: calc(100% - 10px);
        }

        #customize-screen .reset-icon-btn {
            width: 60px;
            background: #e0e0e0;
            color: #555;
            border: none;
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
        }

        #peek-app-icons-settings .icon-preview {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            object-fit: cover;
            flex-shrink: 0;
        }

        /* 主页自定义小部件样式 (*/
.home-widget-container {
    position: relative;
    width: 230px; /* 增加了容器宽度，给加宽后的小椭圆留出空间 */
    height: 150px;
    margin: 0px auto 30px; /* 稍微增加顶部距离 */
    display: flex;
    justify-content: center;
    align-items: center;
}

.central-circle {
    width: 105px;
    height: 105px;
    border-radius: 50%;
    margin-left:-150px;
    margin-top:82px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    background-size: cover;
    background-position: center;
    transition: transform 0.3s ease;
}
.central-circle:hover {
    transform: scale(1.05);
}



/* --- 电池小部件的样式 --- */
.widget-battery {
    color: var(--text-color); /* 字体颜色，和日期保持一致 */
    font-family: var(--font-family);
    font-size: 15px; /* 字体大小，和日期保持一致 */
    
    position: absolute; /* 绝对定位 */
    display: flex; /* 使用flex布局让图标和文字对齐 */
    align-items: center; /* 垂直居中对齐 */

    /* 电池的位置 */
    /* 我们把它放在右下角椭圆的下面，和日期对称 */
    top: 0; /* 高低 */
    right: -50px; /* 左右 */
}

/* 电池图标和文字之间的间距 */
.widget-battery svg {
    margin-top: -0.5px;
    margin-right: 5px;
    
}


/* --- 时间和日期的样式 --- */


.widget-time {
    color: var(--text-color); /* 字体颜色 */
    font-family: 'Varela Round', sans-serif;
    text-align: left;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1); /* 加一点点阴影，更有质感 */
    position: absolute;
    margin-left:136px; /* 先把它推到容器中间 */
    bottom: 30px; /* 数字越大越往上，越小越往下，甚至可以是负数哦 */
/* 核心魔法：强制开启等宽数字 */
    font-variant-numeric: tabular-nums;
    letter-spacing: 1px; /* 稍微缩紧一点点间距会更好看 */   
    /* 如果某个浏览器不支持，可以加这个备用 */
    font-feature-settings: "tnum";
    /* 时间的字体大小 */
    font-size: 45px;
    font-weight: 600; /* 字体粗细 */
}

.widget-signature {
    color: var(--text-color);
    font-family: 'ZCOOL KuaiLe', cursive;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    position: absolute;
    margin-left:134px;
    bottom: -18px; /* Position it below the time widget */
    font-size: 13px;
    font-weight: 500;
    width: 90%;
    max-width: 160px;
    background-color: transparent;
    border: none;
    outline: none;
    text-align: center;
    padding: 5px;
    border-radius: 8px;
    transition: background-color 0.3s;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.widget-signature:focus {
    background-color: rgba(0, 0, 0, 0.05);
    white-space: normal;
    overflow: visible;
}

.widget-signature:empty::before {
    content: attr(placeholder);
    color: #999;
    pointer-events: none;
}

#home-screen.day-mode .widget-signature:focus {
     background-color: rgba(255, 255, 255, 0.1);
}

#home-screen.day-mode .widget-signature:empty::before {
    color: rgba(255, 255, 255, 0.7);
}

.widget-date {
    color: var(--text-color); /* 日期的颜色，淡一点 */
    font-family: 'ZCOOL KuaiLe', cursive;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);

    position: absolute; /* 同样用绝对定位 */
    width: 140px; 
    text-align: center; /* 文字居中对齐 */

    /* 日期的位置 */
    /* 我们把它放在左下角椭圆的下面 */
    margin-left:135px;
    margin-top:110px; /*左右 */

    /* 这个是日期的字体大小 */
    font-size: 15px;
    /*border-top: 1.5px dashed  var(--text-color);*/
}
        /* --- Tutorial Screen Styles --- */
        .tutorial-item {
            margin-bottom: 15px;
            border: 1px solid #DAF0FC;
            border-radius: 12px;
            overflow: hidden;
            background-color: #F5FBFF;
        }

        .tutorial-header {
            padding: 12px 18px;
            font-weight: 600;
            color: var(--secondary-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tutorial-header::after {
            content: '▼';
            font-size: 12px;
            transition: transform 0.3s ease;
        }

        .tutorial-item.open .tutorial-header::after {
            transform: rotate(180deg);
        }

        .tutorial-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease;
            padding: 0 10px;
        }

        .tutorial-item.open .tutorial-content {
            padding: 10px 10px;
            /* A large value to ensure it expands to fit the content */
            max-height: 5000px;
        }

        .tutorial-content img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            display: block;
        }

    /* --- Peek Unlock Screen (Social Media) --- */
    #peek-unlock-screen {
        background-color: #fff;
        color: #262626;
    }

    #peek-unlock-screen .app-header .title,
    #peek-unlock-screen .app-header .back-btn,
    #peek-unlock-screen .app-header .action-btn {
        color: #262626;
    }

    #peek-unlock-screen .content {
        padding: 0;
    }

    .unlock-profile-header {
        display: flex;
        align-items: center;
        padding: 16px;
    }

    .unlock-profile-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        margin-right: 28px;
        object-fit: cover;
    }

    .unlock-profile-info {
        flex-grow: 1;
    }

    .unlock-profile-username {
        font-size: 22px;
        font-weight: 300;
        margin: 0 0 4px 0;
    }

    .unlock-profile-handle {
        font-size: 14px;
        color: #8e8e8e;
        margin: 0;
    }

    .unlock-profile-bio {
        padding: 0 16px 16px;
        font-size: 14px;
        line-height: 1.4;
    }

    .unlock-profile-stats {
        display: flex;
        justify-content: space-around;
        text-align: center;
        padding: 12px 0;
        border-top: 1px solid #efefef;
        border-bottom: 1px solid #efefef;
    }

    .unlock-profile-stat {
        font-size: 14px;
    }

    .unlock-profile-stat .count {
        font-weight: 600;
        display: block;
    }

    .unlock-profile-stat .label {
        color: #8e8e8e;
    }

    .unlock-post-feed {
        padding: 0;
        background-color: #f9f9f9;
    }

    .unlock-post-card {
        background-color: #fff;
        border-bottom: 1px solid #efefef;
        padding: 16px;
    }

    .unlock-post-card-header {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
    }

    .unlock-post-card-header img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 12px;
    }

    .unlock-post-card-author-info {
        display: flex;
        flex-direction: column;
    }

    .unlock-post-card-author-info .username {
        font-weight: 600;
        font-size: 15px;
    }

    .unlock-post-card-author-info .timestamp {
        font-size: 12px;
        color: #8e8e8e;
    }

    .unlock-post-card-content {
        font-size: 15px;
        line-height: 1.6;
        margin-bottom: 12px;
    }


    .unlock-post-card-actions {
        display: flex;
        justify-content: space-around;
        color: #8e8e8e;
        font-size: 13px;
        padding-top: 12px;
        border-top: 1px solid #f5f5f5;
    }

    .unlock-post-card-actions .action {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .unlock-post-card-actions .action svg {
        width: 20px;
        height: 20px;
        fill: #8e8e8e;
    }
    
    /* 猫猫Your existing CSS */

    /* Add specific styles for the settings screen if needed */
    
    #settings-screen .app-header .title{
    font-size: 20px;
    }
    
    #settings-screen .settings-list {
        margin-top: -18px;
        margin-left: -10px;
        padding: 0;
    }

    .settings-list .list-item {       
        border-bottom: none !important;
        justify-content: space-between;
        align-items: center;
        padding: 25px 20px;
        position: relative; /* 添加相对定位，为伪元素定位做准备 */
}

    .settings-list .list-item:not(:last-child)::after {
        content: '';
        position: absolute;
        bottom: 0;
        right: 5px; /* 靠右对齐 */
        width: 82%; /* 控制下划线长度，可调整百分比 */
        height: 1px;
        background-color: #f0f0f0; /* 下划线颜色 */
    }
    
        .settings-list .list-item:last-child:hover {
        background-color: transparent; /* 颜色透明 */
    }


    .settings-list .list-item .item-details {
        margin-top: -4px;
        margin-left: 25px;
        flex-grow: 1;
    }
    
    .settings-list .list-item .item-details .item-name {
        font-size: 19px;
    }

    .settings-list .list-item .setting-icon {
        width: 25px;
        height: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary-color); /* Adjust icon color */
    }

    .settings-list .list-item .setting-icon svg {
        width: 25px;
        height: 25px;
    }

/* --- 滑块开关样式 --- */
.setting-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 5px;
    border-bottom: 1px solid #f0f0f0;
    margin-bottom: 10px;
    background-color: #fff;
}


    /* Toggle Switch Styles */
    .switch {
        position: relative;
        display: inline-block;
        width: 80px;
        height: 28px;
    }
    
    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 10px;
        right: 10px;
        bottom: 0;
        background-color: var(--primary-color);

        -webkit-transition: .4s;
        transition: .4s;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        -webkit-transition: .4s;
        transition: .4s;
    }
    
    .setting-row .slider{       
        background-color: #ccc;

    }
    
    

    input:checked + .slider {
        background-color: #FF9C38;
    }

    .setting-row input:checked +  .slider{       
        background-color: var(--primary-color);

    }

    input:checked + .slider:before {
        -webkit-transform: translateX(32px);
        -ms-transform: translateX(32px);
        transform: translateX(32px);
    }

    /* Rounded sliders */
    .slider.round {
        border-radius: 28px;
    }

    .slider.round:before {
        border-radius: 50%;
    }

    .toggle-setting {
        display: flex;
        align-items: center;
    }
    
    *:focus {
    outline: none !important;
    box-shadow: none !important;
}

/* 专门针对滑块的输入框及其相邻的slider */

.switch input:focus,
:active {
    outline: none !important;
    box-shadow: none !important;
    -webkit-tap-highlight-color: transparent !important; /* 针对移动端点击高亮 */
}



    /* --- Peek Album Styles (偷看相册样式) --- */
    .album-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 2px;
        padding: 2px;
    }

    .album-photo {
        position: relative;
        width: 100%;
        padding-bottom: 100%; /* 1:1 Aspect Ratio */
        background-color: #e9ecef;
        cursor: pointer;
    }

    .album-photo img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .video-indicator {
        position: absolute;
        bottom: 5px;
        right: 5px;
        background-color: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .video-indicator svg {
        width: 14px;
        height: 14px;
        fill: white;
        margin-left: 2px;
    }

    #peek-photo-modal .modal-window {
        width: 90%;
        max-width: 420px; /* 确保弹窗不会超过手机屏幕宽度 */
        padding: 15px;
        background-color: #fff;
        border-radius: 15px;
    }

    #peek-photo-image-container {
        width: 100%;
        max-height: 70vh;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
        background-color: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
    }

    #peek-photo-image-container img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    #peek-photo-description {
        font-size: 15px;
        line-height: 1.6;
        color: #333;
        text-align: left;
        white-space: pre-wrap;
        padding: 0 5px 5px 5px;
        border-top: 1px solid #eee;
        margin-top: 15px;
        padding-top: 15px;
    }
        /* Peek Screen Specific Styles */
        #peek-messages-screen .list-item:hover,
        #peek-conversation-screen {
            background-color: #EEEDF2;
        }

        #peek-messages-screen .app-header,
        #peek-conversation-screen .app-header {
            background-color: rgba(248, 249, 250, 0.85);
            border-bottom-color: rgba(0, 0, 0, 0.08);
        }

        #peek-messages-screen .back-btn,
        #peek-conversation-screen .back-btn,
        #peek-messages-screen .title,
        #peek-conversation-screen .title {
            color: #212529;
        }

        #peek-messages-screen .chat-avatar {
            border-radius: 8px;
        }

        #peek-messages-screen .app-header .action-btn,
        #peek-conversation-screen .app-header .action-btn,
        #peek-cart-screen .app-header .action-btn,
        #peek-transfer-station-screen .app-header .action-btn,
        #peek-browser-screen .app-header .action-btn,
        #peek-drafts-screen .app-header .action-btn {
            color: #212529;
        }


 

        /* --- Peek Memos Screen --- */
        #peek-memos-screen {
            background-color: #f9f9f9;
        }

        #peek-memos-screen .app-header .title,
        #peek-memos-screen .app-header .back-btn,
        #peek-memos-screen .app-header .action-btn {
            color: #212529;
        }

        #peek-memos-screen .content {
            padding: 0;
        }

        #peek-memos-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .memo-item {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .memo-item:hover {
            background-color: #f0f0f0;
        }

        .memo-item-title {
            font-weight: 600;
            font-size: 16px;
            color: #333;
            margin: 0 0 5px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .memo-item-preview {
            font-size: 14px;
            color: #777;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- Peek Memo Detail Screen --- */
        #peek-memo-detail-screen {
            background-color: #fff;
        }

        #peek-memo-detail-screen .app-header .title,
        #peek-memo-detail-screen .app-header .back-btn,
        #peek-memo-detail-screen .app-header .action-btn {
            color: #212529;
        }
        
        #peek-memo-detail-screen .content {
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        #memo-title-input {
            border: none;
            padding: 20px;
            font-size: 22px;
            font-weight: bold;
            outline: none;
            border-bottom: 1px solid #eee;
        }

        #memo-content-textarea {
            flex-grow: 1;
            border: none;
            padding: 20px;
            font-size: 16px;
            line-height: 1.6;
            outline: none;
            resize: none;
            font-family: var(--font-family);
        }

        /* --- Peek Cart Screen --- */
        #peek-cart-screen {
            background-color: #f8f9fa;
        }

        #peek-cart-screen .app-header .title,
        #peek-cart-screen .app-header .back-btn {
            color: #212529;
        }

        #peek-cart-screen .content {
            padding: 0;
        }

        .cart-item-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .cart-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background-color: #fff;
            border-bottom: 1px solid #eee;
        }

        .cart-item-image {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            object-fit: cover;
            margin-right: 15px;
            background-color: #eee;
        }

        .cart-item-details {
            flex-grow: 1;
        }

        .cart-item-title {
            font-weight: 600;
            font-size: 15px;
            color: #333;
            margin: 0 0 5px 0;
        }

        .cart-item-spec {
            font-size: 13px;
            color: #888;
            margin-bottom: 8px;
        }

        .cart-item-price {
            font-size: 16px;
            font-weight: bold;
            color: #e53935;
        }
        
        .cart-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
            background-color: #fff;
            border-top: 1px solid #eee;
            flex-shrink: 0;
        }

        .cart-total-price {
            font-size: 18px;
            font-weight: bold;
            color: #e53935;
        }
        
        .cart-total-price .label {
            font-size: 14px;
            font-weight: normal;
            color: #333;
        }

        .checkout-btn {
            background-color: #e53935;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        /* --- Peek Transfer Station Screen --- */
        #peek-transfer-station-screen {
            background-color: #ededed; /* WeChat-like background */
        }

        #peek-transfer-station-screen .app-header {
            background-color: #ededed;
            border-bottom: 1px solid #dcdcdc;
        }

        #peek-transfer-station-screen .app-header .title,
        #peek-transfer-station-screen .app-header .back-btn {
            color: #000;
        }

        #peek-transfer-station-screen .content {
            display: flex;
            flex-direction: column;
            padding: 0;
        }

        .transfer-station-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .transfer-station-input-area {
            flex-shrink: 0;
            padding: 8px;
            background-color: #f7f7f7;
            border-top: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
        }

        .transfer-station-input-area .fake-input {
            flex-grow: 1;
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            height: 36px;
        }

        .transfer-station-input-area .plus-btn {
            width: 36px;
            height: 36px;
            margin-left: 8px;
            background-image: url('https://i.postimg.cc/8PLqF514/icons8-48.png');
            background-size: 24px;
            background-position: center;
            background-repeat: no-repeat;
            background-color: #f7f7f7;
            border: none;
        }

        /* --- Peek Browser Screen --- */
        #peek-browser-screen {
            background-color: #ffffff;
        }

        #peek-browser-screen .app-header .title,
        #peek-browser-screen .app-header .back-btn {
            color: #212529;
        }

        #peek-browser-screen .content {
            padding: 15px 0;
        }

        .browser-history-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .browser-history-item {
            padding: 12px 20px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .browser-history-item:last-child {
            border-bottom: none;
        }

        .history-item-title {
            font-weight: 500;
            font-size: 16px;
            color: #0056b3; /* A standard link blue */
            margin: 0 0 4px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-item-url {
            font-size: 13px;
            color: #555;
            margin-bottom: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-item-annotation {
            font-size: 14px;
            color: #444;
            background-color: #f5f5f5;
            padding: 8px 12px;
            border-radius: 8px;
            line-height: 1.5;
            position: relative;
        }
        
        .history-item-annotation::before {
            content: '批注：';
            font-weight: 600;
            color: #888;
            font-size: 12px;
            display: block;
            margin-bottom: 4px;
        }

        /* --- Peek Drafts Screen --- */
        #peek-drafts-screen {
            background-color: #fff;
            flex-direction: column;
        }

        #peek-drafts-screen .app-header .title,
        #peek-drafts-screen .app-header .back-btn {
            color: #212529;
        }

        #peek-drafts-screen .content {
            padding: 30px 25px;
            font-family: 'Georgia', 'Times New Roman', serif;
            line-height: 1.8;
            color: #333;
            flex-grow: 1;
            overflow-y: auto;
        }

        .draft-paper {
            background-color: #fdfdfd;
            border: 1px solid #eee;
            padding: 25px;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(130, 170, 200, 0.05);
        }

        .draft-to {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .draft-content {
            font-size: 17px;
            white-space: pre-wrap; /* To preserve line breaks */
        }

        .strikethrough {
            text-decoration: line-through;
            color: #999;
        }

        /* --- Chat Expansion Panel --- */
        .expansion-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }

        .expansion-item-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            transition: background-color 0.2s;
        }
        
        .expansion-item:hover .expansion-item-icon {
            background-color: #f5f5f5;
        }

        .expansion-item-icon svg {
            width: 32px;
            height: 32px;
            fill: #555;
        }

        .expansion-item-name {
            font-size: 13px;
            color: #666;
        }

        /* --- Memory Journal Screen --- */
        #memory-journal-screen .content {
            padding: 15px;
            background-color: #f9f9f9;
        }

        .journal-card {
            background-color: #fdfdfd;
            border: 1px solid #eee;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(130, 170, 200, 0.05);
            margin-bottom: 15px;
            position: relative;
            transition: all 0.3s ease;
        }

        .journal-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .journal-card-title {
            font-size: 18px;
            font-weight: bold;
            font-family: 'Georgia', 'Times New Roman', serif;
            color: #333;
            flex-grow: 1;
            padding-right: 60px; /* Space for buttons */
        }

        .journal-card-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .journal-card-actions .action-icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            color: #999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .journal-card-actions .action-icon-btn:hover {
            color: var(--primary-color);
        }

        .journal-card-actions .action-icon-btn svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        .journal-card-actions .favorite-journal-btn .star-solid {
            fill: #FFD700; /* Gold */
            display: none;
        }

        .journal-card-actions .favorite-journal-btn.favorited .star-solid {
            display: inline;
        }

        .journal-card-actions .favorite-journal-btn.favorited .star-outline {
            display: none;
        }

        .journal-card-content {
            font-family: 'Georgia', 'Times New Roman', serif;
            font-size: 16px;
            line-height: 1.7;
            color: #444;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, margin-top 0.4s ease-out, padding-top 0.4s ease-out;
            white-space: pre-wrap;
            margin-top: 0;
            padding-top: 0;
            border-top: 1px solid #f0f0f0;
        }

        .journal-card.expanded .journal-card-content {
            max-height: 1000px; /* A large enough value */
            margin-top: 15px;
            padding-top: 15px;
        }

        .journal-card-content.editing {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 8px;
            min-height: 150px;
            background: #fff;
            max-height: 1000px !important; /* Ensure it's visible when editing */
        }

        .journal-card-footer {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-top: 10px;
            height: 0;
            opacity: 0;
            transition: height 0.4s ease-out, opacity 0.4s ease-out;
        }

        .journal-card.expanded .journal-card-footer {
            height: auto;
            opacity: 1;
        }

        .journal-card-range {
            font-size: 12px;
            color: #aaa;
        }
        
        #memory-journal-screen .app-header .action-btn svg {
            width: 24px;
            height: 24px;
            }
            
/* --- Memory Journal Detail Screen --- */
#memory-journal-detail-screen .action-btn {
    padding: 0; /* 增加点击区域 */
}

#memory-journal-detail-screen .action-btn svg {
            width: 24px;
            height: 24px;
            }


        
        /* --- 论坛 --- */
        /* --- 论坛分享卡片 --- */
.forum-share-card {
    width: 250px; /* 卡片宽度 */
    background-color: #ffffff;
    border-radius: var(--border-radius);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    padding: 12px 15px;
    cursor: pointer;
    border: 1px solid #f0f0f0;
    margin: 0 8px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.forum-share-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
}

.forum-share-header {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #888;
    margin-bottom: 10px;
    padding-bottom: 8px;
    border-bottom: 1px solid #f5f5f5;
}

.forum-share-header svg {
    width: 18px;
    height: 18px;
    fill: #aaa;
    flex-shrink: 0;
}

.forum-share-content .forum-share-title {
    font-size: 15px;
    font-weight: 600;
    color: #333;
    margin: 0 0 5px 0;
    line-height: 1.4;
    /* 最多显示两行，超出部分显示省略号 */
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.forum-share-content .forum-share-summary {
    font-size: 13px;
    color: #666;
    line-height: 1.5;
    /* 最多显示三行 */
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
}

#forum-binding-modal .modal-window {
    max-width: 380px; /* 弹窗可以稍微宽一点 */
}

.forum-binding-tabs {
    display: flex;
    border-bottom: 2px solid #eee;
    margin-bottom: 15px;
}

.forum-binding-tabs .tab-btn {
    flex: 1;
    padding: 10px 15px;
    background: none;
    border: none;
    font-size: 15px;
    font-weight: 500;
    color: #888;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.2s ease-in-out;
}

.forum-binding-tabs .tab-btn:hover {
    color: var(--primary-color);
}

.forum-binding-tabs .tab-btn.active {
    color: var(--primary-color);
    font-weight: 600;
    border-bottom-color: var(--primary-color);
}

#forum-binding-content-wrapper {
    max-height: 50vh; /* 限制内容区域最大高度，超出则出现滚动条 */
    overflow-y: auto; /* 垂直方向溢出时显示滚动条 */
    padding-right: 10px; /* 为滚动条留出空间，防止内容被遮挡 */
}

.forum-binding-content {
    display: none; /* 默认隐藏所有内容面板 */
}

.forum-binding-content.active {
    display: block; /* 只显示激活的内容面板 */
}

.binding-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.binding-list-item {
    display: flex;
    align-items: center;
    padding: 12px 5px;
    border-bottom: 1px solid #f2f2f2;
}

.binding-list-item:last-child {
    border-bottom: none;
}

.binding-list-item input[type="checkbox"] {
    margin-right: 15px;
    width: 18px;
    height: 18px;
    flex-shrink: 0;
}

.binding-list-item label {
    font-size: 15px;
    color: var(--text-color);
    flex-grow: 1;
    cursor: pointer;
}

/* --- 论坛帖子样式 --- */

/* --- 新增：热帖模块样式 --- */
.hot-posts-section {
    background: #fff;
    margin: 5px 5px 10px 5px;
    border-radius: 12px;
    padding: 0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    overflow: hidden;
}

/* --- 1. 热帖头部下划线优化 --- */
.hot-posts-header {
    display: flex;
    align-items: center;
    padding: 12px 15px 0; /* 底部 padding 去掉，交给 wrapper */
    border-bottom: none; /* 移除通栏长线 */
    color: #F05F4A;
    font-weight: bold;
    font-size: 15px;
}

.header-content-wrapper {
    display: flex;
    align-items: center;
    gap: 3px;
    padding-left: 3px;
    padding-bottom: 3px; /* 文字到底部线的距离 */
    padding-right: 3px; /* 让线稍微长出一点点 */
    border-bottom: 0.5px solid #F05F4A; /* 短线 */
    width: auto;
}

.hot-posts-list {
    display: flex;
    flex-direction: column;
}

.hot-post-item {
    display: flex;
    align-items: flex-start; /* 改为顶部对齐，适应多行标题 */
    padding: 12px 20px; /* 增加左右内边距 */
    position: relative; /* 用于定位分割线 */
    cursor: pointer;
    transition: background-color 0.2s;
}

/* 分割线：两边留空隙 */
.hot-post-item::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 20px;
    right: 20px;
    height: 1px;
    background-color: #f5f5f5;
}

.hot-post-item:last-child::after {
    display: none;
}



.rank-badge {
    width: 24px;
    height: 24px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    font-size: 12px;
    margin-right: 12px;
    margin-top: 8px;
    flex-shrink: 0;
    font-family: var(--font-miao);
}

.rank-1 { 
background: #FDB931; 
box-shadow: 0 2px 4px rgba(255, 215, 0, 0.3); 
} /* 金 */
.rank-2 { background: #BDBDBD; box-shadow: 0 2px 4px rgba(189, 189, 189, 0.3); } /* 银 */
.rank-3 { background: #A0522D; box-shadow: 0 2px 4px rgba(205, 127, 50, 0.3); } /* 铜 */

.hot-post-info {
    flex: 1;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    min-height: 40px; /* 确保有一定高度 */
}

.hot-post-title {
    font-size: 14px;
    color: #333;
    /* 允许换行 */
    white-space: normal;
    line-height: 1.5;
    margin-bottom: 6px;
    font-weight: 500;
}

/* 热帖底部信息：左中右分布 */
/* --- 2. 热帖底部信息对齐优化 --- */
.hot-post-meta-row {
    display: flex;
    align-items: center;
    font-size: 11px;
    color: #999;
    width: 100%;
    /* 使用固定布局防止错位 */
}

.hot-post-meta-row > span:nth-child(1) {
    /* 发帖人：左侧，自适应，超出省略 */
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    text-align: left;
}

.hot-post-meta-row > span:nth-child(2) {
    /* 评论数：中间，固定宽度，居中对齐 */
    width: 45px; 
    text-align: left;
}

.hot-post-meta-row > span:nth-child(3) {
    /* 时间：右侧，固定宽度，右对齐 */
    width: 130px; 
    text-align: right;
}


/* --- 论坛帖子列表容器 (整体变为一张大卡片) --- */
#forum-posts-container {
    display: flex;
    flex-direction: column;
    gap: 0;          /* 关键：消除帖子之间的间距 */
    padding: 0;      /* 关键：消除容器内边距 */
    
    background-color: #ffffff;
    border-radius: 12px;  /* 统一的大圆角 */
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    margin: 5px;         /* 距离屏幕边缘的距离 */
    overflow: hidden;     /* 关键：剪裁内容，确保第一个和最后一个帖子的圆角不被直角覆盖 */
}

/* --- 论坛帖子单项 (变为列表项样式) --- */
/* --- 论坛帖子单项 --- */
.forum-post-card {
    position: relative; /* 关键：为分割线定位做参照 */
    background-color: #ffffff;
    border-radius: 0; 
    box-shadow: none; 
    margin: 0; 
    padding: 16px 20px;
    
    /* 移除之前的 border-bottom，改用伪元素 */
    border-bottom: none; 
    
    transition: background-color 0.2s ease;
    cursor: pointer;
}

.forum-post-card:first-child {
    padding-top: 18px;
}

.forum-post-card:last-child {
    padding-bottom: 20px;
}

/* --- 分割线样式：左右各留 20px 间距 --- */
.forum-post-card::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 20px;  /* 左边距 */
    right: 20px; /* 右边距 */
    height: 1px;
    background-color: #E5F0F7;
}

/* 最后一个帖子隐藏分割线 */
.forum-post-card:last-child::after {
    display: none;
}



.forum-post-card .post-title {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin: 0 0 8px 0; /* 稍微增加一点标题和信息的间距 */
}

/* --- 新增：元数据行样式 (控制对齐) --- */
.post-meta-row {
    display: flex;
    justify-content: space-between; /* 一左一右 */
    align-items: baseline;          /* 关键：基线对齐 */
    font-size: 12px;
    color: #888;
}

/* 占位文字样式调整 (适配白色背景) */
.placeholder-text {
    text-align: center;
    padding: 40px 20px;
    color: #999;
    margin: 0 !important;
}

/* --- Forum Post Detail Screen --- */
#forum-screen {
    background-color: #E5F0F7;
}

#forum-screen .app-header{    
    background-color: #FFFFFF; 
    border-bottom: none;
    height:50px;
}


#world-screen .app-header,
#me-screen .app-header{    
    background-color: #FFFFFF; 
    border-bottom: 1px solid rgba(168, 212, 255, 0.3);
    height:60px;
}

#favorites-screen .app-header .title-container .title,
#forum-screen .app-header .title-container .title,
#world-screen .app-header .title-container .title,
#me-screen .app-header .title-container .title{
    font-family: var(--font-miao);
    color: var(--primary-color);
    font-weight:100;
}


/* --- 论坛详情页新样式 --- */
#forum-post-detail-screen {
    background-color: #E5F0F7; /* 类似贴吧和社交媒体的浅灰色背景 */
}

#forum-post-detail-screen .content {
    padding: 10px; /* 页面边距 */
}

#d-delete-btn svg{
    fill:none;
    transform: translateY(-1px);
}

#favorites-screen .app-header,
#forum-post-detail-screen .app-header{    
    background-color: #FFFFFF; 
    border-bottom: 1px solid rgba(168, 212, 255, 0.3);
    height:60px;
    box-shadow: 0 2px 10px rgba(130, 170, 200, 0.1); 
}

#forum-post-detail-screen .app-header .title-container .title{
    font-family: var(--font-miao);
    color: var(--primary-color);
    font-weight:100;
}



#forum-post-detail-screen .action-btn-group .action-btn svg{
    width: 24px;
    height: 24px;
}

.post-detail-card {
    background-color: #fff;
    margin: 15px;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(130, 170, 200, 0.1);
}

.post-author-info {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
}

.post-author-avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    margin-right: 12px;
    background-color: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: bold;
    flex-shrink: 0;
}

.post-author-name {
    font-size: 16px;
    font-weight: 600;
    color: #333;
}

.post-detail-title {
    font-size: 20px;
    font-weight: 700;
    margin: 0 0 15px 0;
    line-height: 1.4;
}

.post-detail-content {
    font-size: 17px;
    line-height: 1.8;
    color: #444;
    white-space: pre-wrap;
    margin-bottom: 25px;
}

.post-actions {
    display: flex;
    justify-content: space-around;
    padding-top: 15px;
    border-top: 1px solid rgba(168, 212, 255, 1); 
}

.post-action-item {
    display: flex;
    align-items: center;
    gap: 6px;
    color: #666;
    font-size: 14px;
}

.post-action-item svg {
    width: 22px;
    height: 22px;
    fill: #888;
}



.post-detail-container {
    background-color: #ffffff;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(130, 170, 200, 0.2);
    margin-bottom: 10px;
    overflow: hidden;
}

.post-detail-main {
    padding: 20px 20px 10px 20px; /* 上 右 下(关键) 左 */
}

.post-author-info {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
}

.author-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;    
    margin-right: 12px;
    flex-shrink: 0;
    font-family: var(--font-miao);
}

.author-details {
    display: flex;
    flex-direction: column;
}

.author-name {
    font-size: 15px;
    font-weight: 600;
    color: #333;
}

.post-meta-data {
    font-size: 12px;
    color: #999;
}

.post-detail-title {
    font-size: 20px;
    font-weight: 700;
    margin: 0 0 15px 0;
    line-height: 1.4;
    color: #1a1a1a;
    
    /* --- 新增：两端对齐设置 --- */
    text-align: justify;
    text-justify: inter-ideograph; /* 中文对齐优化 */
    word-break: break-all;         /* 防止长英文单词撑破布局 */
}

/* --- 详情页正文排版优化 --- */

/* 1. 确保内容容器本身没有干扰样式 */
.post-detail-content-body {
    font-size: 16px;
    color: #333;
    line-height: 1.5; /* 增加行高，让文字不拥挤 */
    white-space: normal !important;
    padding-bottom: 0;
    margin-bottom: 20px;
}

/* 2. 强力控制 P 标签 (段落) */
.post-detail-content-body p,
.markdown-content p {
    display: block !important;
    margin-top: 0 !important;
    margin-bottom: 12px !important; /* 这里控制段落间距，18px 足够明显 */
    text-align: justify; /* 两端对齐 */
    text-justify: inter-ideograph;
    min-height: 1em; /* 防止空段落塌陷 */
}

/* 3. 修正标题和引用的间距 (防止因为单独渲染导致的间距过大) */
.post-detail-content-body h1, 
.post-detail-content-body h2,
.post-detail-content-body h3,
.post-detail-content-body blockquote {
    margin-top: 20px !important;
    margin-bottom: 10px !important;
}

/* 4. 引用块内部优化 */
.markdown-content blockquote {
    border-left: 4px solid var(--primary-color); /* 引用线颜色改为主题色 */
    background-color: #f8f9fa;
    padding: 10px 15px;
    border-radius: 4px;
}

/* 引用块里的段落不要再加巨大间距了 */
.markdown-content blockquote p {
    margin-bottom: 0 !important;
}

/* 5. 最后一个元素去除下边距 */
.post-detail-content-body > *:last-child {
    margin-bottom: 0 !important;
}

/* 斜体字颜色修改 */
.markdown-content em, 
.post-detail-content-body em {
    color: #4E7FAB;
    font-style: italic;
    font-weight: 500; /*稍微加粗一点点让颜色更明显*/
}

/* --- 2. 详情页复制按钮样式 --- */
.post-detail-main {
    position: relative; /* 关键：作为绝对定位的参照物 */
}

.post-copy-btn {
    position: absolute;
    top: 23px;
    right: 15px;
    background: transparent;
    border: none;
    color: #ccc; /* 默认浅灰色，不抢眼 */
    cursor: pointer;
    padding: 6px;
    border-radius: 8px;
    transition: all 0.2s;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
}



.post-copy-btn:active {
    transform: scale(0.9);
}

.post-copy-btn svg {
    width: 20px;
    height: 20px;
    fill: currentColor;
}


/* --- 新增：中文对话引号自动高亮样式 --- */
.inline-quote {
    font-size: 16px;
    background-color: #F6FAFF; /* 使用置顶底色 */
    border-radius: 4px;       /* 圆角 */
    padding: 2px 6px;         /* 内边距，让文字不拥挤 */
    color: #093F66;  /*可选：让对话文字颜色也变一下，突出显示 */
    margin: 0 1px;            /* 左右留一点空隙 */
    border-left: 1.5px solid #81AFD9;
    border-right: 1.5px solid #81AFD9;
}

.post-detail-actions {
    display: flex;
    justify-content: space-around;
    
    /* --- 修改部分：控制高度 --- */
    border-top: 1px solid #f0f0f0; /* 分割线加在这里 */
    padding-top: 12px;             /* 线条到图标的距离 */
    margin-top: 0;                 /* 移除额外的外部间距 */
}





/* --- 新增：收藏按钮与星标 --- */

#detail-star-btn.active svg {
    fill: #FFD700; /* 激活黄色 */
}


.post-detail-actions .action-item {
    display: flex;
    align-items: center;
    gap: 6px;
    color: #666;
    font-size: 14px;
    cursor: default; 
    padding: 5px 10px;
    border-radius: 5px;
    transition: background-color 0.2s;
    height: 30px; 
    user-select: none;           /* 禁止选中文本 */
    -webkit-tap-highlight-color: transparent; /* 移动端点击不显示高亮色块 */
    outline: none;               /* 去掉点击时的轮廓线 */
}

/* 移除这两个元素的 hover 背景色变化 */
.post-detail-actions .action-item:hover {
    background-color: transparent;
}

.post-detail-actions .action-item span {
    line-height: 1; /* 关键：消除行高带来的上下间隙 */
    
    /* 视觉微调：往下压 1.5px，这通常能让汉字和数字跟图标对得更齐 */
    position: relative;
    top: -1px; 
}

.post-detail-actions .action-item svg {
    width: 20px;
    height: 20px;
    fill: #888;
    transform: translateY(-1px);
}



/* --- 评论区样式 --- */
.comments-section {
    background-color: #ffffff;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    padding: 15px;
}

.comments-header {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    padding-bottom: 10px;
    border-bottom: 1px solid #f0f0f0;
    margin-bottom: 10px;
}

.comment-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.comment-item {
    display: flex;
    padding: 12px 0;
    border-bottom: 1px solid #f5f5f5;
}

.comment-item:last-child {
    border-bottom: none;
}

.comment-author-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background-color: var(--accent-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    margin-right: 12px;
    flex-shrink: 0;
    font-family: var(--font-miao);
}

.comment-body {
    flex-grow: 1;
}

.comment-author-name {
    font-size: 14px;
    font-weight: 600;
    color: #555;    
}

.comment-content {
    font-size: 15px;
    color: #333;
    margin-top: 4px;
    line-height: 1.6;
    
    /* --- 新增：两端对齐设置 --- */
    text-align: justify;
    text-justify: inter-ideograph; /* 中文对齐优化 */
    word-break: break-all;         /* 防止长英文单词撑破布局 */
    padding-right: 5px;            /*稍微给右边留点呼吸空间 */
}

.comment-timestamp {
    font-size: 12px;
    color: #aaa;
    margin-top: 6px;
}

/* --- 新增：评论删除按钮样式 --- */
.comment-delete-btn {
    margin-left: 3px;
    cursor: pointer;
    font-size: 11px;
    opacity: 0.7; 
    color: #777;
    background: rgba(0, 0, 0, 0.05);   
    padding: 2px 4px;
    border-radius: 4px;      
}
.comment-delete-btn:active {
    opacity: 1;
}


/* --- 修改：评论回复按钮 --- */
.comment-reply-btn {
    margin-left: 3px;
    cursor: pointer;
    font-size: 11px;
    color: var(--primary-color);
    background: rgba(0, 153, 255, 0.1);
    opacity: 0.7; 
    padding: 2px 4px;
    border-radius: 4px;    
}
.comment-reply-btn:active {
    background: rgba(0, 153, 255, 0.2);
}

/* --- 新增：New!字角标样式 --- */
.new-badge {
    display: inline-block;    
    color: var(--primary-color);
    background-color: transparent;
    padding: 1px 4px;         /* 稍微撑开一点内边距 */    
    margin-right: 2px;        /* 和标题的间距 */
    vertical-align: text-top; /* 关键：让它靠上对齐，像角标一样 */
    line-height: 1.2;
    font-weight: bold; 
    font-size: 12px;
    font-style: italic;
    transform: translateY(1px); /* 微调位置 */
}

/* --- 论坛搜索栏 --- */

/* 这是整个搜索区域的容器，我们让它透明，只用来布局 */
/* --- 底部导航栏 --- */
.bottom-tab-bar {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 60px;
    background-color: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(8px);
    border-top: 1px solid rgba(168, 212, 255, 0.3);
    display: flex;
    justify-content: space-around;
    align-items: center;
    z-index: 100;
    box-shadow: 0 -2px 10px rgba(130, 170, 200, 0.1);
}

.tab-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #999;
    font-size: 11px;
    font-family: var(--font-miao);
    cursor: pointer;
    flex: 1;
    height: 100%;
    transition: color 0.2s;
}

.tab-item.active {
    color: var(--primary-color);
}

.tab-item svg {
    width: 36px;
    height: 36px;
    margin-bottom:0;
    fill: currentColor;
}


/* --- 顶部搜索栏 (新版) --- */
.forum-top-search-bar {
    position: absolute;
    top: 40px; /* 紧贴 Header 下方 */
    left: 0;
    width: 100%;
    height: 60px;
    background-color: rgba(255, 255, 255, 1);
    backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 15px;
    box-sizing: border-box;
    z-index: 90;
    
    /* 修改点 1：调整边框颜色，让它更淡，或者直接去掉，依靠阴影分割 */
    border-bottom: 1px solid rgba(168, 212, 255, 0.3);
    
    /* 修改点 2：调整阴影，垂直方向(Y轴)加大，让阴影更明显地向下 */
    box-shadow: 0 4px 6px -1px rgba(130, 170, 200, 0.15);
    
    /* 核心修改点：使用 clip-path 裁切掉顶部的所有阴影 */
    /* inset(上 右 下 左) */
    /* 0 代表顶部紧贴边缘裁切（去掉上方阴影） */
    /* -20px 代表右、下、左允许延伸出 20px（保留这些方向的阴影） */
    clip-path: inset(0 -20px -20px -20px);
}

/* 调整搜索框样式 */
.forum-top-search-bar input {
    flex: 1;
    height: 36px;
    border: 1px solid rgba(168, 212, 255, 0.6);
    background-color: #ffffff;
    border-radius: 19px;
    padding: 0 15px;
    font-size: 15px;
    outline: none;
    color: #333;
    transition: all 0.2s;
}

.forum-top-search-bar input:focus {
    background-color: #fff;
    border-color: 1px solid rgba(168, 212, 255, 0.9);
}

/* 搜索栏内的按钮 */
.forum-top-search-bar .action-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background-color: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
    flex-shrink: 0;
}

/* --- 内容区域调整 (适配顶部搜索栏和底部导航栏) --- */
/* 发现页内容区 */
#forum-screen .forum-content-area {
    padding-top: 55px !important; /* Header 60 + Search 60 + Gap */
    padding-bottom: 65px !important; /* Bottom Tab 60 + Gap */
    padding-left:5px !important;
    padding-right:5px !important;
}

/* 针对 Chrome/Safari/Webkit内核 隐藏滚动条 */
#forum-screen .forum-content-area::-webkit-scrollbar {
    display: none;
    width: 0;
    height: 0;
}

/* 世界页 & 我页 内容区 */
.tab-content-area {
    padding: 15px;
    padding-bottom: 70px !important;
    height: 100%;
    overflow-y: auto;
    box-sizing: border-box;
    scrollbar-width: none;
}
.tab-content-area::-webkit-scrollbar { display: none; }

/* --- 世界页样式 --- */
.world-section-title {
    font-size: 14px;
    color: #888;
    margin: 15px 0 10px 5px;
    font-weight: 600;
}
.world-list-container {
    background: #fff;
    border-radius: 12px;
    overflow: hidden;
}

/* --- 世界页面布局 --- */
/* 移除原本的 padding，改为布局容器控制 */
#world-screen .tab-content-area {
    padding: 0 !important; 
    display: flex;
    flex-direction: row;
    height: calc(100% - 110px); /* 减去 Header(60) + BottomNav(60) + Padding(10) */
    overflow: hidden;
    position: absolute;
    top: 50px;
    bottom: 60px;
    width: 100%;
}

/* 侧边栏 */
.world-sidebar {
    width: 90px;
    background-color: #E5F0F7;

    display: flex;
    flex-direction: column;
    padding-top: 10px;
    flex-shrink: 0;
}

/* --- 修改后的侧边栏按钮样式 --- */
.world-sidebar-btn {
    padding: 15px 5px;
    text-align: center;
    font-size: 15px; /* 字体稍微改小一点适配图标 */
    color: #888;     /* 默认颜色淡一点 */
    cursor: pointer;
    border-left: 3px solid transparent;
    transition: all 0.2s;
    background: none;
    border: none;
    
    outline: none;
    width: 100%;
    font-family:var(--font-miao);
    /* 使用 Flex 布局实现图标和文字垂直排列 */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 6px; /* 图标和文字的间距 */
}

/* 激活状态 */
.world-sidebar-btn.active {
    color: var(--primary-color);
    background-color: #fff;
    border-left-color: var(--primary-color);
    border-bottom-right-radius: 18px;
}

/* 图标样式 */
.world-sidebar-btn svg {
    width: 40px;
    height: 40px;
    fill: currentColor; /* 颜色跟随文字颜色变化 */
    transition: transform 0.2s;
}

/* 鼠标悬停微动效 */
.world-sidebar-btn:hover svg {
    transform: scale(1.1);
}

/* 右侧内容区 */
.world-content-wrapper {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    position: relative;
    /* 隐藏滚动条 */
    scrollbar-width: none;
}
.world-content-wrapper::-webkit-scrollbar { display: none; }

/* 两个 Tab 内容容器 */
.world-tab-pane {
    display: none;
}
.world-tab-pane.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}

/* --- 修改：世界页面微调 --- */
.world-book-shortcut-btn {
    width: 100%;
    padding: 12px;
    background-color: var(--top-pinned-bg);
    border: 1px dashed var(--primary-color);
    color: var(--primary-color);
    text-align: center;
    border-radius: 8px;
    margin-bottom: 15px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
}

.history-limit-input {
    width: 80px;
    padding: 5px;
    border: 1px solid var(--primary-color);
    border-radius: 6px;
    margin-left: 10px;
    text-align: center;
}



/* --- 新增：收藏页样式 --- */
/* --- 收藏页样式优化 --- */
/* 收藏列表容器 */
#favorites-list-container {
    padding: 10px;
    background-color: #E5F0F7; /* 背景稍微灰一点，突出卡片 */
    padding-bottom: 60px; /* 留出底部空间 */
    /* --- 新增：隐藏滚动条 --- */
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE 10+ */
}

/* 针对 Chrome/Safari/Webkit内核 隐藏滚动条 */
#favorites-list-container::-webkit-scrollbar {
    display: none;
    width: 0;
    height: 0;
}





/* 收藏卡片样式 */
.fav-post-card {
    background: #fff;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    display: flex;
    align-items: center;
}

.fav-post-content {
    flex: 1;
}

.fav-post-title {
    font-size: 15px;
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
    line-height: 1.4;
}

.fav-post-meta {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: #999;
}

/* 收藏管理栏固定底部 */
.favorites-manage-bar {
    position: absolute; /* 绝对定位 */
    bottom: 60px; /* 位于导航栏上方 (导航栏高60px) */
    right: 0px;
    width: 100%;
    height: 60px;
    background: #eee;    
    padding: 10px 10px 10px 260px;
    display: none; /* 默认隐藏 */
    justify-content: flex-end;
    z-index: 99; /* 确保在列表之上 */
    border-top:1px solid #fff;
    box-shadow: 3px 2px 0 0 rgba(0,0,0,0.1);
}

/* --- 1. 收藏页防遮挡修复 --- */
/* 正常状态下底部留白（给底部导航栏） */
/* 管理模式下底部留白增加（给删除栏留位） */
/* 导航栏60px + 删除栏约50px + 间距 */
#favorites-list-container.manage-mode {
    padding-bottom: 120px !important; 
}

/* --- 我页面头像修改 --- */
.me-avatar-container {
    position: relative;
    width: 110px;
    height: 110px;
    margin: 0 auto 0 auto;
    cursor: pointer;
}

.me-avatar-preview {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background-color: #eee;
    overflow: hidden;
    border: 3px solid #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    position: relative;
}

/* 遮罩层，提示点击更换 */
.me-avatar-overlay {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.3);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s;
}
.me-avatar-overlay svg {
    fill: #fff;
    width: 40px;
    height: 40px;
}
.me-avatar-container:hover .me-avatar-overlay {
    opacity: 1;
}



/* --- 我页样式 --- */
.me-card {
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 1px 3px rgba(130, 170, 200, 0.05);
    margin-bottom: 15px;
}
.me-input-group {
    margin-bottom: 15px;
}
.me-input-group label {
    display: block;
    font-size: 13px;
    color: #666;
    margin-bottom: 5px;
}

#me-screen .form-group textarea {
    min-height: 120px !important;
}




/* --- 新增：详情页回复区域样式 --- */
/* --- 详情页布局核心 --- */
/* --- 详情页布局核心 --- */
.detail-content-area {
    padding-bottom: 70px !important; 
    height: 100%;
    overflow-y: auto; /* 保持滚动功能 */
    box-sizing: border-box;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 15px;

    /* --- 新增：隐藏滚动条 --- */
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE 10+ */
}

/* 针对 Chrome/Safari/Webkit内核 隐藏滚动条 */
.detail-content-area::-webkit-scrollbar {
    display: none;
    width: 0;
    height: 0;
}

/* --- 底部固定回复栏 --- */
.detail-reply-bar {
    position: absolute; /* 绝对定位，钉在屏幕底部 */
    bottom: 0;
    left: 0;
    right: 0; /* 核心修改：同时设置 left 和 right，不设置 width */
    width: auto; /* 核心修改：让宽度自动适应 left/right */
    height: 60px; /* 固定高度 */
    background-color: rgba(255,255,255,0.9);
    backdrop-filter: blur(8px);
    border-top: 1px solid rgba(168, 212, 255, 0.3); 
    padding: 8px 15px;
    box-sizing: border-box;
    display: flex;
    align-items: center;
    gap: 8px;
    z-index: 100;
    box-shadow: 0 -2px 4px rgba(130, 170, 200, 0.1);
}

/* 回复栏内部组件样式 (保持紧凑) */
.reply-bar-select {
    max-width: 80px;
    height: 36px;
    border: 1px solid rgba(168, 212, 255, 0.3); 
    border-radius: 18px;
    padding: 0 10px;
    font-size: 12px;
    background-color: #ffffff;
    outline: none;
    color: #333;
}
.reply-bar-input {
    flex: 1;
    min-width: 0;
    height: 36px;
    border: 1px solid rgba(168, 212, 255, 0.7); 
    border-radius: 18px;
    padding: 8px 15px;
    font-size: 14px;
    background-color: #ffffff;
    outline: none;
}

.reply-bar-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background-color: var(--primary-color);
    color: white;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    flex-shrink: 0;
}
.reply-bar-btn svg {
    width: 18px;
    height: 18px;
    fill: currentColor;
    margin-left: 2px;
}


/* --- 新增：折叠面板样式 --- */
.collapsible-section {
    background-color: #F5FBFF;
    border: 1px solid #DAF0FC;
    border-radius: 12px;
    margin-bottom: 15px;
    overflow: hidden; /* 防止内容溢出圆角 */
    transition: all 0.3s ease-in-out;
}

.collapsible-header {
    padding: 10px 15px; /* 调整内边距 */
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    user-select: none; /* 防止选中文本 */
}
.category-toggle-area {
    flex-grow: 1;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px; /* 增加点击区域 */
}
.category-select-area {
    padding-right: 10px;
    display: flex;
    align-items: center;
}

.collapsible-header h4 {
    margin: 0;
    font-size: 16px;
    color: var(--primary-color);
}

.collapsible-arrow {
    font-size: 14px;
    color: var(--secondary-color);
    transition: transform 0.3s ease-in-out;
}

.collapsible-content {
    max-height: 0; /* 默认折叠 */
    overflow: hidden;
    transition: max-height 0.4s ease-in-out;
    padding: 0 20px; /* 左右留出边距 */
}

/* 当 .collapsible-section 拥有 .open 类时应用的样式 */
.collapsible-section.open .collapsible-content {
    max-height: 5000px; /* 一个足够大的值来完全显示内容 */
    padding: 0 20px 20px; /* 展开时恢复底部内边距 */
}

.collapsible-section.open .collapsible-arrow {
    transform: rotate(180deg); /* 箭头旋转 */
}
/* --- 新增样式结束 --- */
.message-time {
     display: none !important;
}

 
 
/* --- Peek Steps App Styles (偷看步数应用样式) --- */
#peek-steps-screen {
    background-color: #f0f2f5;
    color: #1c1e21;
}


#peek-steps-screen .app-header {
    background-color: #f0f2f5;
    border-bottom: 1px solid #dcdcdc;
}

#peek-steps-screen .app-header .title,
#peek-steps-screen .app-header .back-btn {
    color: #1c1e21;
}

#peek-steps-screen .content {
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    flex-grow: 1;
    overflow-y: auto;
}

.steps-header {
    display: flex;
    align-items: center;
    width: 100%;
    margin-bottom: 30px;
    padding: 0 10px;
}

.steps-header-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    margin-right: 15px;
}

.steps-header-name {
    font-size: 20px;
    font-weight: 600;
}

.steps-progress-container {
    width: 220px;
    height: 220px;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 35px;
    flex-shrink: 0; /* 防止在flex布局中被压缩 */
}

.steps-progress-circle {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: conic-gradient(
        #4CAF50 0deg,
        #4CAF50 calc(3.6deg * var(--steps-percentage, 0)),
        #e6e6e6 calc(3.6deg * var(--steps-percentage, 0)),
        #e6e6e6 360deg
    );
    transition: background 0.5s ease-in-out;
}

.steps-progress-inner {
    position: absolute;
    width: 85%;
    height: 85%;
    background-color: #f0f2f5;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.steps-count {
    font-size: 42px;
    font-weight: bold;
    color: #4CAF50;
}

.steps-label {
    font-size: 14px;
    color: #65676b;
    margin-top: 5px;
}

.steps-module {
    width: 100%;
    background-color: #fff;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

.steps-module-title {
    font-size: 16px;
    font-weight: 600;
    margin: 0 0 12px 0;
    padding-bottom: 10px;
    border-bottom: 1px solid #f0f0f0;
}

.activity-track-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.activity-track-item {
    font-size: 15px;
    color: #333;
    padding: 8px 0;
}

.steps-annotation {
    width: 100%;
    background-color: #fff;
    border-radius: 12px;
    padding: 15px;
    margin-top: 15px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    font-size: 14px;
    color: #555;
    line-height: 1.6;
    font-style: italic;
}
/* --- 世界书分类样式 --- */
.world-book-category-title {
padding: 10px 20px 5px 20px;
font-size: 16px;
font-weight: 600;
color: var(--secondary-color);
background-color: #F5FBFF;
border-bottom: 1px solid #DAF0FC;
border-top: 1px solid #DAF0FC;
margin-top: 10px;
}

#world-book-list-container > .world-book-category-title:first-child {
margin-top: 0;
border-top: none;
}

/* --- 世界书分类选择样式 --- */
.world-book-category-group {
    border-bottom: 1px solid #f0f0f0;
    margin-bottom: 5px;
}
.world-book-category-group:last-child {
    border-bottom: none;
}

.world-book-category-header {
    display: flex;
    align-items: center;
    padding: 12px 5px;
    cursor: pointer;
    user-select: none;
}

.world-book-category-header .category-checkbox {
    margin-right: 15px;
    width: 20px;
    height: 20px;
}

.world-book-category-header .category-name {
    font-weight: 600;
    color: var(--primary-color);
    flex-grow: 1;
}

.world-book-category-header .category-arrow {
    font-size: 12px;
    transition: transform 0.3s ease;
}

.world-book-category-group.open .category-arrow {
    transform: rotate(180deg);
}

.world-book-items-list {
    list-style: none;
    padding: 0 0 0 25px; /* 左侧缩进 */
    margin: 0;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease-in-out;
}

.world-book-category-group.open .world-book-items-list {
    max-height: 1000px; /* 一个足够大的值 */
    padding-bottom: 10px;
}
/* --- 聊天室顶栏按钮优化 --- */
#chat-room-header-default .action-btn-group {
    gap: 2px; /* 减小按钮之间的间距 */
}

#chat-room-header-default .action-btn-group .action-btn {
    width: 30px;  /* 缩小按钮宽度 */
    height: 30px; /* 缩小按钮高度 */
    padding: 0; /* 调整内边距以适应新尺寸 */

}

#chat-room-header-default .action-btn-group .action-btn svg {
    width: 24px;  /* 缩小图标宽度 */
    height: 24px; /* 缩小图标高度 */
    stroke: var(--primary-color) !important;
    stroke-width: 0.5px !important;
}

#chat-room-header-default {
  padding: 20px 10px; 
  height: 60px; /* 你想要的高度，比如原本大约是 56px */ 
  border-bottom:none;
}
  
/* 保持整体布局两端分布 */
#chat-room-header-default .app-header {
  justify-content: space-between !important;
  position: relative !important;
 
    
}
/* 标题靠左放，与返回键组合成一组 */
#chat-room-header-default .title-container {
  position: static !important;   /* 去掉 absolute 定位 */
  transform: none !important;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  text-align: left;
  margin-left: 0;             /* 离返回键留点间距 */
  flex-grow: 1;                  /* 占据中间空间 */
}
#chat-room-header-default .title {
  font-size: 18px;
  font-weight: 600;
  margin: 0;
}
/* 状态栏文字靠左 */
#chat-room-header-default .subtitle {
  font-size: 11px;
margin-top: -1px;
margin-left: 4px;
  display: flex;
  align-items: center;
  justify-content: flex-start;
}

/* 按钮靠左 */
#chat-room-header-default .action-btn-group {
  align-items: center;
  justify-content: flex-start;
}

#chat-room-header-default .back-btn {
margin-left: -8px;
}

        #peek-screen .app-header .back-btn,
        #peek-screen .app-header .action-btn,
        #peek-unlock-screen .app-header .action-btn,
        #peek-messages-screen .app-header .action-btn,
        #peek-conversation-screen .app-header .action-btn,
        #peek-cart-screen .app-header .action-btn,
        #peek-transfer-station-screen .app-header .action-btn,
        #peek-browser-screen .app-header .action-btn,
        #peek-drafts-screen .app-header .action-btn,
        #peek-memos-screen .app-header .action-btn,
        #peek-memo-detail-screen .app-header .action-btn{            
            color: #212529
    }
    

        #peek-screen .app-header .action-btn svg,
        #peek-unlock-screen .app-header .action-btn svg,
        #peek-messages-screen .app-header .action-btn svg,
        #peek-conversation-screen .app-header .action-btn svg,
        #peek-cart-screen .app-header .action-btn svg,
        #peek-transfer-station-screen .app-header .action-btn svg,
        #peek-browser-screen .app-header .action-btn svg,
        #peek-drafts-screen .app-header .action-btn svg,
        #peek-memos-screen .app-header .action-btn svg,
        #peek-memo-detail-screen .app-header .action-btn svg{
            width: 28px;
            height: 28px;
            color: #212529
    }
    
        #peek-conversation-screen    .message-bubble.sent {
         background-color: var(--primary-color);
          color: #FFFFFF
        }

       #peek-conversation-screen .message-bubble.received {
           background-color: #FFFFFF;   
        }


/* --- 存储分析详情列表样式 --- */
.storage-detail-item {
    display: flex;
    align-items: center;
    padding: 12px 8px;
    border-bottom: 1px solid #f0f0f0;
}
.storage-detail-item:last-child {
    border-bottom: none;
}
.storage-color-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 15px;
    flex-shrink: 0;
}
.storage-detail-info {
    flex-grow: 1;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 15px;
}
.storage-detail-name {
    font-size: 16px;
    color: #333;
    font-weight: 500;
}
.storage-detail-size {
    font-size: 15px;
    color: #666;
    text-align: right;
}
.storage-detail-percentage {
    font-size: 12px;
    color: #999;
    width: 50px;
    text-align: right;
    flex-shrink: 0;
}
        /* --- 引用消息样式 --- */
        #reply-preview-bar {
            display: none; /* 默认隐藏 */
            padding: 8px 12px;
            background-color: rgba(240, 240, 240, 0.9);
            backdrop-filter: blur(10px);
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            animation: fadeIn 0.2s ease-out;
        }

        #reply-preview-bar.visible {
            display: flex;
        }

        .reply-preview-content {
            flex-grow: 1;
            overflow: hidden;
            border-left: 3px solid var(--primary-color);
            padding-left: 8px;
        }

        .reply-preview-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--primary-color);
            display: block;
        }

        .reply-preview-text {
            font-size: 14px;
            color: #666;
            margin: 2px 0 0 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #cancel-reply-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: #999;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
        }

        .quoted-message {
            background-color: rgba(0, 0, 0, 0.04);
            padding: 6px 10px;
            border-radius: 10px;
            margin-bottom: 6px;
            border-left: 3px solid var(--secondary-color);
        }

        .quoted-sender {
            font-size: 14px;
            font-weight: 600;
            color: var(--secondary-color);
            display: block;
        }

        .quoted-text {
            font-size: 13px;
            color: #555;
            margin: 2px 0 0 0;
            white-space: pre-wrap; /* Allow line breaks */
            word-wrap: break-word;
            /* Limit to 3 lines with ellipsis */
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    
        /* --- Pomodoro (番茄钟) Styles --- */
        #pomodoro-screen {
            background: var(--white-color); /* Match other app screens */
            color: #333;
            flex-direction: column;
        }


        #pomodoro-screen .content {
            padding: 15px;
            flex-grow: 1;
            overflow-y: auto;
        }

        .task-list-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .task-card {
            background: var(--white-color); /* 使用白色背景以突出卡片 */
            border: 1px solid #f5f5f5; /* 添加一个非常浅的边框 */
            border-radius: 12px; /* 恢复圆角，使其看起来像卡片 */
            padding: 18px; /* 统一内边距 */
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04); /* 添加微妙的阴影以营造悬浮感 */
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .task-card:hover {
            transform: translateY(-2px); /* 悬停时轻微上浮 */
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08); /* 悬停时阴影加深 */
        }

        .task-card-info {
            flex-grow: 1;
        }

        .task-card-title {
            font-size: 16px; /* 标题字号稍小 */
            font-weight: 500; /* 字体变细 */
            margin: 0 0 8px 0; /* 增加与详情的间距 */
            color: #333;
        }

        .task-card-details {
            font-size: 14px; /* 详情字号稍大 */
            color: #888; /* 颜色变浅 */
        }

        .task-card-start-btn {
            background-color: transparent; /* 透明背景 */
            color: var(--primary-color); /* 主题色文字 */
            border: 1px solid var(--primary-color); /* 主题色描边 */
            border-radius: 20px; /* 更圆润的按钮 */
            padding: 8px 18px; /* 调整按钮大小 */
            font-weight: 500; /* 字体稍细 */
            cursor: pointer;
            flex-shrink: 0;
            margin-left: 15px;
            transition: all 0.2s ease; /* 平滑过渡 */
        }

        .task-card-start-btn:hover {
            background-color: var(--primary-color); /* 悬停时填充背景 */
            color: white; /* 文字变白 */
        }

        /* Create Task Modal Styles */
        #pomodoro-create-modal .modal-window {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #pomodoro-create-modal .form-group {
            margin-bottom: 18px;
        }

        #pomodoro-create-modal .radio-group-pills {
            display: flex;
            border: 1px solid #ddd;
            border-radius: 12px;
            overflow: hidden;
        }

        #pomodoro-create-modal .radio-group-pills label {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            background-color: transparent;
            color: #555;
            transition: background-color 0.2s, color 0.2s;
            font-weight: 500;
        }

        #pomodoro-create-modal .radio-group-pills input[type="radio"] {
            display: none;
        }

        #pomodoro-create-modal .radio-group-pills input[type="radio"]:checked + label {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 2px 8px rgba(56, 155, 255, 0.4);
        }

        #pomodoro-duration-options {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, margin-top 0.4s ease-in-out;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        #pomodoro-duration-options.visible {
            max-height: 200px; /* A large enough value */
            margin-top: 15px;
        }

        #pomodoro-duration-options .duration-pill {
            flex-grow: 1;
            background-color: #f0f0f0;
            border: none;
            border-radius: 10px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s, color 0.2s;
        }

        #pomodoro-duration-options .duration-pill.active {
            background-color: var(--accent-color);
            color: white;
        }

        #pomodoro-custom-duration-input {
            width: 100%;
            margin-top: 10px;
            display: none; /* Initially hidden */
        }
        /* --- Pomodoro Focus Screen Styles --- */
        #pomodoro-focus-screen {
            background: var(--white-color);
            color: var(--text-color);
            flex-direction: column;
        }

        #pomodoro-focus-screen .app-header {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #eee;
        }

        #pomodoro-focus-screen .app-header .back-btn,
        #pomodoro-focus-screen .app-header .title {
            color: var(--text-color);
            text-shadow: none;
        }

        #pomodoro-focus-screen .content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Push timer up and controls down */
            align-items: center;
            flex-grow: 1;
        }

        .focus-timer-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-grow: 1; /* Take up available space */
            text-align: center;
        }

        .focus-task-title {
            font-size: 22px;
            font-weight: 500;
            color: #555;
            margin: 0 0 25px 0;
        }

        .focus-timer-display {
            font-size: 80px;
            font-weight: 700;
            line-height: 1;
            color: #333;
        }

        .focus-timer-mode {
            font-size: 16px;
            color: #888;
            margin-top: 10px;
        }

        .focus-total-time {
            font-size: 14px;
            color: #aaa;
            margin-top: 15px;
        }

        .focus-bottom-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 320px; /* Limit width for better spacing */
            padding: 20px 0 calc(20px + env(safe-area-inset-bottom));
            flex-shrink: 0;
        }
        
        .focus-controls-group {
            display: flex;
            gap: 20px;
        }

        .focus-bottom-controls .control-btn {
            background: transparent;
            border: none;
            color: #333;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            padding: 8px;
            border-radius: 50%;
        }

        .focus-bottom-controls .control-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .focus-bottom-controls .control-btn svg {
            width: 32px;
            height: 32px;
        }

        .focus-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
        }

        .focus-footer {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .focus-message-bubble {
            background-color: #f0f0f0;
            border-radius: 12px;
            padding: 15px 20px;
            width: 90%;
            max-width: 340px;
            margin-bottom: 20px;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            text-align: center;
            color: #333;
            font-size: 15px;
            /* --- 新增：动画样式 --- */
            opacity: 0;
            transform: translateY(15px) scale(0.95);
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); /* 一个有弹性的过渡效果 */
            pointer-events: none; /* 隐藏时不可交互 */
        }

        .focus-message-bubble.visible {
            opacity: 1;
            transform: translateY(0) scale(1);
            visibility: visible;
            pointer-events: auto; /* 显示时可交互 */
        }

        .focus-message-bubble::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #f0f0f0;
        }
        /* --- NEW: Swipe to delete styles for task cards (Corrected) --- */
        .task-card-wrapper {
            position: relative;
            overflow: hidden;
            border-radius: 12px; /* Match task-card border-radius */
        }

        .task-card {
            transition: transform 0.3s ease-in-out;
            will-change: transform;
            background-color: var(--white-color); /* Ensure it has a background */
            z-index: 2; /* Keep card above delete button */
            position: relative; /* Establishes stacking context */
        }

        .task-card-delete-btn {
            position: absolute;
            top: 0;
            right: 0;
            width: 80px;
            height: 100%;
            background-color: #ef5350; /* Danger color */
            color: white;
            border: none;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1; /* Positioned behind the card */
        }

        .task-card-wrapper.is-swiped .task-card {
            transform: translateX(-80px);
        }

        /* --- Pomodoro Settings Sidebar Styles --- */
        #pomodoro-settings-sidebar {
            background: rgba(245, 245, 245, 0.9);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
        }

        #pomodoro-settings-sidebar .header {
            color: #333;
            font-weight: 600;
            border-bottom-color: rgba(0,0,0,0.08);
        }

        #pomodoro-settings-sidebar .form-group label {
            color: #555;
            font-weight: 500;
        }

        #pomodoro-settings-sidebar .form-group input,
        #pomodoro-settings-sidebar .form-group select {
            background-color: rgba(255, 255, 255, 0.95);
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            font-size: 15px;
        }

        #pomodoro-settings-sidebar .form-group input:focus,
        #pomodoro-settings-sidebar .form-group select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(56, 155, 255, 0.2);
        }

        #pomodoro-settings-sidebar hr {
            border: none;
            border-top: 1px solid #eee;
            margin: 25px 0;
        }

        /* --- Pomodoro Certificate Styles --- */
        #pomodoro-certificate-modal .modal-window {
            background: linear-gradient(135deg, #F5FBFF, #EBF5FF);
            border: 1px solid var(--primary-color);
            box-shadow: 0 8px 25px rgba(56, 155, 255, 0.2);
        }

        #pomodoro-certificate-modal h3 {
            font-family: 'Georgia', 'Times New Roman', serif;
            font-size: 24px;
            color: var(--primary-color);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        #pomodoro-certificate-content {
            border-color: rgba(56, 155, 255, 0.5);
            text-align: left;
            padding: 20px 25px;
        }

        #pomodoro-certificate-content p {
            font-size: 16px;
            color: #555;
            margin: 10px 0;
            line-height: 1.6;
        }

        #pomodoro-certificate-content p strong {
            color: var(--secondary-color);
            font-weight: 600;
        }

        /* --- Pomodoro Record Card in Chat (New Style) --- */
        .pomodoro-record-card {
            width: 230px;
            background-color: #fff;
            border: 2px solid #333;
            border-radius: var(--border-radius);
            box-shadow: 4px 4px 0px #ddd;
            padding: 10px;
            display: flex;
            align-items: center;
            cursor: pointer;
            margin: 0 8px;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .pomodoro-record-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }

        .pomodoro-record-icon {
            width: 50px;
            height: 50px;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .pomodoro-record-body .task-name {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            font-family: 'Comic Sans MS', 'Chalkduster', 'Handwriting', cursive;
        }

        .pomodoro-record-details {
            font-size: 14px;
            color: #555;
            background-color: rgba(240, 240, 240, 0.9);
            padding: 8px 12px;
            margin-top: 10px;
            border-radius: 10px;
            line-height: 1.6;
            display: none; /* 默认隐藏 */
            animation: fadeIn 0.3s ease;
            white-space: nowrap; /* 不换行 */
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .pomodoro-record-details.active {
            display: flex;
        }

        /* --- New INS-Style Widget --- */
        .ins-widget {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            align-items: center;
            padding: 10px; /* Add some padding */
            gap: 5px;
            box-sizing: border-box;
        }

        .ins-widget-row {
            display: flex;
            width: 100%;
            align-items: center;
        }

        .ins-widget-row.user {
            justify-content: flex-start;
        }

        .ins-widget-row.character {
            justify-content: flex-end;
        }

        .ins-widget-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;

            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15); /* 头像阴影 */
        }

        .ins-widget-bubble {
            position: relative;
            background-color: #fff;
            border-radius: 15px;
            padding: 6px 10px;
            font-size: 12px; /* 气泡字体大小 */
            color: #333;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.07);
            max-width: 70%;
        }

        .ins-widget-row.user .ins-widget-bubble {
            margin-left: 12px;
        }

        .ins-widget-row.character .ins-widget-bubble {
            margin-right: 12px;
        }

        /* Bubble tail */
        .ins-widget-bubble::after {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
        }

        /* User bubble tail (left) */
        .ins-widget-row.user .ins-widget-bubble::after {
            top: 50%;
            left: -5.5px; /* 尾巴位置 */
            margin-top: -4px; /* 尾巴位置 */
            border-width: 4px 6px 4px 0; /* 尾巴大小 */
            border-color: transparent #fff transparent transparent;
        }

        /* Character bubble tail (right) */
        .ins-widget-row.character .ins-widget-bubble::after {
            top: 50%;
            right: -5.5px; /* 尾巴位置 */
            margin-top: -6px; /* 尾巴位置 */
            border-width: 6px 0 6px 8px; /* 尾巴大小 */
            border-color: transparent transparent transparent #fff;
        }

        .ins-widget-divider {
            width: 90%;
            text-align: center;
            border-bottom: 1.5px dashed  var(--text-color);
            line-height: 0.1em;
            margin: 12px 0;
        }

        .ins-widget-divider span {
            background: transparent;
            padding: 0 10px;
            color: var(--text-color);
            font-size: 14px;
            font-weight: bold;
        }
/* --- 世界书批量选择模式样式 --- */
#world-book-multi-select-bar {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
    border-top: 1px solid #eee;
    z-index: 20;
    animation: slideUp 0.3s ease-out;
}

.world-book-item.is-selecting {
    cursor: pointer;
}

.world-book-item.selected::after {
    content: '✓';
    position: absolute;
    top: 50%;
    left: 15px;
    transform: translateY(-50%);
    background-color: var(--primary-color);
    color: white;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: bold;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.world-book-item.selected {
    padding-left: 50px !important;
    background-color: #EBF5FF;
}


.collapsible-header .category-checkbox {
    margin-right: 15px;
    width: 20px;
    height: 20px;
    flex-shrink: 0;
}

.collapsible-header h4 {
    flex-grow: 1;
}

/* --- 新增：双语气泡样式 --- */
.bilingual-bubble {
    position: relative;
    /* padding-right: 35px; */ /* 移除为图标预留的内边距 */
    cursor: pointer;
}

.translation-text {
    font-size: 14px;
    color: #555;
    background-color: rgba(255, 255, 255, 0.7);
    padding: 4px 10px;
    margin-top: 5px;
    margin-left: 44px; /* 根据您的头像宽度(36px) + 气泡外边距(8px)调整 */
    margin-right: 8px;
    border-radius: 10px;
    max-width: calc(100% - 52px); /* 44px + 8px = 52px */
    display: none; /* 默认隐藏 */
    animation: fadeIn 0.3s ease;
    align-self: flex-start;
}

.message-wrapper.sent .translation-text {
    align-self: flex-end;
    margin-right: 44px; /* 根据您的头像宽度(36px) + 气泡外边距(8px)调整 */
    margin-left: 8px;
}

.translation-text.active {
    display: block; /* 点击后显示 */
}

/* --- 新增样式结束 --- */

        /* --- Update Log Modal Styles --- */
        #update-log-modal .modal-window {
            max-width: 380px;
            text-align: left;
        }

        #update-log-modal-content {
            max-height: 60vh;
            overflow-y: auto;
            padding: 15px 15px;
            margin: 15px 0;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
            background-color: #fcfcfc;
            border-radius: 8px;
        }

        #update-log-modal-content h4 {
            font-size: 16px;
            color: var(--primary-color);
            margin-top: 10px;
            margin-bottom: 8px;
        }

        #update-log-modal-content ul {
            list-style-type: none;
            padding-left: 5px;
            margin: 0;
        }

        #update-log-modal-content li {
            margin-bottom: 8px;
            line-height: 1.6;
            font-size: 14px;
            color: #555;
            position: relative;
            padding-left: 20px;
        }

        #update-log-modal-content li::before {
            content: '✨';
            position: absolute;
            left: 0;
            top: 2px;
            color: var(--accent-color);
        }
        


    </style>
</head>

<body>
<!-- 从这里body开始 -->
<svg width="0" height="0" style="position:absolute;">
  <defs>
    <clipPath id="heart-clip" clipPathUnits="objectBoundingBox">
      <path d="M0.5,1 C0.1,0.8,0,0.45,0.5,0.2 C1,0.45,0.9,0.8,0.5,1 Z" />
    </clipPath>
  </defs>
</svg>
<div class="phone-screen">
    <div id="home-screen" class="screen active"></div>
    <div id="chat-list-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="home-screen">‹</button>
            <div class="title-container">
                <h1 class="title">聊天</h1>
            </div>
            <div class="action-btn-group">
                <button class="action-btn" id="create-group-btn" title="群聊">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                </button>
                <button class="action-btn" id="import-character-card-btn" title="导入">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                </button>
                <button class="action-btn" id="add-chat-btn">+</button>
            </div>
        </header>
        <main class="content">
            <ul class="list-container" id="chat-list-container"></ul>
            <div class="placeholder-text" id="no-chats-placeholder" style="display: none;">
                <p>还没有聊天对象哦~</p>
                <p>点击右上角的“+”创建一个吧！</p>
            </div>
        </main>
    </div>
    
        <!-- 猫猫新增的设置页面开始 -->
    <div id="settings-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="home-screen">‹</button>
            <div class="title-container">
                <h1 class="title">设&nbsp;&nbsp;置</h1>
            </div>
            <div class="placeholder"></div>
        </header>
        <main class="content">
            <ul class="list-container settings-list">
                <li class="list-item" data-target="api-settings-screen">
                    <div class="setting-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-cloud">
                            <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
                        </svg>
                    </div>
                    <div class="item-details">
                        <span class="item-name">API&nbsp;设置</span>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right">
                      
                    </svg>
                </li>
                <li class="list-item" data-target="customize-screen">
                    <div class="setting-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-grid">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                    </div>
                    <div class="item-details">
                        <span class="item-name">主屏幕自定义</span>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right">
                        
                    </svg>
                </li>
                <li class="list-item" data-target="wallpaper-screen">
                    <div class="setting-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-image">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                    </div>
                    <div class="item-details">
                        <span class="item-name">更换壁纸</span>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right">
                        
                    </svg>
                </li>
                <li class="list-item" data-target="tutorial-screen">
                    <div class="setting-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-book-open">
                            <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                            <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                        </svg>
                    </div>
                    <div class="item-details">
                        <span class="item-name">教程与备份</span>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right">
                        
                    </svg>
                </li>
                <li class="list-item" data-target="font-settings-screen">
                    <div class="setting-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-type">
                            <polyline points="4 7 4 4 20 4 20 7"></polyline>
                            <line x1="9" y1="20" x2="15" y2="20"></line>
                            <line x1="12" y1="4" x2="12" y2="20"></line>
                        </svg>
                    </div>
                    <div class="item-details">
                        <span class="item-name">字体设置</span>
                    </div>
                     </li>
                  <li class="list-item" data-target="storage-analysis-screen">
                    <div class="setting-icon">
                        <svg class="storage-icon-alt" viewBox="0 0 24 24" fill="currentColor">
  <!-- 分析图表：主体部分 (75%) -->
  <path d="M11 13 L11 4 A9 9 0 1 0 20 13 Z"></path>
  
  <!-- 分析图表：分离切片 (25%) -->
  <path d="M13 11 L13 2 A9 9 0 0 1 22 11 Z"></path>
</svg>
                    </div>
                    <div class="item-details">
                        <span class="item-name">存储分析</span>
                    </div>
                     </li>
               <li class="list-item toggle-setting">
    <div class="setting-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-lightbulb">
            <path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"></path>
            <path d="M9 18h6"></path>
            <path d="M10 22h4"></path>
        </svg>
    </div>
    <div class="item-details">
        <span class="item-name">主题颜色</span>
    </div>
    <div class="setting-icon">
     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>   
    </div>
    <label class="switch">
        <input type="checkbox" id="dark-mode-toggle">
        <span class="slider round"></span>
    </label>
    <div class="setting-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
    </div>
</li>
            </ul>
        </main>
    </div>
    <!-- END OF NEW SETTINGS SCREEN CODE -->
    
    
    <div id="chat-room-screen" class="screen">
        <header class="app-header" id="chat-room-header-default">
            <button class="back-btn" data-target="chat-list-screen">‹</button>
            <div class="title-container">
                <h1 class="title" id="chat-room-title">...</h1>
                <div class="subtitle" id="chat-room-subtitle">
                    <div class="online-indicator"></div>
                    <span id="chat-room-status-text">在线</span>
                </div>
            </div>
            <div class="action-btn-group">
                <button class="action-btn" id="peek-btn">
                    <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
  <!-- 删除了 translate，增加了 scale，并微调位置使其居中 -->
  <path transform="scale(1.4) translate(0.5 0.5)" d="M3.654 1.328a.678.678 0 0 0-1.015-.063L1.605 2.3c-.483.484-.661 1.169-.45 1.77a17.568 17.568 0 0 0 4.168 6.608 17.569 17.569 0 0 0 6.608 4.168c.601.211 1.286.033 1.77-.45l1.034-1.034a.678.678 0 0 0-.063-1.015l-2.307-1.794a.678.678 0 0 0-.58-.122l-2.19.547a1.745 1.745 0 0 1-1.657-.459L5.482 8.062a1.745 1.745 0 0 1-.46-1.657l.548-2.19a.678.678 0 0 0-.122-.58L3.654 1.328zM1.83 1.83l.002-.001-.002.001z" fill="none" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
                </button>
                <button class="action-btn" id="chat-settings-btn"><svg viewBox="0 0 24 24" fill="currentColor">
                        <rect x="3" y="5" width="18" height="1.5" rx="0.75"/>
                        <rect x="3" y="11" width="18" height="1.5" rx="0.75"/>
                        <rect x="3" y="17" width="18" height="1.5" rx="0.75"/>
                    </svg></button>
            </div>
        </header>
        <header class="app-header" id="chat-room-header-select" style="display: none;">
            <button class="action-btn" id="cancel-multi-select-btn">取消</button>
            <div class="title-container">
                <h1 class="title" id="multi-select-title">选择消息</h1>
            </div>
            <div class="placeholder"></div>
        </header>
        <main class="content">
            <div class="message-area" id="message-area"></div>
            <div class="typing-indicator" id="typing-indicator"></div>
        </main>
        <div class="chat-input-wrapper">
        
                    <div id="reply-preview-bar">
                <div class="reply-preview-content">
                    <span class="reply-preview-name"></span>
                    <p class="reply-preview-text"></p>
                </div>
                <button id="cancel-reply-btn">×</button>
            </div>
            <div class="message-input-area" id="message-input-default">
                <input type="text" id="message-input" placeholder="输入消息...">
                <button id="send-message-btn" class="icon-btn send-btn">发送</button>
                <button id="get-reply-btn" class="icon-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M12,2A10,10 0 1,0 22,12A10,10 0 0,0 12,2M12,20A8,8 0 1,1 20,12A8,8 0 0,1 12,20M16.24,7.76C15.07,6.58 13.53,6 12,6V12L7.76,16.24C10.1,18.58 13.9,18.58 16.24,16.24C18.58,13.9 18.58,10.1 16.24,7.76Z"/>
                    </svg>
                </button>
            </div>
            <div id="sticker-bar">
                <button class="sticker-bar-btn" id="regenerate-btn" title="重回">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.65,6.35C16.2,4.9,14.21,4,12,4A8,8,0,0,0,4,12A8,8,0,0,0,12,20C15.73,20,18.84,17.45,19.73,14H17.65C16.83,16.33,14.61,18,12,18A6,6,0,0,1,6,12A6,6,0,0,1,12,6C13.66,6,15.14,6.69,16.22,7.78L13,11H20V4L17.65,6.35Z" />
                    </svg>
                </button>
                <button class="sticker-bar-btn" id="voice-message-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/>
                    </svg>
                </button>
                                <button class="sticker-bar-btn" id="image-recognition-btn">
                     <svg viewBox="0 0 24 24">
        <!-- 外框 -->
        <path d="M20,4H4C2.9,4,2,4.9,2,6v12c0,1.1,0.9,2,2,2h16c1.1,0,2-0.9,2-2V6C22,4.9,21.1,4,20,4z M20,18H4v-4.57l5.36-4.91l4.06,3.72l3.43-3.09L20,12.27V18z"/>
    </svg>
                </button>
                
                <button class="sticker-bar-btn" id="photo-video-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z"/>
                    </svg>
                </button> 
                                <button class="sticker-bar-btn" id="wallet-btn">
                    <svg viewBox="0 0 24 24">
        <!-- 钱包主体与信封盖 -->
        <path d="M20,4H4C2.9,4,2,4.9,2,6v12c0,1.1,0.9,2,2,2h16c1.1,0,2-0.9,2-2V6C22,4.9,21.1,4,20,4z M20,8l-8,5L4,8V6l8,5l8-5V8z"/>

    </svg>
                </button>             
                <button class="sticker-bar-btn" id="sticker-toggle-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/>
                    </svg>
                </button>             
               
                <button class="sticker-bar-btn" id="placeholder-plus-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                </button>
            </div>

        </div>
                       
        <div id="multi-select-bar"><span id="select-count">已选择 0 项</span>
            <button class="btn btn-danger" id="delete-selected-btn" style="width: auto; padding: 8px 16px;">删除已选
            </button>
        </div>
        <div id="sticker-modal">
            <div class="header">
                <span>我的表情</span>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-neutral btn-small" id="manage-stickers-btn">管理</button>
                    <button class="btn btn-primary btn-small" id="batch-add-sticker-btn" style="background-color: var(--accent-color);">批量导入</button>
                    <button class="btn btn-primary btn-small" id="add-new-sticker-btn">添加新表情</button>
                </div>
            </div>
            <div class="sticker-grid" id="sticker-grid-container"></div>
            <div id="sticker-manage-bar" style="display: none; padding: 10px; border-top: 1px solid #eee; background: #f7f7f7;">
                <button class="btn btn-danger" id="delete-selected-stickers-btn" style="width: 100%;">删除已选 (0)</button>
            </div>
        </div>
        <!-- NEW: Chat Expansion Panel -->
        <div id="chat-expansion-panel">
            <div class="sticker-grid" id="chat-expansion-grid">
                <!-- Items will be populated by JS -->
            </div>
        </div>
    </div>
    <div id="world-book-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="home-screen">‹</button>
            <div class="title-container">
                <h1 class="title">世界书</h1>
            </div>
            <div class="action-btn-group">
                <button class="action-btn" id="add-world-book-btn">+</button>
                <button class="action-btn" id="cancel-wb-multi-select-btn" style="display: none; font-size: 16px;">取消</button>
            </div>
        </header>
        <main class="content">
            <ul class="list-container" id="world-book-list-container"></ul>
            <div class="placeholder-text" id="no-world-books-placeholder" style="display: none;">
                <p>你的世界一片混沌...</p>
                <p>点击右上角的“+”创造第一个设定吧！</p>
            </div>
        </main>
        <div id="world-book-multi-select-bar" style="display: none;">
            <span id="world-book-select-count">已选择 0 项</span>
            <button class="btn btn-danger" id="delete-selected-world-books-btn" style="width: auto; padding: 8px 16px;">删除已选</button>
        </div>
    </div>
    <div id="edit-world-book-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="world-book-screen">‹</button>
            <div class="title-container">
                <h1 class="title" id="edit-world-book-title">创建/编辑条目</h1>
            </div>
            <div class="placeholder"></div>
        </header>
        <main class="content">
            <form id="edit-world-book-form">
                <input type="hidden" id="world-book-id">
                <div class="form-group">
                    <label for="world-book-name">条目名称</label>
                    <input type="text" id="world-book-name" placeholder="例如：世界观背景、魔法体系" required>
                </div>
                <div class="form-group">
                    <label for="world-book-category">条目分类</label>
                    <input type="text" id="world-book-category" placeholder="例如：人物、地点、组织（可选）">
                </div>
                <div class="form-group">
                    <label for="world-book-content">条目内容</label>
                    <textarea id="world-book-content" rows="8" placeholder="详细描述此项设定..." required></textarea>
                </div>
                <div class="form-group">
                    <label>注入位置</label>
                    <div class="form-group radio-group">
                        <label><input type="radio" name="world-book-position" value="before" checked> 前</label>
                        <label><input type="radio" name="world-book-position" value="after"> 后</label>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">保存条目</button>
            </form>
        </main>
    </div>
    
    <div id="api-settings-screen" class="screen"></div>
    <div id="wallpaper-screen" class="screen"></div>
    <div id="font-settings-screen" class="screen"></div>
    <div id="customize-screen" class="screen"></div>
    <div id="tutorial-screen" class="screen"></div>
    <div id="toast-notification" class="toast">
        <img class="toast-avatar" src="" alt="avatar">
        <div class="toast-content">
            <div class="toast-name"></div>
            <div class="toast-message"></div>
        </div>
    </div>
    <input type="file" id="image-upload-input" accept="image/*" style="display:none;">
    <!-- Message Edit Modal -->
    <div id="message-edit-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>编辑消息</h3>
            <form id="message-edit-form">
                <div class="form-group">
                    <textarea id="message-edit-textarea" rows="6" required></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">保存</button>
                    <button type="button" id="cancel-edit-modal-btn" class="btn btn-neutral" style="flex: 1;">取消</button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-char-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>创建新角色</h3>
            <form id="add-char-form">
                <div class="form-group">
                    <label for="char-real-name">角色姓名</label><input type="text" id="char-real-name"
                                                                       placeholder="角色的真实姓名" required>
                </div>
                <div class="form-group">
                    <label for="char-remark-name">角色备注 (昵称)</label><input type="text" id="char-remark-name"
                                                                                placeholder="你对Ta的称呼" required>
                </div>
                <div class="form-group">
                    <label for="my-name-for-char">我的姓名</label><input type="text" id="my-name-for-char"
                                                                         placeholder="你希望Ta如何称呼你" required>
                </div>
                <button type="submit" class="btn btn-primary">创建</button>
            </form>
        </div>
    </div>
    <div id="add-sticker-modal" class="modal-overlay">
        <div class="modal-window">
            <h3 id="add-sticker-modal-title">添加新表情</h3>
            <form id="add-sticker-form"><input type="hidden" id="sticker-edit-id">
                <div id="sticker-preview"><span>预览</span></div>
                <div class="form-group"><label for="sticker-name">表情名称</label><input type="text" id="sticker-name"
                                                                                         placeholder="如：开心" required>
                </div>
                <div class="form-group"><label for="sticker-url-input">表情URL</label><input type="url"
                                                                                             id="sticker-url-input"
                                                                                             placeholder="粘贴图片URL">
                </div>
                <p style="text-align:center; color:#888; margin: -10px 0 15px;">或</p><input type="file"
                                                                                             id="sticker-file-upload"
                                                                                             accept="image/*"
                                                                                             style="display:none;"><label
                        for="sticker-file-upload" class="btn btn-secondary" style="width:100%; margin-bottom: 20px;">从本地上传</label>
                <button type="submit" class="btn btn-primary">保存</button>
            </form>
        </div>
    </div>
    <div id="sticker-actionsheet" class="action-sheet-overlay">
        <div class="action-sheet">
            <button class="action-sheet-button" id="edit-sticker-btn">编辑</button>
            <button class="action-sheet-button danger" id="delete-sticker-btn">删除</button>
        </div>
    </div>
    <!-- Batch Add Sticker Modal -->
    <div id="batch-add-sticker-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>批量导入表情</h3>
            <form id="batch-add-sticker-form">
                <div class="form-group">
                    <label for="sticker-urls-textarea">数据格式：名称:URL (英文冒号，每行一个)</label>
                    <textarea id="sticker-urls-textarea" rows="8" placeholder="例如：&#10;开心:https://example.com/happy.gif&#10;哭泣:https://example.com/cry.png"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">开始导入</button>
            </form>
        </div>
    </div>
    <div id="send-voice-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>发送语音消息</h3>
            <form id="send-voice-form">
                <div class="form-group">
                    <label for="voice-text-input">输入语音文字</label>
                    <textarea id="voice-text-input" placeholder="在这里输入你想说的话..." required rows="4"></textarea>
                </div>
                <div class="form-group" style="text-align:center; color:#888; font-size: 14px;">
                    预计时长: <span id="voice-duration-preview">0"</span>
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <div id="send-pv-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>分享照片/视频</h3>
            <form id="send-pv-form">
                <div class="form-group">
                    <label for="pv-text-input">输入描述</label>
                    <textarea id="pv-text-input" placeholder="在这里描述你的照片或视频内容..." required
                              rows="4"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <div id="send-transfer-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>转账</h3>
            <form id="send-transfer-form">
                <div class="form-group">
                    <label for="transfer-amount-input">金额 (元)</label>
                    <input type="number" id="transfer-amount-input" placeholder="0.00" required step="0.01" min="0.01">
                </div>
                <div class="form-group">
                    <label for="transfer-remark-input">备注</label>
                    <input type="text" id="transfer-remark-input" placeholder="（选填）">
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <div id="send-gift-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>送出礼物</h3>
            <form id="send-gift-form">
                <div class="form-group">
                    <label for="gift-description-input">礼物描述</label>
                    <textarea id="gift-description-input" placeholder="告诉Ta你送了什么特别的东西..." required
                              rows="4"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <!-- NEW: Time Skip Modal -->
    <div id="time-skip-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>记录今天发生的事</h3>
            <form id="time-skip-form">
                <div class="form-group">
                    <label for="time-skip-input">事件描述 (该消息AI可见，会作为上下文)</label>
                    <textarea id="time-skip-input" placeholder="例如：我们一起去山顶看了日落，然后吃了烧烤。" required
                              rows="4"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <!-- NEW: Group Recipient Selection Modal -->
    <div id="group-recipient-selection-modal" class="modal-overlay">
        <div class="modal-window">
            <h3 id="group-recipient-selection-title">选择收件人</h3>
            <ul id="group-recipient-selection-list"></ul>
            <button class="btn btn-primary" id="confirm-group-recipient-btn" style="margin-top: 20px;">确认</button>
        </div>
    </div>
    <div id="receive-transfer-actionsheet" class="action-sheet-overlay">
        <div class="action-sheet">
            <button class="action-sheet-button" id="accept-transfer-btn">接收</button>
            <button class="action-sheet-button danger" id="return-transfer-btn">退回</button>
        </div>
    </div>
    <!-- Private Chat Settings -->
    <div id="chat-settings-sidebar" class="settings-sidebar">
        <div class="header">聊天设置</div>
        <div class="content">
            <form id="chat-settings-form">
                <div class="avatar-setting"><img src="" alt="角色头像" id="setting-char-avatar-preview"
                                                 class="avatar-preview"><input type="file"
                                                                               id="setting-char-avatar-upload"
                                                                               accept="image/*"
                                                                               style="display:none;"><label
                        for="setting-char-avatar-upload" class="btn btn-primary"
                        style="flex-grow:1;">更换角色头像</label></div>
                <div class="form-group"><label for="setting-char-remark">角色备注 (昵称)</label><input type="text"
                                                                                                       id="setting-char-remark">
                </div>
                <div class="form-group"><label for="setting-char-persona">角色人设</label><textarea
                        id="setting-char-persona" placeholder="详细描述角色的性格、背景、说话风格等。"></textarea></div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="avatar-setting"><img src="" alt="我的头像" id="setting-my-avatar-preview"
                                                 class="avatar-preview"><input type="file" id="setting-my-avatar-upload"
                                                                               accept="image/*"
                                                                               style="display:none;"><label
                        for="setting-my-avatar-upload" class="btn btn-secondary"
                        style="flex-grow:1;">更换我的头像</label></div>
                <div class="form-group"><label for="setting-my-name">我的姓名</label><input type="text"
                                                                                            id="setting-my-name"></div>
                <div class="form-group"><label for="setting-my-persona">我的人设</label><textarea
                        id="setting-my-persona" placeholder="描述你希望在对话中扮演的形象。"></textarea></div>
               <div class="panel panel-sm" style="padding:12px;border-radius:10px;border:1px solid var(--border-color,#e8e8ef);background:var(--panel-bg,#fff);box-shadow:var(--panel-shadow,0 4px 12px rgba(20,20,30,0.04));margin:10px 0;"><div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;"><label for="mypersona-preset-select" style="width:88px;color:var(--muted,#667);font-size:13px;">人设</label><select id="mypersona-preset-select" style="flex:1;padding:8px 10px;border-radius:8px;border:1px solid var(--input-border,#e6e6ea);background:var(--input-bg,#fff);font-size:14px;"><option value="">— 选择预设 —</option></select><button type="button" id="mypersona-apply-btn" class="btn btn-primary" style="margin-left:8px;padding:7px 10px;border-radius:8px;">应用</button></div><div style="display:flex;gap:8px;align-items:center;margin-bottom:6px;"><label style="width:88px;color:var(--muted,#667);font-size:13px;">外观操作</label><button type="button" id="mypersona-save-btn" class="btn" style="padding:7px 10px;border-radius:8px;">另存为</button><button type="button" id="mypersona-manage-btn" class="btn" style="padding:7px 10px;border-radius:8px;">管理</button></div></div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <button type="button" class="btn btn-secondary" id="link-world-book-btn">关联世界书</button>
                </div>
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #DAF0FC; border-radius: 10px; background-color: #F5FBFF;">
                    <label for="setting-bilingual-mode" style="margin-bottom: 0; color: var(--secondary-color); font-weight: 600;">双语聊天模式</label>
                    <input type="checkbox" id="setting-bilingual-mode" style="width: auto; height: 20px; width: 20px;">
                </div>                
                <div class="form-group"><label for="setting-theme-color">主题颜色 (对方/我方)</label><select
                        id="setting-theme-color"></select></div>

                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label for="setting-use-custom-css" style="margin-bottom:0;">自定义气泡样式</label>
                        <input type="checkbox" id="setting-use-custom-css" style="width: auto;">
                    </div>
                    <div id="private-bubble-css-preview" class="bubble-css-preview"
                         style="background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px;">
                    </div>
                    <textarea id="setting-custom-bubble-css" rows="6"
                              placeholder="在此输入CSS代码...&#10;例如：&#10;.message-bubble.sent { background-color: #A5D6A7; }&#10;.message-bubble.received { background-color: #E1E1E1; }"
                              disabled></textarea>
                    <button type="button" class="btn btn-neutral" id="reset-custom-bubble-css-btn"
                            style="margin-top: 10px; width: auto; padding: 5px 15px; font-size: 14px;">恢复默认
                    </button>
                </div>
               <div class="panel panel-sm" style="padding:12px;border-radius:10px;border:1px solid var(--border-color,#e8e8ef);background:var(--panel-bg,#fff);box-shadow:var(--panel-shadow,0 4px 12px rgba(20,20,30,0.04));margin:10px 0;"><div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;"><label for="bubble-preset-select" style="width:88px;color:var(--muted,#667);font-size:13px;">气泡</label><select id="bubble-preset-select" style="flex:1;padding:8px 10px;border-radius:8px;border:1px solid var(--input-border,#e6e6ea);background:var(--input-bg,#fff);font-size:14px;"><option value="">— 选择预设 —</option></select><button type="button" id="apply-preset-btn" class="btn btn-primary" style="margin-left:8px;padding:7px 10px;border-radius:8px;">应用</button></div><div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;"><label style="width:88px;color:var(--muted,#667);font-size:13px;">外观操作</label><button type="button" id="save-preset-btn" class="btn" style="padding:7px 10px;border-radius:8px;">另存为</button><button type="button" id="manage-presets-btn" class="btn" style="padding:7px 10px;border-radius:8px;">管理</button></div></div>
                <div class="form-group"><label for="setting-max-memory">最大记忆轮数</label><input type="number"
                                                                                                   id="setting-max-memory"
                                                                                                   value="10" min="1">
                </div>
                <div class="form-group"><label for="setting-chat-bg-upload" class="btn btn-primary">更换聊天背景</label><input
                        type="file" id="setting-chat-bg-upload" accept="image/*" style="display:none;"></div>
                <button type="submit" class="btn btn-primary">保存设置</button>
            </form>
            <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
            <button type="button" class="btn btn-danger" id="clear-chat-history-btn">清空聊天记录</button>
        </div>
    </div>
    <div id="world-book-selection-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>选择要关联的世界书</h3>
            <ul id="world-book-selection-list"></ul>
            <button class="btn btn-primary" id="save-world-book-selection-btn" style="margin-top: 20px;">确认</button>
        </div>
    </div>
    <!-- Global Pomodoro World Book Selection Modal -->
    <div id="global-pomodoro-world-book-selection-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>为全局专注设置关联世界书</h3>
            <ul id="global-pomodoro-world-book-selection-list" class="list-container" style="max-height: 40vh; overflow-y: auto; padding: 0; margin: 15px 0;">
                <!-- World book items will be rendered here -->
            </ul>
            <button class="btn btn-primary" id="save-global-pomodoro-world-book-selection-btn" style="margin-top: 20px;">确认</button>
        </div>
    </div>
    <!-- Group Chat Creation Modal -->
    <div id="create-group-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>创建群聊</h3>
            <form id="create-group-form">
                <div class="form-group">
                    <label>选择群成员</label>
                    <ul id="member-selection-list" class="member-selection-list"></ul>
                </div>
                <div class="form-group">
                    <label for="group-name-input">群聊名称</label>
                    <input type="text" id="group-name-input" placeholder="给你的群聊起个名字吧" required>
                </div>
                <button type="submit" class="btn btn-primary">创建群聊</button>
            </form>
        </div>
    </div>
    <!-- Group Chat Settings -->
    <div id="group-settings-sidebar" class="settings-sidebar">
        <div class="header">群聊设置</div>
        <div class="content">
            <form id="group-settings-form">
                <div class="group-avatar-setting">
                    <img src="" alt="群头像" id="setting-group-avatar-preview" class="group-avatar-preview">
                    <input type="file" id="setting-group-avatar-upload" accept="image/*" style="display:none;">
                    <label for="setting-group-avatar-upload" class="btn btn-primary"
                           style="flex-grow:1;">更换群头像</label>
                </div>
                <div class="form-group">
                    <label for="setting-group-name">群名 (AI也可见)</label>
                    <input type="text" id="setting-group-name">
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="avatar-setting">
                    <img src="" alt="我的头像" id="setting-group-my-avatar-preview" class="avatar-preview">
                    <input type="file" id="setting-group-my-avatar-upload" accept="image/*" style="display:none;">
                    <label for="setting-group-my-avatar-upload" class="btn btn-secondary"
                           style="flex-grow:1;">更换我的头像</label>
                </div>
                <div class="form-group">
                    <label for="setting-group-my-nickname">我的群昵称</label>
                    <input type="text" id="setting-group-my-nickname">
                </div>
                <div class="form-group">
                    <label for="setting-group-my-persona">我的人设</label>
                    <textarea id="setting-group-my-persona" placeholder="描述你希望在此群聊中扮演的形象。"></textarea>
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <label>群成员</label>
                    <div class="group-members-list" id="group-members-list-container"></div>
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <button type="button" class="btn btn-secondary" id="link-group-world-book-btn">关联世界书</button>
                </div>
                <div class="form-group"><label for="setting-group-theme-color">主题颜色 (对方/我方)</label><select
                        id="setting-group-theme-color"></select></div>

                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label for="setting-group-use-custom-css" style="margin-bottom:0;">自定义气泡样式</label>
                        <input type="checkbox" id="setting-group-use-custom-css" style="width: auto;">
                    </div>
                    <div id="group-bubble-css-preview" class="bubble-css-preview"
                         style="background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px;">
                    </div>
                    <textarea id="setting-group-custom-bubble-css" rows="6"
                              placeholder="在此输入CSS代码...&#10;例如：&#10;.message-bubble.sent { background-color: #A5D6A7; }&#10;.message-bubble.received { background-color: #E1E1E1; }"
                              disabled></textarea>
                    <button type="button" class="btn btn-neutral" id="reset-group-custom-bubble-css-btn"
                            style="margin-top: 10px; width: auto; padding: 5px 15px; font-size: 14px;">恢复默认
                    </button>
                </div>
                <div class="panel panel-sm" style="padding:12px;border-radius:10px;border:1px solid var(--border-color,#e8e8ef);background:var(--panel-bg,#fff);box-shadow:var(--panel-shadow,0 4px 12px rgba(20,20,30,0.04));margin:10px 0;"><div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;"><label for="group-bubble-preset-select" style="width:88px;color:var(--muted,#667);font-size:13px;">气泡预设</label><select id="group-bubble-preset-select" style="flex:1;padding:8px 10px;border-radius:8px;border:1px solid var(--input-border,#e6e6ea);background:var(--input-bg,#fff);font-size:14px;"><option value="">— 选择预设 —</option></select><button type="button" id="group-apply-preset-btn" class="btn btn-primary" style="margin-left:8px;padding:7px 10px;border-radius:8px;">应用</button></div><div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;"><label style="width:88px;color:var(--muted,#667);font-size:13px;">外观操作</label><button type="button" id="group-save-preset-btn" class="btn" style="padding:7px 10px;border-radius:8px;">另存为</button><button type="button" id="group-manage-presets-btn" class="btn" style="padding:7px 10px;border-radius:8px;">管理</button></div></div>
                <div class="form-group"><label for="setting-group-max-memory">最大记忆轮数</label><input type="number"
                                                                                                         id="setting-group-max-memory"
                                                                                                         value="10"
                                                                                                         min="1"></div>
                <div class="form-group"><label for="setting-group-chat-bg-upload"
                                               class="btn btn-primary">更换聊天背景</label><input type="file"
                                                                                                  id="setting-group-chat-bg-upload"
                                                                                                  accept="image/*"
                                                                                                  style="display:none;">
                </div>
                <button type="submit" class="btn btn-primary">保存设置</button>
            </form>
            <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
            <button type="button" class="btn btn-danger" id="clear-group-chat-history-btn">清空聊天记录</button>
        </div>
    </div>
    <!-- Group Member Edit Modal -->
    <div id="edit-group-member-modal" class="modal-overlay">
        <div class="modal-window">
            <h3 id="edit-group-member-title">编辑群成员</h3>
            <form id="edit-group-member-form">
                <input type="hidden" id="editing-member-id">
                <div class="avatar-setting" style="justify-content: center;">
                    <img src="" alt="成员头像" id="edit-member-avatar-preview" class="avatar-preview"
                         style="cursor: pointer;">
                    <input type="file" id="edit-member-avatar-upload" accept="image/*" style="display:none;">
                </div>
                <div class="form-group">
                    <label for="edit-member-group-nickname">群昵称</label>
                    <input type="text" id="edit-member-group-nickname" required>
                </div>
                <div class="form-group">
                    <label for="edit-member-real-name">真名</label>
                    <input type="text" id="edit-member-real-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-member-persona">人设</label>
                    <textarea id="edit-member-persona" placeholder="详细描述角色的性格、背景等。"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">保存</button>
            </form>
        </div>
    </div>
    <!-- Add Member to Group Action Sheet -->
    <div id="add-member-actionsheet" class="action-sheet-overlay">
        <div class="action-sheet">
            <button class="action-sheet-button" id="invite-existing-member-btn">邀请现有角色</button>
            <button class="action-sheet-button" id="create-new-member-btn">创建新角色入群</button>
        </div>
    </div>
    <!-- Invite Existing Member Modal -->
    <div id="invite-member-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>邀请成员加入群聊</h3>
            <ul id="invite-member-selection-list"></ul>
            <button class="btn btn-primary" id="confirm-invite-btn" style="margin-top: 20px;">确认邀请</button>
        </div>
    </div>
    <!-- Create New Member for Group Modal -->
    <div id="create-member-for-group-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>创建新角色并加入群聊</h3>
            <form id="create-member-for-group-form">
                <div class="avatar-setting" style="justify-content: center;">
                    <img src="https://i.postimg.cc/Y96LPskq/o-o-2.jpg" alt="新成员头像"
                         id="create-group-member-avatar-preview" class="avatar-preview" style="cursor: pointer;">
                    <input type="file" id="create-group-member-avatar-upload" accept="image/*" style="display:none;">
                </div>
                <div class="form-group">
                    <label for="create-group-member-nickname">群昵称</label>
                    <input type="text" id="create-group-member-nickname" required>
                </div>
                <div class="form-group">
                    <label for="create-group-member-realname">真名</label>
                    <input type="text" id="create-group-member-realname" required>
                </div>
                <div class="form-group">
                    <label for="create-group-member-persona">人设</label>
                    <textarea id="create-group-member-persona" placeholder="详细描述角色的性格、背景等。"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">创建并加入</button>
            </form>
        </div>
    </div>
    <!-- Memory Journal Screen -->
    <div id="memory-journal-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="chat-room-screen">‹</button>
            <div class="title-container">
                <h1 class="title">回忆日记</h1>
            </div>
            <div class="action-btn-group">
                <button class="action-btn" id="bind-journal-worldbook-btn" title="绑定世界书">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                        <path d="M17 7h-4v2h4c1.65 0 3 1.35 3 3s-1.35 3-3 3h-4v2h4c2.76 0 5-2.24 5-5s-2.24-5-5-5zm-6 8H7c-1.65 0-3-1.35-3-3s1.35-3 3-3h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-2zm-3-4h8v2H8v-2z"></path>
                    </svg>
                </button>
                <button class="action-btn" id="generate-new-journal-btn" title="生成新日记">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path>
                    </svg>
                </button>
            </div>
        </header>
        <main class="content">
            <ul class="list-container" id="journal-list-container">
                <!-- Journal cards will be rendered here -->
            </ul>
            <div class="placeholder-text" id="no-journals-placeholder" style="display: none;">
                <p>还没有日记哦~</p>
                <p>点击右上角的“+号”来创建第一篇吧！</p>
            </div>
        </main>
    </div>

    <!-- Memory Journal Detail Screen -->
    <div id="memory-journal-detail-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="memory-journal-screen">‹</button>
            <div class="title-container">
                <h1 class="title">日记详情</h1>
            </div>
            <button class="action-btn" id="edit-journal-detail-btn">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z" /></svg>
            </button>
        </header>
        <main class="content" style="padding: 20px; font-family: 'Georgia', 'Times New Roman', serif;">
            <h2 id="journal-detail-title" style="margin-top: 0; font-size: 22px;"></h2>
            <p id="journal-detail-meta" style="font-size: 12px; color: #aaa; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;"></p>
            <div id="journal-detail-content" style="line-height: 1.7; white-space: pre-wrap; font-size: 16px;"></div>
        </main>
    </div>

    <!-- Peek Steps App Screen -->
    <div id="peek-steps-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="peek-screen">‹</button>
            <div class="title-container">
                <h1 class="title">步数</h1>
            </div>
            <div class="placeholder"></div> <!-- To balance the header -->
        </header>
        <main class="content">
            <div class="steps-header">
                <img src="https://i.postimg.cc/Y96LPskq/o-o-2.jpg" alt="Char Avatar" class="steps-header-avatar" id="steps-char-avatar">
                <span class="steps-header-name" id="steps-char-name">Char</span>
            </div>

            <div class="steps-progress-container">
                <div class="steps-progress-circle" id="steps-progress-ring"></div>
                <div class="steps-progress-inner">
                    <div class="steps-count" id="steps-current-count">4321</div>
                    <div class="steps-label">/ 6000 步</div>
                </div>
            </div>

            <div class="steps-module">
                <h3 class="steps-module-title">最近活动轨迹</h3>
                <ul class="activity-track-list" id="activity-track-list">
                    <li class="activity-track-item">10:00 AM - 咖啡馆</li>
                    <li class="activity-track-item">01:30 PM - 市中心图书馆</li>
                    <li class="activity-track-item">06:00 PM - 河边公园</li>
                    <li class="activity-track-item">07:00 PM - 健身房</li>
                    <li class="activity-track-item">08:30 PM - 超市</li>
                    <li class="activity-track-item">09:00 PM - 回家</li>
                </ul>
            </div>
            <div class="steps-annotation" id="steps-annotation-content">
                “今天走了不少路，但感觉很充实。特别是下午在图书馆找到的那本书，感觉能看很久。”
            </div>
        </main>
    </div>

    <div id="peek-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="chat-room-screen">‹</button>
            <div class="title-container">
                <h1 class="title">Ta的手机</h1>
            </div>
            <button class="action-btn" id="peek-settings-btn"><svg viewBox="0 0 24 24" fill="currentColor">
                        <rect x="3" y="5" width="18" height="1.5" rx="0.75"/>
                        <rect x="3" y="11" width="18" height="1.5" rx="0.75"/>
                        <rect x="3" y="17" width="18" height="1.5" rx="0.75"/>
                    </svg></button>
        </header>
        <main class="content" style="padding: 50px 0; justify-content: flex-start; align-items: center;">
            <!-- Content rendered by renderPeekScreen() -->
        </main>
    </div>

 <!-- 1. 发现页 (Forum Home) -->
<div id="forum-screen" class="screen">
    <!-- Header: 只有返回和标题 -->
    <header class="app-header">
        <button class="back-btn" data-target="home-screen">‹</button>
        <div class="title-container">
            <h1 class="title">喵 坛</h1>
        </div>
        <!-- 右侧留空，保持标题居中 -->
        <div style="width: 40px;"></div>
    </header>

    <!-- 顶部搜索栏 (包含发帖按钮) -->
    <div class="forum-top-search-bar">
        <input type="text" id="forum-search-input" placeholder="搜索关键词...">
        <button class="action-btn" id="forum-refresh-btn" title="搜索/刷新">
             <svg viewBox="0 0 24 24" fill="none" width="22" height="22" xmlns="http://www.w3.org/2000/svg">
<path d="M15.7955 15.8111L21 21M18 10.5C18 14.6421 14.6421 18 10.5 18C6.35786 18 3 14.6421 3 10.5C3 6.35786 6.35786 3 10.5 3C14.6421 3 18 6.35786 18 10.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
        </button>
        <button class="action-btn" id="forum-create-btn" title="发布新帖">
            <svg viewBox="0 0 24 24" fill="currentColor" width="22" height="22">
                <path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" />
            </svg>
        </button>
    </div>

    <!-- Main 内容区域 -->
   <main class="content forum-content-area">
   <!-- 新增：热帖模块 -->
<div id="hot-posts-section" class="hot-posts-section" style="display:none;">
    <!-- 修改：header 增加 inner-wrapper 用于控制下划线长度 -->
    <div class="hot-posts-header">
        <span class="header-content-wrapper">
            <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20" xmlns="http://www.w3.org/2000/svg">
<path d="M12.8324 21.8013C15.9583 21.1747 20 18.926 20 13.1112C20 7.8196 16.1267 4.29593 13.3415 2.67685C12.7235 2.31757 12 2.79006 12 3.50492V5.3334C12 6.77526 11.3938 9.40711 9.70932 10.5018C8.84932 11.0607 7.92052 10.2242 7.816 9.20388L7.73017 8.36604C7.6304 7.39203 6.63841 6.80075 5.85996 7.3946C4.46147 8.46144 3 10.3296 3 13.1112C3 20.2223 8.28889 22.0001 10.9333 22.0001C11.0871 22.0001 11.2488 21.9955 11.4171 21.9858C10.1113 21.8742 8 21.064 8 18.4442C8 16.3949 9.49507 15.0085 10.631 14.3346C10.9365 14.1533 11.2941 14.3887 11.2941 14.7439V15.3331C11.2941 15.784 11.4685 16.4889 11.8836 16.9714C12.3534 17.5174 13.0429 16.9454 13.0985 16.2273C13.1161 16.0008 13.3439 15.8564 13.5401 15.9711C14.1814 16.3459 15 17.1465 15 18.4442C15 20.4922 13.871 21.4343 12.8324 21.8013Z" fill="currentColor"/>
</svg>
            <span>Hot！</span>
        </span>
    </div>
    <div id="hot-posts-list" class="hot-posts-list">
        <!-- JS 生成热帖 -->
    </div>
</div>

    <div id="forum-posts-container">
        <!-- 普通帖子列表 -->
    </div>
</main>

    <!-- 底部导航栏 -->
<!-- 底部导航栏 (发现页 - 发现高亮) -->
<!-- 这是一个通用的底部导航栏模板，请在 forum-screen, world-screen, favorites-screen, me-screen 中同步替换 -->
<nav class="bottom-tab-bar">
    <div class="tab-item active" data-target="forum-screen">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<!-- 添加了一个分组 <g>，并应用了缩放和平移 -->
<!-- scale(0.8) 表示缩小到80% -->
<!-- translate(2.4, 2.4) 是为了让缩放后的图标重新居中 ((24 - 24*0.8)/2 = 2.4) -->
<g transform="translate(1.2, 1.2) scale(0.9)">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M13.9931 3.43368C12.8564 2.42331 11.1436 2.42331 10.0069 3.43368L2.33565 10.2526C1.92286 10.6195 1.88568 11.2516 2.2526 11.6644C2.61952 12.0771 3.25159 12.1143 3.66437 11.7474L4.00001 11.4491L4.00001 17.0658C3.99996 17.9523 3.99992 18.7161 4.08215 19.3278C4.17028 19.9833 4.36903 20.6117 4.87869 21.1213C5.38835 21.631 6.0167 21.8297 6.67222 21.9179C7.28388 22.0001 8.04769 22 8.93418 22H15.0658C15.9523 22 16.7161 22.0001 17.3278 21.9179C17.9833 21.8297 18.6117 21.631 19.1213 21.1213C19.631 20.6117 19.8297 19.9833 19.9179 19.3278C20.0001 18.7161 20.0001 17.9523 20 17.0659L20 11.4491L20.3356 11.7474C20.7484 12.1143 21.3805 12.0771 21.7474 11.6644C22.1143 11.2516 22.0772 10.6195 21.6644 10.2526L13.9931 3.43368ZM12 16C11.4477 16 11 16.4477 11 17V19C11 19.5523 10.5523 20 10 20C9.44772 20 9 19.5523 9 19V17C9 15.3431 10.3431 14 12 14C13.6569 14 15 15.3431 15 17V19C15 19.5523 14.5523 20 14 20C13.4477 20 13 19.5523 13 19V17C13 16.4477 12.5523 16 12 16Z" fill="currentColor"/>
</g>
</svg>
        <span>主页</span>
    </div>
    <div class="tab-item" data-target="world-screen">
         <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 20C16.4183 20 20 16.4183 20 12C20 11.8805 19.9974 11.7615 19.9922 11.6433C20.2479 11.4141 20.4882 11.1864 20.7118 10.9611C21.0037 10.6672 21.002 10.1923 20.708 9.90049C20.4336 9.628 20.0014 9.61143 19.7077 9.84972C19.4023 8.75248 18.8688 7.75024 18.1616 6.89725C18.4607 6.84611 18.7436 6.8084 19.0087 6.784C19.4212 6.74604 19.7247 6.38089 19.6868 5.96842C19.6488 5.55595 19.2837 5.25235 18.8712 5.29032C18.4474 5.32932 17.9972 5.39638 17.5262 5.48921C17.3267 5.52851 17.1614 5.64353 17.0543 5.79852C15.6765 4.67424 13.917 4 12 4C7.58172 4 4 7.58172 4 12C4 12.2776 4.01414 12.552 4.04175 12.8223C3.78987 12.7532 3.50899 12.8177 3.31137 13.0159C2.97651 13.3517 2.67596 13.6846 2.415 14.0113C2.15647 14.3349 2.20924 14.8069 2.53287 15.0654C2.8565 15.3239 3.32843 15.2711 3.58696 14.9475C3.78866 14.695 4.02466 14.4302 4.2938 14.1557C4.60754 15.2796 5.16056 16.3037 5.8945 17.1697C5.66824 17.3368 5.54578 17.6248 5.60398 17.919C5.68437 18.3253 6.07894 18.5896 6.48528 18.5092C6.7024 18.4662 6.92455 18.4177 7.15125 18.3637C8.49656 19.3903 10.1771 20 12 20ZM7.15125 18.3637C6.69042 18.012 6.26891 17.6114 5.8945 17.1697C5.98073 17.106 6.08204 17.0599 6.19417 17.0377C7.19089 16.8405 8.33112 16.5084 9.55581 16.0486C9.94359 15.903 10.376 16.0994 10.5216 16.4872C10.6671 16.8749 10.4708 17.3073 10.083 17.4529C9.05325 17.8395 8.0653 18.1459 7.15125 18.3637ZM19.7077 9.84972C19.6869 9.86663 19.6667 9.88483 19.6474 9.90431C18.9609 10.5957 18.0797 11.3337 17.0388 12.0753C16.7014 12.3157 16.6228 12.784 16.8631 13.1213C17.1035 13.4587 17.5718 13.5373 17.9091 13.297C18.6809 12.7471 19.3806 12.1912 19.9922 11.6433C19.965 11.0246 19.8676 10.4241 19.7077 9.84972ZM20.9366 5.37924C20.5336 5.28378 20.1294 5.53313 20.034 5.93619C19.9385 6.33925 20.1879 6.74339 20.5909 6.83886C20.985 6.93219 21.1368 7.07125 21.1932 7.16142C21.2565 7.26269 21.3262 7.52732 21.0363 8.10938C20.8516 8.48014 21.0025 8.93042 21.3732 9.1151C21.744 9.29979 22.1943 9.14894 22.379 8.77818C22.7566 8.02003 22.9422 7.12886 22.4648 6.36582C22.1206 5.81574 21.5416 5.52252 20.9366 5.37924ZM2.81481 16.2501C2.94057 15.8555 2.72259 15.4336 2.32793 15.3078C1.93327 15.1821 1.51138 15.4 1.38562 15.7947C1.19392 16.3963 1.17354 17.0573 1.53488 17.6349C1.98775 18.3587 2.84153 18.6413 3.68907 18.7224C4.1014 18.7619 4.46765 18.4596 4.50712 18.0473C4.54658 17.635 4.24432 17.2687 3.83199 17.2293C3.13763 17.1628 2.88355 16.9624 2.80651 16.8393C2.75679 16.7598 2.70479 16.5954 2.81481 16.2501ZM15.7504 14.704C16.106 14.4915 16.2218 14.0309 16.0093 13.6754C15.7967 13.3199 15.3362 13.204 14.9807 13.4166C14.4991 13.7045 13.9974 13.9881 13.4781 14.2648C12.9445 14.5491 12.4132 14.8149 11.8883 15.0615C11.5134 15.2376 11.3522 15.6843 11.5283 16.0592C11.7044 16.4341 12.1511 16.5953 12.526 16.4192C13.0739 16.1618 13.6277 15.8847 14.1834 15.5887C14.7242 15.3005 15.2474 15.0048 15.7504 14.704Z" fill="currentColor"/></svg>
        <span>世界</span>
    </div>
    <!-- 新增：收藏 Tab -->
    <div class="tab-item" data-target="favorites-screen">
        <svg viewBox="0 0 24 24"  xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M10.5766 8.70419C11.2099 7.56806 11.5266 7 12 7C12.4734 7 12.7901 7.56806 13.4234 8.70419L13.5873 8.99812C13.7672 9.32097 13.8572 9.48239 13.9975 9.5889C14.1378 9.69541 14.3126 9.73495 14.6621 9.81402L14.9802 9.88601C16.2101 10.1643 16.825 10.3034 16.9713 10.7739C17.1176 11.2443 16.6984 11.7345 15.86 12.715L15.643 12.9686C15.4048 13.2472 15.2857 13.3865 15.2321 13.5589C15.1785 13.7312 15.1965 13.9171 15.2325 14.2888L15.2653 14.6272C15.3921 15.9353 15.4554 16.5894 15.0724 16.8801C14.6894 17.1709 14.1137 16.9058 12.9622 16.3756L12.6643 16.2384C12.337 16.0878 12.1734 16.0124 12 16.0124C11.8266 16.0124 11.663 16.0878 11.3357 16.2384L11.0378 16.3756C9.88634 16.9058 9.31059 17.1709 8.92757 16.8801C8.54456 16.5894 8.60794 15.9353 8.7347 14.6272L8.76749 14.2888C8.80351 13.9171 8.82152 13.7312 8.76793 13.5589C8.71434 13.3865 8.59521 13.2472 8.35696 12.9686L8.14005 12.715C7.30162 11.7345 6.88241 11.2443 7.02871 10.7739C7.17501 10.3034 7.78993 10.1643 9.01977 9.88601L9.33794 9.81402C9.68743 9.73495 9.86217 9.69541 10.0025 9.5889C10.1428 9.48239 10.2328 9.32097 10.4127 8.99812L10.5766 8.70419ZM12 1.25C12.4142 1.25 12.75 1.58579 12.75 2V4C12.75 4.41421 12.4142 4.75 12 4.75C11.5858 4.75 11.25 4.41421 11.25 4V2C11.25 1.58579 11.5858 1.25 12 1.25ZM18.5304 5.46955C18.8233 5.76245 18.8233 6.23732 18.5304 6.53021L18.1872 6.87348C17.8943 7.16637 17.4194 7.16637 17.1265 6.87348C16.8336 6.58058 16.8336 6.10571 17.1265 5.81282L17.4698 5.46955C17.7627 5.17666 18.2376 5.17666 18.5304 5.46955ZM5.46967 5.46967C5.76256 5.17678 6.23744 5.17678 6.53033 5.46967L6.87359 5.81293C7.16648 6.10582 7.16648 6.5807 6.87359 6.87359C6.5807 7.16648 6.10582 7.16648 5.81293 6.87359L5.46967 6.53033C5.17678 6.23744 5.17678 5.76256 5.46967 5.46967ZM1.25 12C1.25 11.5858 1.58579 11.25 2 11.25H4C4.41421 11.25 4.75 11.5858 4.75 12C4.75 12.4142 4.41421 12.75 4 12.75H2C1.58579 12.75 1.25 12.4142 1.25 12ZM19.25 12C19.25 11.5858 19.5858 11.25 20 11.25H22C22.4142 11.25 22.75 11.5858 22.75 12C22.75 12.4142 22.4142 12.75 22 12.75H20C19.5858 12.75 19.25 12.4142 19.25 12ZM6.87348 17.1265C7.16637 17.4194 7.16637 17.8943 6.87348 18.1872L6.53043 18.5302C6.23754 18.8231 5.76266 18.8231 5.46977 18.5302C5.17688 18.2373 5.17688 17.7625 5.46977 17.4696L5.81282 17.1265C6.10571 16.8336 6.58058 16.8336 6.87348 17.1265ZM17.1265 17.1267C17.4194 16.8339 17.8943 16.8339 18.1872 17.1267L18.5302 17.4698C18.8231 17.7627 18.8231 18.2376 18.5302 18.5305C18.2373 18.8233 17.7624 18.8233 17.4695 18.5305L17.1265 18.1874C16.8336 17.8945 16.8336 17.4196 17.1265 17.1267ZM12 19.25C12.4142 19.25 12.75 19.5858 12.75 20V22C12.75 22.4142 12.4142 22.75 12 22.75C11.5858 22.75 11.25 22.4142 11.25 22V20C11.25 19.5858 11.5858 19.25 12 19.25Z" fill="currentColor"/></svg>
        <span>收藏</span>
    </div>
    <div class="tab-item" data-target="me-screen">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M11.7501 6.40636C10.2698 6.40636 10.1222 6.5625 9.3561 6.5625C8.71769 6.5625 6.80245 5 5.84485 5C4.88724 5 3.77004 5.5625 3.77004 7.1875V9.0625C3.77197 9.55469 3.95081 11.0634 4.65075 10.6602C3.82323 11.6382 3.73963 12.7786 3.751 13.8826C3.52812 13.947 3.30072 14.0196 3.08003 14.095C2.39614 14.3289 1.67085 14.6271 1.3432 14.8387C0.995241 15.0634 0.895339 15.5277 1.12006 15.8756C1.34478 16.2236 1.80903 16.3235 2.15698 16.0988C2.3132 15.9979 2.87823 15.7493 3.56532 15.5144C3.64124 15.4884 3.71731 15.4631 3.79298 15.4386C3.83925 15.8724 3.95408 16.2684 4.12478 16.6292L4.1012 16.6416C3.69148 16.8581 3.3113 17.1067 3.06889 17.2652C3.02694 17.2926 2.98912 17.3173 2.95599 17.3387C2.60803 17.5634 2.50813 18.0277 2.73285 18.3756C2.95757 18.7236 3.42182 18.8235 3.76978 18.5988C3.8109 18.5722 3.85472 18.5436 3.90097 18.5134C4.1463 18.3533 4.45999 18.1485 4.80199 17.9678C4.88218 17.9254 4.95935 17.887 5.03317 17.8524C6.76347 19.4748 9.86991 20 11.7501 20C13.6302 20 16.7367 19.4748 18.467 17.8524C18.5408 17.887 18.6179 17.9254 18.6981 17.9678C19.0401 18.1485 19.3538 18.3533 19.5991 18.5134C19.6454 18.5436 19.6892 18.5722 19.7303 18.5988C20.0783 18.8235 20.5425 18.7236 20.7673 18.3756C20.992 18.0277 20.8921 17.5634 20.5441 17.3387C20.511 17.3173 20.4732 17.2926 20.4312 17.2652C20.1888 17.1067 19.8086 16.8581 19.3989 16.6416L19.3754 16.6292C19.5461 16.2683 19.6609 15.8724 19.7072 15.4385C19.783 15.463 19.8592 15.4883 19.9352 15.5144C20.6223 15.7493 21.1874 15.9979 21.3436 16.0988C21.6915 16.3235 22.1558 16.2236 22.3805 15.8756C22.6052 15.5277 22.5053 15.0634 22.1574 14.8387C21.8297 14.6271 21.1044 14.3289 20.4205 14.095C20.1997 14.0195 19.9722 13.947 19.7492 13.8825C19.7605 12.7785 19.6769 11.6382 18.8494 10.6602C19.5494 11.0634 19.7282 9.55469 19.7302 9.0625V7.18761C19.7302 5.56261 18.6129 5.00011 17.6553 5.00011C16.6977 5.00011 14.7825 6.5625 14.1441 6.5625C13.378 6.5625 13.2305 6.40636 11.7501 6.40636ZM13.9201 12.5005C14.0566 12.2721 14.326 12 14.7301 12C15.1342 12 15.4036 12.2721 15.54 12.5005C15.6823 12.7387 15.7501 13.0274 15.7501 13.3125C15.7501 13.5976 15.6823 13.8863 15.54 14.1245C15.4036 14.3529 15.1342 14.625 14.7301 14.625C14.326 14.625 14.0566 14.3529 13.9201 14.1245C13.7778 13.8863 13.7101 13.5976 13.7101 13.3125C13.7101 13.0274 13.7778 12.7387 13.9201 12.5005ZM7.96016 12.5005C8.09658 12.2721 8.36599 12 8.7701 12C9.17421 12 9.44362 12.2721 9.58004 12.5005C9.72234 12.7387 9.79011 13.0274 9.79011 13.3125C9.79011 13.5976 9.72234 13.8863 9.58004 14.1245C9.44362 14.3529 9.17421 14.625 8.7701 14.625C8.36599 14.625 8.09658 14.3529 7.96016 14.1245C7.81786 13.8863 7.75009 13.5976 7.75009 13.3125C7.75009 13.0274 7.81786 12.7387 7.96016 12.5005Z" fill="currentColor"/></svg>
        <span>我</span>
    </div>
</nav>
</div>


<!-- 2. 世界页 (World Settings) -->
<div id="world-screen" class="screen">
    <header class="app-header">
        <!-- 新增：返回按钮，指向 forum-screen -->
        <button class="back-btn" data-target="forum-screen">‹</button>
        
        <div class="title-container"><h1 class="title">世 界</h1></div>
        
        <!-- 右侧保存按钮保持不变 -->
        <button class="action-btn" id="world-save-btn" title="保存设置">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M12 22C7.28595 22 4.92893 22 3.46447 20.5355C2 19.0711 2 16.714 2 12C2 7.28595 2 4.92893 3.46447 3.46447C4.92893 2 7.28595 2 12 2C12.3415 2 12.5122 2 12.6858 2.01515C13.4951 2.08581 14.2874 2.414 14.9097 2.93631C15.0431 3.04834 15.1668 3.17204 15.4142 3.41938L20.5806 8.58578C20.828 8.83317 20.9516 8.95687 21.0637 9.09034C21.586 9.71257 21.9142 10.5049 21.9848 11.3142C22 11.4878 22 11.6585 22 12C22 16.714 22 19.0711 20.5355 20.5355C19.0711 22 16.714 22 12 22ZM8.60982 13.0384C8.80302 13 9.03535 13 9.5 13H14.5C14.9647 13 15.197 13 15.3902 13.0384C16.1836 13.1962 16.8038 13.8164 16.9616 14.6098C17 14.803 17 15.0353 17 15.5C17 15.9647 17 16.197 16.9616 16.3902C16.8038 17.1836 16.1836 17.8038 15.3902 17.9616C15.197 18 14.9647 18 14.5 18H9.5C9.03535 18 8.80302 18 8.60982 17.9616C7.81644 17.8038 7.19624 17.1836 7.03843 16.3902C7 16.197 7 15.9647 7 15.5C7 15.0353 7 14.803 7.03843 14.6098C7.19624 13.8164 7.81644 13.1962 8.60982 13.0384Z" fill="currentColor"/></svg>
        </button>
    </header>

    <!-- 2. 新布局：侧边栏 + 内容区 -->
    <main class="content tab-content-area">
        <!-- 侧边栏：角色在上，世界书在下 -->
        <div class="world-sidebar">
            <!-- 1. 角色按钮 (默认激活 active) -->
            <button class="world-sidebar-btn active" data-tab="char">
                <svg viewBox="0 0 24 24"><path d="M12,5.5A3.5,3.5 0 0,1 15.5,9A3.5,3.5 0 0,1 12,12.5A3.5,3.5 0 0,1 8.5,9A3.5,3.5 0 0,1 12,5.5M5,8C5.56,8 6.08,8.15 6.53,8.42C6.38,9.85 6.8,11.27 7.66,12.38C7.16,13.34 6.16,14 5,14A3,3 0 0,1 2,11A3,3 0 0,1 5,8M19,8A3,3 0 0,1 22,11A3,3 0 0,1 19,14C17.84,14 16.84,13.34 16.34,12.38C17.2,11.27 17.62,9.85 17.47,8.42C17.92,8.15 18.44,8 19,8M5.5,18.25C5.5,16.18 8.41,14.5 12,14.5C15.59,14.5 18.5,16.18 18.5,18.25V20H5.5V18.25M0,20V18.5C0,17.11 1.89,15.94 4.45,15.6C3.86,16.28 3.5,17.22 3.5,18.25V20H0M24,20H20.5V18.25C20.5,17.22 20.14,16.28 19.55,15.6C22.11,15.94 24,17.11 24,18.5V20Z" /></svg>
                <span>角色</span>
            </button>
            
            <!-- 2. 世界书按钮 -->
            <button class="world-sidebar-btn" data-tab="wb">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M4 5V19C4 20.6569 5.34315 22 7 22H17C18.6569 22 20 20.6569 20 19V9C20 7.34315 18.6569 6 17 6H5C4.44772 6 4 5.55228 4 5ZM7.25 12C7.25 11.5858 7.58579 11.25 8 11.25H16C16.4142 11.25 16.75 11.5858 16.75 12C16.75 12.4142 16.4142 12.75 16 12.75H8C7.58579 12.75 7.25 12.4142 7.25 12ZM7.25 15.5C7.25 15.0858 7.58579 14.75 8 14.75H13.5C13.9142 14.75 14.25 15.0858 14.25 15.5C14.25 15.9142 13.9142 16.25 13.5 16.25H8C7.58579 16.25 7.25 15.9142 7.25 15.5Z" fill="currentColor"/>
<path d="M4.40879 4.0871C4.75727 4.24338 5 4.59334 5 5H17C17.3453 5 17.6804 5.04375 18 5.12602V4.30604C18 3.08894 16.922 2.15402 15.7172 2.32614L4.91959 3.86865C4.72712 3.89615 4.55271 3.97374 4.40879 4.0871Z" fill="currentColor"/>
</svg>
                <span>世界书</span>
            </button>
        </div>
        
        <div class="world-content-wrapper">
            <p style="font-size: 14px; color: #888; margin-bottom: 10px; line-height:1.4;">
                <span style="color:var(--primary-color)">提示：</span>勾选后请点击右上角保存。
            </p>

            <!-- Tab 1: 角色 (默认显示 active) -->
            <!-- Tab 1: 角色 -->
<div id="world-tab-char" class="world-tab-pane active">
    <div class="setting-row">
        <div style="display:flex; flex-direction:column;">
            <span style="font-size:14px; font-weight:600; color:#333;">关联角色聊天记忆</span>
            <span style="font-size:11px; color:#999;">开启后 AI 将读取该角色的历史聊天</span>
        </div>
        <div style="display: flex; align-items: center;">
            <!-- 修改：开关在前，输入框在后 -->
            <label class="switch" style="margin-right: -5px;">
                <input type="checkbox" id="world-use-history-toggle">
                <span class="slider round"></span>
            </label>
            <!-- 修改：去掉了 display:none，增加了 transition 和默认占位样式 -->
            <input type="number" id="world-history-limit" class="history-limit-input" value="50" min="1" max="500" placeholder="条数" 
                   style="opacity: 0; pointer-events: none; transition: opacity 0.2s; width: 45px;">
        </div>
    </div>
    <div class="world-section-title">活跃的角色 (Char)</div>
    <!-- 列表容器将由 JS 填充 -->
    <div class="world-list-container">
        <ul id="forum-char-list" class="binding-list"></ul>
    </div>
</div>

            <!-- Tab 2: 世界书 (默认隐藏) -->
            <div id="world-tab-wb" class="world-tab-pane">
            <!-- 新增：跳转按钮 -->
    <div id="jump-to-wb-edit-btn" class="world-book-shortcut-btn">
        + 去管理/添加世界书
    </div>
                <div class="world-section-title">生效的世界书</div>
             
                <div class="world-list-container">
                    <ul id="forum-worldbook-list" class="binding-list">
                        <!-- JS 填充 -->
                    </ul>
                </div>
            </div>
        </div>
    </main>

    <!-- 底部导航栏保持不变 -->
    <!-- 底部导航栏 (世界页 - 世界高亮) -->
 <!-- 这是一个通用的底部导航栏模板，请在 forum-screen, world-screen, favorites-screen, me-screen 中同步替换 -->
<nav class="bottom-tab-bar">
    <div class="tab-item" data-target="forum-screen">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<!-- 添加了一个分组 <g>，并应用了缩放和平移 -->
<!-- scale(0.8) 表示缩小到80% -->
<!-- translate(2.4, 2.4) 是为了让缩放后的图标重新居中 ((24 - 24*0.8)/2 = 2.4) -->
<g transform="translate(1.2, 1.2) scale(0.9)">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M13.9931 3.43368C12.8564 2.42331 11.1436 2.42331 10.0069 3.43368L2.33565 10.2526C1.92286 10.6195 1.88568 11.2516 2.2526 11.6644C2.61952 12.0771 3.25159 12.1143 3.66437 11.7474L4.00001 11.4491L4.00001 17.0658C3.99996 17.9523 3.99992 18.7161 4.08215 19.3278C4.17028 19.9833 4.36903 20.6117 4.87869 21.1213C5.38835 21.631 6.0167 21.8297 6.67222 21.9179C7.28388 22.0001 8.04769 22 8.93418 22H15.0658C15.9523 22 16.7161 22.0001 17.3278 21.9179C17.9833 21.8297 18.6117 21.631 19.1213 21.1213C19.631 20.6117 19.8297 19.9833 19.9179 19.3278C20.0001 18.7161 20.0001 17.9523 20 17.0659L20 11.4491L20.3356 11.7474C20.7484 12.1143 21.3805 12.0771 21.7474 11.6644C22.1143 11.2516 22.0772 10.6195 21.6644 10.2526L13.9931 3.43368ZM12 16C11.4477 16 11 16.4477 11 17V19C11 19.5523 10.5523 20 10 20C9.44772 20 9 19.5523 9 19V17C9 15.3431 10.3431 14 12 14C13.6569 14 15 15.3431 15 17V19C15 19.5523 14.5523 20 14 20C13.4477 20 13 19.5523 13 19V17C13 16.4477 12.5523 16 12 16Z" fill="currentColor"/>
</g>
</svg>
        <span>主页</span>
    </div>
    <div class="tab-item active" data-target="world-screen">
         <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 20C16.4183 20 20 16.4183 20 12C20 11.8805 19.9974 11.7615 19.9922 11.6433C20.2479 11.4141 20.4882 11.1864 20.7118 10.9611C21.0037 10.6672 21.002 10.1923 20.708 9.90049C20.4336 9.628 20.0014 9.61143 19.7077 9.84972C19.4023 8.75248 18.8688 7.75024 18.1616 6.89725C18.4607 6.84611 18.7436 6.8084 19.0087 6.784C19.4212 6.74604 19.7247 6.38089 19.6868 5.96842C19.6488 5.55595 19.2837 5.25235 18.8712 5.29032C18.4474 5.32932 17.9972 5.39638 17.5262 5.48921C17.3267 5.52851 17.1614 5.64353 17.0543 5.79852C15.6765 4.67424 13.917 4 12 4C7.58172 4 4 7.58172 4 12C4 12.2776 4.01414 12.552 4.04175 12.8223C3.78987 12.7532 3.50899 12.8177 3.31137 13.0159C2.97651 13.3517 2.67596 13.6846 2.415 14.0113C2.15647 14.3349 2.20924 14.8069 2.53287 15.0654C2.8565 15.3239 3.32843 15.2711 3.58696 14.9475C3.78866 14.695 4.02466 14.4302 4.2938 14.1557C4.60754 15.2796 5.16056 16.3037 5.8945 17.1697C5.66824 17.3368 5.54578 17.6248 5.60398 17.919C5.68437 18.3253 6.07894 18.5896 6.48528 18.5092C6.7024 18.4662 6.92455 18.4177 7.15125 18.3637C8.49656 19.3903 10.1771 20 12 20ZM7.15125 18.3637C6.69042 18.012 6.26891 17.6114 5.8945 17.1697C5.98073 17.106 6.08204 17.0599 6.19417 17.0377C7.19089 16.8405 8.33112 16.5084 9.55581 16.0486C9.94359 15.903 10.376 16.0994 10.5216 16.4872C10.6671 16.8749 10.4708 17.3073 10.083 17.4529C9.05325 17.8395 8.0653 18.1459 7.15125 18.3637ZM19.7077 9.84972C19.6869 9.86663 19.6667 9.88483 19.6474 9.90431C18.9609 10.5957 18.0797 11.3337 17.0388 12.0753C16.7014 12.3157 16.6228 12.784 16.8631 13.1213C17.1035 13.4587 17.5718 13.5373 17.9091 13.297C18.6809 12.7471 19.3806 12.1912 19.9922 11.6433C19.965 11.0246 19.8676 10.4241 19.7077 9.84972ZM20.9366 5.37924C20.5336 5.28378 20.1294 5.53313 20.034 5.93619C19.9385 6.33925 20.1879 6.74339 20.5909 6.83886C20.985 6.93219 21.1368 7.07125 21.1932 7.16142C21.2565 7.26269 21.3262 7.52732 21.0363 8.10938C20.8516 8.48014 21.0025 8.93042 21.3732 9.1151C21.744 9.29979 22.1943 9.14894 22.379 8.77818C22.7566 8.02003 22.9422 7.12886 22.4648 6.36582C22.1206 5.81574 21.5416 5.52252 20.9366 5.37924ZM2.81481 16.2501C2.94057 15.8555 2.72259 15.4336 2.32793 15.3078C1.93327 15.1821 1.51138 15.4 1.38562 15.7947C1.19392 16.3963 1.17354 17.0573 1.53488 17.6349C1.98775 18.3587 2.84153 18.6413 3.68907 18.7224C4.1014 18.7619 4.46765 18.4596 4.50712 18.0473C4.54658 17.635 4.24432 17.2687 3.83199 17.2293C3.13763 17.1628 2.88355 16.9624 2.80651 16.8393C2.75679 16.7598 2.70479 16.5954 2.81481 16.2501ZM15.7504 14.704C16.106 14.4915 16.2218 14.0309 16.0093 13.6754C15.7967 13.3199 15.3362 13.204 14.9807 13.4166C14.4991 13.7045 13.9974 13.9881 13.4781 14.2648C12.9445 14.5491 12.4132 14.8149 11.8883 15.0615C11.5134 15.2376 11.3522 15.6843 11.5283 16.0592C11.7044 16.4341 12.1511 16.5953 12.526 16.4192C13.0739 16.1618 13.6277 15.8847 14.1834 15.5887C14.7242 15.3005 15.2474 15.0048 15.7504 14.704Z" fill="currentColor"/></svg>
        <span>世界</span>
    </div>
    <!-- 新增：收藏 Tab -->
    <div class="tab-item" data-target="favorites-screen">
        <svg viewBox="0 0 24 24"  xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M10.5766 8.70419C11.2099 7.56806 11.5266 7 12 7C12.4734 7 12.7901 7.56806 13.4234 8.70419L13.5873 8.99812C13.7672 9.32097 13.8572 9.48239 13.9975 9.5889C14.1378 9.69541 14.3126 9.73495 14.6621 9.81402L14.9802 9.88601C16.2101 10.1643 16.825 10.3034 16.9713 10.7739C17.1176 11.2443 16.6984 11.7345 15.86 12.715L15.643 12.9686C15.4048 13.2472 15.2857 13.3865 15.2321 13.5589C15.1785 13.7312 15.1965 13.9171 15.2325 14.2888L15.2653 14.6272C15.3921 15.9353 15.4554 16.5894 15.0724 16.8801C14.6894 17.1709 14.1137 16.9058 12.9622 16.3756L12.6643 16.2384C12.337 16.0878 12.1734 16.0124 12 16.0124C11.8266 16.0124 11.663 16.0878 11.3357 16.2384L11.0378 16.3756C9.88634 16.9058 9.31059 17.1709 8.92757 16.8801C8.54456 16.5894 8.60794 15.9353 8.7347 14.6272L8.76749 14.2888C8.80351 13.9171 8.82152 13.7312 8.76793 13.5589C8.71434 13.3865 8.59521 13.2472 8.35696 12.9686L8.14005 12.715C7.30162 11.7345 6.88241 11.2443 7.02871 10.7739C7.17501 10.3034 7.78993 10.1643 9.01977 9.88601L9.33794 9.81402C9.68743 9.73495 9.86217 9.69541 10.0025 9.5889C10.1428 9.48239 10.2328 9.32097 10.4127 8.99812L10.5766 8.70419ZM12 1.25C12.4142 1.25 12.75 1.58579 12.75 2V4C12.75 4.41421 12.4142 4.75 12 4.75C11.5858 4.75 11.25 4.41421 11.25 4V2C11.25 1.58579 11.5858 1.25 12 1.25ZM18.5304 5.46955C18.8233 5.76245 18.8233 6.23732 18.5304 6.53021L18.1872 6.87348C17.8943 7.16637 17.4194 7.16637 17.1265 6.87348C16.8336 6.58058 16.8336 6.10571 17.1265 5.81282L17.4698 5.46955C17.7627 5.17666 18.2376 5.17666 18.5304 5.46955ZM5.46967 5.46967C5.76256 5.17678 6.23744 5.17678 6.53033 5.46967L6.87359 5.81293C7.16648 6.10582 7.16648 6.5807 6.87359 6.87359C6.5807 7.16648 6.10582 7.16648 5.81293 6.87359L5.46967 6.53033C5.17678 6.23744 5.17678 5.76256 5.46967 5.46967ZM1.25 12C1.25 11.5858 1.58579 11.25 2 11.25H4C4.41421 11.25 4.75 11.5858 4.75 12C4.75 12.4142 4.41421 12.75 4 12.75H2C1.58579 12.75 1.25 12.4142 1.25 12ZM19.25 12C19.25 11.5858 19.5858 11.25 20 11.25H22C22.4142 11.25 22.75 11.5858 22.75 12C22.75 12.4142 22.4142 12.75 22 12.75H20C19.5858 12.75 19.25 12.4142 19.25 12ZM6.87348 17.1265C7.16637 17.4194 7.16637 17.8943 6.87348 18.1872L6.53043 18.5302C6.23754 18.8231 5.76266 18.8231 5.46977 18.5302C5.17688 18.2373 5.17688 17.7625 5.46977 17.4696L5.81282 17.1265C6.10571 16.8336 6.58058 16.8336 6.87348 17.1265ZM17.1265 17.1267C17.4194 16.8339 17.8943 16.8339 18.1872 17.1267L18.5302 17.4698C18.8231 17.7627 18.8231 18.2376 18.5302 18.5305C18.2373 18.8233 17.7624 18.8233 17.4695 18.5305L17.1265 18.1874C16.8336 17.8945 16.8336 17.4196 17.1265 17.1267ZM12 19.25C12.4142 19.25 12.75 19.5858 12.75 20V22C12.75 22.4142 12.4142 22.75 12 22.75C11.5858 22.75 11.25 22.4142 11.25 22V20C11.25 19.5858 11.5858 19.25 12 19.25Z" fill="currentColor"/></svg>
        <span>收藏</span>
    </div>
    <div class="tab-item" data-target="me-screen">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M11.7501 6.40636C10.2698 6.40636 10.1222 6.5625 9.3561 6.5625C8.71769 6.5625 6.80245 5 5.84485 5C4.88724 5 3.77004 5.5625 3.77004 7.1875V9.0625C3.77197 9.55469 3.95081 11.0634 4.65075 10.6602C3.82323 11.6382 3.73963 12.7786 3.751 13.8826C3.52812 13.947 3.30072 14.0196 3.08003 14.095C2.39614 14.3289 1.67085 14.6271 1.3432 14.8387C0.995241 15.0634 0.895339 15.5277 1.12006 15.8756C1.34478 16.2236 1.80903 16.3235 2.15698 16.0988C2.3132 15.9979 2.87823 15.7493 3.56532 15.5144C3.64124 15.4884 3.71731 15.4631 3.79298 15.4386C3.83925 15.8724 3.95408 16.2684 4.12478 16.6292L4.1012 16.6416C3.69148 16.8581 3.3113 17.1067 3.06889 17.2652C3.02694 17.2926 2.98912 17.3173 2.95599 17.3387C2.60803 17.5634 2.50813 18.0277 2.73285 18.3756C2.95757 18.7236 3.42182 18.8235 3.76978 18.5988C3.8109 18.5722 3.85472 18.5436 3.90097 18.5134C4.1463 18.3533 4.45999 18.1485 4.80199 17.9678C4.88218 17.9254 4.95935 17.887 5.03317 17.8524C6.76347 19.4748 9.86991 20 11.7501 20C13.6302 20 16.7367 19.4748 18.467 17.8524C18.5408 17.887 18.6179 17.9254 18.6981 17.9678C19.0401 18.1485 19.3538 18.3533 19.5991 18.5134C19.6454 18.5436 19.6892 18.5722 19.7303 18.5988C20.0783 18.8235 20.5425 18.7236 20.7673 18.3756C20.992 18.0277 20.8921 17.5634 20.5441 17.3387C20.511 17.3173 20.4732 17.2926 20.4312 17.2652C20.1888 17.1067 19.8086 16.8581 19.3989 16.6416L19.3754 16.6292C19.5461 16.2683 19.6609 15.8724 19.7072 15.4385C19.783 15.463 19.8592 15.4883 19.9352 15.5144C20.6223 15.7493 21.1874 15.9979 21.3436 16.0988C21.6915 16.3235 22.1558 16.2236 22.3805 15.8756C22.6052 15.5277 22.5053 15.0634 22.1574 14.8387C21.8297 14.6271 21.1044 14.3289 20.4205 14.095C20.1997 14.0195 19.9722 13.947 19.7492 13.8825C19.7605 12.7785 19.6769 11.6382 18.8494 10.6602C19.5494 11.0634 19.7282 9.55469 19.7302 9.0625V7.18761C19.7302 5.56261 18.6129 5.00011 17.6553 5.00011C16.6977 5.00011 14.7825 6.5625 14.1441 6.5625C13.378 6.5625 13.2305 6.40636 11.7501 6.40636ZM13.9201 12.5005C14.0566 12.2721 14.326 12 14.7301 12C15.1342 12 15.4036 12.2721 15.54 12.5005C15.6823 12.7387 15.7501 13.0274 15.7501 13.3125C15.7501 13.5976 15.6823 13.8863 15.54 14.1245C15.4036 14.3529 15.1342 14.625 14.7301 14.625C14.326 14.625 14.0566 14.3529 13.9201 14.1245C13.7778 13.8863 13.7101 13.5976 13.7101 13.3125C13.7101 13.0274 13.7778 12.7387 13.9201 12.5005ZM7.96016 12.5005C8.09658 12.2721 8.36599 12 8.7701 12C9.17421 12 9.44362 12.2721 9.58004 12.5005C9.72234 12.7387 9.79011 13.0274 9.79011 13.3125C9.79011 13.5976 9.72234 13.8863 9.58004 14.1245C9.44362 14.3529 9.17421 14.625 8.7701 14.625C8.36599 14.625 8.09658 14.3529 7.96016 14.1245C7.81786 13.8863 7.75009 13.5976 7.75009 13.3125C7.75009 13.0274 7.81786 12.7387 7.96016 12.5005Z" fill="currentColor"/></svg>
        <span>我</span>
    </div>
</nav>
</div>


<!-- 新增：收藏页 -->
<div id="favorites-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="forum-screen">‹</button>
        <div class="title-container"><h1 class="title">收 藏</h1></div>
        <button class="action-btn" id="fav-manage-btn" title="管理">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M19 7L18.1327 19.1425C18.0579 20.1891 17.187 21 16.1378 21H7.86224C6.81296 21 5.94208 20.1891 5.86732 19.1425L5 7M10 11V17M14 11V17M15 7V4C15 3.44772 14.5523 3 14 3H10C9.44772 3 9 3.44772 9 4V7M4 7H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
        </button>
    </header>

    <main class="content" style="padding:0; position: relative;"> <!-- 设为 relative 以便内部绝对定位 -->
        <!-- 列表容器 -->
        <div id="favorites-list-container" style="overflow-y: auto; height: 100%;">
            <!-- 收藏列表 JS 填充 -->
            <p class="placeholder-text" style="margin-top:50px;">暂无收藏内容</p>
        </div>
        
        <!-- 管理操作栏 (固定在底部) -->
        <div id="fav-manage-actions" class="favorites-manage-bar">
             <button id="fav-delete-confirm-btn" class="btn btn-danger">删除选中</button>
        </div>
    </main>
    
    <!-- 底部导航栏 (需包含 收藏 高亮) -->
    <nav class="bottom-tab-bar">
        <div class="tab-item" data-target="forum-screen">
             <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<!-- 添加了一个分组 <g>，并应用了缩放和平移 -->
<!-- scale(0.8) 表示缩小到80% -->
<!-- translate(2.4, 2.4) 是为了让缩放后的图标重新居中 ((24 - 24*0.8)/2 = 2.4) -->
<g transform="translate(1.2, 1.2) scale(0.9)">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M13.9931 3.43368C12.8564 2.42331 11.1436 2.42331 10.0069 3.43368L2.33565 10.2526C1.92286 10.6195 1.88568 11.2516 2.2526 11.6644C2.61952 12.0771 3.25159 12.1143 3.66437 11.7474L4.00001 11.4491L4.00001 17.0658C3.99996 17.9523 3.99992 18.7161 4.08215 19.3278C4.17028 19.9833 4.36903 20.6117 4.87869 21.1213C5.38835 21.631 6.0167 21.8297 6.67222 21.9179C7.28388 22.0001 8.04769 22 8.93418 22H15.0658C15.9523 22 16.7161 22.0001 17.3278 21.9179C17.9833 21.8297 18.6117 21.631 19.1213 21.1213C19.631 20.6117 19.8297 19.9833 19.9179 19.3278C20.0001 18.7161 20.0001 17.9523 20 17.0659L20 11.4491L20.3356 11.7474C20.7484 12.1143 21.3805 12.0771 21.7474 11.6644C22.1143 11.2516 22.0772 10.6195 21.6644 10.2526L13.9931 3.43368ZM12 16C11.4477 16 11 16.4477 11 17V19C11 19.5523 10.5523 20 10 20C9.44772 20 9 19.5523 9 19V17C9 15.3431 10.3431 14 12 14C13.6569 14 15 15.3431 15 17V19C15 19.5523 14.5523 20 14 20C13.4477 20 13 19.5523 13 19V17C13 16.4477 12.5523 16 12 16Z" fill="currentColor"/>
</g>
</svg>
            <span>主页</span>
        </div>
        <div class="tab-item" data-target="world-screen">
             <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 20C16.4183 20 20 16.4183 20 12C20 11.8805 19.9974 11.7615 19.9922 11.6433C20.2479 11.4141 20.4882 11.1864 20.7118 10.9611C21.0037 10.6672 21.002 10.1923 20.708 9.90049C20.4336 9.628 20.0014 9.61143 19.7077 9.84972C19.4023 8.75248 18.8688 7.75024 18.1616 6.89725C18.4607 6.84611 18.7436 6.8084 19.0087 6.784C19.4212 6.74604 19.7247 6.38089 19.6868 5.96842C19.6488 5.55595 19.2837 5.25235 18.8712 5.29032C18.4474 5.32932 17.9972 5.39638 17.5262 5.48921C17.3267 5.52851 17.1614 5.64353 17.0543 5.79852C15.6765 4.67424 13.917 4 12 4C7.58172 4 4 7.58172 4 12C4 12.2776 4.01414 12.552 4.04175 12.8223C3.78987 12.7532 3.50899 12.8177 3.31137 13.0159C2.97651 13.3517 2.67596 13.6846 2.415 14.0113C2.15647 14.3349 2.20924 14.8069 2.53287 15.0654C2.8565 15.3239 3.32843 15.2711 3.58696 14.9475C3.78866 14.695 4.02466 14.4302 4.2938 14.1557C4.60754 15.2796 5.16056 16.3037 5.8945 17.1697C5.66824 17.3368 5.54578 17.6248 5.60398 17.919C5.68437 18.3253 6.07894 18.5896 6.48528 18.5092C6.7024 18.4662 6.92455 18.4177 7.15125 18.3637C8.49656 19.3903 10.1771 20 12 20ZM7.15125 18.3637C6.69042 18.012 6.26891 17.6114 5.8945 17.1697C5.98073 17.106 6.08204 17.0599 6.19417 17.0377C7.19089 16.8405 8.33112 16.5084 9.55581 16.0486C9.94359 15.903 10.376 16.0994 10.5216 16.4872C10.6671 16.8749 10.4708 17.3073 10.083 17.4529C9.05325 17.8395 8.0653 18.1459 7.15125 18.3637ZM19.7077 9.84972C19.6869 9.86663 19.6667 9.88483 19.6474 9.90431C18.9609 10.5957 18.0797 11.3337 17.0388 12.0753C16.7014 12.3157 16.6228 12.784 16.8631 13.1213C17.1035 13.4587 17.5718 13.5373 17.9091 13.297C18.6809 12.7471 19.3806 12.1912 19.9922 11.6433C19.965 11.0246 19.8676 10.4241 19.7077 9.84972ZM20.9366 5.37924C20.5336 5.28378 20.1294 5.53313 20.034 5.93619C19.9385 6.33925 20.1879 6.74339 20.5909 6.83886C20.985 6.93219 21.1368 7.07125 21.1932 7.16142C21.2565 7.26269 21.3262 7.52732 21.0363 8.10938C20.8516 8.48014 21.0025 8.93042 21.3732 9.1151C21.744 9.29979 22.1943 9.14894 22.379 8.77818C22.7566 8.02003 22.9422 7.12886 22.4648 6.36582C22.1206 5.81574 21.5416 5.52252 20.9366 5.37924ZM2.81481 16.2501C2.94057 15.8555 2.72259 15.4336 2.32793 15.3078C1.93327 15.1821 1.51138 15.4 1.38562 15.7947C1.19392 16.3963 1.17354 17.0573 1.53488 17.6349C1.98775 18.3587 2.84153 18.6413 3.68907 18.7224C4.1014 18.7619 4.46765 18.4596 4.50712 18.0473C4.54658 17.635 4.24432 17.2687 3.83199 17.2293C3.13763 17.1628 2.88355 16.9624 2.80651 16.8393C2.75679 16.7598 2.70479 16.5954 2.81481 16.2501ZM15.7504 14.704C16.106 14.4915 16.2218 14.0309 16.0093 13.6754C15.7967 13.3199 15.3362 13.204 14.9807 13.4166C14.4991 13.7045 13.9974 13.9881 13.4781 14.2648C12.9445 14.5491 12.4132 14.8149 11.8883 15.0615C11.5134 15.2376 11.3522 15.6843 11.5283 16.0592C11.7044 16.4341 12.1511 16.5953 12.526 16.4192C13.0739 16.1618 13.6277 15.8847 14.1834 15.5887C14.7242 15.3005 15.2474 15.0048 15.7504 14.704Z" fill="currentColor"/></svg>
            <span>世界</span>
        </div>
        <div class="tab-item active" data-target="favorites-screen">
             <svg viewBox="0 0 24 24"  xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M10.5766 8.70419C11.2099 7.56806 11.5266 7 12 7C12.4734 7 12.7901 7.56806 13.4234 8.70419L13.5873 8.99812C13.7672 9.32097 13.8572 9.48239 13.9975 9.5889C14.1378 9.69541 14.3126 9.73495 14.6621 9.81402L14.9802 9.88601C16.2101 10.1643 16.825 10.3034 16.9713 10.7739C17.1176 11.2443 16.6984 11.7345 15.86 12.715L15.643 12.9686C15.4048 13.2472 15.2857 13.3865 15.2321 13.5589C15.1785 13.7312 15.1965 13.9171 15.2325 14.2888L15.2653 14.6272C15.3921 15.9353 15.4554 16.5894 15.0724 16.8801C14.6894 17.1709 14.1137 16.9058 12.9622 16.3756L12.6643 16.2384C12.337 16.0878 12.1734 16.0124 12 16.0124C11.8266 16.0124 11.663 16.0878 11.3357 16.2384L11.0378 16.3756C9.88634 16.9058 9.31059 17.1709 8.92757 16.8801C8.54456 16.5894 8.60794 15.9353 8.7347 14.6272L8.76749 14.2888C8.80351 13.9171 8.82152 13.7312 8.76793 13.5589C8.71434 13.3865 8.59521 13.2472 8.35696 12.9686L8.14005 12.715C7.30162 11.7345 6.88241 11.2443 7.02871 10.7739C7.17501 10.3034 7.78993 10.1643 9.01977 9.88601L9.33794 9.81402C9.68743 9.73495 9.86217 9.69541 10.0025 9.5889C10.1428 9.48239 10.2328 9.32097 10.4127 8.99812L10.5766 8.70419ZM12 1.25C12.4142 1.25 12.75 1.58579 12.75 2V4C12.75 4.41421 12.4142 4.75 12 4.75C11.5858 4.75 11.25 4.41421 11.25 4V2C11.25 1.58579 11.5858 1.25 12 1.25ZM18.5304 5.46955C18.8233 5.76245 18.8233 6.23732 18.5304 6.53021L18.1872 6.87348C17.8943 7.16637 17.4194 7.16637 17.1265 6.87348C16.8336 6.58058 16.8336 6.10571 17.1265 5.81282L17.4698 5.46955C17.7627 5.17666 18.2376 5.17666 18.5304 5.46955ZM5.46967 5.46967C5.76256 5.17678 6.23744 5.17678 6.53033 5.46967L6.87359 5.81293C7.16648 6.10582 7.16648 6.5807 6.87359 6.87359C6.5807 7.16648 6.10582 7.16648 5.81293 6.87359L5.46967 6.53033C5.17678 6.23744 5.17678 5.76256 5.46967 5.46967ZM1.25 12C1.25 11.5858 1.58579 11.25 2 11.25H4C4.41421 11.25 4.75 11.5858 4.75 12C4.75 12.4142 4.41421 12.75 4 12.75H2C1.58579 12.75 1.25 12.4142 1.25 12ZM19.25 12C19.25 11.5858 19.5858 11.25 20 11.25H22C22.4142 11.25 22.75 11.5858 22.75 12C22.75 12.4142 22.4142 12.75 22 12.75H20C19.5858 12.75 19.25 12.4142 19.25 12ZM6.87348 17.1265C7.16637 17.4194 7.16637 17.8943 6.87348 18.1872L6.53043 18.5302C6.23754 18.8231 5.76266 18.8231 5.46977 18.5302C5.17688 18.2373 5.17688 17.7625 5.46977 17.4696L5.81282 17.1265C6.10571 16.8336 6.58058 16.8336 6.87348 17.1265ZM17.1265 17.1267C17.4194 16.8339 17.8943 16.8339 18.1872 17.1267L18.5302 17.4698C18.8231 17.7627 18.8231 18.2376 18.5302 18.5305C18.2373 18.8233 17.7624 18.8233 17.4695 18.5305L17.1265 18.1874C16.8336 17.8945 16.8336 17.4196 17.1265 17.1267ZM12 19.25C12.4142 19.25 12.75 19.5858 12.75 20V22C12.75 22.4142 12.4142 22.75 12 22.75C11.5858 22.75 11.25 22.4142 11.25 22V20C11.25 19.5858 11.5858 19.25 12 19.25Z" fill="currentColor"/></svg>
            <span>收藏</span>
        </div>
        <div class="tab-item" data-target="me-screen">
             <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M11.7501 6.40636C10.2698 6.40636 10.1222 6.5625 9.3561 6.5625C8.71769 6.5625 6.80245 5 5.84485 5C4.88724 5 3.77004 5.5625 3.77004 7.1875V9.0625C3.77197 9.55469 3.95081 11.0634 4.65075 10.6602C3.82323 11.6382 3.73963 12.7786 3.751 13.8826C3.52812 13.947 3.30072 14.0196 3.08003 14.095C2.39614 14.3289 1.67085 14.6271 1.3432 14.8387C0.995241 15.0634 0.895339 15.5277 1.12006 15.8756C1.34478 16.2236 1.80903 16.3235 2.15698 16.0988C2.3132 15.9979 2.87823 15.7493 3.56532 15.5144C3.64124 15.4884 3.71731 15.4631 3.79298 15.4386C3.83925 15.8724 3.95408 16.2684 4.12478 16.6292L4.1012 16.6416C3.69148 16.8581 3.3113 17.1067 3.06889 17.2652C3.02694 17.2926 2.98912 17.3173 2.95599 17.3387C2.60803 17.5634 2.50813 18.0277 2.73285 18.3756C2.95757 18.7236 3.42182 18.8235 3.76978 18.5988C3.8109 18.5722 3.85472 18.5436 3.90097 18.5134C4.1463 18.3533 4.45999 18.1485 4.80199 17.9678C4.88218 17.9254 4.95935 17.887 5.03317 17.8524C6.76347 19.4748 9.86991 20 11.7501 20C13.6302 20 16.7367 19.4748 18.467 17.8524C18.5408 17.887 18.6179 17.9254 18.6981 17.9678C19.0401 18.1485 19.3538 18.3533 19.5991 18.5134C19.6454 18.5436 19.6892 18.5722 19.7303 18.5988C20.0783 18.8235 20.5425 18.7236 20.7673 18.3756C20.992 18.0277 20.8921 17.5634 20.5441 17.3387C20.511 17.3173 20.4732 17.2926 20.4312 17.2652C20.1888 17.1067 19.8086 16.8581 19.3989 16.6416L19.3754 16.6292C19.5461 16.2683 19.6609 15.8724 19.7072 15.4385C19.783 15.463 19.8592 15.4883 19.9352 15.5144C20.6223 15.7493 21.1874 15.9979 21.3436 16.0988C21.6915 16.3235 22.1558 16.2236 22.3805 15.8756C22.6052 15.5277 22.5053 15.0634 22.1574 14.8387C21.8297 14.6271 21.1044 14.3289 20.4205 14.095C20.1997 14.0195 19.9722 13.947 19.7492 13.8825C19.7605 12.7785 19.6769 11.6382 18.8494 10.6602C19.5494 11.0634 19.7282 9.55469 19.7302 9.0625V7.18761C19.7302 5.56261 18.6129 5.00011 17.6553 5.00011C16.6977 5.00011 14.7825 6.5625 14.1441 6.5625C13.378 6.5625 13.2305 6.40636 11.7501 6.40636ZM13.9201 12.5005C14.0566 12.2721 14.326 12 14.7301 12C15.1342 12 15.4036 12.2721 15.54 12.5005C15.6823 12.7387 15.7501 13.0274 15.7501 13.3125C15.7501 13.5976 15.6823 13.8863 15.54 14.1245C15.4036 14.3529 15.1342 14.625 14.7301 14.625C14.326 14.625 14.0566 14.3529 13.9201 14.1245C13.7778 13.8863 13.7101 13.5976 13.7101 13.3125C13.7101 13.0274 13.7778 12.7387 13.9201 12.5005ZM7.96016 12.5005C8.09658 12.2721 8.36599 12 8.7701 12C9.17421 12 9.44362 12.2721 9.58004 12.5005C9.72234 12.7387 9.79011 13.0274 9.79011 13.3125C9.79011 13.5976 9.72234 13.8863 9.58004 14.1245C9.44362 14.3529 9.17421 14.625 8.7701 14.625C8.36599 14.625 8.09658 14.3529 7.96016 14.1245C7.81786 13.8863 7.75009 13.5976 7.75009 13.3125C7.75009 13.0274 7.81786 12.7387 7.96016 12.5005Z" fill="currentColor"/></svg>
            <span>我</span>
        </div>
    </nav>
</div>

<!-- 3. 我 (User Settings) -->
<div id="me-screen" class="screen">
    <header class="app-header">
        <!-- 新增：返回按钮，指向 forum-screen -->
        <button class="back-btn" data-target="forum-screen">‹</button>
        
        <div class="title-container"><h1 class="title">我</h1></div>
        
        <!-- 右侧占位保持标题居中 -->
        <div style="width: 40px;"></div>
    </header>

    <main class="content tab-content-area">
        <div class="me-card">
            <!-- 3. 修改头像部分：点击触发 -->
            <div class="me-avatar-container" id="me-avatar-trigger">
                <div class="me-avatar-preview">
                    <img id="me-avatar-img" src="https://i.postimg.cc/Y96LPskq/o-o-2.jpg" alt="头像" style="width:100%; height:100%; object-fit:cover;">
                </div>
                <div class="me-avatar-overlay">
                    <svg viewBox="0 0 24 24"><path d="M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z" /></svg>
                </div>
            </div>
            
            <div class="form-group">
                <label>论坛昵称</label>
                <input type="text" id="me-nickname-input" placeholder="起个响亮的网名吧">
            </div>

            <!-- 隐藏原来的头像 URL 输入框 -->
            <input type="hidden" id="me-avatar-input">

            <div class="form-group">
                <label>我的人设 (仅在论坛生效)</label>
                <textarea id="me-persona-input" placeholder="描述你在论坛中的身份、性格、说话语气。例如：一个潜水党，偶尔出来吐槽..." ></textarea>
            </div>

            <button id="me-save-btn" type="submit" class="btn btn-primary">保存设置</button>
        </div>
    </main>

    <!-- 底部导航栏保持不变 -->
    <!-- 底部导航栏 (我页面 - 我高亮) -->
<!-- 这是一个通用的底部导航栏模板，请在 forum-screen, world-screen, favorites-screen, me-screen 中同步替换 -->
<nav class="bottom-tab-bar">
    <div class="tab-item" data-target="forum-screen">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<!-- 添加了一个分组 <g>，并应用了缩放和平移 -->
<!-- scale(0.8) 表示缩小到80% -->
<!-- translate(2.4, 2.4) 是为了让缩放后的图标重新居中 ((24 - 24*0.8)/2 = 2.4) -->
<g transform="translate(1.2, 1.2) scale(0.9)">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M13.9931 3.43368C12.8564 2.42331 11.1436 2.42331 10.0069 3.43368L2.33565 10.2526C1.92286 10.6195 1.88568 11.2516 2.2526 11.6644C2.61952 12.0771 3.25159 12.1143 3.66437 11.7474L4.00001 11.4491L4.00001 17.0658C3.99996 17.9523 3.99992 18.7161 4.08215 19.3278C4.17028 19.9833 4.36903 20.6117 4.87869 21.1213C5.38835 21.631 6.0167 21.8297 6.67222 21.9179C7.28388 22.0001 8.04769 22 8.93418 22H15.0658C15.9523 22 16.7161 22.0001 17.3278 21.9179C17.9833 21.8297 18.6117 21.631 19.1213 21.1213C19.631 20.6117 19.8297 19.9833 19.9179 19.3278C20.0001 18.7161 20.0001 17.9523 20 17.0659L20 11.4491L20.3356 11.7474C20.7484 12.1143 21.3805 12.0771 21.7474 11.6644C22.1143 11.2516 22.0772 10.6195 21.6644 10.2526L13.9931 3.43368ZM12 16C11.4477 16 11 16.4477 11 17V19C11 19.5523 10.5523 20 10 20C9.44772 20 9 19.5523 9 19V17C9 15.3431 10.3431 14 12 14C13.6569 14 15 15.3431 15 17V19C15 19.5523 14.5523 20 14 20C13.4477 20 13 19.5523 13 19V17C13 16.4477 12.5523 16 12 16Z" fill="currentColor"/>
</g>
</svg>
        <span>主页</span>
    </div>
    <div class="tab-item" data-target="world-screen">
         <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 20C16.4183 20 20 16.4183 20 12C20 11.8805 19.9974 11.7615 19.9922 11.6433C20.2479 11.4141 20.4882 11.1864 20.7118 10.9611C21.0037 10.6672 21.002 10.1923 20.708 9.90049C20.4336 9.628 20.0014 9.61143 19.7077 9.84972C19.4023 8.75248 18.8688 7.75024 18.1616 6.89725C18.4607 6.84611 18.7436 6.8084 19.0087 6.784C19.4212 6.74604 19.7247 6.38089 19.6868 5.96842C19.6488 5.55595 19.2837 5.25235 18.8712 5.29032C18.4474 5.32932 17.9972 5.39638 17.5262 5.48921C17.3267 5.52851 17.1614 5.64353 17.0543 5.79852C15.6765 4.67424 13.917 4 12 4C7.58172 4 4 7.58172 4 12C4 12.2776 4.01414 12.552 4.04175 12.8223C3.78987 12.7532 3.50899 12.8177 3.31137 13.0159C2.97651 13.3517 2.67596 13.6846 2.415 14.0113C2.15647 14.3349 2.20924 14.8069 2.53287 15.0654C2.8565 15.3239 3.32843 15.2711 3.58696 14.9475C3.78866 14.695 4.02466 14.4302 4.2938 14.1557C4.60754 15.2796 5.16056 16.3037 5.8945 17.1697C5.66824 17.3368 5.54578 17.6248 5.60398 17.919C5.68437 18.3253 6.07894 18.5896 6.48528 18.5092C6.7024 18.4662 6.92455 18.4177 7.15125 18.3637C8.49656 19.3903 10.1771 20 12 20ZM7.15125 18.3637C6.69042 18.012 6.26891 17.6114 5.8945 17.1697C5.98073 17.106 6.08204 17.0599 6.19417 17.0377C7.19089 16.8405 8.33112 16.5084 9.55581 16.0486C9.94359 15.903 10.376 16.0994 10.5216 16.4872C10.6671 16.8749 10.4708 17.3073 10.083 17.4529C9.05325 17.8395 8.0653 18.1459 7.15125 18.3637ZM19.7077 9.84972C19.6869 9.86663 19.6667 9.88483 19.6474 9.90431C18.9609 10.5957 18.0797 11.3337 17.0388 12.0753C16.7014 12.3157 16.6228 12.784 16.8631 13.1213C17.1035 13.4587 17.5718 13.5373 17.9091 13.297C18.6809 12.7471 19.3806 12.1912 19.9922 11.6433C19.965 11.0246 19.8676 10.4241 19.7077 9.84972ZM20.9366 5.37924C20.5336 5.28378 20.1294 5.53313 20.034 5.93619C19.9385 6.33925 20.1879 6.74339 20.5909 6.83886C20.985 6.93219 21.1368 7.07125 21.1932 7.16142C21.2565 7.26269 21.3262 7.52732 21.0363 8.10938C20.8516 8.48014 21.0025 8.93042 21.3732 9.1151C21.744 9.29979 22.1943 9.14894 22.379 8.77818C22.7566 8.02003 22.9422 7.12886 22.4648 6.36582C22.1206 5.81574 21.5416 5.52252 20.9366 5.37924ZM2.81481 16.2501C2.94057 15.8555 2.72259 15.4336 2.32793 15.3078C1.93327 15.1821 1.51138 15.4 1.38562 15.7947C1.19392 16.3963 1.17354 17.0573 1.53488 17.6349C1.98775 18.3587 2.84153 18.6413 3.68907 18.7224C4.1014 18.7619 4.46765 18.4596 4.50712 18.0473C4.54658 17.635 4.24432 17.2687 3.83199 17.2293C3.13763 17.1628 2.88355 16.9624 2.80651 16.8393C2.75679 16.7598 2.70479 16.5954 2.81481 16.2501ZM15.7504 14.704C16.106 14.4915 16.2218 14.0309 16.0093 13.6754C15.7967 13.3199 15.3362 13.204 14.9807 13.4166C14.4991 13.7045 13.9974 13.9881 13.4781 14.2648C12.9445 14.5491 12.4132 14.8149 11.8883 15.0615C11.5134 15.2376 11.3522 15.6843 11.5283 16.0592C11.7044 16.4341 12.1511 16.5953 12.526 16.4192C13.0739 16.1618 13.6277 15.8847 14.1834 15.5887C14.7242 15.3005 15.2474 15.0048 15.7504 14.704Z" fill="currentColor"/></svg>
        <span>世界</span>
    </div>
    <!-- 新增：收藏 Tab -->
    <div class="tab-item" data-target="favorites-screen">
        <svg viewBox="0 0 24 24"  xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M10.5766 8.70419C11.2099 7.56806 11.5266 7 12 7C12.4734 7 12.7901 7.56806 13.4234 8.70419L13.5873 8.99812C13.7672 9.32097 13.8572 9.48239 13.9975 9.5889C14.1378 9.69541 14.3126 9.73495 14.6621 9.81402L14.9802 9.88601C16.2101 10.1643 16.825 10.3034 16.9713 10.7739C17.1176 11.2443 16.6984 11.7345 15.86 12.715L15.643 12.9686C15.4048 13.2472 15.2857 13.3865 15.2321 13.5589C15.1785 13.7312 15.1965 13.9171 15.2325 14.2888L15.2653 14.6272C15.3921 15.9353 15.4554 16.5894 15.0724 16.8801C14.6894 17.1709 14.1137 16.9058 12.9622 16.3756L12.6643 16.2384C12.337 16.0878 12.1734 16.0124 12 16.0124C11.8266 16.0124 11.663 16.0878 11.3357 16.2384L11.0378 16.3756C9.88634 16.9058 9.31059 17.1709 8.92757 16.8801C8.54456 16.5894 8.60794 15.9353 8.7347 14.6272L8.76749 14.2888C8.80351 13.9171 8.82152 13.7312 8.76793 13.5589C8.71434 13.3865 8.59521 13.2472 8.35696 12.9686L8.14005 12.715C7.30162 11.7345 6.88241 11.2443 7.02871 10.7739C7.17501 10.3034 7.78993 10.1643 9.01977 9.88601L9.33794 9.81402C9.68743 9.73495 9.86217 9.69541 10.0025 9.5889C10.1428 9.48239 10.2328 9.32097 10.4127 8.99812L10.5766 8.70419ZM12 1.25C12.4142 1.25 12.75 1.58579 12.75 2V4C12.75 4.41421 12.4142 4.75 12 4.75C11.5858 4.75 11.25 4.41421 11.25 4V2C11.25 1.58579 11.5858 1.25 12 1.25ZM18.5304 5.46955C18.8233 5.76245 18.8233 6.23732 18.5304 6.53021L18.1872 6.87348C17.8943 7.16637 17.4194 7.16637 17.1265 6.87348C16.8336 6.58058 16.8336 6.10571 17.1265 5.81282L17.4698 5.46955C17.7627 5.17666 18.2376 5.17666 18.5304 5.46955ZM5.46967 5.46967C5.76256 5.17678 6.23744 5.17678 6.53033 5.46967L6.87359 5.81293C7.16648 6.10582 7.16648 6.5807 6.87359 6.87359C6.5807 7.16648 6.10582 7.16648 5.81293 6.87359L5.46967 6.53033C5.17678 6.23744 5.17678 5.76256 5.46967 5.46967ZM1.25 12C1.25 11.5858 1.58579 11.25 2 11.25H4C4.41421 11.25 4.75 11.5858 4.75 12C4.75 12.4142 4.41421 12.75 4 12.75H2C1.58579 12.75 1.25 12.4142 1.25 12ZM19.25 12C19.25 11.5858 19.5858 11.25 20 11.25H22C22.4142 11.25 22.75 11.5858 22.75 12C22.75 12.4142 22.4142 12.75 22 12.75H20C19.5858 12.75 19.25 12.4142 19.25 12ZM6.87348 17.1265C7.16637 17.4194 7.16637 17.8943 6.87348 18.1872L6.53043 18.5302C6.23754 18.8231 5.76266 18.8231 5.46977 18.5302C5.17688 18.2373 5.17688 17.7625 5.46977 17.4696L5.81282 17.1265C6.10571 16.8336 6.58058 16.8336 6.87348 17.1265ZM17.1265 17.1267C17.4194 16.8339 17.8943 16.8339 18.1872 17.1267L18.5302 17.4698C18.8231 17.7627 18.8231 18.2376 18.5302 18.5305C18.2373 18.8233 17.7624 18.8233 17.4695 18.5305L17.1265 18.1874C16.8336 17.8945 16.8336 17.4196 17.1265 17.1267ZM12 19.25C12.4142 19.25 12.75 19.5858 12.75 20V22C12.75 22.4142 12.4142 22.75 12 22.75C11.5858 22.75 11.25 22.4142 11.25 22V20C11.25 19.5858 11.5858 19.25 12 19.25Z" fill="currentColor"/></svg>
        <span>收藏</span>
    </div>
    <div class="tab-item active" data-target="me-screen">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M11.7501 6.40636C10.2698 6.40636 10.1222 6.5625 9.3561 6.5625C8.71769 6.5625 6.80245 5 5.84485 5C4.88724 5 3.77004 5.5625 3.77004 7.1875V9.0625C3.77197 9.55469 3.95081 11.0634 4.65075 10.6602C3.82323 11.6382 3.73963 12.7786 3.751 13.8826C3.52812 13.947 3.30072 14.0196 3.08003 14.095C2.39614 14.3289 1.67085 14.6271 1.3432 14.8387C0.995241 15.0634 0.895339 15.5277 1.12006 15.8756C1.34478 16.2236 1.80903 16.3235 2.15698 16.0988C2.3132 15.9979 2.87823 15.7493 3.56532 15.5144C3.64124 15.4884 3.71731 15.4631 3.79298 15.4386C3.83925 15.8724 3.95408 16.2684 4.12478 16.6292L4.1012 16.6416C3.69148 16.8581 3.3113 17.1067 3.06889 17.2652C3.02694 17.2926 2.98912 17.3173 2.95599 17.3387C2.60803 17.5634 2.50813 18.0277 2.73285 18.3756C2.95757 18.7236 3.42182 18.8235 3.76978 18.5988C3.8109 18.5722 3.85472 18.5436 3.90097 18.5134C4.1463 18.3533 4.45999 18.1485 4.80199 17.9678C4.88218 17.9254 4.95935 17.887 5.03317 17.8524C6.76347 19.4748 9.86991 20 11.7501 20C13.6302 20 16.7367 19.4748 18.467 17.8524C18.5408 17.887 18.6179 17.9254 18.6981 17.9678C19.0401 18.1485 19.3538 18.3533 19.5991 18.5134C19.6454 18.5436 19.6892 18.5722 19.7303 18.5988C20.0783 18.8235 20.5425 18.7236 20.7673 18.3756C20.992 18.0277 20.8921 17.5634 20.5441 17.3387C20.511 17.3173 20.4732 17.2926 20.4312 17.2652C20.1888 17.1067 19.8086 16.8581 19.3989 16.6416L19.3754 16.6292C19.5461 16.2683 19.6609 15.8724 19.7072 15.4385C19.783 15.463 19.8592 15.4883 19.9352 15.5144C20.6223 15.7493 21.1874 15.9979 21.3436 16.0988C21.6915 16.3235 22.1558 16.2236 22.3805 15.8756C22.6052 15.5277 22.5053 15.0634 22.1574 14.8387C21.8297 14.6271 21.1044 14.3289 20.4205 14.095C20.1997 14.0195 19.9722 13.947 19.7492 13.8825C19.7605 12.7785 19.6769 11.6382 18.8494 10.6602C19.5494 11.0634 19.7282 9.55469 19.7302 9.0625V7.18761C19.7302 5.56261 18.6129 5.00011 17.6553 5.00011C16.6977 5.00011 14.7825 6.5625 14.1441 6.5625C13.378 6.5625 13.2305 6.40636 11.7501 6.40636ZM13.9201 12.5005C14.0566 12.2721 14.326 12 14.7301 12C15.1342 12 15.4036 12.2721 15.54 12.5005C15.6823 12.7387 15.7501 13.0274 15.7501 13.3125C15.7501 13.5976 15.6823 13.8863 15.54 14.1245C15.4036 14.3529 15.1342 14.625 14.7301 14.625C14.326 14.625 14.0566 14.3529 13.9201 14.1245C13.7778 13.8863 13.7101 13.5976 13.7101 13.3125C13.7101 13.0274 13.7778 12.7387 13.9201 12.5005ZM7.96016 12.5005C8.09658 12.2721 8.36599 12 8.7701 12C9.17421 12 9.44362 12.2721 9.58004 12.5005C9.72234 12.7387 9.79011 13.0274 9.79011 13.3125C9.79011 13.5976 9.72234 13.8863 9.58004 14.1245C9.44362 14.3529 9.17421 14.625 8.7701 14.625C8.36599 14.625 8.09658 14.3529 7.96016 14.1245C7.81786 13.8863 7.75009 13.5976 7.75009 13.3125C7.75009 13.0274 7.81786 12.7387 7.96016 12.5005Z" fill="currentColor"/></svg>
        <span>我</span>
    </div>
</nav>
</div>

<!-- 新增：头像更换弹窗 (复用并修改自提供的示例) -->
<div id="me-avatar-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>更换论坛头像</h3>
        <form id="me-avatar-form">
            <div id="me-avatar-preview-modal" style="width: 100px; height: 100px; border: 2px dashed #ddd; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; color: #aaa; background-color: #f9f9f9; background-size: cover; background-position: center;">
                <span>预览</span>
            </div>
            <div class="form-group">
                <label for="me-avatar-url-input-modal">头像URL</label>
                <input type="url" id="me-avatar-url-input-modal" placeholder="粘贴图片URL">
            </div>
            <p style="text-align:center; color:#888; margin: -10px 0 15px;">或</p>
            <input type="file" id="me-avatar-file-upload-modal" accept="image/*" style="display:none;">
            <label for="me-avatar-file-upload-modal" class="btn btn-secondary" style="width:100%; margin-bottom: 20px;">从本地上传</label>
            
            <!-- 修改：去掉了取消按钮，只保留确认按钮 -->
            <button type="submit" class="btn btn-primary" style="width:100%; margin-top:0;">确认</button>
        </form>
    </div>
</div>


<div id="forum-post-detail-screen" class="screen">
    <!-- 1. 静态 Header -->
    <header class="app-header">
    <button class="back-btn" data-target="forum-screen">‹</button>
    <div class="title-container">
        <h1 class="title">详 情</h1>
    </div>
    <div class="action-btn-group" style="display: flex; gap: 5px;">
        <!-- 新增：收藏星标 -->
        <button class="action-btn" id="d-delete-btn" style="cursor: pointer;">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M19 7L18.1327 19.1425C18.0579 20.1891 17.187 21 16.1378 21H7.86224C6.81296 21 5.94208 20.1891 5.86732 19.1425L5 7M10 11V17M14 11V17M15 7V4C15 3.44772 14.5523 3 14 3H10C9.44772 3 9 3.44772 9 4V7M4 7H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
        </button>        
        <!-- 原有的分享按钮 -->        
        <!-- 原有的 AI 按钮 -->
        <button class="action-btn" id="detail-ai-btn" title="AI生成评论">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg>
        </button>
    </div>
</header>

    <!-- 2. 静态 Main (内容滚动区) -->
    <main class="content detail-content-area">
        <!-- 帖子主体容器 -->
        <div class="post-detail-container">
            <div class="post-detail-main">
                <!-- 新增：复制按钮 -->
                <button class="post-copy-btn" id="d-copy-btn" title="复制标题和正文">
                <svg viewBox="0 0 24 24">
            <path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z" />
        </svg>
                </button>
                <div class="post-author-info">
                    <div id="d-author-avatar" class="author-avatar">?</div>
                    <div class="author-details">
                        <span id="d-author-name" class="author-name">加载中...</span>
                        <span id="d-post-time" class="post-meta-data">...</span>
                    </div>
                </div>
                <h2 id="d-post-title" class="post-detail-title">...</h2>
                <div id="d-post-content" class="post-detail-content-body">...</div>
                
                <!-- 操作栏：赞和删除 -->
                <!-- 操作栏：删除、阅读、评论 -->
                <div class="post-detail-actions">
                                    <!-- 2. 阅读数 (原点赞，换成眼睛图标) -->
                <div class="action-item">
                        <!-- Eye Icon -->
                        <svg viewBox="0 0 24 24"><path d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z" /></svg>
                        <span id="d-like-count">0</span>
                    </div>


                    <!-- 2. 评论数 -->
                    <div class="action-item">
                        <svg viewBox="0 0 24 24"><path d="M20,8H4V6H20V8M18,10H6V12H18V10M16,14H8V16H16V14M22,4V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V4A2,2 0 0,1 4,2H20A2,2 0 0,1 22,4Z" /></svg>
                        <span id="d-comment-count">0</span>
                    </div>
                    
                    <div class="action-item" id="detail-star-btn" title="收藏" style="cursor: pointer;">
                   <svg viewBox="0 0 24 24"><path d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z"/></svg>
                        <span>收藏</span>
                    </div>
                    
                    <div class="action-item" id="detail-share-btn" title="分享" style="cursor: pointer;">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18,16.08C17.24,16.08 16.56,16.38 16.04,16.85L8.91,12.7C8.96,12.47 9,12.24 9,12C9,11.76 8.96,11.53 8.91,11.3L16.04,7.15C16.56,7.62 17.24,7.92 18,7.92C19.66,7.92 21,6.58 21,5C21,3.42 19.66,2 18,2C16.34,2 15,3.42 15,5C15,5.24 15.04,5.47 15.09,5.7L7.96,9.85C7.44,9.38 6.76,9.08 6,9.08C4.34,9.08 3,10.42 3,12C3,13.58 4.34,14.92 6,14.92C6.76,14.92 7.44,14.62 7.96,14.15L15.09,18.3C15.04,18.53 15,18.76 15,19C15,20.58 16.34,22 18,22C19.66,22 21,20.58 21,19C21,17.42 19.66,16.08 18,16.08Z"></path></svg>
                        <span>分享</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 评论列表容器 -->
        <div class="comments-section">
            <div class="comments-header">全部评论</div>
            <ul class="comment-list" id="detail-comment-list">
                <!-- JS 将在这里插入 li -->
            </ul>
        </div>
    </main>


    <!-- 3. 静态 Footer (固定回复栏) -->
    <div class="detail-reply-bar">
        <!-- 替换为复选框容器 -->
        <div style="display: flex; align-items: center; margin-right: 5px;">
            <input type="checkbox" id="reply-is-anon" style="width: 16px; height: 16px;">
            <label for="reply-is-anon" style="font-size: 16px; color: #666; margin-left: 4px; margin-bottom: 3px;white-space: nowrap;">匿名</label>
        </div>
        
        <input type="text" id="reply-content-input" class="reply-bar-input" placeholder="输入评论...">
        <button id="submit-reply-btn" class="reply-bar-btn">
            <svg viewBox="0 0 24 24"><path d="M2,21L23,12L2,3V10L17,12L2,14V21Z" /></svg>
        </button>
    </div>
</div>



<div id="storage-analysis-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="settings-screen">‹</button>
        <div class="title-container">
            <h1 class="title">存储分析</h1>
        </div>
        <div class="placeholder"></div>
    </header>
    <main class="content" style="flex-direction: column; justify-content: flex-start; padding: 20px; gap: 20px;">
        <div id="storage-chart-container" style="width: 100%; height: 300px; flex-shrink: 0;"></div>
        <div id="storage-total-size-container" style="text-align: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0; margin-bottom: 10px;">
            <span style="font-size: 14px; color: #888;">总占用空间</span>
            <h2 id="storage-total-size" style="margin: 4px 0 0 0; font-size: 24px; color: #333; font-weight: 600;">---</h2>
        </div>
        <div id="storage-details-list" style="width: 100%; overflow-y: auto;"></div>
    </main>
</div>


<div id="peek-messages-screen" class="screen">

        <header class="app-header">
            <button class="back-btn" data-target="peek-screen">‹</button>
            <div class="title-container">
                <h1 class="title">Ta的消息</h1>
            </div>
            <button class="action-btn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg>
            </button>
        </header>
        <main class="content">
            <ul class="list-container" id="peek-chat-list-container">
                <!-- Simulated chat list will be rendered here -->
            </ul>
        </main>
    </div>

    <!-- Peek Conversation Screen -->
    <div id="peek-conversation-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="peek-messages-screen">‹</button>
            <div class="title-container">
                <h1 class="title" id="peek-conversation-title">...</h1>
            </div>
            <button class="action-btn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg>
            </button>
        </header>
        <main class="content">
            <div class="message-area" id="peek-message-area">
                <!-- Simulated messages will be rendered here -->
            </div>
        </main>
    </div>

    <!-- Peek Memos Screen -->
    <div id="peek-memos-screen" class="screen"></div>

    <!-- Peek Memo Detail Screen -->
    <div id="peek-memo-detail-screen" class="screen"></div>

    <!-- Peek Cart Screen -->
    <div id="peek-cart-screen" class="screen"></div>

    <!-- Peek Transfer Station Screen -->
    <div id="peek-transfer-station-screen" class="screen"></div>

    <!-- Peek Browser Screen -->
    <div id="peek-browser-screen" class="screen"></div>

    <!-- Peek Drafts Screen -->
    <div id="peek-drafts-screen" class="screen"></div>

    <div id="peek-album-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="peek-screen">‹</button>
            <div class="title-container"><h1 class="title">相册</h1></div>
            <button class="action-btn" id="refresh-album-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg></button>
        </header>
        <main class="content">
            <div class="album-grid">
                <p class="placeholder-text">正在生成相册内容...</p>
            </div>
        </main>
    </div>
 
    <!-- Peek Unlock Screen (Social Media) -->
    <div id="peek-unlock-screen" class="screen">
        <!-- Content will be dynamically rendered by renderPeekUnlock() -->
    </div>
 
    <div id="peek-confirm-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>要偷看ta的手机吗？</h3>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="peek-confirm-yes" class="btn btn-primary" style="flex: 1;">是</button>
                <button id="peek-confirm-no" class="btn btn-neutral" style="flex: 1;">否</button>
            </div>
        </div>
    </div>
    <!-- New Peek Wallpaper Modal -->
    <div id="peek-wallpaper-modal" class="modal-overlay">
        <div class="modal-window" style="max-height: 80vh; overflow-y: auto;">
            <h3>“偷看”页面自定义</h3>
            <div class="collapsible-section open">
                <div class="collapsible-header">
                    <h4>页面壁纸</h4>
                    <span class="collapsible-arrow">▼</span>
                </div>
                <div class="collapsible-content">
                    <form id="peek-wallpaper-form">
                        <div class="form-group">
                            <label for="peek-wallpaper-url-input">壁纸URL</label>
                            <input type="url" id="peek-wallpaper-url-input" class="form-group" placeholder="粘贴图片URL">
                        </div>
                        <p style="text-align:center; color:#888; margin: -10px 0 15px;">或</p>
                        <input type="file" id="peek-wallpaper-upload" accept="image/*" style="display: none;">
                        <label for="peek-wallpaper-upload" class="btn btn-secondary">从本地上传</label>
                    </form>
                </div>
            </div>
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h4>应用图标</h4>
                    <span class="collapsible-arrow">▼</span>
                </div>
                <div class="collapsible-content" id="peek-app-icons-settings">
                    <!-- App icon settings will be rendered here by JS -->
                </div>
            </div>
             <div class="collapsible-section">
                <div class="collapsible-header">
                    <h4>微博(Unlock)小号</h4>
                    <span class="collapsible-arrow">▼</span>
                </div>
                <div class="collapsible-content">
                    <div class="form-group">
                        <label for="peek-unlock-avatar-url">头像URL</label>
                        <input type="url" id="peek-unlock-avatar-url" class="form-group" placeholder="粘贴图片URL">
                    </div>
                </div>
            </div>
            <button id="save-peek-settings-btn" class="btn btn-primary" style="margin-top: 20px;">保存所有更改</button>
        </div>
    </div>
<div id="pomodoro-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="home-screen">‹</button>
        <div class="title-container">
            <h1 class="title">专注任务</h1>
        </div>
        <div class="action-btn-group">
            <button class="action-btn" id="pomodoro-settings-btn" title="设置">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.44,0.17-0.48,0.41L9.2,5.77C8.61,6.01,8.08,6.33,7.58,6.71L5.19,5.75C4.97,5.68,4.72,5.75,4.6,5.97L2.68,9.29 c-0.11,0.2-0.06,0.47,0.12,0.61l2.03,1.58C4.78,11.66,4.76,11.97,4.76,12.3c0,0.32,0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.04,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.48-0.41l0.36-2.54c0.59-0.24,1.12-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0.01,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
            </button>
            <button class="action-btn" id="pomodoro-create-task-btn" title="创建任务">+</button>
        </div>
    </header>
    <main class="content">
        <div class="task-list-container" id="pomodoro-task-list">
            <!-- Task cards will be rendered here by JS -->
        </div>
        <p class="placeholder-text" id="pomodoro-no-tasks-placeholder">还没有专注任务，点击右上角“+”创建一个吧。</p>
    </main>
</div>
<!-- Pomodoro Focus Screen -->
<div id="pomodoro-focus-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="pomodoro-screen">‹</button>
        <div class="title-container">
            <h1 class="title">专注中</h1>
        </div>
        <div class="action-btn-group">
            <button class="action-btn" id="pomodoro-focus-settings-btn" title="设置">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.44,0.17-0.48,0.41L9.2,5.77C8.61,6.01,8.08,6.33,7.58,6.71L5.19,5.75C4.97,5.68,4.72,5.75,4.6,5.97L2.68,9.29 c-0.11,0.2-0.06,0.47,0.12,0.61l2.03,1.58C4.78,11.66,4.76,11.97,4.76,12.3c0,0.32,0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.04,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.48-0.41l0.36-2.54c0.59-0.24,1.12-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0.01,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
            </button>
        </div>
    </header>
    <main class="content">
        <div class="focus-timer-container">
            <h2 class="focus-task-title">阅读一章《JavaScript高级程序设计》</h2>
            <div class="focus-timer-display">24:32</div>
            <div class="focus-timer-mode">倒计时</div>
            <div class="focus-total-time" id="pomodoro-total-focused-time">已专注 0 分钟</div>
        </div>

        <div class="focus-footer">
            <div class="focus-message-bubble">
                <p>保持专注，你做得很好！</p>
            </div>
            <div class="focus-bottom-controls">
                <div class="focus-controls-group">
                    <button class="control-btn" id="pomodoro-start-btn" title="开始">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                    </button>
                    <button class="control-btn" id="pomodoro-pause-btn" title="暂停" style="display: none;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
                    </button>
                </div>
                <img src="https://i.postimg.cc/Y96LPskq/o-o-2.jpg" class="focus-avatar" alt="avatar">
                <button class="control-btn" id="pomodoro-giveup-btn" title="放弃">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
        </div>
    </main>
</div>

<!-- Pomodoro Settings Sidebar -->
<div id="pomodoro-settings-sidebar" class="settings-sidebar">
    <div class="header">专注设置</div>
    <div class="content">
        <form id="pomodoro-settings-form">
            <div class="form-group">
                <label for="pomodoro-char-select">绑定陪伴角色</label>
                <select id="pomodoro-char-select" class="form-group"></select>
            </div>
            <div class="form-group">
                <label for="pomodoro-user-persona-select">选择你的设定</label>
                <select id="pomodoro-user-persona-select" class="form-group"></select>
            </div>
            <hr>
            <div class="form-group">
                <label for="pomodoro-encouragement-minutes">鼓励机制 (分钟)</label>
                <input type="number" id="pomodoro-encouragement-minutes" class="form-group" placeholder="专注多少分钟后收到鼓励" min="1">
            </div>
            <div class="form-group">
                <label for="pomodoro-poke-limit">“戳一戳”次数上限</label>
                <input type="number" id="pomodoro-poke-limit" class="form-group" placeholder="每次专注允许戳几次" min="0">
            </div>
            <hr>
            <div class="form-group">
                <label for="pomodoro-focus-bg-url">专注界面背景 URL</label>
                <input type="url" id="pomodoro-focus-bg-url" class="form-group" placeholder="粘贴图片URL">
            </div>
            <div class="form-group">
                <label for="pomodoro-focus-bg-upload" class="btn btn-secondary">或从本地上传</label>
                <input type="file" id="pomodoro-focus-bg-upload" accept="image/*" style="display:none;">
            </div>
            <hr>
            <div class="form-group">
                <label for="pomodoro-task-card-bg-url">任务卡片背景 URL</label>
                <input type="url" id="pomodoro-task-card-bg-url" class="form-group" placeholder="粘贴图片URL">
            </div>
            <div class="form-group">
                <label for="pomodoro-task-card-bg-upload" class="btn btn-secondary">或从本地上传</label>
                <input type="file" id="pomodoro-task-card-bg-upload" accept="image/*" style="display:none;">
            </div>
            <button type="submit" class="btn btn-primary" style="margin-top: 20px;">保存设置</button>
        </form>
    </div>
</div>

<!-- Pomodoro Global Settings Sidebar -->
<div id="pomodoro-global-settings-sidebar" class="settings-sidebar">
    <div class="header">全局专注设置</div>
    <div class="content">
        <form id="pomodoro-global-settings-form">
            <div class="form-group">
                <button type="button" class="btn btn-secondary" id="link-global-pomodoro-world-book-btn">关联世界书</button>
            </div>
            <p style="font-size: 12px; color: #888; margin-top: 15px;">
                这里关联的世界书将作为全局上下文，作用于所有番茄钟任务的AI互动。
            </p>
        </form>
    </div>
</div>

<!-- Pomodoro Certificate Modal -->
<div id="pomodoro-certificate-modal" class="modal-overlay">
    <div class="modal-window" style="text-align: center;">
        <h3>专注完成！</h3>
        <div id="pomodoro-certificate-content" style="border: 2px dashed var(--primary-color); padding: 20px; margin: 15px 0; border-radius: 10px; background: #F5FBFF;">
            <p><strong>任务名称:</strong> <span id="cert-task-name"></span></p>
            <p><strong>专注时长:</strong> <span id="cert-duration"></span></p>
            <p><strong>“戳一戳”次数:</strong> <span id="cert-poke-count"></span></p>
        </div>
        <p>做的很棒！要不要把这次的专注成果分享一下？</p>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button id="forward-certificate-btn" class="btn btn-primary" style="flex: 1;">转发到聊天框</button>
            <button id="close-certificate-btn" class="btn btn-neutral" style="flex: 1;">关闭</button>
        </div>
    </div>
</div>

<!-- Pomodoro Record Detail Modal -->

<!-- Pomodoro Create Task Modal -->
<div id="pomodoro-create-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>创建专注任务</h3>
        <form id="pomodoro-create-form">
            <div class="form-group">
                <label for="pomodoro-task-name">任务名称</label>
                <input type="text" id="pomodoro-task-name" class="form-group" placeholder="例如：阅读一章《JavaScript高级程序设计》" required>
            </div>
            <div class="form-group">
                <label>计时模式</label>
                <div class="radio-group-pills">
                    <input type="radio" id="mode-countdown" name="pomodoro-mode" value="countdown" checked>
                    <label for="mode-countdown">倒计时</label>
                    <input type="radio" id="mode-stopwatch" name="pomodoro-mode" value="stopwatch">
                    <label for="mode-stopwatch">正计时</label>
                </div>
            </div>
            <div id="pomodoro-duration-options" class="visible">
                <button type="button" class="duration-pill active" data-duration="30">30分钟</button>
                <button type="button" class="duration-pill" data-duration="45">45分钟</button>
                <button type="button" class="duration-pill" data-duration="60">60分钟</button>
                <button type="button" class="duration-pill" data-duration="custom">自定义</button>
                <input type="number" id="pomodoro-custom-duration-input" class="form-group" placeholder="输入分钟数">
            </div>
            <button type="submit" class="btn btn-primary" style="margin-top: 20px;">创建任务</button>
        </form>
    </div>
</div>
    <div id="peek-photo-modal" class="modal-overlay">
        <div class="modal-window">
            <div id="peek-photo-image-container">
                <span class="placeholder-icon">🖼️</span>
            </div>
            <div id="peek-photo-description"></div>
        </div>
    </div>
</div>
 

    <div id="forum-binding-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>绑定上下文</h3>
            <div class="forum-binding-tabs">
                <button class="tab-btn active" data-target="binding-content-worldbook">世界书</button>
                <button class="tab-btn" data-target="binding-content-char">char</button>
                <button class="tab-btn" data-target="binding-content-user">user</button>
            </div>
            <div id="forum-binding-content-wrapper">
                <div id="binding-content-worldbook" class="forum-binding-content active">
                    <ul id="forum-worldbook-list" class="binding-list"></ul>
                </div>
                <div id="binding-content-char" class="forum-binding-content">
                    <ul id="forum-char-list" class="binding-list"></ul>
                </div>
                <div id="binding-content-user" class="forum-binding-content">
                    <ul id="forum-user-list" class="binding-list"></ul>
                </div>
            </div>
            <button id="confirm-forum-binding-btn" class="btn btn-primary" style="margin-top: 20px;">确认绑定</button>
        </div>
    </div>

<!-- 新增：手动发帖弹窗 -->
<div id="forum-create-post-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>发布新帖</h3>
        
        <div class="form-group" style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
            <input type="checkbox" id="create-post-is-anon" style="width: auto;">
            <label for="create-post-is-anon" style="margin: 0; user-select: none;">使用匿名发布 (隐藏身份)</label>
        </div>

        <div class="form-group">
            <input type="text" id="create-post-title" placeholder="帖子标题" maxlength="30">
        </div>
        <div class="form-group">
            <textarea id="create-post-content" placeholder="分享你的想法..." rows="5"></textarea>
        </div>
        
        <!-- 修改：去掉了取消按钮，只保留发布按钮 -->
        <button class="btn btn-primary" id="confirm-create-post-btn" style="width: 100%; margin-top: 10px;">发布</button>
    </div>
</div>


<!-- Generate Journal Modal -->
<div id="generate-journal-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>指定总结范围</h3>
        <form id="generate-journal-form">
            <div id="journal-range-info" style="font-size: 12px; color: #888; text-align: center; margin-bottom: 15px;"></div>
            <div class="form-group">
                <label for="journal-range-start">起始消息 (序号)</label>
                <input type="number" id="journal-range-start" placeholder="例如：1" required>
            </div>
            <div class="form-group">
                <label for="journal-range-end">结束消息 (序号)</label>
                <input type="number" id="journal-range-end" placeholder="例如：100" required>
            </div>
            <button type="submit" class="btn btn-primary">生成</button>
        </form>
    </div>
</div>

<!-- Journal World Book Selection Modal -->
<div id="journal-worldbook-selection-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>为日记绑定世界书</h3>
        <ul id="journal-worldbook-selection-list" class="list-container" style="max-height: 40vh; overflow-y: auto; padding: 0; margin: 15px 0;">
            <!-- World book items will be rendered here -->
        </ul>
        <button class="btn btn-primary" id="save-journal-worldbook-selection-btn" style="margin-top: 20px;">确认</button>
    </div>
</div>

<!-- NEW: Delete History Chunk Modals -->
<div id="delete-chunk-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>删除指定范围记录</h3>
        <form id="delete-chunk-form">
            <div id="delete-chunk-range-info" style="font-size: 12px; color: #888; text-align: center; margin-bottom: 15px;"></div>
            <div class="form-group">
                <label for="delete-range-start">起始消息 (序号)</label>
                <input type="number" id="delete-range-start" placeholder="例如：1" required>
            </div>
            <div class="form-group">
                <label for="delete-range-end">结束消息 (序号)</label>
                <input type="number" id="delete-range-end" placeholder="例如：100" required>
            </div>
            <button type="submit" class="btn btn-primary">下一步</button>
        </form>
    </div>
</div>

<div id="share-post-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>分享帖子给角色</h3>
        <!-- 新增：评论数量设置 -->
        <div class="form-group" style="margin-bottom: 10px;">
            <label style="font-size:13px; color:#666;">包含最新评论条数</label>
            <input type="number" id="share-comment-count-input" value="30" min="0" max="100" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 8px;">
        </div>

        <div style="max-height: 250px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 5px; margin-bottom: 15px;">
            <ul id="share-char-list" class="binding-list">
                <!-- JS 填充 -->
            </ul>
        </div>
        <button id="confirm-share-btn" class="btn btn-primary" style="width:100%">发送</button>
    </div>
</div>


<div id="delete-chunk-confirm-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>确认删除</h3>
        <p>将永久删除以下范围的消息，此操作不可撤销！</p>
        <div id="delete-chunk-preview" style="max-height: 200px; overflow-y: auto; background: #f5f5f5; border-radius: 8px; padding: 10px; margin: 15px 0; font-size: 12px; line-height: 1.5;">
            <!-- Preview will be inserted here -->
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button id="confirm-delete-chunk-btn" class="btn btn-danger" style="flex: 1;">永久删除</button>
            <button id="cancel-delete-chunk-btn" class="btn btn-neutral" style="flex: 1;">取消</button>
        </div>
    </div>
</div>

<div id="bubble-presets-modal" class="modal-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);justify-content:center;align-items:center;z-index:9999;"><div class="modal-window" style="max-width:520px;background:var(--panel-bg,#fff);padding:14px;border-radius:10px;box-shadow:0 12px 36px rgba(10,10,20,0.12);"><h3 style="margin:0 0 10px 0;font-size:16px;">管理气泡预设</h3><div id="bubble-presets-list" style="max-height:340px; overflow:auto; margin-bottom:12px;"></div><div style="display:flex;gap:8px;justify-content:flex-end;"><button type="button" id="close-presets-modal" class="btn btn-primary" style="padding:8px 12px;border-radius:8px;">关闭</button></div></div></div>
<div id="mypersona-presets-modal" class="modal-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);justify-content:center;align-items:center;z-index:9999;"><div class="modal-window" style="max-width:520px;background:var(--panel-bg,#fff);padding:14px;border-radius:10px;box-shadow:0 12px 36px rgba(10,10,20,0.12);"><h3 style="margin:0 0 10px 0;font-size:16px;">管理我的人设预设</h3><div id="mypersona-presets-list" style="max-height:340px; overflow:auto; margin-bottom:12px;"></div><div style="display:flex;gap:8px;justify-content:flex-end;"><button type="button" id="mypersona-close-modal" class="btn btn-primary" style="padding:8px 12px;border-radius:8px;">关闭</button></div></div></div>
<div id="global-css-presets-modal" class="modal-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);justify-content:center;align-items:center;z-index:9999;"><div class="modal-window" style="max-width:520px;background:var(--panel-bg,#fff);padding:14px;border-radius:10px;box-shadow:0 12px 36px rgba(10,10,20,0.12);"><h3 style="margin:0 0 10px 0;font-size:16px;">管理全局CSS预设</h3><div id="global-css-presets-list" style="max-height:340px; overflow:auto; margin-bottom:12px;"></div><div style="display:flex;gap:8px;justify-content:flex-end;"><button type="button" id="global-css-close-modal" class="btn btn-primary" style="padding:8px 12px;border-radius:8px;">关闭</button></div></div></div>
<input type="file" id="import-data-input" accept=".ee" style="display: none;">
<div id="storage-screen" class="screen"></div>
<input type="file" id="character-card-input" accept="image/png,application/json" style="display: none;">
<!-- INS Widget Avatar Modal -->
<div id="ins-widget-avatar-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>更换头像</h3>
        <form id="ins-widget-avatar-form">
            <input type="hidden" id="ins-widget-avatar-target">
            <div id="ins-widget-avatar-preview" style="width: 100px; height: 100px; border: 2px dashed #ddd; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; color: #aaa; background-color: #f9f9f9; background-size: cover; background-position: center;">
                <span>预览</span>
            </div>
            <div class="form-group">
                <label for="ins-widget-avatar-url-input">头像URL</label>
                <input type="url" id="ins-widget-avatar-url-input" class="form-group" placeholder="粘贴图片URL">
            </div>
            <p style="text-align:center; color:#888; margin: -10px 0 15px;">或</p>
            <input type="file" id="ins-widget-avatar-file-upload" accept="image/*" style="display:none;">
            <label for="ins-widget-avatar-file-upload" class="btn btn-secondary" style="width:100%; margin-bottom: 20px;">从本地上传</label>
            <button type="submit" class="btn btn-primary">保存</button>
        </form>
    </div>
</div>
    <!-- Update Log Modal -->
    <div id="update-log-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>发现新版本！</h3>
            <div id="update-log-modal-content">
                <!-- Update content will be injected here -->
            </div>
            <button id="close-update-log-modal" class="btn btn-primary" style="margin-top: 15px;">我知道了</button>
        </div>
    </div>
    </div>




<script>
// 这是猫代码的第一行默认图标定义
// 蓝色部分固定为 rgb(129, 175, 217)
// 脸部部分改为 currentColor (跟随 CSS color 变化)
const FORUM_SVG_CODE = `
<svg class="icon-img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
    <!-- 外圈和身体 (固定蓝色) -->
    <path d="M18,2.5a1.52,1.52,0,0,0-.84.26L14.24,2a1,1,0,0,0-1.19.65l-2,6A1,1,0,0,0,11.68,10,1.25,1.25,0,0,0,12,10,1,1,0,0,0,13,9.32l1.71-5.13,2,.51A1.5,1.5,0,1,0,18,2.5Z" fill="rgb(129, 175, 217)"></path>
    
    <!-- 脸部 (原来的白色，现在设为 currentColor) -->
    <path d="M22,11a4,4,0,0,0-4-4,4,4,0,0,0-3,1.33A14.17,14.17,0,0,0,9,8.33,4,4,0,0,0,6,7a4,4,0,0,0-4,4,3.93,3.93,0,0,0,.47,1.87A5.15,5.15,0,0,0,2,15c0,3.92,4.39,7,10,7s10-3.08,10-7a5.15,5.15,0,0,0-.47-2.13A3.93,3.93,0,0,0,22,11Z" fill="currentColor"></path>
    
    <!-- 脸颊细节 (固定蓝色) -->
    <path d="M10,14a1.5,1.5,0,1,1-1.5-1.5A1.5,1.5,0,0,1,10,14Zm5.5-1.5A1.5,1.5,0,1,0,17,14,1.5,1.5,0,0,0,15.5,12.5Z" fill="rgb(129, 175, 217)"></path>
</svg>
`;

// 1. 聊天 (Chat)
// 原白色部分 -> currentColor (带0.9透明度)
// 原蓝色部分 -> #81AFD9 固定
const CHAT_SVG_CODE = `
<svg class="icon-img" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path opacity="1" d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 13.5997 2.37562 15.1116 3.04346 16.4525C3.22094 16.8088 3.28001 17.2161 3.17712 17.6006L2.58151 19.8267C2.32295 20.793 3.20701 21.677 4.17335 21.4185L6.39939 20.8229C6.78393 20.72 7.19121 20.7791 7.54753 20.9565C8.88837 21.6244 10.4003 22 12 22Z" fill="currentColor"/>
    <path opacity="1" d="M7.5 11.1093C7.5 12.4777 8.81884 13.9135 10.0286 14.9426C10.8524 15.6435 11.2644 15.9939 12 15.9939C12.7356 15.9939 13.1476 15.6435 13.9714 14.9426C15.1812 13.9135 16.5 12.4777 16.5 11.1093C16.5 8.43212 14.0249 7.4326 12 9.50069C9.97507 7.4326 7.5 8.43212 7.5 11.1093Z" fill="#81AFD9"/>
</svg>`;

// 2. 番茄钟 (Pomodoro)
const POMODORO_SVG_CODE = `
<svg class="icon-img" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path opacity="1" d="M11.9998 21.9997C16.836 21.9997 20.7565 18.1159 20.7565 13.325C20.7565 8.53417 16.836 4.65039 11.9998 4.65039C7.16366 4.65039 3.24316 8.53417 3.24316 13.325C3.24316 18.1159 7.16366 21.9997 11.9998 21.9997Z" fill="currentColor"/>
    <path d="M11.9993 8.74707C12.4023 8.74707 12.729 9.07072 12.729 9.46996V13.0259L14.9477 15.2238C15.2326 15.5061 15.2326 15.9638 14.9477 16.2461C14.6627 16.5285 14.2006 16.5285 13.9157 16.2461L11.4833 13.8365C11.3464 13.701 11.2695 13.5171 11.2695 13.3254V9.46996C11.2695 9.07072 11.5962 8.74707 11.9993 8.74707Z" fill="#81AFD9"/>
    <path fill-rule="evenodd" clip-rule="evenodd" d="M8.2405 2.33986C8.45409 2.67841 8.3502 3.1244 8.00844 3.33599L4.11657 5.74562C3.77481 5.95722 3.32461 5.8543 3.11102 5.51574C2.89742 5.17718 3.00131 4.7312 3.34307 4.5196L7.23494 2.10998C7.5767 1.89838 8.0269 2.0013 8.2405 2.33986Z" fill="#81AFD9"/>
    <path fill-rule="evenodd" clip-rule="evenodd" d="M15.7595 2.33985C15.9731 2.0013 16.4233 1.89838 16.7651 2.10998L20.6569 4.5196C20.9987 4.7312 21.1026 5.17719 20.889 5.51574C20.6754 5.8543 20.2252 5.95722 19.8834 5.74562L15.9916 3.33599C15.6498 3.1244 15.5459 2.67841 15.7595 2.33985Z" fill="#81AFD9"/>
</svg>`;

// 3. 世界书 (World Book)
const WORLDBOOK_SVG_CODE = `
<svg class="icon-img" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path opacity="1" d="M21.6602 10.44L20.6802 14.62C19.8402 18.23 18.1802 19.69 15.0602 19.39C14.5602 19.35 14.0202 19.26 13.4402 19.12L11.7602 18.72C7.59018 17.73 6.30018 15.67 7.28018 11.49L8.26018 7.30001C8.46018 6.45001 8.70018 5.71001 9.00018 5.10001C10.1702 2.68001 12.1602 2.03001 15.5002 2.82001L17.1702 3.21001C21.3602 4.19001 22.6402 6.26001 21.6602 10.44Z" fill="currentColor"/>
    <path d="M15.0603 19.3901C14.4403 19.8101 13.6603 20.1601 12.7103 20.4701L11.1303 20.9901C7.16034 22.2701 5.07034 21.2001 3.78034 17.2301L2.50034 13.2801C1.22034 9.3101 2.28034 7.2101 6.25034 5.9301L7.83034 5.4101C8.24034 5.2801 8.63034 5.1701 9.00034 5.1001C8.70034 5.7101 8.46034 6.4501 8.26034 7.3001L7.28034 11.4901C6.30034 15.6701 7.59034 17.7301 11.7603 18.7201L13.4403 19.1201C14.0203 19.2601 14.5603 19.3501 15.0603 19.3901Z" fill="#81AFD9"/>
    <path d="M17.4894 10.51C17.4294 10.51 17.3694 10.5 17.2994 10.49L12.4494 9.26002C12.0494 9.16002 11.8094 8.75002 11.9094 8.35002C12.0094 7.95002 12.4194 7.71002 12.8194 7.81002L17.6694 9.04002C18.0694 9.14002 18.3094 9.55002 18.2094 9.95002C18.1294 10.28 17.8194 10.51 17.4894 10.51Z" fill="#81AFD9"/>
    <path d="M14.5592 13.8899C14.4992 13.8899 14.4392 13.8799 14.3692 13.8699L11.4592 13.1299C11.0592 13.0299 10.8192 12.6199 10.9192 12.2199C11.0192 11.8199 11.4292 11.5799 11.8292 11.6799L14.7392 12.4199C15.1392 12.5199 15.3792 12.9299 15.2792 13.3299C15.1992 13.6699 14.8992 13.8899 14.5592 13.8899Z" fill="#81AFD9"/>
</svg>`;

// 4. 设置 (Settings)
const SETTINGS_SVG_CODE = `
<svg class="icon-img" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path opacity="1" fill-rule="evenodd" clip-rule="evenodd" d="M14.2788 2.15224C13.9085 2 13.439 2 12.5 2C11.561 2 11.0915 2 10.7212 2.15224C10.2274 2.35523 9.83509 2.74458 9.63056 3.23463C9.53719 3.45834 9.50065 3.7185 9.48635 4.09799C9.46534 4.65568 9.17716 5.17189 8.69017 5.45093C8.20318 5.72996 7.60864 5.71954 7.11149 5.45876C6.77318 5.2813 6.52789 5.18262 6.28599 5.15102C5.75609 5.08178 5.22018 5.22429 4.79616 5.5472C4.47814 5.78938 4.24339 6.1929 3.7739 6.99993C3.30441 7.80697 3.06967 8.21048 3.01735 8.60491C2.94758 9.1308 3.09118 9.66266 3.41655 10.0835C3.56506 10.2756 3.77377 10.437 4.0977 10.639C4.57391 10.936 4.88032 11.4419 4.88029 12C4.88026 12.5581 4.57386 13.0639 4.0977 13.3608C3.77372 13.5629 3.56497 13.7244 3.41645 13.9165C3.09108 14.3373 2.94749 14.8691 3.01725 15.395C3.06957 15.7894 3.30432 16.193 3.7738 17C4.24329 17.807 4.47804 18.2106 4.79606 18.4527C5.22008 18.7756 5.75599 18.9181 6.28589 18.8489C6.52778 18.8173 6.77305 18.7186 7.11133 18.5412C7.60852 18.2804 8.2031 18.27 8.69012 18.549C9.17714 18.8281 9.46533 19.3443 9.48635 19.9021C9.50065 20.2815 9.53719 20.5417 9.63056 20.7654C9.83509 21.2554 10.2274 21.6448 10.7212 21.8478C11.0915 22 11.561 22 12.5 22C13.439 22 13.9085 22 14.2788 21.8478C14.7726 21.6448 15.1649 21.2554 15.3694 20.7654C15.4628 20.5417 15.4994 20.2815 15.5137 19.902C15.5347 19.3443 15.8228 18.8281 16.3098 18.549C16.7968 18.2699 17.3914 18.2804 17.8886 18.5412C18.2269 18.7186 18.4721 18.8172 18.714 18.8488C19.2439 18.9181 19.7798 18.7756 20.2038 18.4527C20.5219 18.2105 20.7566 17.807 21.2261 16.9999C21.6956 16.1929 21.9303 15.7894 21.9827 15.395C22.0524 14.8691 21.9088 14.3372 21.5835 13.9164C21.4349 13.7243 21.2262 13.5628 20.9022 13.3608C20.4261 13.0639 20.1197 12.558 20.1197 11.9999C20.1197 11.4418 20.4261 10.9361 20.9022 10.6392C21.2263 10.4371 21.435 10.2757 21.5836 10.0835C21.9089 9.66273 22.0525 9.13087 21.9828 8.60497C21.9304 8.21055 21.6957 7.80703 21.2262 7C20.7567 6.19297 20.522 5.78945 20.2039 5.54727C19.7799 5.22436 19.244 5.08185 18.7141 5.15109C18.4722 5.18269 18.2269 5.28136 17.8887 5.4588C17.3915 5.71959 16.7969 5.73002 16.3099 5.45096C15.8229 5.17191 15.5347 4.65566 15.5136 4.09794C15.4993 3.71848 15.4628 3.45833 15.3694 3.23463C15.1649 2.74458 14.7726 2.35523 14.2788 2.15224Z" fill="currentColor"/>
    <path d="M15.5227 12C15.5227 13.6569 14.1694 15 12.4999 15C10.8304 15 9.47705 13.6569 9.47705 12C9.47705 10.3431 10.8304 9 12.4999 9C14.1694 9 15.5227 10.3431 15.5227 12Z" fill="#81AFD9"/>
</svg>`;

    async function updateBatteryStatus() {
        // 首先检查浏览器是否支持电池API
        if ('getBattery' in navigator) {
            try {
                // 异步获取电池状态管理器
                const battery = await navigator.getBattery();        // 获取相关的HTML元素
            const batteryLevelText = document.getElementById('battery-level');
            const batteryFillRect = document.getElementById('battery-fill-rect');
    
            // 创建一个内部函数，用于更新显示
            const updateDisplay = () => {
                if (!batteryLevelText || !batteryFillRect) return;
    
                // 计算电量百分比
                const level = Math.floor(battery.level * 100);
                batteryLevelText.textContent = `${level}%`;
    
                // 根据电量更新SVG内部填充条的宽度
                // SVG内部填充区域总宽度是18，所以用电量百分比去乘以它
                batteryFillRect.setAttribute('width', 18 * battery.level);
    
                // 根据电量和充电状态改变颜色，更有细节感
                let fillColor = "currentColor"; // 默认颜色
                if (battery.charging) {
                    fillColor = "#4CAF50"; // 充电时显示绿色
                } else if (level <= 20) {
                    fillColor = "#f44336"; // 低电量时显示红色
                }
                batteryFillRect.setAttribute('fill', fillColor);
            };
    
            // 第一次加载时，立即更新一次
            updateDisplay();
    
            // 添加事件监听器，当电量变化或充电状态变化时，自动更新
            battery.addEventListener('levelchange', updateDisplay);
            battery.addEventListener('chargingchange', updateDisplay);
    
        } catch (error) {
            console.error('无法获取电池信息:', error);
            // 如果获取失败，就隐藏电池小部件
            const batteryWidget = document.querySelector('.widget-battery');
            if (batteryWidget) batteryWidget.style.display = 'none';
        }
    } else {
        console.log('您的浏览器不支持电池状态API。');
        // 如果浏览器不支持，也隐藏电池小部件
        const batteryWidget = document.querySelector('.widget-battery');
        if (batteryWidget) batteryWidget.style.display = 'none';
    }
    }
    
    
    // gemini如果是多个密钥, 那么随机获取一个
    function getRandomValue(str) {
        // 检查字符串是否包含逗号
        if (str.includes(',')) {
            // 用逗号分隔字符串并移除多余空格
            const arr = str.split(',').map(item => item.trim());
            // 生成随机索引 (0 到 arr.length-1)
            const randomIndex = Math.floor(Math.random() * arr.length);
            // 返回随机元素
            return arr[randomIndex];
        }
        // 没有逗号则直接返回原字符串
        return str;
    }

    document.addEventListener('DOMContentLoaded', () => {
        async function compressImage(file, options = {}) {
            const {
                quality = 0.8, maxWidth = 800, maxHeight = 800
            } = options;

            // --- 新增：处理GIF动图 ---
            // 如果文件是GIF，则不经过canvas压缩，直接返回原始文件数据以保留动画
            if (file.type === 'image/gif') {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
            }

            // --- 对其他静态图片（如PNG, JPG）进行压缩 ---
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onerror = reject;
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onerror = reject;
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxWidth) {
                                height = Math.round(height * (maxWidth / width));
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = Math.round(width * (maxHeight / height));
                                height = maxHeight;
                            }
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');

                        // 对于有透明背景的PNG图片，先填充一个白色背景
                        // 这样可以防止透明区域在转换成JPEG时变黑
                        if (file.type === 'image/png') {
                            ctx.fillStyle = '#FFFFFF'; // 白色背景
                            ctx.fillRect(0, 0, width, height);
                        }

                        ctx.drawImage(img, 0, 0, width, height);

                        // --- 关键修正：将输出格式改为 'image/jpeg' ---
                        // JPEG格式可以显著减小文件大小，避免浏览器处理超大Base64字符串时崩溃
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressedDataUrl);
                    };
                };
            });
        }

        // --- Initial HTML Injection ---
        document.getElementById('api-settings-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="settings-screen">‹</button><div class="title-container"><h1 class="title">API 设置</h1></div><div class="placeholder"></div></header><main class="content"><form id="api-form"><div class="form-group"><label for="api-provider">API 服务商</label><select id="api-provider" name="provider"><option value="newapi">NewAPI (自定义)</option><option value="deepseek">DeepSeek</option><option value="claude">Claude</option><option value="gemini">Gemini</option></select></div><div class="form-group"><label for="api-url">API 地址（后缀不用添加/v1）</label><input type="url" id="api-url" name="url" placeholder="选择服务商可自动填写" required></div><div class="form-group"><label for="api-key">密钥 (Key)</label><input type="password" id="api-key" name="key" placeholder="请输入你的API密钥" required></div><button type="button" class="btn btn-secondary" id="fetch-models-btn"><span class="btn-text">点击拉取模型</span><div class="spinner"></div></button><div class="form-group"><label for="api-model">选择模型</label><select id="api-model" name="model" required><option value="">请先拉取模型列表</option></select></div><div class="form-group" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #DAF0FC; border-radius: 10px; background-color: #F5FBFF;">
    <label for="time-perception-switch" style="margin-bottom: 0; color: var(--secondary-color); font-weight: 600;">时间感知加强</label>
    <input type="checkbox" id="time-perception-switch" style="width: auto; height: 20px; width: 20px;">
</div>
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #DAF0FC; border-radius: 10px; background-color: #F5FBFF; margin-top: 10px;">
    <label for="stream-switch" style="margin-bottom: 0; color: var(--secondary-color); font-weight: 600;">流式输出</label>
    <input type="checkbox" id="stream-switch" style="width: auto; height: 20px; width: 20px;">
</div>
<button type="submit" class="btn btn-primary" id="save-btn"><span class="btn-text">保 存</span><div class="spinner"></div></button></form><div class="api-presets-embedded" style="margin-top:12px;"><div id="api-presets-control" style="margin:12px 0;padding:12px;border-radius:8px;border:1px solid var(--border-color, #eee);background:var(--panel-bg, #fff);box-shadow:var(--panel-shadow, none);"><div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;"><label style="min-width:86px;color:var(--muted,#666);">API 预设：</label><select id="api-preset-select" style="flex:1;padding:8px;border-radius:6px;border:1px solid #ddd;"><option value="">— 选择 API 预设 —</option></select><button id="api-apply-preset" class="btn btn-primary" style="margin-left:8px;padding:6px 10px;">应用</button></div><div style="display:flex;gap:8px;align-items:center;"><button id="api-save-preset" class="btn" style="padding:6px 10px;">另存为</button><button id="api-manage-presets" class="btn" style="padding:6px 10px;">管理</button><div style="flex:1"></div><button id="api-import-presets" class="btn" style="padding:6px 10px;">导入</button><button id="api-export-presets" class="btn" style="padding:6px 10px;">导出</button></div></div><div id="api-presets-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:9999;align-items:center;justify-content:center;"><div style="width:640px;max-width:94%;background:var(--panel-bg,#fff);padding:16px;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.12);"><h3 style="margin:0 0 12px 0;">API 预设管理</h3><div id="api-presets-list" style="max-height:360px;overflow:auto;border:1px solid #f0f0f0;padding:8px;border-radius:6px;"></div><div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;"><button id="api-close-modal" class="btn btn-primary">关闭</button></div></div></div></div></main>`;
        document.getElementById('wallpaper-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="settings-screen">‹</button><div class="title-container"><h1 class="title">更换壁纸</h1></div><div class="placeholder"></div></header><main class="content"><div class="wallpaper-preview" id="wallpaper-preview"><span>当前壁纸预览</span></div><input type="file" id="wallpaper-upload" accept="image/*" style="display: none;"><label for="wallpaper-upload" class="btn btn-primary">从相册选择新壁纸</label></main>`;
        document.getElementById('font-settings-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="settings-screen">‹</button><div class="title-container"><h1 class="title">字体设置</h1></div><div class="placeholder"></div></header><main class="content"><form id="font-settings-form"><div class="form-group"><label for="font-url">字体链接 (ttf, woff, woff2)</label><input type="url" id="font-url" placeholder="https://.../font.ttf" required></div><p style="font-size:12px; color:#888; text-align:center;">示例: https://cdn.jsdelivr.net/npm/@fontsource/zcool-kuaile/files/zcool-kuaile-chinese-simplified-400-normal.woff2</p><button type="submit" class="btn btn-primary">应用字体</button><button type="button" class="btn btn-neutral" id="restore-default-font-btn" style="margin-top: 15px;">恢复默认字体</button></form></main>`;
        document.getElementById('customize-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="settings-screen">‹</button><div class="title-container"><h1 class="title">主屏幕自定义</h1></div><div class="placeholder"></div></header><main class="content"><form id="customize-form"></form></main>`;
        document.getElementById('tutorial-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="settings-screen">‹</button><div class="title-container"><h1 class="title">教程与备份</h1></div><div class="placeholder"></div></header><main class="content" id="tutorial-content-area"></main>`;

        // --- Global Variables and Constants ---
        const colorThemes = {
            'white_blue': {
                name: '白/蓝',
                received: {bg: '#FFFFFF', text: '#1D1F21'},
                sent: {bg: '#0099FF', text: '#FFFFFF'}
            },
            'white_pink': {
                name: '白/粉',
                received: {bg: 'rgba(255,255,255,1)', text: '#1D1F21'},
                sent: {bg: '#FF80AB', text: '#FFFFFF'}
            },            
            
            'white_yellow': {
                name: '白/橙',
                received: {bg: 'rgba(255,255,255,1)', text: '#1D1F21'},
                sent: {bg: '#FA7D00', text: '#FFFFFF'}
            },
            'white_green': {
                name: '白/绿',
                received: {bg: 'rgba(255,255,255,1)', text: '#1D1F21'},
                sent: {bg: '#3E9653', text: '#FFFFFF'}
            },
            'white_purple': {
                name: '白/紫',
                received: {bg: 'rgba(255,255,255,1)', text: '#1D1F21'},
                sent: {bg: '#405EDB', text: '#FFFFFF'}
            },
        };
        const defaultWidgetSettings = {
            centralCircleImage: 'https://i.postimg.cc/mD83gR29/avatar-1.jpg',
            
        };
        const defaultIcons = { 
     // 聊天
    'chat-list-screen': { 
        name: '聊天', 
        url: './chat.svg', 
        svgCode: CHAT_SVG_CODE 
    },
    
    // 番茄钟
    'pomodoro-screen': { 
        name: '番茄钟', 
        url: './pomodoro.svg',
        svgCode: POMODORO_SVG_CODE 
    },
    
    // 世界书
    'world-book-screen': { 
        name: '世界书', 
        url: './worldbook.svg',
        svgCode: WORLDBOOK_SVG_CODE 
    },
    
    // 设置
    'settings-screen': { 
        name: '设置', 
        url: './settings.svg',
        svgCode: SETTINGS_SVG_CODE 
    },
          'api-settings-screen': {name: 'api', url: 'https://i.postimg.cc/50FqT8GL/chan-125.png'},
          'wallpaper-screen': {name: '壁纸', url: 'https://i.postimg.cc/VvQB8dQT/chan-143.png'},
          'customize-screen': {name: '自定义', url: 'https://i.postimg.cc/vZVdC7gt/chan-133.png'},
          'font-settings-screen': {name: '字体', url: 'https://i.postimg.cc/FzVtC0x4/chan-21.png'},
          'tutorial-screen': {name: '教程', url: 'https://i.postimg.cc/6QgNzCFf/chan-118.png'},
          'day-mode-btn': {name: '白昼模式', url: 'https://i.postimg.cc/Jz0tYqnT/chan-145.png'},
          'night-mode-btn': {name: '夜间模式', url: 'https://i.postimg.cc/htYvkdQK/chan-146.png'},
          'forum-screen': {name: '喵坛', url: './forum.svg', svgCode: FORUM_SVG_CODE},
          'diary-screen': {name: '日记本', url: 'https://i.postimg.cc/ydd65txK/1758451018266.png'},
          'piggy-bank-screen': {name: '存钱罐', url: 'https://i.postimg.cc/3RmWRRtS/chan-18.png'},
          'storage-analysis-screen': {name: '存储分析', url: 'https://i.postimg.cc/J0F3Lt0T/chan-107.png'}
        };


        const peekScreenApps = {
            'messages': { name: '消息', url: 'https://i.postimg.cc/Kvs4tDh5/export202509181826424260.png' },
            'memos': { name: '备忘录', url: 'https://i.postimg.cc/JzD0xH1C/export202509181829064550.png' },
            'cart': { name: '购物车', url: 'https://i.postimg.cc/pLwT6VTh/export202509181830143960.png' },
            'transfer': { name: '中转站', url: 'https://i.postimg.cc/63wQBHCB/export202509181831140230.png' },
            'browser': { name: '浏览器', url: 'https://i.postimg.cc/SKcsF02Z/export202509181830445980.png' },
            'drafts': { name: '草稿箱', url: 'https://i.postimg.cc/ZKqC9D2R/export202509181827225860.png' },
            'album': { name: '相册', url: 'https://i.postimg.cc/qBcdpqNc/export202509221549335970.png' },
            'steps': { name: '步数', url: 'https://i.postimg.cc/5NndFrq6/export202509181824532800.png' },
            'unlock': { name: 'unlock！', url: 'https://i.postimg.cc/28zNyYWs/export202509221542593320.png' }
        };

        const simulatedMemos = [];

        const globalSettingKeys = [
            'apiSettings', 'wallpaper', 'homeScreenMode', 'fontUrl', 'customIcons',
            'apiPresets', 'bubbleCssPresets', 'myPersonaPresets', 'globalCss',
            'globalCssPresets', 'homeSignature', 'forumPosts', 'forumBindings', 'pomodoroTasks', 'pomodoroSettings', 'insWidgetSettings', 'homeWidgetSettings','favoritePostIds', 
    'forumBindings', 
    'forumUserIdentity'
        ];
        const appVersion = "1.3.0"; // Current app version
        const updateLog = [
            {
                version: "1.3.0",
                date: "2025-11-11",
                notes: [
                    "务必仔细观看！重复观看指路→主屏幕的教程app→更新说明！",
                    "新增：双语模式，位于聊天界面的侧边栏内，当char为外国人而你想要更沉浸式的对话时，可按需开启，开启后会将“外文（中文）”的消息识别成双语消息气泡，注意！中文翻译必须在括号内，点击气泡后展开翻译。",
                    "↑补充：如果掉格式如何修改？编辑窗口将翻译括号内的其他括号删掉，比如带括号的颜文字、(笑)等。如果还有bug就先别开这个吧！",
                    "新增：流式传输开关，位于api设置界面，开跟不开不知道有什么区别，总之做了嗯嗯。没改之前默认是流式传输，如果非流出不来就开流式，流式出不来就关流式，都出不来我也没招了！",
                    "新增：拓展css美化代码，指路→主屏幕的自定义app→全局美化css中，下滑。有隐藏头像、底部变简洁、隐藏表情包背景之类的，可自行复制需要的部分放到全局美化中。",
                    "补充教学：发现有些宝宝还有地方不太清楚怎么使用，补充一下",
                    "1. 偷看手机：存储为临时存储，离开char手机页面后，偷看的相关内容将会清空，有喜欢的内容请及时截图",
                    "2. 回忆日记：生成日记后，需点亮该篇日记右上角的☆按钮收藏，收藏后该篇日记才会作为char的回忆加入聊天上下文中",
                    "3. 日记使用拓展方法：日记内容可编辑，当日记篇数过多/char被日记内的主观形容影响性格较大时，可以将你需要保留的日记内容复制给某个ai（豆包、deepseek、哈吉米都行）进行大总结，指令参考：以全客观的、不参杂任何主观情绪，以第三人称视角按照时间顺序总结发生过的事件和关键语句。然后将返回的总结塞进日记收藏加入上下文即可。",
                ]
            },
            {
                version: "1.2.0",
                date: "2025-10-15",
                notes: [
                    "新增：猫箱图床 (Catbox) 渲染机制，在当前绑定的表情包世界书中包含 'catbox' 关键词即可切换到猫箱模式，注意！iposting图床表情包和猫箱表情包不可同时渲染，只能选择一方。如：绑定了猫箱表情包世界书，就无法渲染过往iposting图床的表情包，不绑定则反之。",
                    "新增：世界书批量删除功能，长按条目即可进入多选删除模式，支持分类全选。",
                ]
            },
            {
                version: "1.1.0",
                date: "2025-10-13",
                notes: [
                    "重要！！已更换存储方式，请尽快导出原网址的备份并清理浏览器内该网址的数据，并重新在此网址导入备份",
                    "新增：番茄钟，可以创建专注任务并绑定char和自己的人设预设（仅可从预设中选择），在列表中左滑删除任务。专注期间想摸鱼了可以戳一戳头像，ta会对你做出回复。每个专注界面的设置键可以自定义鼓励频率和限制自己戳一戳的次数，超过次数则ta不会再理你，请补药偷懒，努力专注吧！",
                    "新增：两个桌面小组件，现所有小组件都可以通过点击来自定义图片和文字",
                    "优化：修复了存储膨胀的问题，现为测试阶段不确定是否有bug，请勤备份！唯有备份才是安全的！",
                    "优化：修复了一些使用体验上的小问题",
                    "画饼（未来可能会做的）：1.第二页的布局美化 2.日记本、存钱罐、音乐",
                ]
            }
        ];
     // 小手机数据
        let db = {
            characters: [],
            groups: [],
            apiSettings: {},
            wallpaper: 'https://i.postimg.cc/W4Z9R9x4/ins-1.jpg',
            myStickers: [],
            homeScreenMode: 'night',
            worldBooks: [],
            fontUrl: '',
            customIcons: {},
            apiPresets: [],
            bubbleCssPresets: [],
            myPersonaPresets: [],
            forumPosts: [],
            globalCss: '',
            globalCssPresets: [],
            homeSignature: '编辑个性签名...',
            favoritePostIds: [],
            forumBindings: {
                worldBookIds: [],
                charIds: [],
                userPersonaIds: [],
                useChatHistory: false,
        historyLimit: 50 // 新增：默认50条
            },
            forumUserIdentity: {
                nickname: '一只喵叽',
                avatar: 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg',
                persona: ''
            },
            pomodoroTasks: [],
            pomodoroSettings: {
                boundCharId: null,
                userPersona: '',
                focusBackground: '',
                taskCardBackground: '',
                encouragementMinutes: 25,
                pokeLimit: 5,
                globalWorldBookIds: [] // NEW: For global settings
            },
            insWidgetSettings: {
                avatar1: 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg',
                bubble1: 'love u.',
                avatar2: 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg',
                bubble2: 'miss u.'
            },
            currentViewingPostId: null
        };
        let currentSourceScreen = 'forum-screen'; // 默认为发现页
        let currentChatId = null, currentChatType = null, isGenerating = false, longPressTimer = null,
            isInMultiSelectMode = false, editingMessageId = null, currentPage = 1, currentTransferMessageId = null,
            currentEditingWorldBookId = null, currentStickerActionTarget = null,
            currentJournalDetailId = null,
            currentQuoteInfo = null, // 新增：用于存储引用信息
            currentGroupAction = {type: null, recipients: []};
        let currentPomodoroTask = null, pomodoroInterval = null, pomodoroRemainingSeconds = 0, pomodoroCurrentSessionSeconds = 0, isPomodoroPaused = true, pomodoroPokeCount = 0, pomodoroIsInterrupted = false, currentPomodoroSettingsContext = null, pomodoroSessionHistory = [];
        let isStickerManageMode = false;
        let selectedStickerIds = new Set();
        let isWorldBookMultiSelectMode = false;
        let selectedWorldBookIds = new Set();
        let peekContentCache = {};
        let generatingPeekApps = new Set(); // Tracks which apps are currently generating content
        let selectedMessageIds = new Set();
        const MESSAGES_PER_PAGE = 50;

        // --- DOM Element Cache ---
        const screens = document.querySelectorAll('.screen'),
            settingsScreen = document.getElementById('settings-screen'),
            toastElement = document.getElementById('toast-notification'),
            homeScreen = document.getElementById('home-screen'),
            chatListContainer = document.getElementById('chat-list-container'),
            noChatsPlaceholder = document.getElementById('no-chats-placeholder'),
            addChatBtn = document.getElementById('add-chat-btn'),
            addCharModal = document.getElementById('add-char-modal'),
            addCharForm = document.getElementById('add-char-form'),
            chatRoomScreen = document.getElementById('chat-room-screen'),
            chatRoomHeaderDefault = document.getElementById('chat-room-header-default'),
            chatRoomHeaderSelect = document.getElementById('chat-room-header-select'),
            cancelMultiSelectBtn = document.getElementById('cancel-multi-select-btn'),
            multiSelectTitle = document.getElementById('multi-select-title'),
            chatRoomTitle = document.getElementById('chat-room-title'),
            chatRoomStatusText = document.getElementById('chat-room-status-text'),
            messageArea = document.getElementById('message-area'),
            messageInputDefault = document.getElementById('message-input-default'),
            messageInput = document.getElementById('message-input'),
            sendMessageBtn = document.getElementById('send-message-btn'),
            getReplyBtn = document.getElementById('get-reply-btn'),
            typingIndicator = document.getElementById('typing-indicator'),
            chatSettingsBtn = document.getElementById('chat-settings-btn'),
            settingsSidebar = document.getElementById('chat-settings-sidebar'),
            settingsForm = document.getElementById('chat-settings-form'),
            multiSelectBar = document.getElementById('multi-select-bar'),
            selectCount = document.getElementById('select-count'),
            deleteSelectedBtn = document.getElementById('delete-selected-btn');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const regenerateBtn = document.getElementById('regenerate-btn'),
            stickerToggleBtn = document.getElementById('sticker-toggle-btn'),
            stickerModal = document.getElementById('sticker-modal'),
            stickerGridContainer = document.getElementById('sticker-grid-container'),
            addNewStickerBtn = document.getElementById('add-new-sticker-btn'),
            addStickerModal = document.getElementById('add-sticker-modal'),
            addStickerModalTitle = document.getElementById('add-sticker-modal-title'),
            addStickerForm = document.getElementById('add-sticker-form'),
            stickerEditIdInput = document.getElementById('sticker-edit-id'),
            stickerPreview = document.getElementById('sticker-preview'),
            stickerNameInput = document.getElementById('sticker-name'),
            stickerUrlInput = document.getElementById('sticker-url-input'),
            stickerFileUpload = document.getElementById('sticker-file-upload');
        const stickerActionSheet = document.getElementById('sticker-actionsheet'),
            editStickerBtn = document.getElementById('edit-sticker-btn'),
            deleteStickerBtn = document.getElementById('delete-sticker-btn');
        const voiceMessageBtn = document.getElementById('voice-message-btn'),
            sendVoiceModal = document.getElementById('send-voice-modal'),
            sendVoiceForm = document.getElementById('send-voice-form'),
            voiceTextInput = document.getElementById('voice-text-input'),
            voiceDurationPreview = document.getElementById('voice-duration-preview');
        const photoVideoBtn = document.getElementById('photo-video-btn'),
            sendPvModal = document.getElementById('send-pv-modal'),
            sendPvForm = document.getElementById('send-pv-form'),
            pvTextInput = document.getElementById('pv-text-input');
        const imageRecognitionBtn = document.getElementById('image-recognition-btn'),
            imageUploadInput = document.getElementById('image-upload-input');
        const walletBtn = document.getElementById('wallet-btn'),
            sendTransferModal = document.getElementById('send-transfer-modal'),
            sendTransferForm = document.getElementById('send-transfer-form'),
            transferAmountInput = document.getElementById('transfer-amount-input'),
            transferRemarkInput = document.getElementById('transfer-remark-input');
        const receiveTransferActionSheet = document.getElementById('receive-transfer-actionsheet'),
            acceptTransferBtn = document.getElementById('accept-transfer-btn'),
            returnTransferBtn = document.getElementById('return-transfer-btn');
        const sendGiftModal = document.getElementById('send-gift-modal'),
            sendGiftForm = document.getElementById('send-gift-form'),
            giftDescriptionInput = document.getElementById('gift-description-input');
        const timeSkipModal = document.getElementById('time-skip-modal'),
            timeSkipForm = document.getElementById('time-skip-form'),
            timeSkipInput = document.getElementById('time-skip-input');
        const clearChatHistoryBtn = document.getElementById('clear-chat-history-btn');
        const worldBookListContainer = document.getElementById('world-book-list-container'),
            noWorldBooksPlaceholder = document.getElementById('no-world-books-placeholder'),
            addWorldBookBtn = document.getElementById('add-world-book-btn'),
            editWorldBookScreen = document.getElementById('edit-world-book-screen'),
            editWorldBookForm = document.getElementById('edit-world-book-form'),
            worldBookIdInput = document.getElementById('world-book-id'),
            worldBookNameInput = document.getElementById('world-book-name'),
            worldBookContentInput = document.getElementById('world-book-content');
        const linkWorldBookBtn = document.getElementById('link-world-book-btn'),
            worldBookSelectionModal = document.getElementById('world-book-selection-modal'),
            worldBookSelectionList = document.getElementById('world-book-selection-list'),
            saveWorldBookSelectionBtn = document.getElementById('save-world-book-selection-btn');
        const fontSettingsForm = document.getElementById('font-settings-form'),
            fontUrlInput = document.getElementById('font-url'),
            restoreDefaultFontBtn = document.getElementById('restore-default-font-btn');
        const createGroupBtn = document.getElementById('create-group-btn'),
            createGroupModal = document.getElementById('create-group-modal'),
            createGroupForm = document.getElementById('create-group-form'),
            memberSelectionList = document.getElementById('member-selection-list'),
            groupNameInput = document.getElementById('group-name-input'),
            groupSettingsSidebar = document.getElementById('group-settings-sidebar'),
            groupSettingsForm = document.getElementById('group-settings-form'),
            groupMembersListContainer = document.getElementById('group-members-list-container'),
            editGroupMemberModal = document.getElementById('edit-group-member-modal'),
            editGroupMemberForm = document.getElementById('edit-group-member-form');
        const addMemberActionSheet = document.getElementById('add-member-actionsheet'),
            inviteExistingMemberBtn = document.getElementById('invite-existing-member-btn'),
            createNewMemberBtn = document.getElementById('create-new-member-btn'),
            inviteMemberModal = document.getElementById('invite-member-modal'),
            inviteMemberSelectionList = document.getElementById('invite-member-selection-list'),
            confirmInviteBtn = document.getElementById('confirm-invite-btn'),
            createMemberForGroupModal = document.getElementById('create-member-for-group-modal'),
            createMemberForGroupForm = document.getElementById('create-member-for-group-form');
        const customizeForm = document.getElementById('customize-form'),
            tutorialContentArea = document.getElementById('tutorial-content-area');
        const groupRecipientSelectionModal = document.getElementById('group-recipient-selection-modal'),
            groupRecipientSelectionList = document.getElementById('group-recipient-selection-list'),
            confirmGroupRecipientBtn = document.getElementById('confirm-group-recipient-btn'),
            groupRecipientSelectionTitle = document.getElementById('group-recipient-selection-title');
        const linkGroupWorldBookBtn = document.getElementById('link-group-world-book-btn');

        // --- 数据库Dexie DB Setup ---
        const dexieDB = new Dexie('QChatDB_ee');
        dexieDB.version(1).stores({
            storage: 'key, value'
        });
        dexieDB.version(2).stores({
            characters: '&id',
            groups: '&id',
            worldBooks: '&id',
            myStickers: '&id',
            globalSettings: 'key'
        }).upgrade(async tx => {
            console.log("Upgrading database to version 2...");
            const oldData = await tx.table('storage').get('QChat');
            if (oldData && oldData.value) {
                console.log("Old data found, starting migration.");
                const data = JSON.parse(oldData.value);
                if (data.characters) await tx.table('characters').bulkPut(data.characters);
                if (data.groups) await tx.table('groups').bulkPut(data.groups);
                if (data.worldBooks) await tx.table('worldBooks').bulkPut(data.worldBooks);
                if (data.myStickers) await tx.table('myStickers').bulkPut(data.myStickers);
                
                const settingsToMigrate = {
                    apiSettings: data.apiSettings || {},
                    wallpaper: data.wallpaper || 'https://i.postimg.cc/W4Z9R9x4/ins-1.jpg',
                    homeScreenMode: data.homeScreenMode || 'night',
                    fontUrl: data.fontUrl || '',
                    customIcons: data.customIcons || {},
                    apiPresets: data.apiPresets || [],
                    bubbleCssPresets: data.bubbleCssPresets || [],
                    myPersonaPresets: data.myPersonaPresets || [],
                    globalCss: data.globalCss || '',
                    globalCssPresets: data.globalCssPresets || [],
                    homeSignature: data.homeSignature || '编辑个性签名...',
                    forumPosts: data.forumPosts || [],
                    forumBindings: data.forumBindings || { worldBookIds: [], charIds: [], userPersonaIds: [],useChatHistory: false,
        historyLimit: 50 },
                    pomodoroTasks: data.pomodoroTasks || [],
                    pomodoroSettings: data.pomodoroSettings || { boundCharId: null, userPersona: '', focusBackground: '', taskCardBackground: '', encouragementMinutes: 25, pokeLimit: 5, globalWorldBookIds: [] },
                    insWidgetSettings: data.insWidgetSettings || { avatar1: 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg', bubble1: 'love u.', avatar2: 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg', bubble2: 'miss u.' },
                    homeWidgetSettings: data.homeWidgetSettings || defaultWidgetSettings
                };

                const settingsPromises = Object.entries(settingsToMigrate).map(([key, value]) =>
                    tx.table('globalSettings').put({ key, value })
                );
                await Promise.all(settingsPromises);
   // 删除记录             
                await tx.table('storage').delete('QChat');
                console.log("Migration complete. Old data removed.");
            } else {
                console.log("No old data found to migrate.");
            }
        });

        const saveData = async () => {
            await dexieDB.transaction('rw', dexieDB.tables, async () => {
                await dexieDB.characters.bulkPut(db.characters);
                await dexieDB.groups.bulkPut(db.groups);
                await dexieDB.worldBooks.bulkPut(db.worldBooks);
                await dexieDB.myStickers.bulkPut(db.myStickers);

                const settingsPromises = globalSettingKeys.map(key => {
                    if (db[key] !== undefined) {
                        return dexieDB.globalSettings.put({ key: key, value: db[key] });
                    }
                    return null;
                }).filter(p => p);
                await Promise.all(settingsPromises);
            });
        };

        const loadData = async () => {
            const [characters, groups, worldBooks, myStickers, settingsArray] = await Promise.all([
                dexieDB.characters.toArray(),
                dexieDB.groups.toArray(),
                dexieDB.worldBooks.toArray(),
                dexieDB.myStickers.toArray(),
                dexieDB.globalSettings.toArray()
            ]);

            db.characters = characters;
            db.groups = groups;
            db.worldBooks = worldBooks;
            db.myStickers = myStickers;

            const settings = settingsArray.reduce((acc, { key, value }) => {
                acc[key] = value;
                return acc;
            }, {});

            globalSettingKeys.forEach(key => {
                const defaultValue = {
                    apiSettings: {},
                    wallpaper: 'https://i.postimg.cc/W4Z9R9x4/ins-1.jpg',
                    homeScreenMode: 'night',
                    fontUrl: '',
                    customIcons: {},
                    apiPresets: [],
                    bubbleCssPresets: [],
                    myPersonaPresets: [],
                    globalCss: '',
                    globalCssPresets: [],
                    homeSignature: '编辑个性签名...',
                    forumPosts: [],
                    // --- 新增：默认身份 ---
                    forumUserIdentity: { 
                        nickname: '新用户', 
                        avatar: 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg', 
                        persona: '' 
                    },
                    forumBindings: { worldBookIds: [], charIds: [], userPersonaIds: [] ,useChatHistory: false,
        historyLimit: 50},
                    pomodoroTasks: [],
                    pomodoroSettings: { boundCharId: null, userPersona: '', focusBackground: '', taskCardBackground: '', encouragementMinutes: 25, pokeLimit: 5, globalWorldBookIds: [] },
                    insWidgetSettings: { avatar1: 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg', bubble1: 'love u.', avatar2: 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg', bubble2: 'miss u.' },
                    homeWidgetSettings: defaultWidgetSettings
                };
                // 深度合并逻辑，防止新字段丢失
                if (settings[key] !== undefined) {
                    db[key] = settings[key];
                    // 特殊处理：如果读取到了旧数据，但旧数据里缺了 forumUserIdentity，手动补上
                    if (key === 'forumUserIdentity' && !db[key]) {
                         db[key] = defaultValue.forumUserIdentity;
                    }
                } else {
                    db[key] = defaultValue[key] !== undefined ? JSON.parse(JSON.stringify(defaultValue[key])) : undefined;
                }
            });
            
            // 兜底检查：万一 forumUserIdentity 还是空的
            if (!db.forumUserIdentity) {
                db.forumUserIdentity = { nickname: '新用户', avatar: 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg', persona: '' };
            }

            // ... (原有的 Data integrity checks 保持不变) ...
            db.characters.forEach(c => {
                if (c.isPinned === undefined) c.isPinned = false;
                if (c.status === undefined) c.status = '在线';
                if (!c.worldBookIds) c.worldBookIds = [];
                if (c.customBubbleCss === undefined) c.customBubbleCss = '';
                if (c.useCustomBubbleCss === undefined) c.useCustomBubbleCss = false;
            });
            // ... (Groups check 保持不变) ...
            db.groups.forEach(g => {
                if (g.isPinned === undefined) g.isPinned = false;
                if (!g.worldBookIds) g.worldBookIds = [];
                if (g.customBubbleCss === undefined) g.customBubbleCss = '';
                if (g.useCustomBubbleCss === undefined) g.useCustomBubbleCss = false;
            });
            
            // Handle old localStorage data if it exists
            const oldLocalStorageData = localStorage.getItem('gemini-chat-app-db');
            if(oldLocalStorageData) {
                // ... (旧数据迁移逻辑保持不变) ...
                 localStorage.removeItem('gemini-chat-app-db');
                 await loadData();
            }
        };

        let notificationQueue = [];
        let isToastVisible = false;

        function processToastQueue() {
            if (isToastVisible || notificationQueue.length === 0) {
                return;
            }

        isToastVisible = true;
        const notification = notificationQueue.shift(); // 取出队列中的第一个通知

        const toastElement = document.getElementById('toast-notification');
        const avatarEl = toastElement.querySelector('.toast-avatar');
        const nameEl = toastElement.querySelector('.toast-name');
        const messageEl = toastElement.querySelector('.toast-message');

        const isRichNotification = typeof notification === 'object' && notification !== null && notification.name;

        if (isRichNotification) {
            toastElement.classList.remove('simple');
            avatarEl.style.display = 'block';
            nameEl.style.display = 'block';
            messageEl.style.textAlign = 'left';
            avatarEl.src = notification.avatar || 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg';
            nameEl.textContent = notification.name;
            messageEl.textContent = notification.message;
        } else {
            toastElement.classList.add('simple');
            avatarEl.style.display = 'none';
            nameEl.style.display = 'none';
            messageEl.style.textAlign = 'center';
            messageEl.textContent = notification;
        }

        toastElement.classList.add('show');

        // 设置定时器，在通知显示一段时间后将其隐藏
        setTimeout(() => {
            toastElement.classList.remove('show');
            
            // 等待隐藏动画（0.5秒）结束后，处理下一个通知
            setTimeout(() => {
                isToastVisible = false;
                processToastQueue(); // 尝试处理队列中的下一个通知
            }, 500);

        }, 1500); // 通知显示时间（1.5秒）
    }
    const showToast = (notification) => {
        notificationQueue.push(notification); // 将通知加入队列
        processToastQueue(); // 尝试处理队列
    };

// 显示持久化的加载提示 (居中 + showToast风格)
function showLoadingToast(message) {
    // 1. 创建元素
    const toast = document.createElement('div');
    toast.className = 'toast loading'; // 应用我们刚才写的 CSS 类
    
    // 2. 填充内容 (Spinner + 文字)
    toast.innerHTML = `
        <div class="toast-spinner"></div>
        <div style="font-size: 15px; font-weight: 500; color: #333;">${message}</div>
    `;
    
    // 3. 添加到页面
    document.body.appendChild(toast);
    
    // 4. 触发显示动画 (微小延迟确保 CSS transition 生效)
    requestAnimationFrame(() => {
        toast.classList.add('show');
    });

    // 5. 返回一个“关闭函数”，供外部调用以关闭这个提示
    return function hide() {
        toast.classList.remove('show'); // 淡出
        // 等待淡出动画结束后从 DOM 移除
        setTimeout(() => {
            if (toast.parentNode) toast.parentNode.removeChild(toast);
        }, 300);
    };
}

        const switchScreen = (targetId) => {
            screens.forEach(screen => screen.classList.remove('active'));
            document.getElementById(targetId)?.classList.add('active');
            // Close all overlays and sidebars
            const overlays = document.querySelectorAll('.modal-overlay, .action-sheet-overlay, .settings-sidebar');
            overlays.forEach(o => o.classList.remove('visible', 'open'));
        };
        const pad = (num) => num.toString().padStart(2, '0');

        function createContextMenu(items, x, y) {
            removeContextMenu();
            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
            items.forEach(item => {
                const menuItem = document.createElement('div');
                menuItem.className = 'context-menu-item';
                if (item.danger) menuItem.classList.add('danger');
                menuItem.textContent = item.label;
                menuItem.onclick = () => {
                    item.action();
                    removeContextMenu();
                };
                menu.appendChild(menuItem);
            });
            document.body.appendChild(menu);
            document.addEventListener('click', removeContextMenu, {once: true});
        }

        function removeContextMenu() {
            const menu = document.querySelector('.context-menu');
            if (menu) menu.remove();
        }

        function updateCustomBubbleStyle(chatId, css, enabled) {
            const styleId = `custom-bubble-style-for-${chatId}`;
            let styleElement = document.getElementById(styleId);

            if (enabled && css) {
                if (!styleElement) {
                    styleElement = document.createElement('style');
                    styleElement.id = styleId;
                    document.head.appendChild(styleElement);
                }

                const scope = `#chat-room-screen.chat-active-${chatId}`;
                let finalCss = '';

                // 1. Handle :root variables by applying them directly to the scoped element
                const rootRegex = /:root\s*\{([\s\S]*?)\}/;
                const rootMatch = css.match(rootRegex);
                if (rootMatch && rootMatch[1]) {
                    const rootVars = rootMatch[1].trim();
                    if (rootVars) {
                        // This creates a rule that applies the CSS variables to the specific chat screen
                        finalCss += `${scope} { ${rootVars} }\n`;
                    }
                }

                // 2. Remove the original :root block and any @-rules that are problematic
                let remainingCss = css
                    .replace(rootRegex, '')
                    .replace(/@keyframes[\s\S]*?(\}\s*\}|\})/g, '') // Remove @keyframes
                    .replace(/@font-face[\s\S]*?\}/g, ''); // Remove @font-face

                // 3. Process all other rules with a more intelligent scoping logic
                const ruleRegex = /([^{}]+?)\s*\{([^{}]+?)\}/g;
                let match;
                while ((match = ruleRegex.exec(remainingCss)) !== null) {
                    const selectors = match[1].trim();
                    const properties = match[2].trim();

                    if (selectors && properties) {
                        const scopedSelectors = selectors
                            .split(',')
                            .map(s => s.trim())
                            .filter(s => s && !s.startsWith('@'))
                            .map(s => {
                                // NEW INTELLIGENT SCOPING:
                                // If the selector already contains the base screen ID,
                                // just add the active class to it. Otherwise, prepend the full scope.
                                if (s.includes('#chat-room-screen')) {
                                    return s.replace('#chat-room-screen', scope);
                                } else {
                                    return `${scope} ${s}`;
                                }
                            })
                            .join(', ');
                        
                        if (scopedSelectors) {
                           finalCss += `${scopedSelectors} { ${properties} }\n`;
                        }
                    }
                }

                styleElement.innerHTML = finalCss;

            } else {
                if (styleElement) {
                    styleElement.remove();
                }
            }
        }

        function updateBubbleCssPreview(previewContainer, css, useDefault, theme) {
            previewContainer.innerHTML = '';

            const sentBubble = document.createElement('div');
            sentBubble.className = 'message-bubble sent';
            sentBubble.textContent = '这是我方气泡。';
            sentBubble.style.alignSelf = 'flex-end';
            sentBubble.style.borderRadius = '8px';

            const receivedBubble = document.createElement('div');
            receivedBubble.className = 'message-bubble received';
            receivedBubble.textContent = '这是对方气泡。';
            receivedBubble.style.alignSelf = 'flex-start';
            receivedBubble.style.borderRadius = '8px';

            [sentBubble, receivedBubble].forEach(bubble => {
                bubble.style.maxWidth = '70%';
                bubble.style.padding = '8px 12px';
                bubble.style.wordWrap = 'break-word';
                bubble.style.lineHeight = '1.4';
            });

            if (useDefault || !css) {
                sentBubble.style.backgroundColor = theme.sent.bg;
                sentBubble.style.color = theme.sent.text;
                sentBubble.style.borderRadius = '8px';              
                receivedBubble.style.backgroundColor = theme.received.bg;
                receivedBubble.style.color = theme.received.text;
                receivedBubble.style.borderRadius = '8px';                
            } else {
                const styleTag = document.createElement('style');
                const scopedCss = css.replace(/(\.message-bubble(?:\.sent|\.received)?)/g, `#${previewContainer.id} $1`);
                styleTag.textContent = scopedCss;
                previewContainer.appendChild(styleTag);
            }
            previewContainer.appendChild(receivedBubble);
            previewContainer.appendChild(sentBubble);
        }
        const dataStorage = {
            getStorageInfo: async function() {
                const stringify = (obj) => {
                    try {
                        // Handle potential circular references, although unlikely with Dexie data
                        return JSON.stringify(obj).length;
                    } catch (e) {
                        console.warn("Could not stringify object for size calculation:", obj, e);
                        return 0;
                    }
                };

                let categorizedSizes = {
                    messages: 0,
                    charactersAndGroups: 0,
                    worldAndForum: 0,
                    personalization: 0,
                    apiAndCore: 0,
                    other: 0
                };

                // Ensure db is loaded, this is a safeguard.
                if (!db || !db.characters) {
                    await loadData();
                }

                // 1. Messages (History)
                (db.characters || []).forEach(char => {
                    categorizedSizes.messages += stringify(char.history);
                });
                (db.groups || []).forEach(group => {
                    categorizedSizes.messages += stringify(group.history);
                });

                // 2. Characters and Groups (metadata)
                (db.characters || []).forEach(char => {
                    const charWithoutHistory = { ...char, history: undefined };
                    categorizedSizes.charactersAndGroups += stringify(charWithoutHistory);
                });
                (db.groups || []).forEach(group => {
                    const groupWithoutHistory = { ...group, history: undefined };
                    categorizedSizes.charactersAndGroups += stringify(groupWithoutHistory);
                });

                // 3. World and Forum
                categorizedSizes.worldAndForum += stringify(db.worldBooks);
                categorizedSizes.worldAndForum += stringify(db.forumPosts);
                categorizedSizes.worldAndForum += stringify(db.forumBindings);

                // 4. Personalization
                categorizedSizes.personalization += stringify(db.myStickers);
                categorizedSizes.personalization += stringify(db.wallpaper);
                categorizedSizes.personalization += stringify(db.homeScreenMode);
                categorizedSizes.personalization += stringify(db.fontUrl);
                categorizedSizes.personalization += stringify(db.customIcons);
                categorizedSizes.personalization += stringify(db.bubbleCssPresets);
                categorizedSizes.personalization += stringify(db.myPersonaPresets);
                categorizedSizes.personalization += stringify(db.globalCss);
                categorizedSizes.personalization += stringify(db.globalCssPresets);
                categorizedSizes.personalization += stringify(db.homeSignature);
                categorizedSizes.personalization += stringify(db.pomodoroTasks);
                categorizedSizes.personalization += stringify(db.pomodoroSettings);
                categorizedSizes.personalization += stringify(db.insWidgetSettings);
                categorizedSizes.personalization += stringify(db.homeWidgetSettings);

                // 5. API and Core
                categorizedSizes.apiAndCore += stringify(db.apiSettings);
                categorizedSizes.apiAndCore += stringify(db.apiPresets);

                // Total size
                const totalSize = Object.values(categorizedSizes).reduce((sum, size) => sum + size, 0);

                return {
                    totalSize,
                    categorizedSizes
                };
            }
        };

        function setupStorageAnalysisScreen() {
            const screen = document.getElementById('storage-analysis-screen');
            const chartContainer = document.getElementById('storage-chart-container');
            const detailsList = document.getElementById('storage-details-list');
            let myChart = null;

            // 定义一个共享的颜色调色板
            const colorPalette = ['#389CFF', '#90caf9', '#a5d6a7', '#fff59d', '#b39ddb', '#ffcc80'];

            const categoryNames = {
                messages: '聊天记录',
                charactersAndGroups: '角色与群组',
                worldAndForum: '世界书与喵坛',
                personalization: '个性化设置',
                apiAndCore: '核心与API',
                other: '其他数据'
            };

            function formatBytes(bytes, decimals = 2) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            }

            // 修改函数签名，接收颜色数组
            function renderStorageChart(info, colors) {
                if (!myChart) {
                    myChart = echarts.init(chartContainer);
                }

                const chartData = Object.entries(info.categorizedSizes)
                    .map(([key, value]) => ({
                        name: categoryNames[key] || key,
                        value: value
                    }))
                    .filter(item => item.value > 0);

                const option = {
                    // 将颜色数组应用到图表
                    color: colors,
                    tooltip: {
                        trigger: 'item',
                        formatter: '{a} <br/>{b}: {c} ({d}%)'
                    },
                    legend: {
                        show: false // 隐藏图例，因为我们下面有更详细的列表
                    },
                    series: [
                        {
                            name: '存储占比',
                            type: 'pie',
                            radius: ['50%', '70%'],
                            avoidLabelOverlap: false,
                            label: {
                                show: false,
                                position: 'center'
                            },
                            emphasis: {
                                label: {
                                    show: true,
                                    fontSize: '20',
                                    fontWeight: 'bold'
                                }
                            },
                            labelLine: {
                                show: false
                            },
                            data: chartData
                        }
                    ]
                };
                myChart.setOption(option);
            }

            // 修改函数签名，接收颜色数组
            function renderStorageDetails(info, colors) {
                detailsList.innerHTML = '';
                const totalSize = info.totalSize;

                const totalSizeEl = document.getElementById('storage-total-size');
                if (totalSizeEl) {
                    totalSizeEl.textContent = formatBytes(totalSize);
                }
        

                const sortedData = Object.entries(info.categorizedSizes)
                    .map(([key, value]) => ({
                        key: key,
                        name: categoryNames[key] || key,
                        value: value
                    }))
                    .sort((a, b) => b.value - a.value);

                // 不再从图表实例获取颜色，直接使用传入的参数
                sortedData.forEach((item, index) => {
                    if (item.value <= 0) return; // 不显示大小为0的项目
                    const percentage = totalSize > 0 ? ((item.value / totalSize) * 100).toFixed(2) : 0;
                    const color = colors[index % colors.length];

                    const detailItem = document.createElement('div');
                    detailItem.className = 'storage-detail-item';
                    detailItem.innerHTML = `
                        <div class="storage-color-indicator" style="background-color: ${color};"></div>
                        <div class="storage-detail-info">
                            <span class="storage-detail-name">${item.name}</span>
                            <span class="storage-detail-size">${formatBytes(item.value)}</span>
                        </div>
                        <span class="storage-detail-percentage">${percentage}%</span>
                    `;
                    detailsList.appendChild(detailItem);
                });
            }

            const observer = new MutationObserver(async (mutations) => {
                if (screen.classList.contains('active')) {
                    showToast('正在分析存储空间...');
                    const storageInfo = await dataStorage.getStorageInfo();
                    if (storageInfo) {
                        // 将颜色数组传递给两个函数
                        renderStorageChart(storageInfo, colorPalette);
                        renderStorageDetails(storageInfo, colorPalette);
                    } else {
                        showToast('分析失败');
                    }
                }
            });

            observer.observe(screen, { attributes: true, attributeFilter: ['class'] });
        }

        function renderPomodoroTasks() {
            const taskListContainer = document.getElementById('pomodoro-task-list');
            const placeholder = document.getElementById('pomodoro-no-tasks-placeholder');
            if (!taskListContainer || !placeholder) return;

            taskListContainer.innerHTML = ''; // Clear existing tasks

            if (!db.pomodoroTasks || db.pomodoroTasks.length === 0) {
                placeholder.style.display = 'block';
                taskListContainer.style.display = 'none';
                return;
            }

            placeholder.style.display = 'none';
            taskListContainer.style.display = 'flex';

            db.pomodoroTasks.forEach(task => {
                const wrapper = document.createElement('div');
                wrapper.className = 'task-card-wrapper';
                wrapper.dataset.id = task.id;

                const pomodorosText = task.mode === 'countdown' ? `倒计时模式` : '正计时模式';
                const durationText = task.mode === 'countdown' ? `${task.duration}分钟` : '';

                // 只使用任务自己的背景设置
                const backgroundUrl = task.settings?.taskCardBackground;
                let styleAttr = '';
                let textStyle = '';

                if (backgroundUrl) {
                    styleAttr = `style="background-image: url(${backgroundUrl}); background-size: cover; background-position: center;"`;
                    // 当有背景图时，让文字变白并增加阴影以提高可读性
                    textStyle = `style="color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5);"`;
                }

                wrapper.innerHTML = `
                    <div class="task-card" ${styleAttr}>
                        <div class="task-card-info">
                            <h4 class="task-card-title" ${textStyle}>${DOMPurify.sanitize(task.name)}</h4>
                            <p class="task-card-details" ${textStyle}>${pomodorosText} ${durationText}</p>
                        </div>
                        <button class="task-card-start-btn">开始</button>
                    </div>
                    <button class="task-card-delete-btn">删除</button>
                `;
                taskListContainer.appendChild(wrapper);
            });
        }

        function setupPomodoroApp() {
            const createTaskBtn = document.getElementById('pomodoro-create-task-btn');
            const createModal = document.getElementById('pomodoro-create-modal');
            const createForm = document.getElementById('pomodoro-create-form');
            const modeRadios = document.querySelectorAll('input[name="pomodoro-mode"]');
            const durationOptions = document.getElementById('pomodoro-duration-options');
            const durationPills = durationOptions.querySelectorAll('.duration-pill');
            const customDurationInput = document.getElementById('pomodoro-custom-duration-input');

            // Focus Screen elements
            const focusScreen = document.getElementById('pomodoro-focus-screen');
            const focusTitleEl = focusScreen.querySelector('.focus-task-title');
            const focusTimerEl = focusScreen.querySelector('.focus-timer-display');
            const focusModeEl = focusScreen.querySelector('.focus-timer-mode');
            const startBtn = document.getElementById('pomodoro-start-btn');
            const pauseBtn = document.getElementById('pomodoro-pause-btn');
            const giveUpBtn = document.getElementById('pomodoro-giveup-btn');
            const focusAvatar = focusScreen.querySelector('.focus-avatar');
            const focusMessageBubble = focusScreen.querySelector('.focus-message-bubble');

            if (focusAvatar && focusMessageBubble) {
                focusAvatar.addEventListener('click', () => {
                    // "Poke" feature logic
                    if (isPomodoroPaused || !pomodoroInterval || !currentPomodoroTask) return;

                    pomodoroIsInterrupted = true;
                    pomodoroPokeCount++;

                    const pokeLimit = currentPomodoroTask.settings.pokeLimit || 5;

                    if (pomodoroPokeCount > pokeLimit) {
                        showTypewriterMessage(focusMessageBubble.querySelector('p'), '传讯次数已经到达上限啦，请再专心一点吧宝宝^^');
                    } else {
                        getPomodoroAiReply('poke');
                    }
                });
            }


            // --- Timer Core Logic ---
            function updateTimerDisplay() {
                const hours = Math.floor(pomodoroRemainingSeconds / 3600);
                const minutes = Math.floor((pomodoroRemainingSeconds % 3600) / 60);
                const seconds = pomodoroRemainingSeconds % 60;

                if (pomodoroRemainingSeconds >= 3600) {
                    focusTimerEl.textContent = `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                } else {
                    focusTimerEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                }
            }

            function updateTotalFocusedTimeDisplay() {
                const totalMinutes = Math.floor(pomodoroCurrentSessionSeconds / 60);
                const totalTimeEl = document.getElementById('pomodoro-total-focused-time');
                if (totalTimeEl) {
                    totalTimeEl.textContent = `已专注 ${totalMinutes} 分钟`;
                }
            }

            function stopTimer() {
                clearInterval(pomodoroInterval);
                pomodoroInterval = null;
                isPomodoroPaused = true;
                startBtn.style.display = 'inline-flex';
                pauseBtn.style.display = 'none';
            }

            function startTimer() {
                if (pomodoroInterval) return; // Already running

                // NEW: Check for resume from a paused state
                if (isPomodoroPaused && pomodoroCurrentSessionSeconds > 0) {
                    getPomodoroAiReply('resume');
                }

                isPomodoroPaused = false;
                pomodoroIsInterrupted = false; // Also reset this flag on resume
                startBtn.style.display = 'none';
                pauseBtn.style.display = 'inline-flex';

                pomodoroInterval = setInterval(() => {
                    if (currentPomodoroTask.mode === 'countdown') {
                        pomodoroRemainingSeconds--;
                    } else { // stopwatch
                        pomodoroRemainingSeconds++;
                    }
                    pomodoroCurrentSessionSeconds++;
                    updateTimerDisplay();
                    updateTotalFocusedTimeDisplay();

                    // Check for encouragement
                    if (currentPomodoroTask && currentPomodoroTask.settings) {
                        const encouragementMinutes = currentPomodoroTask.settings.encouragementMinutes || 25;
                        if (pomodoroCurrentSessionSeconds > 0 && (pomodoroCurrentSessionSeconds % (encouragementMinutes * 60)) === 0 && !pomodoroIsInterrupted) {
                            getPomodoroAiReply('encouragement');
                        }
                    }

                    if (currentPomodoroTask.mode === 'countdown' && pomodoroRemainingSeconds <= 0) {
                        stopTimer();
                        handlePomodoroCompletion();
                    }
                }, 1000);
            }

            function pauseTimer() {
                pomodoroIsInterrupted = true; // Pausing counts as an interruption
                isPomodoroPaused = true;
                clearInterval(pomodoroInterval);
                pomodoroInterval = null;
                startBtn.style.display = 'inline-flex';
                pauseBtn.style.display = 'none';
            }

            // --- Event Listeners for Controls ---
            startBtn.addEventListener('click', startTimer);
            pauseBtn.addEventListener('click', pauseTimer);
            giveUpBtn.addEventListener('click', () => {
                if (confirm('确定要放弃当前任务吗？')) {
                    stopTimer();
                    currentPomodoroTask = null;
                    switchScreen('pomodoro-screen');
                }
            });

            // Certificate modal listeners
            const certModal = document.getElementById('pomodoro-certificate-modal');
            const forwardCertBtn = document.getElementById('forward-certificate-btn');
            const closeCertBtn = document.getElementById('close-certificate-btn');

            forwardCertBtn.addEventListener('click', async () => {
                const taskName = document.getElementById('cert-task-name').textContent;
                const duration = document.getElementById('cert-duration').textContent;
                const pokeCount = document.getElementById('cert-poke-count').textContent;
                const chat = db.characters.find(c => c.id === currentPomodoroTask.settings.boundCharId);

                if (chat) {
                    const messageContent = `[专注记录] 任务：${taskName}，时长：${duration}，期间与 ${chat.realName} 互动 ${pokeCount} 次。`;
                    const message = {
                        id: `msg_pomodoro_${Date.now()}`,
                        role: 'user',
                        content: messageContent,
                        parts: [{ type: 'text', text: messageContent }],
                        timestamp: Date.now(),
                        senderId: 'user_me'
                    };
                    chat.history.push(message);
                    await saveData();
                    showToast('已转发到聊天框！');
                    renderChatList();
                }
                certModal.classList.remove('visible');
                switchScreen('pomodoro-screen');
            });

            closeCertBtn.addEventListener('click', () => {
                certModal.classList.remove('visible');
                switchScreen('pomodoro-screen');
            });


            function handlePomodoroCompletion() {
                const certModal = document.getElementById('pomodoro-certificate-modal');
                document.getElementById('cert-task-name').textContent = currentPomodoroTask.name;
                const totalMinutes = Math.floor(pomodoroCurrentSessionSeconds / 60);
                document.getElementById('cert-duration').textContent = `${totalMinutes} 分钟`;
                document.getElementById('cert-poke-count').textContent = pomodoroPokeCount;

                // 新增：清空并隐藏对话框
                const focusMessageBubble = document.querySelector('#pomodoro-focus-screen .focus-message-bubble');
                if (focusMessageBubble) {
                    focusMessageBubble.classList.remove('visible');
                    focusMessageBubble.querySelector('p').textContent = '';
                }

                // No longer call AI for completion
                certModal.classList.add('visible');
            }

            function showPomodoroTypingIndicator(element) {
                element.innerHTML = '对方正在输入中<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>';
            }

            function showTypewriterMessage(element, text) {
                let i = 0;
                element.innerHTML = ''; // Clear previous content
                const typingInterval = setInterval(() => {
                    if (i < text.length) {
                        element.textContent += text.charAt(i);
                        i++;
                    } else {
                        clearInterval(typingInterval);
                    }
                }, 50);
            }

            async function getPomodoroAiReply(promptType) {
                const focusMessageBubble = document.querySelector('.focus-message-bubble');
                const messageP = focusMessageBubble.querySelector('p');
                const settings = currentPomodoroTask.settings;
                const character = db.characters.find(c => c.id === settings.boundCharId);

                if (!character) {
                    focusMessageBubble.classList.remove('visible');
                    return;
                }

                const userPersonaPreset = db.myPersonaPresets.find(p => p.name === settings.userPersona);
                const userPersona = userPersonaPreset ? userPersonaPreset.persona : '一个普通人';

                let prompt;
                const totalMinutes = Math.floor(pomodoroCurrentSessionSeconds / 60);
                const remainingMinutes = Math.round(pomodoroRemainingSeconds / 60);
                const taskName = currentPomodoroTask.name;

                switch (promptType) {
                    case 'encouragement':
                        if (currentPomodoroTask.mode === 'countdown') {
                            prompt = `你正在扮演[${character.realName}]。用户正在进行专注任务“${taskName}”，已连续专注了[${totalMinutes}]分钟，还剩下大约[${remainingMinutes}]分钟。请根据你的人设、任务内容和剩余时间，以鼓励用户为目的，给用户发送一条文字消息。`;
                        } else { // stopwatch
                            prompt = `你正在扮演[${character.realName}]。用户正在进行专注任务“${taskName}”，已经连续专注了[${totalMinutes}]分钟。请根据你的人设和任务内容，以鼓励用户为目的，给用户发送一条文字消息。`;
                        }
                        break;
                    case 'poke':
                        if (currentPomodoroTask.mode === 'countdown') {
                            prompt = `你正在扮演[${character.realName}]。用户在进行专注任务“${taskName}”时，专注了[${totalMinutes}]分钟（还剩下大约[${remainingMinutes}]分钟），忍不住第${pomodoroPokeCount}次戳了戳你的头像。请根据你的人设、任务内容和剩余时间，给用户回复一条文字消息。`;
                        } else { // stopwatch
                            prompt = `你正在扮演[${character.realName}]。用户在进行专注任务“${taskName}”时，已经连续专注了[${totalMinutes}]分钟，这时忍不住第${pomodoroPokeCount}次戳了戳你的头像。请根据你的人设和任务内容，给用户回复一条文字消息。`;
                        }
                        break;
                    case 'resume':
                        prompt = `你正在扮演[${character.realName}]。用户正在进行专注任务“${taskName}”，刚刚暂停了任务后又重新开始了。请根据你的人设，给用户回复一条文字消息。`;
                        break;
                }

                // NEW: Add session history context
                if (pomodoroSessionHistory && pomodoroSessionHistory.length > 0) {
                    const myName = character.myName || '我';
                    const charName = character.realName || '角色';
                    const historyContext = pomodoroSessionHistory.map(item => {
                        if (item.type === 'user') {
                            return `[${myName}的消息：(执行操作: ${item.content})]`;
                        } else {
                            return `[${charName}的消息：${item.content}]`;
                        }
                    }).join('\n');
                    prompt += `\n\n【本次专注期间的简短互动历史】\n${historyContext}\n\n请基于以上历史，继续你的下一句回应。`;
                }
 
                focusMessageBubble.classList.add('visible');
                showPomodoroTypingIndicator(messageP);

                try {
                    const { url, key, model } = db.apiSettings;
                    if (!url || !key || !model) {
                        messageP.textContent = 'API未配置，无法获取回应。';
                        return;
                    }

                    // --- NEW: Construct system prompt with world books ---
                    const globalWorldBookIds = db.pomodoroSettings?.globalWorldBookIds || [];
                    const globalWorldBooksBefore = globalWorldBookIds
                        .map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'before'))
                        .filter(Boolean)
                        .map(wb => wb.content)
                        .join('\n\n');
                    const globalWorldBooksAfter = globalWorldBookIds
                        .map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'after'))
                        .filter(Boolean)
                        .map(wb => wb.content)
                        .join('\n\n');

                    let systemPromptContent = `你正在扮演角色。你的名字是${character.realName}。`;
                    if (globalWorldBooksBefore) {
                        systemPromptContent += `\n\n【全局世界观设定】\n${globalWorldBooksBefore}`;
                    }
                    systemPromptContent += `\n\n【你的角色设定】\n人设: ${character.persona}`;
                    if (globalWorldBooksAfter) {
                        systemPromptContent += `\n\n【补充设定】\n${globalWorldBooksAfter}`;
                    }
                    systemPromptContent += `\n\n【我的角色设定】\n我的名字是${character.myName}，人设是：${userPersona}。`;
                    // --- END NEW ---

                    const response = await fetch(`${url}/v1/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${key}`
                        },
                        body: JSON.stringify({
                            model: model,
                            messages: [
                                { role: 'system', content: systemPromptContent },
                                { role: 'user', content: prompt }
                            ],
                            temperature: 0.8
                        })
                    });

                    if (!response.ok) {
                        throw new Error('API请求失败');
                    }

                    const result = await response.json();
                    const reply = result.choices[0].message.content;

                    // NEW: Add user action and AI reply to session history
                    pomodoroSessionHistory.push({ type: 'user', content: promptType });
                    pomodoroSessionHistory.push({ type: 'ai', content: reply });
                    // Keep history short, e.g., last 4 pairs
                    if (pomodoroSessionHistory.length > 8) {
                        pomodoroSessionHistory.splice(0, 2);
                    }

                    showTypewriterMessage(messageP, reply);
 
                    // If the reply was for a 'poke', start a timer to reset the interruption flag.
                    if (promptType === 'poke') {
                        setTimeout(() => {
                            pomodoroIsInterrupted = false;
                        }, 10000); // 10 seconds
                    }

                } catch (error) {
                    console.error('获取AI回应失败:', error);
                    messageP.textContent = '获取回应失败，请检查网络或API设置。';
                }
            }


            // Show create task modal
            if (createTaskBtn) {
                createTaskBtn.addEventListener('click', () => {
                    // Reset form to default state on open
                    createForm.reset();
                    durationOptions.classList.add('visible');
                    durationPills.forEach(p => p.classList.remove('active'));
                    if (durationPills.length > 0) {
                        durationPills[0].classList.add('active');
                    }
                    customDurationInput.style.display = 'none';
                    document.getElementById('mode-countdown').checked = true;
                    document.getElementById('mode-stopwatch').checked = false;

                    createModal.classList.add('visible');
                });
            }

            // Handle mode change (countdown vs stopwatch)
            modeRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    if (radio.value === 'countdown') {
                        durationOptions.classList.add('visible');
                    } else {
                        durationOptions.classList.remove('visible');
                    }
                });
            });

            // Handle duration pill selection
            durationPills.forEach(pill => {
                pill.addEventListener('click', () => {
                    durationPills.forEach(p => p.classList.remove('active'));
                    pill.classList.add('active');
                    if (pill.dataset.duration === 'custom') {
                        customDurationInput.style.display = 'block';
                        customDurationInput.focus();
                    } else {
                        customDurationInput.style.display = 'none';
                    }
                });
            });

            // Handle form submission
            if (createForm) {
                createForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const taskName = document.getElementById('pomodoro-task-name').value.trim();
                    if (!taskName) {
                        showToast('请输入任务名称');
                        return;
                    }

                    const mode = document.querySelector('input[name="pomodoro-mode"]:checked').value;
                    let duration = 0;

                    if (mode === 'countdown') {
                        const activePill = durationOptions.querySelector('.duration-pill.active');
                        if (activePill.dataset.duration === 'custom') {
                            duration = parseInt(customDurationInput.value, 10);
                            if (isNaN(duration) || duration <= 0) {
                                showToast('请输入有效的自定义分钟数');
                                return;
                            }
                        } else {
                            duration = parseInt(activePill.dataset.duration, 10);
                        }
                    }

                    const newTask = {
                        id: `pomodoro_${Date.now()}`,
                        name: taskName,
                        mode: mode,
                        duration: duration,
                        status: 'pending',
                        // 为每个任务创建独立的设置副本
                        // 为每个任务创建独立的设置副本，但确保背景是空的
                        settings: {
                            ...JSON.parse(JSON.stringify(db.pomodoroSettings)),
                            focusBackground: '',
                            taskCardBackground: ''
                        }
                    };

                    if (!db.pomodoroTasks) {
                        db.pomodoroTasks = [];
                    }
                    db.pomodoroTasks.push(newTask);
                    await saveData();

                    showToast(`任务 "${taskName}" 已创建`);
                    renderPomodoroTasks();

                    createModal.classList.remove('visible');
                });
            }

            const screen = document.getElementById('pomodoro-screen');
            if (screen) {
                const observer = new MutationObserver(() => {
                    if (screen.classList.contains('active')) {
                        renderPomodoroTasks();
                    }
                });
                observer.observe(screen, { attributes: true, attributeFilter: ['class'] });
            }

            const taskListContainer = document.getElementById('pomodoro-task-list');

            // --- Swipe to delete logic ---
            let touchStartX = 0;
            let touchCurrentX = 0;
            let swipedCardWrapper = null;
            let isDragging = false;
            const swipeThreshold = 50; // Min pixels to trigger swipe

            const handleSwipeStart = (x, target) => {
                touchStartX = x;
                isDragging = true;
                // Close any other swiped card
                const targetWrapper = target.closest('.task-card-wrapper');
                if (swipedCardWrapper && swipedCardWrapper !== targetWrapper) {
                    swipedCardWrapper.classList.remove('is-swiped');
                    swipedCardWrapper = null;
                }
            };

            const handleSwipeMove = (x, target) => {
                if (!isDragging) return;
                const cardWrapper = target.closest('.task-card-wrapper');
                if (!cardWrapper) return;

                touchCurrentX = x;
                const deltaX = touchCurrentX - touchStartX;

                // Only allow left swipe
                if (deltaX < 0) {
                    // Prevent over-swiping
                    const distance = Math.max(deltaX, -80);
                    cardWrapper.querySelector('.task-card').style.transform = `translateX(${distance}px)`;
                }
            };

            const handleSwipeEnd = (target) => {
                if (!isDragging) return;
                isDragging = false;

                const cardWrapper = target.closest('.task-card-wrapper');
                if (!cardWrapper) return;

                const card = cardWrapper.querySelector('.task-card');
                const deltaX = touchCurrentX - touchStartX;

                // Reset inline style
                card.style.transform = '';

                if (deltaX < -swipeThreshold) {
                    cardWrapper.classList.add('is-swiped');
                    swipedCardWrapper = cardWrapper;
                } else {
                    cardWrapper.classList.remove('is-swiped');
                    if (swipedCardWrapper === cardWrapper) {
                        swipedCardWrapper = null;
                    }
                }
                
                // Reset positions
                touchStartX = 0;
                touchCurrentX = 0;
            };

            taskListContainer.addEventListener('touchstart', (e) => {
                handleSwipeStart(e.touches[0].clientX, e.target);
            }, { passive: true });

            taskListContainer.addEventListener('touchmove', (e) => {
                handleSwipeMove(e.touches[0].clientX, e.target);
            }, { passive: true });

            taskListContainer.addEventListener('touchend', (e) => {
                handleSwipeEnd(e.target);
            });
            
            // Mouse events for desktop
            taskListContainer.addEventListener('mousedown', (e) => {
                if (e.target.closest('.task-card-start-btn') || e.target.closest('.task-card-delete-btn')) return;
                handleSwipeStart(e.clientX, e.target);
            });

            taskListContainer.addEventListener('mousemove', (e) => {
                handleSwipeMove(e.clientX, e.target);
            });

            taskListContainer.addEventListener('mouseup', (e) => {
                handleSwipeEnd(e.target);
            });
            
            taskListContainer.addEventListener('mouseleave', (e) => {
                if (isDragging) {
                    handleSwipeEnd(e.target);
                }
            });


            // --- Click handling for start and delete ---
            if (taskListContainer) {
                taskListContainer.addEventListener('click', async (e) => {
                    const startBtn = e.target.closest('.task-card-start-btn');
                    const deleteBtn = e.target.closest('.task-card-delete-btn');
                    const cardWrapper = e.target.closest('.task-card-wrapper');

                    if (deleteBtn && cardWrapper) {
                        const taskId = cardWrapper.dataset.id;
                        if (confirm('确定要删除这个任务吗？')) {
                            db.pomodoroTasks = db.pomodoroTasks.filter(t => t.id !== taskId);
                            await saveData();
                            renderPomodoroTasks();
                            showToast('任务已删除');
                        }
                    } else if (startBtn && cardWrapper) {
                        const taskId = cardWrapper.dataset.id;
                        const task = db.pomodoroTasks.find(t => t.id === taskId);
                        
                        if (task) {
                            // --- Start Focus Session ---
                            currentPomodoroTask = task;
                            stopTimer(); // Ensure any previous timer is stopped
                            pomodoroCurrentSessionSeconds = 0; // Reset session timer
                            pomodoroPokeCount = 0; // Reset poke count
                            pomodoroIsInterrupted = false; // Reset interruption flag
                            pomodoroSessionHistory = []; // NEW: Reset session history
 
                            // 新增：清空并隐藏对话框
                            const focusMessageBubble = document.querySelector('#pomodoro-focus-screen .focus-message-bubble');
                            if (focusMessageBubble) {
                                focusMessageBubble.classList.remove('visible');
                                focusMessageBubble.querySelector('p').textContent = '';
                            }

                            focusTitleEl.textContent = task.name;
                            focusModeEl.textContent = task.mode === 'countdown' ? '倒计时' : '正计时';
                            
                            if (task.mode === 'countdown') {
                                pomodoroRemainingSeconds = task.duration * 60;
                            } else {
                                pomodoroRemainingSeconds = 0;
                            }
                            
                            updateTimerDisplay();
                            updateTotalFocusedTimeDisplay(); // Update display to show 0

                            // NEW: Update avatar based on bound character
                            const focusAvatarEl = document.querySelector('#pomodoro-focus-screen .focus-avatar');
                            if (task.settings && task.settings.boundCharId) {
                                const boundChar = db.characters.find(c => c.id === task.settings.boundCharId);
                                if (boundChar && focusAvatarEl) {
                                    focusAvatarEl.src = boundChar.avatar;
                                } else if (focusAvatarEl) {
                                    focusAvatarEl.src = 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg'; // Fallback
                                }
                            } else if (focusAvatarEl) {
                                focusAvatarEl.src = 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg'; // Fallback
                            }
                            // END NEW
 
                            applyPomodoroBackgrounds(); // Apply backgrounds when starting a task
                            // Timer is now started from the focus screen, not automatically.
                            switchScreen('pomodoro-focus-screen');
                        }
                    } else if (cardWrapper && !cardWrapper.classList.contains('is-swiped')) {
                        // If a non-swiped card is clicked, close any open one
                        if (swipedCardWrapper) {
                            swipedCardWrapper.classList.remove('is-swiped');
                            swipedCardWrapper = null;
                        }
                    }
                });
            }
        }

        const init = async () => {
            await loadData();
            if (!db.homeWidgetSettings || !db.homeWidgetSettings.topLeft) {
            db.homeWidgetSettings = JSON.parse(JSON.stringify(defaultWidgetSettings));
            }
            document.body.addEventListener('click', (e) => {
                if (e.target.closest('.context-menu')) {
                    e.stopPropagation();
                    return;
                }
                removeContextMenu();

                // ... 在 init 函数的事件监听中 ...

                const backBtn = e.target.closest('.back-btn');
                if (backBtn) {
                    e.preventDefault();
                    const targetId = backBtn.getAttribute('data-target');
                    switchScreen(targetId);

                    // --- 新增：点击返回按钮时，同步更新底部导航栏的高亮状态 ---
                    document.querySelectorAll('.bottom-tab-bar .tab-item').forEach(t => {
                        if (t.dataset.target === targetId) {
                            t.classList.add('active');
                        } else {
                            t.classList.remove('active');
                        }
                    });
                }
                
                

                // Consolidated overlay closing logic
                const openOverlay = document.querySelector('.modal-overlay.visible, .action-sheet-overlay.visible');
                if (openOverlay && e.target === openOverlay) {
                    openOverlay.classList.remove('visible');
                }
            });

            // Specific nav links that switch screens
            document.body.addEventListener('click', e => {
                const navLink = e.target.closest('.app-icon[data-target]');
                if (navLink) {
                    e.preventDefault();
                    const target = navLink.getAttribute('data-target');
                    if (target === 'screen' || target === 'diary-screen' || target === 'piggy-bank-screen') {
                        showToast('该应用正在开发中，敬请期待！');
                        return;
                    }
                    switchScreen(target);
                }
            });

            updateClock();
            setInterval(updateClock, 30000);
            applyGlobalFont(db.fontUrl);
            applyGlobalCss(db.globalCss);
            applyPomodoroBackgrounds();
            setupHomeScreen();
            setupChatListScreen();
            setupAddCharModal();
            setupChatRoom();
            setupChatSettings();
            setupApiSettingsApp();
            setupWallpaperApp();
            await setupStickerSystem();
            setupPresetFeatures();
            setupVoiceMessageSystem();
            setupPhotoVideoSystem();
            setupImageRecognition();
            setupWalletSystem();
            setupGiftSystem();
            setupTimeSkipSystem();
            setupWorldBookApp();
            setupFontSettingsApp();
            setupGroupChatSystem();
            setupCustomizeApp();
            setupTutorialApp();
            checkForUpdates();
            setupPeekFeature();
            setupChatExpansionPanel();
            setupMemoryJournalScreen(); // 新增：初始化回忆日记功能
            setupDeleteHistoryChunk();
            setupForumBindingFeature();
            setupForumFeature();
            setupShareModal();
            setupStorageAnalysisScreen();
            setupPomodoroApp();
            setupPomodoroSettings();
            setupPomodoroGlobalSettings(); // NEW: Setup global settings
            setupInsWidgetAvatarModal();
          
            document.getElementById('delete-selected-world-books-btn').addEventListener('click', deleteSelectedWorldBooks);
            document.getElementById('cancel-wb-multi-select-btn').addEventListener('click', exitWorldBookMultiSelectMode);
        };

        function setupInsWidgetAvatarModal() {
            const modal = document.getElementById('ins-widget-avatar-modal');
            const form = document.getElementById('ins-widget-avatar-form');
            const preview = document.getElementById('ins-widget-avatar-preview');
            const urlInput = document.getElementById('ins-widget-avatar-url-input');
            const fileUpload = document.getElementById('ins-widget-avatar-file-upload');
            const targetInput = document.getElementById('ins-widget-avatar-target');

            // Use event delegation on homeScreen for avatars since it's re-rendered
            const homeScreen = document.getElementById('home-screen');
            homeScreen.addEventListener('click', (e) => {
                const avatar1 = e.target.closest('#ins-widget-avatar-1');
                const avatar2 = e.target.closest('#ins-widget-avatar-2');

                let targetAvatarId = null;
                let currentSrc = '';

                if (avatar1) {
                    targetAvatarId = 'avatar1';
                    currentSrc = db.insWidgetSettings.avatar1;
                } else if (avatar2) {
                    targetAvatarId = 'avatar2';
                    currentSrc = db.insWidgetSettings.avatar2;
                }

                if (targetAvatarId) {
                    targetInput.value = targetAvatarId;
                    preview.style.backgroundImage = `url("${currentSrc}")`;
                    preview.innerHTML = ''; // Clear "预览" text
                    urlInput.value = '';
                    fileUpload.value = null;
                    modal.classList.add('visible');
                }
            });

            // Handle URL input
            urlInput.addEventListener('input', () => {
                const url = urlInput.value.trim();
                if (url) {
                    preview.style.backgroundImage = `url("${url}")`;
                    preview.innerHTML = '';
                    fileUpload.value = null; // Clear file input if URL is used
                } else {
                    preview.style.backgroundImage = 'none';
                    preview.innerHTML = '<span>预览</span>';
                }
            });

            // Handle file upload
            fileUpload.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 200, maxHeight: 200 });
                        preview.style.backgroundImage = `url("${compressedUrl}")`;
                        preview.innerHTML = '';
                        urlInput.value = ''; // Clear URL input if file is used
                    } catch (error) {
                        showToast('图片压缩失败，请重试');
                        preview.style.backgroundImage = 'none';
                        preview.innerHTML = '<span>预览</span>';
                    }
                }
            });

            // Handle form submission
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const targetAvatar = targetInput.value;
                const bgImage = preview.style.backgroundImage;
                const newSrc = bgImage.slice(5, -2); // Extract URL from 'url("...")'

                if (!targetAvatar || !newSrc) {
                    showToast('没有要保存的图片');
                    return;
                }

                if (targetAvatar === 'centralCircle') {
                    db.homeWidgetSettings.centralCircleImage = newSrc;
                } else if (targetAvatar === 'avatar1') {
                    db.insWidgetSettings.avatar1 = newSrc;
                } else if (targetAvatar === 'avatar2') {
                    db.insWidgetSettings.avatar2 = newSrc;
                }

                await saveData();
                setupHomeScreen(); // Re-render the home screen to show the new avatar
                modal.classList.remove('visible');
                showToast('头像已更新');
            });
        }

       function updatePolaroidImage(imageUrl) {
           const styleId = 'polaroid-image-style';
           let styleElement = document.getElementById(styleId);
           if (!styleElement) {
               styleElement = document.createElement('style');
               styleElement.id = styleId;
               document.head.appendChild(styleElement);
           }
           styleElement.innerHTML = `
               .heart-photo-widget::after {
                   background-image: url('${imageUrl}');
               }
           `;
       }    

 // Function to switch screens (ensure this is accessible, or redefine if needed)
        // function showScreen(screenId) {
        //     screens.forEach(screen => {
        //         screen.classList.remove('active');
        //     });
        //     document.getElementById(screenId).classList.add('active');
        // }

    settingsScreen.addEventListener('click', (e) => {
        const listItem = e.target.closest('.list-item');
        if (listItem && listItem.dataset.target) {
            const targetScreenId = listItem.dataset.target;
            // 直接调用全局的 showScreen 函数
            switchScreen(targetScreenId);
            if (targetScreenId === 'world-book-screen') {
                renderWorldBookList();
            }
            if (targetScreenId === 'customize-screen') {
                renderCustomizeForm();
            }
            if (targetScreenId === 'tutorial-screen') {
                renderTutorialContent();
            }
        }
    });
    
     // Dark mode toggle functionality
        darkModeToggle.addEventListener('change', function() {
            if (this.checked) {
                // Day mode
    applyHomeScreenMode('day');            
            } else {
                // Night mode
   
   applyHomeScreenMode('night');    
            }
        });
        
        function setupPomodoroSettings() {
            const settingsBtn = document.getElementById('pomodoro-focus-settings-btn');
            const settingsSidebar = document.getElementById('pomodoro-settings-sidebar');
            const settingsForm = document.getElementById('pomodoro-settings-form');
            const focusBgUpload = document.getElementById('pomodoro-focus-bg-upload');
            const taskCardBgUpload = document.getElementById('pomodoro-task-card-bg-upload');

            settingsBtn?.addEventListener('click', () => {
                if (currentPomodoroTask) {
                    currentPomodoroSettingsContext = currentPomodoroTask.settings;
                    loadSettingsToPomodoroSidebar(currentPomodoroSettingsContext);
                    settingsSidebar.classList.add('open');
                } else {
                    showToast('没有正在进行的专注任务');
                }
            });

            settingsForm?.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (currentPomodoroSettingsContext) {
                    await savePomodoroSettingsFromSidebar(currentPomodoroSettingsContext);
                }
                settingsSidebar.classList.remove('open');
            });

            focusBgUpload?.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file && currentPomodoroSettingsContext) {
                    try {
                        const compressedUrl = await compressImage(file, { quality: 0.85, maxWidth: 1080, maxHeight: 1920 });
                        document.getElementById('pomodoro-focus-bg-url').value = compressedUrl;
                        currentPomodoroSettingsContext.focusBackground = compressedUrl;
                        applyPomodoroBackgrounds();
                        showToast('专注背景已更新，请保存设置');
                    } catch (error) {
                        showToast('背景压缩失败');
                    }
                }
            });

            taskCardBgUpload?.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file && currentPomodoroSettingsContext) {
                    try {
                        const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 800, maxHeight: 800 });
                        // 将上传的图片URL保存到当前任务的独立设置中
                        currentPomodoroSettingsContext.taskCardBackground = compressedUrl;
                        // 同时更新输入框的值，以便保存时能正确写入
                        document.getElementById('pomodoro-task-card-bg-url').value = compressedUrl;
                        showToast('卡片背景已更新，请保存设置');
                    } catch (error) {
                        showToast('背景压缩失败');
                    }
                }
            });
        }

        function loadSettingsToPomodoroSidebar(settings) {
            const charSelect = document.getElementById('pomodoro-char-select');
            const userPersonaSelect = document.getElementById('pomodoro-user-persona-select');

            charSelect.innerHTML = '<option value="">不绑定</option>';
            db.characters.forEach(char => {
                const option = document.createElement('option');
                option.value = char.id;
                option.textContent = char.remarkName;
                if (settings.boundCharId === char.id) {
                    option.selected = true;
                }
                charSelect.appendChild(option);
            });

            userPersonaSelect.innerHTML = '<option value="">默认</option>';
            (db.myPersonaPresets || []).forEach(preset => {
                const option = document.createElement('option');
                option.value = preset.name;
                option.textContent = preset.name;
                if (settings.userPersona === preset.name) {
                    option.selected = true;
                }
                userPersonaSelect.appendChild(option);
            });

            document.getElementById('pomodoro-encouragement-minutes').value = settings.encouragementMinutes || 25;
            document.getElementById('pomodoro-poke-limit').value = settings.pokeLimit || 5;
            document.getElementById('pomodoro-focus-bg-url').value = settings.focusBackground || '';
            document.getElementById('pomodoro-task-card-bg-url').value = settings.taskCardBackground || '';
        }

        async function savePomodoroSettingsFromSidebar(settings) {
            const oldCharId = settings.boundCharId;
            const newCharId = document.getElementById('pomodoro-char-select').value;

            settings.boundCharId = newCharId;
            settings.userPersona = document.getElementById('pomodoro-user-persona-select').value;
            settings.encouragementMinutes = parseInt(document.getElementById('pomodoro-encouragement-minutes').value, 10) || 25;
            settings.pokeLimit = parseInt(document.getElementById('pomodoro-poke-limit').value, 10) || 5;
            settings.focusBackground = document.getElementById('pomodoro-focus-bg-url').value.trim();
            settings.taskCardBackground = document.getElementById('pomodoro-task-card-bg-url').value.trim();
            
            await saveData();
            applyPomodoroBackgrounds();

            // Update avatar in focus screen if it's active
            const focusAvatarEl = document.querySelector('#pomodoro-focus-screen .focus-avatar');
            if (settings.boundCharId) {
                const boundChar = db.characters.find(c => c.id === settings.boundCharId);
                if (boundChar && focusAvatarEl) {
                    focusAvatarEl.src = boundChar.avatar;
                }
            } else if (focusAvatarEl) {
                focusAvatarEl.src = 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg'; // Fallback
            }

            // 新增：如果更换了角色，则清空对话框
            if (oldCharId !== newCharId) {
                const focusMessageBubble = document.querySelector('#pomodoro-focus-screen .focus-message-bubble');
                if (focusMessageBubble) {
                    focusMessageBubble.classList.remove('visible');
                    focusMessageBubble.querySelector('p').textContent = '';
                }
            }

            showToast('专注设置已保存');
        }

        function applyPomodoroBackgrounds() {
            const focusScreen = document.getElementById('pomodoro-focus-screen');
            
            // Apply focus screen background from the CURRENT task if it exists
            if (currentPomodoroTask && currentPomodoroTask.settings.focusBackground) {
                focusScreen.style.backgroundImage = `url(${currentPomodoroTask.settings.focusBackground})`;
                focusScreen.style.backgroundSize = 'cover';
                focusScreen.style.backgroundPosition = 'center';
            } else {
                focusScreen.style.backgroundImage = 'none';
            }

        }

        function setupPomodoroGlobalSettings() {
            const settingsBtn = document.getElementById('pomodoro-settings-btn');
            const sidebar = document.getElementById('pomodoro-global-settings-sidebar');
            const linkBtn = document.getElementById('link-global-pomodoro-world-book-btn');
            const modal = document.getElementById('global-pomodoro-world-book-selection-modal');
            const selectionList = document.getElementById('global-pomodoro-world-book-selection-list');
            const saveBtn = document.getElementById('save-global-pomodoro-world-book-selection-btn');

            settingsBtn?.addEventListener('click', () => {
                sidebar.classList.add('open');
            });

            linkBtn?.addEventListener('click', () => {
                if (!db.pomodoroSettings) {
                    db.pomodoroSettings = { globalWorldBookIds: [] };
                }
                const selectedIds = db.pomodoroSettings.globalWorldBookIds || [];
                renderCategorizedWorldBookList(selectionList, db.worldBooks, selectedIds, 'global-pomodoro-wb-select');
                modal.classList.add('visible');
            });

            saveBtn?.addEventListener('click', async () => {
                const selectedIds = Array.from(selectionList.querySelectorAll('.item-checkbox:checked')).map(input => input.value);
                if (!db.pomodoroSettings) {
                    db.pomodoroSettings = {};
                }
                db.pomodoroSettings.globalWorldBookIds = selectedIds;
                await saveData();
                modal.classList.remove('visible');
                showToast('全局专注世界书已更新');
            });
        }

        function setupMemoryJournalScreen() {
            const generateNewJournalBtn = document.getElementById('generate-new-journal-btn');
            const generateJournalModal = document.getElementById('generate-journal-modal');
            const generateJournalForm = document.getElementById('generate-journal-form');
            const journalListContainer = document.getElementById('journal-list-container');
            const editDetailBtn = document.getElementById('edit-journal-detail-btn');
            const bindWorldBookBtn = document.getElementById('bind-journal-worldbook-btn');
            const journalWorldBookModal = document.getElementById('journal-worldbook-selection-modal');
            const journalWorldBookList = document.getElementById('journal-worldbook-selection-list');
            const saveJournalWorldBookBtn = document.getElementById('save-journal-worldbook-selection-btn');

            // 新增：绑定世界书按钮事件
            bindWorldBookBtn.addEventListener('click', () => {
                const character = db.characters.find(c => c.id === currentChatId);
                if (!character) return;
                renderCategorizedWorldBookList(journalWorldBookList, db.worldBooks, character.journalWorldBookIds || [], 'journal-wb-select');
                journalWorldBookModal.classList.add('visible');
            });

            // 新增：保存世界书绑定
            saveJournalWorldBookBtn.addEventListener('click', async () => {
                const character = db.characters.find(c => c.id === currentChatId);
                if (!character) return;

                const selectedIds = Array.from(journalWorldBookList.querySelectorAll('.item-checkbox:checked')).map(input => input.value);
                character.journalWorldBookIds = selectedIds;
                await saveData();
                journalWorldBookModal.classList.remove('visible');
                showToast('日记绑定的世界书已更新');
            });

             // "生成新日记" 按钮 -> 弹出范围选择模态框
            generateNewJournalBtn.addEventListener('click', () => {
                const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
                const totalMessages = chat ? chat.history.length : 0;
                
                const rangeInfo = document.getElementById('journal-range-info');
                rangeInfo.textContent = `当前聊天总消息数: ${totalMessages}`;

                generateJournalForm.reset();
                generateJournalModal.classList.add('visible');
            });

            // 范围选择表单提交
            generateJournalForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const startInput = document.getElementById('journal-range-start');
                const endInput = document.getElementById('journal-range-end');

                const start = parseInt(startInput.value);
                const end = parseInt(endInput.value);
                
                if (isNaN(start) || isNaN(end) || start <= 0 || end < start) {
                    showToast('请输入有效的起止范围');
                    return;
                }

                generateJournalModal.classList.remove('visible');
                await generateJournal(start, end);
            });

            // 点击列表容器中的项目 (事件委托)
            journalListContainer.addEventListener('click', async (e) => {
                const target = e.target;
                const card = target.closest('.journal-card');
                if (!card) return;

                const journalId = card.dataset.id;
                const character = db.characters.find(c => c.id === currentChatId);
                if (!character) return;
                const journal = character.memoryJournals.find(j => j.id === journalId);
                if (!journal) return;

                // --- Handle Action Buttons ---
                if (target.closest('.delete-journal-btn')) {
                    if (confirm('确定要删除这篇日记吗？')) {
                        character.memoryJournals = character.memoryJournals.filter(j => j.id !== journalId);
                        await saveData();
                        renderJournalList();
                        showToast('日记已删除');
                    }
                    return;
                }

                if (target.closest('.favorite-journal-btn')) {
                    journal.isFavorited = !journal.isFavorited;
                    await saveData();
                    target.closest('.favorite-journal-btn').classList.toggle('favorited', journal.isFavorited);
                    showToast(journal.isFavorited ? '已收藏' : '已取消收藏');
                    return;
                }
                
                // --- Handle Navigation to Detail Screen ---
                const date = new Date(journal.createdAt);
                const formattedDate = `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}`;
                
                currentJournalDetailId = journal.id;

                const titleEl = document.getElementById('journal-detail-title');
                const contentEl = document.getElementById('journal-detail-content');

                titleEl.isContentEditable = false;
                contentEl.isContentEditable = false;
                titleEl.style.border = 'none';
                contentEl.style.border = 'none';
                titleEl.style.padding = '0';
                contentEl.style.padding = '0';
                editDetailBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z" /></svg>`;

                titleEl.textContent = journal.title;
                document.getElementById('journal-detail-meta').textContent = `创建于 ${formattedDate} | 消息范围: ${journal.range.start}-${journal.range.end}`;
                document.getElementById('journal-detail-content').textContent = journal.content;
                
                switchScreen('memory-journal-detail-screen');
            });

            // --- NEW: Event listener for the detail page edit button ---
            editDetailBtn.addEventListener('click', async () => {
                if (!currentJournalDetailId) return;

                const titleEl = document.getElementById('journal-detail-title');
                const contentEl = document.getElementById('journal-detail-content');
                const isEditing = titleEl.isContentEditable;

                if (isEditing) {
                    // --- SAVE LOGIC ---
                    const character = db.characters.find(c => c.id === currentChatId);
                    if (!character) return;
                    const journal = character.memoryJournals.find(j => j.id === currentJournalDetailId);
                    if (!journal) return;

                    journal.title = titleEl.textContent.trim();
                    journal.content = contentEl.textContent.trim();
                    await saveData();

                    titleEl.isContentEditable = false;
                    contentEl.isContentEditable = false;
                    titleEl.style.border = 'none';
                    contentEl.style.border = 'none';
                    titleEl.style.padding = '0';
                    contentEl.style.padding = '0';
                    editDetailBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z" /></svg>`;
                    showToast('日记已保存');
                    renderJournalList(); // Re-render list to show updated title if changed
                } else {
                    // --- EDIT LOGIC ---
                    titleEl.setAttribute('contenteditable', 'true');
                    contentEl.setAttribute('contenteditable', 'true');
                    titleEl.style.border = '1px dashed #ccc';
                    titleEl.style.padding = '5px';
                    contentEl.style.border = '1px dashed #ccc';
                    contentEl.style.padding = '10px';
                    editDetailBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M9,16.17L4.83,12L3.41,13.41L9,19L21,7L19.59,5.59L9,16.17Z" /></svg>`; // Checkmark icon
                    titleEl.focus();
                }
            });
        }

        function renderJournalList() {
            const container = document.getElementById('journal-list-container');
            const placeholder = document.getElementById('no-journals-placeholder');
            container.innerHTML = '';

            const character = db.characters.find(c => c.id === currentChatId);
            const journals = character ? character.memoryJournals : [];

            if (!journals || journals.length === 0) {
                placeholder.style.display = 'block';
                return;
            }

            placeholder.style.display = 'none';

            const sortedJournals = [...journals].sort((a, b) => a.createdAt - b.createdAt);

            sortedJournals.forEach(journal => {
                const card = document.createElement('li');
                card.className = 'journal-card';
                card.dataset.id = journal.id;

                const date = new Date(journal.createdAt);
                const formattedDate = `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}`;

                card.innerHTML = `
                    <div class="journal-card-header">
                        <div class="journal-card-title">${journal.title}</div>
                    </div>
                    <div class="journal-card-actions">
                        <button class="action-icon-btn favorite-journal-btn" title="收藏">
                            <svg viewBox="0 0 24 24">
                                <path class="star-outline" d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z" fill="currentColor"/>
                                <path class="star-solid" d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z"/>
                            </svg>
                        </button>
                        <button class="action-icon-btn delete-journal-btn" title="删除">
                            <svg viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" /></svg>
                        </button>
                    </div>
                    <div class="journal-card-footer" style="justify-content: space-between; height: auto; opacity: 1; margin-top: 10px;">
                        <span class="journal-card-date">${formattedDate}</span>
                        <span class="journal-card-range">范围: ${journal.range.start}-${journal.range.end}</span>
                    </div>
                `;

                if (journal.isFavorited) {
                    card.querySelector('.favorite-journal-btn').classList.add('favorited');
                }

                container.appendChild(card);
            });

            // 为相册刷新按钮添加事件监听
            const refreshAlbumBtn = document.getElementById('refresh-album-btn');
            if(refreshAlbumBtn) {
                refreshAlbumBtn.addEventListener('click', () => generateAndRenderPeekContent('album', { forceRefresh: true }));
            }
    
            // 为照片详情模态框添加关闭事件
            const photoModal = document.getElementById('peek-photo-modal');
            if(photoModal) {
                photoModal.addEventListener('click', (e) => {
                    if (e.target === photoModal) {
                        photoModal.classList.remove('visible');
                    }
                });
            }
        }

        async function generateJournal(start, end) {
            showToast('正在生成日记，请稍候...');
            isGenerating = true; // Set a flag to prevent other actions

            try {
                const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
                if (!chat) {
                    throw new Error("未找到当前聊天。");
                }

                // Message indices are 1-based for the user, so convert to 0-based for slicing
                const startIndex = start - 1;
                const endIndex = end;
                
                if (startIndex < 0 || endIndex > chat.history.length || startIndex >= endIndex) {
                    throw new Error("无效的消息范围。");
                }

                const messagesToSummarize = chat.history.slice(startIndex, endIndex);
                
                // 使用为日记绑定的世界书
                const journalWorldBooks = (chat.journalWorldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id)).filter(Boolean);
                const worldBooksContent = journalWorldBooks.map(wb => wb.content).join('\n\n');

                let summaryPrompt = `你是一个日记整理助手。请以角色 "${chat.remarkName || chat.name}" 的第一人称视角，总结以下聊天记录。请专注于重要的情绪、事件和细节。\n\n`;
                summaryPrompt += "为了更好地理解角色和背景，请参考以下信息：\n";
                summaryPrompt += "=====\n";

                if (worldBooksContent) {
                    summaryPrompt += `世界观设定:\n${worldBooksContent}\n\n`;
                }

                summaryPrompt += `你的角色设定:\n- 角色名: ${chat.realName}\n- 人设: ${chat.persona || "一个友好、乐于助人的伙伴。"}\n\n`;
                summaryPrompt += `我的角色设定:\n- 我的称呼: ${chat.myName}\n- 我的人设: ${chat.myPersona || "无特定人设。"}\n\n`;
                summaryPrompt += "=====\n";
                summaryPrompt += `请基于以上所有背景信息，总结以下聊天记录。你的输出必须是一个JSON对象，包含 'title' (一个简洁的标题) 和 'content' (完整的日记正文) 两个字段。聊天记录如下：\n\n---\n${messagesToSummarize.map(m => m.content).join('\n')}\n---`;

                const { url, key, model, provider } = db.apiSettings;
                if (!url || !key || !model) {
                    throw new Error("API设置不完整。");
                }

                const requestBody = {
                    model: model,
                    messages: [{ role: 'user', content: summaryPrompt }],
                    temperature: 0.7,
                    response_format: { type: "json_object" }, // Request JSON output
                };
                const endpoint = `${url}/v1/chat/completions`;
                const headers = { 'Content-Type': 'application/json', Authorization: `Bearer ${key}` };

                const response = await fetch(endpoint, { method: 'POST', headers: headers, body: JSON.stringify(requestBody) });
                if (!response.ok) {
                    const error = new Error(`API 错误: ${response.status} ${await response.text()}`);
                    error.response = response;
                    throw error;
                }

                const result = await response.json();
                const rawContent = result.choices[0].message.content;
                const journalData = JSON.parse(rawContent);

                // Create and save the new journal entry
                const newJournal = {
                    id: `journal_${Date.now()}`,
                    range: { start, end },
                    title: journalData.title || "无标题日记",
                    content: journalData.content || "内容为空。",
                    createdAt: Date.now(),
                    chatId: currentChatId,
                    chatType: currentChatType,
                    isFavorited: false // 新增：收藏状态
                };

                if (!chat.memoryJournals) {
                    chat.memoryJournals = [];
                }
                chat.memoryJournals.push(newJournal);
                await saveData();

                renderJournalList();
                showToast('新日记已生成！');

            } catch (error) {
                showApiError(error);
            } finally {
                isGenerating = false; // Reset the flag
            }
        }

        function setupPeekFeature() {
            const peekBtn = document.getElementById('peek-btn');
            const peekConfirmModal = document.getElementById('peek-confirm-modal');
            const peekConfirmYes = document.getElementById('peek-confirm-yes');
            const peekConfirmNo = document.getElementById('peek-confirm-no');
            const peekSettingsBtn = document.getElementById('peek-settings-btn');
            const peekWallpaperModal = document.getElementById('peek-wallpaper-modal');
            const peekWallpaperForm = document.getElementById('peek-wallpaper-form');
            const peekWallpaperUpload = document.getElementById('peek-wallpaper-upload');
            const peekWallpaperPreview = document.getElementById('peek-wallpaper-preview');

            peekBtn?.addEventListener('click', () => {
                peekConfirmModal.classList.add('visible');
            });

            peekConfirmNo?.addEventListener('click', () => {
                peekConfirmModal.classList.remove('visible');
            });

            peekConfirmYes?.addEventListener('click', () => {
                peekConfirmModal.classList.remove('visible');
                peekContentCache = {}; // Clear cache for new session
                renderPeekScreen(); // Render before switching
                switchScreen('peek-screen');
            });

            // New simplified settings functionality
            peekSettingsBtn?.addEventListener('click', () => {
                renderPeekSettings();
                peekWallpaperModal.classList.add('visible');
            });

            peekWallpaperUpload?.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, { quality: 0.85, maxWidth: 1080, maxHeight: 1920 });
                        document.getElementById('peek-wallpaper-url-input').value = compressedUrl;
                        showToast('图片已压缩并填入URL输入框');
                    } catch (error) {
                        showToast('壁纸压缩失败，请重试');
                    }
                }
            });

            // Combined save button for all peek settings
            document.getElementById('save-peek-settings-btn')?.addEventListener('click', async () => {
                const character = db.characters.find(c => c.id === currentChatId);
                if (!character) {
                    showToast('错误：未找到当前角色');
                    return;
                }

                if (!character.peekScreenSettings) {
                    character.peekScreenSettings = { wallpaper: '', customIcons: {}, unlockAvatar: '' };
                }

                // Save wallpaper
                character.peekScreenSettings.wallpaper = document.getElementById('peek-wallpaper-url-input').value.trim();

                // Save custom app icons
                const iconInputs = document.querySelectorAll('#peek-app-icons-settings input[type="url"]');
                iconInputs.forEach(input => {
                    const appId = input.dataset.appId;
                    const newUrl = input.value.trim();
                    if (newUrl) {
                        if (!character.peekScreenSettings.customIcons) {
                            character.peekScreenSettings.customIcons = {};
                        }
                        character.peekScreenSettings.customIcons[appId] = newUrl;
                    } else {
                        if (character.peekScreenSettings.customIcons) {
                            delete character.peekScreenSettings.customIcons[appId];
                        }
                    }
                });
                
                // Save unlock avatar
                character.peekScreenSettings.unlockAvatar = document.getElementById('peek-unlock-avatar-url').value.trim();

                await saveData();
                renderPeekScreen(); // Re-render to apply all changes
                showToast('已保存！');
                peekWallpaperModal.classList.remove('visible');
            });

            // Add collapsible functionality
            peekWallpaperModal.addEventListener('click', (e) => {
                const header = e.target.closest('.collapsible-header');
                if (header) {
                    header.parentElement.classList.toggle('open');
                }
            });

            const peekMessagesScreen = document.getElementById('peek-messages-screen');
            peekMessagesScreen.addEventListener('click', (e) => {
                const chatItem = e.target.closest('.chat-item');
                if (chatItem) {
                    const partnerName = chatItem.dataset.name;
                    const cachedData = peekContentCache.messages;
                    if (cachedData && cachedData.conversations) {
                        const conversation = cachedData.conversations.find(c => c.partnerName === partnerName);
                        if (conversation) {
                            renderPeekConversation(conversation.history, conversation.partnerName);
                            switchScreen('peek-conversation-screen');
                        } else {
                            showToast('找不到对话记录');
                        }
                    }
                } else if (e.target.closest('.action-btn')) {
                    generateAndRenderPeekContent('messages', { forceRefresh: true });
                }
            });

            const peekConversationScreen = document.getElementById('peek-conversation-screen');
            peekConversationScreen.addEventListener('click', (e) => {
                if (e.target.closest('.action-btn')) {
                    generateAndRenderPeekContent('messages', { forceRefresh: true });
                }
            });

            // 为相册刷新按钮添加事件监听
            const refreshAlbumBtn = document.getElementById('refresh-album-btn');
            if(refreshAlbumBtn) {
                refreshAlbumBtn.addEventListener('click', () => generateAndRenderPeekContent('album', { forceRefresh: true }));
            }
    
            // 为照片详情模态框添加关闭事件
            const photoModal = document.getElementById('peek-photo-modal');
            if(photoModal) {
                photoModal.addEventListener('click', (e) => {
                    if (e.target === photoModal) {
                        photoModal.classList.remove('visible');
                    }
                });
            }
        }

        function renderPeekAlbum(photos) {
            const screen = document.getElementById('peek-album-screen');
            const grid = screen.querySelector('.album-grid');
            grid.innerHTML = ''; // Clear previous content
    
            if (!photos || photos.length === 0) {
                grid.innerHTML = '<p class="placeholder-text">正在生成相册内容...</p>';
                return;
            }
    
            photos.forEach(photo => {
                const photoEl = document.createElement('div');
                photoEl.className = 'album-photo';
                photoEl.dataset.imageDescription = photo.imageDescription;
                photoEl.dataset.description = photo.description;
    
                const img = document.createElement('img');
                img.src = 'https://i.postimg.cc/1tH6ds9g/1752301200490.jpg'; // 使用一个静态占位图
                img.alt = "相册照片";
                photoEl.appendChild(img);
    
                if (photo.type === 'video') {
                    const videoIndicator = document.createElement('div');
                    videoIndicator.className = 'video-indicator';
                    videoIndicator.innerHTML = `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>`;
                    photoEl.appendChild(videoIndicator);
                }
                
                photoEl.addEventListener('click', () => {
                    const modal = document.getElementById('peek-photo-modal');
                    const imgContainer = document.getElementById('peek-photo-image-container');
                    const descriptionEl = document.getElementById('peek-photo-description');
                    
                    // 将AI生成的图片文字描述展示出来，而不是真的图片
                    imgContainer.innerHTML = `<div style="padding: 20px; text-align: left; color: #555; font-size: 16px; line-height: 1.6; height: 100%; overflow-y: auto;">${photo.imageDescription}</div>`;
                    // 显示角色对照片的批注
                    descriptionEl.textContent = `批注：${photo.description}`;
                    
                    modal.classList.add('visible');
                });
    
                grid.appendChild(photoEl);
            });
        }

        function renderPeekUnlock(data) {
            const screen = document.getElementById('peek-unlock-screen');
            if (!screen) return;

            // Handle loading/empty state
            if (!data) {
                screen.innerHTML = `
                    <header class="app-header">
                        <button class="back-btn" data-target="peek-screen">‹</button>
                        <div class="title-container"><h1 class="title">...</h1></div>
                        <button class="action-btn">···</button>
                    </header>
                    <main class="content"><p class="placeholder-text">正在生成小号内容...</p></main>
                `;
                return;
            }

            const { nickname, handle, bio, posts } = data;
            const character = db.characters.find(c => c.id === currentChatId);
            const peekSettings = character?.peekScreenSettings || { unlockAvatar: '' };
            const fixedAvatar = peekSettings.unlockAvatar || 'https://i.postimg.cc/SNwL1XwR/chan-11.png';

            // Random numbers for stats
            const randomFollowers = (Math.random() * 5 + 1).toFixed(1) + 'k';
            const randomFollowing = Math.floor(Math.random() * 500) + 50;

            let postsHtml = '';
            if (posts && posts.length > 0) {
                posts.forEach(post => {
                    const randomComments = Math.floor(Math.random() * 100);
                    const randomLikes = Math.floor(Math.random() * 500);
                    postsHtml += `
                        <div class="unlock-post-card">
                            <div class="unlock-post-card-header">
                                <img src="${fixedAvatar}" alt="Profile Avatar">
                                <div class="unlock-post-card-author-info">
                                    <span class="username">${nickname}</span>
                                    <span class="timestamp">${post.timestamp}</span>
                                </div>
                            </div>
                            <div class="unlock-post-card-content">
                                ${post.content.replace(/\n/g, '<br>')}
                            </div>
                            <div class="unlock-post-card-actions">
                                <div class="action"><svg viewBox="0 0 24 24"><path d="M18,16.08C17.24,16.08 16.56,16.38 16.04,16.85L8.91,12.7C8.96,12.47 9,12.24 9,12C9,11.76 8.96,11.53 8.91,11.3L16.04,7.15C16.56,7.62 17.24,7.92 18,7.92C19.66,7.92 21,6.58 21,5C21,3.42 19.66,2 18,2C16.34,2 15,3.42 15,5C15,5.24 15.04,5.47 15.09,5.7L7.96,9.85C7.44,9.38 6.76,9.08 6,9.08C4.34,9.08 3,10.42 3,12C3,13.58 4.34,14.92 6,14.92C6.76,14.92 7.44,14.62 7.96,14.15L15.09,18.3C15.04,18.53 15,18.76 15,19C15,20.58 16.34,22 18,22C19.66,22 21,20.58 21,19C21,17.42 19.66,16.08 18,16.08Z"></path></svg> <span>分享</span></div>
                                <div class="action"><svg viewBox="0 0 24 24"><path d="M20,2H4C2.9,0,2,0.9,2,2v18l4-4h14c1.1,0,2-0.9,2-2V4C22,2.9,21.1,2,20,2z M18,14H6v-2h12V14z M18,11H6V9h12V11z M18,8H6V6h12V8z"></path></svg> <span>${randomComments}</span></div>
                                <div class="action"><svg viewBox="0 0 24 24"><path d="M12,21.35L10.55,20.03C5.4,15.36,2,12.27,2,8.5C2,5.42,4.42,3,7.5,3c1.74,0,3.41,0.81,4.5,2.09C13.09,3.81,14.76,3,16.5,3C19.58,3,22,5.42,22,8.5c0,3.78-3.4,6.86-8.55,11.54L12,21.35z"></path></svg> <span>${randomLikes}</span></div>
                            </div>
                        </div>
                    `;
                });
            }

            screen.innerHTML = `
                <header class="app-header">
                    <button class="back-btn" data-target="peek-screen">‹</button>
                    <div class="title-container">
                        <h1 class="title">${nickname}</h1>
                    </div>
                    <button class="action-btn" id="refresh-unlock-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg></button>
                </header>
                <main class="content">
                    <div class="unlock-profile-header">
                        <img src="${fixedAvatar}" alt="Profile Avatar" class="unlock-profile-avatar">
                        <div class="unlock-profile-info">
                            <h2 class="unlock-profile-username">${nickname}</h2>
                            <p class="unlock-profile-handle">${handle}</p>
                        </div>
                    </div>
                    <div class="unlock-profile-bio">
                        <p>${bio.replace(/\n/g, '<br>')}</p>
                    </div>
                    <div class="unlock-profile-stats">
                        <div class="unlock-profile-stat">
                            <span class="count">${posts.length}</span>
                            <span class="label">帖子</span>
                        </div>
                        <div class="unlock-profile-stat">
                            <span class="count">${randomFollowers}</span>
                            <span class="label">粉丝</span>
                        </div>
                        <div class="unlock-profile-stat">
                            <span class="count">${randomFollowing}</span>
                            <span class="label">关注</span>
                        </div>
                    </div>
                    <div class="unlock-post-feed">
                        ${postsHtml}
                    </div>
                </main>
            `;

            // Add event listener for the new refresh button
            screen.querySelector('#refresh-unlock-btn').addEventListener('click', () => {
                generateAndRenderPeekContent('unlock', { forceRefresh: true });
            });
        }
 
        function renderPeekConversation(history, partnerName) {
            const titleEl = document.getElementById('peek-conversation-title');
            const messageAreaEl = document.getElementById('peek-message-area');

            titleEl.textContent = partnerName;
            messageAreaEl.innerHTML = '';

            if (!history || history.length === 0) {
                messageAreaEl.innerHTML = '<p class="placeholder-text">正在生成对话...</p>';
                return;
            }

            history.forEach(msg => {
                const isSentByChar = msg.sender === 'char'; // 'char' is the character whose phone we are peeking
                const wrapper = document.createElement('div');
                wrapper.className = `message-wrapper ${isSentByChar ? 'sent' : 'received'}`;

                const bubbleRow = document.createElement('div');
                bubbleRow.className = 'message-bubble-row';

                const bubble = document.createElement('div');
                bubble.className = `message-bubble ${isSentByChar ? 'sent' : 'received'}`;
                bubble.textContent = msg.content;

                if (isSentByChar) {
                    bubbleRow.appendChild(bubble);
                } else {
                    const avatar = document.createElement('img');
                    avatar.className = 'message-avatar';
                    avatar.src = 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg';
                    bubbleRow.appendChild(avatar);
                    bubbleRow.appendChild(bubble);
                }
                
                wrapper.appendChild(bubbleRow);
                messageAreaEl.appendChild(wrapper);
            });
            messageAreaEl.scrollTop = messageAreaEl.scrollHeight;
        }

        function renderPeekScreen() {
            const peekScreen = document.getElementById('peek-screen');
            const contentArea = peekScreen.querySelector('main.content');

            // Set content
            contentArea.innerHTML = `
                <div class="time-widget">
                    <div class="time" id="peek-time-display"></div>
                    <div class="date" id="peek-date-display"></div>
                </div>
                <div class="app-grid"></div>
            `;

            const character = db.characters.find(c => c.id === currentChatId);
            const peekSettings = character?.peekScreenSettings || { wallpaper: '', customIcons: {} };

            // Apply wallpaper to the parent screen element
            const wallpaper = peekSettings.wallpaper;
            if (wallpaper) {
                peekScreen.style.backgroundImage = `url(${wallpaper})`;
            } else {
                peekScreen.style.backgroundImage = `url(${db.wallpaper})`; // Fallback to global wallpaper
            }
            peekScreen.style.backgroundSize = 'cover';
            peekScreen.style.backgroundPosition = 'center';

            // Render the 6 specific, non-functional icons
            const appGrid = contentArea.querySelector('.app-grid');
            Object.keys(peekScreenApps).forEach(id => {
                const iconData = peekScreenApps[id];
                const iconEl = document.createElement('a');
                iconEl.href = '#';
                iconEl.className = 'app-icon';
                iconEl.dataset.peekAppId = id;
                const customIconUrl = peekSettings.customIcons?.[id];
                const iconUrl = customIconUrl || iconData.url;
                iconEl.innerHTML = `
                    <img src="${iconUrl}" alt="${iconData.name}" class="icon-img">
                    <span class="app-name">${iconData.name}</span>
                `;
                iconEl.addEventListener('click', (e) => {
                    e.preventDefault();
                    generateAndRenderPeekContent(id);
                });
                appGrid.appendChild(iconEl);
            });

            // Call updateClock to immediately populate the time
            updateClock();
        }

        function renderPeekChatList(conversations = []) {
            const container = document.getElementById('peek-chat-list-container');
            container.innerHTML = '';

            if (!conversations || conversations.length === 0) {
                // This case is handled by the loading/error message in generateAndRenderPeekContent
                return;
            }

            // Use a pool of default avatars
            conversations.forEach((convo) => {
                const history = convo.history || [];
                const lastMessage = history.length > 0 ? history[history.length - 1] : null;
                const lastMessageText = lastMessage ? (lastMessage.content || '').replace(/\[.*?的消息：([\s\S]+)\]/, '$1') : '...';
                
                const li = document.createElement('li');
                li.className = 'list-item chat-item';
                // Use partnerName as the unique identifier for clicking
                li.dataset.name = convo.partnerName;

                const avatarUrl = 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg';

                li.innerHTML = `
                    <img src="${avatarUrl}" alt="${convo.partnerName}" class="chat-avatar">
                    <div class="item-details">
                        <div class="item-details-row"><div class="item-name">${convo.partnerName}</div></div>
                        <div class="item-preview-wrapper">
                            <div class="item-preview">${lastMessageText}</div>
                        </div>
                    </div>`;
                container.appendChild(li);
            });
        }

        function renderMemosList(memos) {
            const screen = document.getElementById('peek-memos-screen');
            let listHtml = '';
            if (!memos || memos.length === 0) {
                listHtml = '<p class="placeholder-text">正在生成备忘录...</p>';
            } else {
                memos.forEach(memo => {
                    const firstLine = memo.content.split('\n')[0];
                    listHtml += `
                        <li class="memo-item" data-id="${memo.id}">
                            <h3 class="memo-item-title">${memo.title}</h3>
                            <p class="memo-item-preview">${firstLine}</p>
                        </li>
                    `;
                });
            }

            screen.innerHTML = `
                <header class="app-header">
                    <button class="back-btn" data-target="peek-screen">‹</button>
                    <div class="title-container"><h1 class="title">备忘录</h1></div>
                    <button class="action-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg></button>
                </header>
                <main class="content"><ul id="peek-memos-list">${listHtml}</ul></main>
            `;

            screen.querySelector('.action-btn').addEventListener('click', () => {
                generateAndRenderPeekContent('memos', { forceRefresh: true });
            });

            screen.querySelectorAll('.memo-item').forEach(item => {
                item.addEventListener('click', () => {
                    // FIX: Correctly access the 'memos' array within the cached object.
                    const memo = peekContentCache.memos?.memos?.find(m => m.id === item.dataset.id);
                    if (memo) {
                        renderMemoDetail(memo);
                        switchScreen('peek-memo-detail-screen');
                    }
                });
            });
        }

        function renderMemoDetail(memo) {
            const screen = document.getElementById('peek-memo-detail-screen');
            if (!memo) return;
            const contentHtml = memo.content.replace(/\n/g, '<br>');
            screen.innerHTML = `
                <header class="app-header">
                    <button class="back-btn" data-target="peek-memos-screen">‹</button>
                    <div class="title-container"><h1 class="title">${memo.title}</h1></div>
                    <button class="action-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg></button>
                </header>
                <main class="content" style="padding: 20px; line-height: 1.6;">${contentHtml}</main>
            `;
        }

       function renderPeekCart(items) {
           const screen = document.getElementById('peek-cart-screen');
            let itemsHtml = '';
            let totalPrice = 0;

            if (!items || items.length === 0) {
                itemsHtml = '<p class="placeholder-text">正在生成购物车内容...</p>';
            } else {
                items.forEach(item => {
                    itemsHtml += `
                        <li class="cart-item" data-id="${item.id}">
                            <img src="https://i.postimg.cc/wMbSMvR9/export202509181930036600.png" class="cart-item-image" alt="${item.title}">
                            <div class="cart-item-details">
                                <h3 class="cart-item-title">${item.title}</h3>
                                <p class="cart-item-spec">规格：${item.spec}</p>
                                <p class="cart-item-price">¥${item.price}</p>
                            </div>
                        </li>
                    `;
                    totalPrice += parseFloat(item.price);
                });
            }

           screen.innerHTML = `
               <header class="app-header">
                   <button class="back-btn" data-target="peek-screen">‹</button>
                   <div class="title-container"><h1 class="title">购物车</h1></div>
                   <button class="action-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg></button>
               </header>
               <main class="content"><ul class="cart-item-list">${itemsHtml}</ul></main>
               <footer class="cart-footer">
                   <div class="cart-total-price">
                       <span class="label">合计：</span>¥${totalPrice.toFixed(2)}
                   </div>
                   <button class="checkout-btn">结算</button>
               </footer>
           `;
           
            screen.querySelector('.action-btn').addEventListener('click', () => {
                generateAndRenderPeekContent('cart', { forceRefresh: true });
            });
           screen.querySelector('.checkout-btn').addEventListener('click', () => {
               showToast('功能开发中');
           });
       }

       function renderPeekTransferStation(entries) {
           const screen = document.getElementById('peek-transfer-station-screen');
            let messagesHtml = '';

            if (!entries || entries.length === 0) {
                messagesHtml = '<p class="placeholder-text">正在生成中转站内容...</p>';
            } else {
                entries.forEach(entry => {
                    // Each entry is a message from the character to themselves.
                    // We'll render it as a 'sent' message bubble.
                    messagesHtml += `
                        <div class="message-wrapper sent">
                            <div class="message-bubble-row">
                                <div class="message-bubble sent" style="background-color: #98E165; color: #000;">
                                    ${entry}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

           screen.innerHTML = `
               <header class="app-header">
                   <button class="back-btn" data-target="peek-screen">‹</button>
                   <div class="title-container">
                       <h1 class="title">文件传输助手</h1>
                   </div>
                   <button class="action-btn">
                       <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg>
                   </button>
               </header>
               <main class="content">
                   <div class="message-area" style="padding: 10px;">
                        ${messagesHtml}
                   </div>
                   <div class="transfer-station-input-area">
                       <div class="fake-input"></div>
                       <button class="plus-btn"></button>
                   </div>
               </main>
           `;
            
            screen.querySelector('.action-btn').addEventListener('click', () => {
                generateAndRenderPeekContent('transfer', { forceRefresh: true });
            });

            const messageArea = screen.querySelector('.message-area');
            if (messageArea) {
                messageArea.scrollTop = messageArea.scrollHeight;
            }
       }

      function renderPeekBrowser(historyItems) {
          const screen = document.getElementById('peek-browser-screen');
          let itemsHtml = '';
            if (!historyItems || historyItems.length === 0) {
                itemsHtml = '<p class="placeholder-text">正在生成浏览记录...</p>';
            } else {
                historyItems.forEach(item => {
                    itemsHtml += `
                        <li class="browser-history-item">
                            <h3 class="history-item-title">${item.title}</h3>
                            <p class="history-item-url">${item.url}</p>
                            <div class="history-item-annotation">${item.annotation}</div>
                        </li>
                    `;
                });
            }

          screen.innerHTML = `
              <header class="app-header">
                  <button class="back-btn" data-target="peek-screen">‹</button>
                  <div class="title-container"><h1 class="title">浏览器</h1></div>
                  <button class="action-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg></button>
              </header>
              <main class="content"><ul class="browser-history-list">${itemsHtml}</ul></main>
          `;
          screen.querySelector('.action-btn').addEventListener('click', () => {
              generateAndRenderPeekContent('browser', { forceRefresh: true });
          });
      }

       function renderPeekDrafts(draft) {
            const screen = document.getElementById('peek-drafts-screen');
            let draftTo = '...';
            let draftContent = '<p class="placeholder-text">正在生成草稿...</p>';

            if (draft) {
                draftTo = draft.to;
                draftContent = draft.content;
            }
            
           screen.innerHTML = `
               <header class="app-header">
                   <button class="back-btn" data-target="peek-screen">‹</button>
                   <div class="title-container"><h1 class="title">草稿箱</h1></div>
                   <button class="action-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg></button>
               </header>
               <main class="content">
                   <div class="draft-paper">
                       <div class="draft-to">To: ${draftTo}</div>
                       <div class="draft-content">${draftContent}</div>
                   </div>
               </main>
           `;
            screen.querySelector('.action-btn').addEventListener('click', () => {
                generateAndRenderPeekContent('drafts', { forceRefresh: true });
            });
       }

      // ==================================================================================================================
      // ========================================== 1. API 预设管理 (API PRESET MANAGEMENT) ==========================================
      // ==================================================================================================================
       function _getApiPresets() {
           return db.apiPresets || [];
       }
       function _saveApiPresets(arr) {
           db.apiPresets = arr || [];
           saveData();
       }

       function populateApiSelect() {
           const sel = document.getElementById('api-preset-select');
           if (!sel) return;
           const presets = _getApiPresets();
           sel.innerHTML = '<option value="">— 选择 API 预设 —</option>';
           presets.forEach(p => {
           const opt = document.createElement('option');
           opt.value = p.name;
           opt.textContent = p.name;
           sel.appendChild(opt);
           });
       }

       function saveCurrentApiAsPreset() {
           const apiKeyEl = document.querySelector('#api-key');
           const apiUrlEl = document.querySelector('#api-url');
           const providerEl = document.querySelector('#api-provider');
           const modelEl = document.querySelector('#api-model');

           const data = {
               apiKey: apiKeyEl ? apiKeyEl.value : '',
               apiUrl: apiUrlEl ? apiUrlEl.value : '',
               provider: providerEl ? providerEl.value : '',
               model: modelEl ? modelEl.value : ''
           };
           
           let name = prompt('为该 API 预设填写名称（会覆盖同名预设）：');
           if (!name) return;
           const presets = _getApiPresets();
           const idx = presets.findIndex(p => p.name === name);
           const preset = {name: name, data: data};
           if (idx >= 0) presets[idx] = preset; else presets.push(preset);
           _saveApiPresets(presets);
           populateApiSelect();
           (window.showToast && showToast('API 预设已保存')) || console.log('API 预设已保存');
       }

       async function applyApiPreset(name) {
           const presets = _getApiPresets();
           const p = presets.find(x => x.name === name);
           if (!p) return (window.showToast && showToast('未找到该预设')) || alert('未找到该预设');
           try {
               const apiKeyEl = document.querySelector('#api-key');
               const apiUrlEl = document.querySelector('#api-url');
               const providerEl = document.querySelector('#api-provider');
               const modelEl = document.querySelector('#api-model');

               if (apiKeyEl && p.data && typeof p.data.apiKey !== 'undefined') apiKeyEl.value = p.data.apiKey;
               if (apiUrlEl && p.data && typeof p.data.apiUrl !== 'undefined') apiUrlEl.value = p.data.apiUrl;
               if (providerEl && p.data && typeof p.data.provider !== 'undefined') providerEl.value = p.data.provider;
               if (modelEl && p.data && typeof p.data.model !== 'undefined') {
                   modelEl.innerHTML = `<option value="${p.data.model}">${p.data.model}</option>`;
                   modelEl.value = p.data.model;
               }

               (window.showToast && showToast('已应用 API 预设')) || console.log('已应用 API 预设');
           } catch(e) {
               console.error('applyApiPreset error', e);
           }
       }

       function openApiManageModal() {
           const modal = document.getElementById('api-presets-modal');
           const list = document.getElementById('api-presets-list');
           if (!modal || !list) return;
           list.innerHTML = '';
           const presets = _getApiPresets();
           if (!presets.length) {
               list.innerHTML = '<p style="color:#888;margin:6px 0;">暂无预设</p>';
           }
           presets.forEach((p, idx) => {
               const row = document.createElement('div');
               row.style.display = 'flex';
               row.style.justifyContent = 'space-between';
               row.style.alignItems = 'center';
               row.style.padding = '8px 6px';
               row.style.borderBottom = '1px solid #f6f6f6';

               const left = document.createElement('div');
               left.style.flex = '1';
               left.style.minWidth = '0';
               left.innerHTML = '<div style="font-weight:600;">'+p.name+'</div><div style="font-size:12px;color:#666;margin-top:4px;">' + (p.data && p.data.provider ? ('提供者：'+p.data.provider) : '') + '</div>';

               const btns = document.createElement('div');
               btns.style.display = 'flex';
               btns.style.gap = '6px';

               const applyBtn = document.createElement('button');
               applyBtn.className = 'btn';
               applyBtn.textContent = '应用';
               applyBtn.onclick = function(){ applyApiPreset(p.name); modal.style.display='none'; };

               const renameBtn = document.createElement('button');
               renameBtn.className = 'btn';
               renameBtn.textContent = '重命名';
               renameBtn.onclick = function(){
                   const newName = prompt('输入新名称：', p.name);
                   if (!newName) return;
                   const all = _getApiPresets();
                   all[idx].name = newName;
                   _saveApiPresets(all);
                   openApiManageModal();
                   populateApiSelect();
               };

               const delBtn = document.createElement('button');
               delBtn.className = 'btn';
               delBtn.textContent = '删除';
               delBtn.onclick = function(){ if(!confirm('确定删除 "'+p.name+'" ?')) return; const all=_getApiPresets(); all.splice(idx,1); _saveApiPresets(all); openApiManageModal(); populateApiSelect(); };

               btns.appendChild(applyBtn); btns.appendChild(renameBtn); btns.appendChild(delBtn);

               row.appendChild(left); row.appendChild(btns);
               list.appendChild(row);
           });
           modal.style.display = 'flex';
       }

       function exportApiPresets() {
           const presets = _getApiPresets();
           const blob = new Blob([JSON.stringify(presets, null, 2)], {type: 'application/json'});
           const url = URL.createObjectURL(blob);
           const a = document.createElement('a');
           a.href = url; a.download = 'api_presets.json'; document.body.appendChild(a); a.click(); a.remove();
           URL.revokeObjectURL(url);
       }
       function importApiPresets() {
           const inp = document.createElement('input');
           inp.type = 'file';
           inp.accept = 'application/json';
           inp.onchange = function(e){
               const f = e.target.files[0];
               if (!f) return;
               const r = new FileReader();
               r.onload = function(){ try { const data = JSON.parse(r.result); if (Array.isArray(data)) { _saveApiPresets(data); populateApiSelect(); openApiManageModal(); } else alert('文件格式不正确'); } catch(e){ alert('导入失败：'+e.message); } };
               r.readAsText(f);
           };
           inp.click();
       }
       
       // ==================================================================================================================
       // =================================== 2. 气泡CSS自定义预设管理 (BUBBLE CSS PRESET MANAGEMENT) ===================================
       // ==================================================================================================================
       function _getBubblePresets() {
           return db.bubbleCssPresets || [];
       }
       function _saveBubblePresets(arr) {
           db.bubbleCssPresets = arr || [];
           saveData();
       }

       function populateBubblePresetSelect(selectId) { // 增加了参数
           const sel = document.getElementById(selectId); // 使用参数
           if (!sel) return;
           const presets = _getBubblePresets();
           sel.innerHTML = '<option value="">— 选择预设 —</option>';
           presets.forEach((p) => {
               const opt = document.createElement('option');
               opt.value = p.name;
               opt.textContent = p.name;
               sel.appendChild(opt);
           });
       }

       async function applyPresetToCurrentChat(presetName) {
           const presets = _getBubblePresets();
           const preset = presets.find(p => p.name === presetName);
           if (!preset) { (window.showToast && showToast('未找到该预设')) || alert('未找到该预设'); return; }
           
           const textarea = document.getElementById('setting-custom-bubble-css') || document.getElementById('setting-group-custom-bubble-css');
           if (textarea) textarea.value = preset.css;

           try {
               const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
               if (chat) {
                   chat.customBubbleCss = preset.css;
                   chat.useCustomBubbleCss = true;
                   if (currentChatType === 'private') {
                       document.getElementById('setting-use-custom-css').checked = true;
                       document.getElementById('setting-custom-bubble-css').disabled = false;
                   } else {
                       document.getElementById('setting-group-use-custom-css').checked = true;
                       document.getElementById('setting-group-custom-bubble-css').disabled = false;
                   }
               }
           } catch(e){
               console.warn('applyPresetToCurrentChat: cannot write to db object', e);
           }

           try {
               updateCustomBubbleStyle(window.currentChatId || null, preset.css, true);
               const previewBox = document.getElementById('private-bubble-css-preview') || document.getElementById('group-bubble-css-preview');
               if (previewBox) {
                   const themeKey = (currentChatType === 'private' ? db.characters.find(c => c.id === currentChatId).theme : db.groups.find(g => g.id === currentChatId).theme) || 'white_blue';
                   updateBubbleCssPreview(previewBox, preset.css, false, colorThemes[themeKey]);
               }
               (window.showToast && showToast('预设已应用到当前聊天并保存')) || alert('预设已应用（若页面支持）');
               await saveData();
           } catch(e){
               console.error('applyPresetToCurrentChat error', e);
           }
       }

       function saveCurrentTextareaAsPreset() {
           const textarea = document.getElementById('setting-custom-bubble-css') || document.getElementById('setting-group-custom-bubble-css');
           if (!textarea) return (window.showToast && showToast('找不到自定义 CSS 文本框')) || alert('找不到自定义 CSS 文本框');
           const css = textarea.value.trim();
           if (!css) return (window.showToast && showToast('当前 CSS 为空，无法保存')) || alert('当前 CSS 为空，无法保存');
           let name = prompt('请输入预设名称（将覆盖同名预设）:');
           if (!name) return;
           const presets = _getBubblePresets();
           const idx = presets.findIndex(p => p.name === name);
           if (idx >= 0) presets[idx].css = css;
           else presets.push({name, css});
           _saveBubblePresets(presets);
           populateBubblePresetSelect('bubble-preset-select'); populateBubblePresetSelect('group-bubble-preset-select');
           (window.showToast && showToast('预设已保存')) || alert('预设已保存');
       }

       function openManagePresetsModal() {
           const modal = document.getElementById('bubble-presets-modal');
           const list = document.getElementById('bubble-presets-list');
           if (!modal || !list) return;
           list.innerHTML = '';
           const presets = _getBubblePresets();
           if (!presets.length) list.innerHTML = '<p style="color:#888;margin:6px 0;">暂无预设</p>';
           presets.forEach((p, idx) => {
               const row = document.createElement('div');
               row.style.display = 'flex';
               row.style.justifyContent = 'space-between';
               row.style.alignItems = 'center';
               row.style.padding = '8px 0';
               row.style.borderBottom = '1px solid #f0f0f0';
               const nameDiv = document.createElement('div');
               nameDiv.style.flex = '1';
               nameDiv.style.whiteSpace = 'nowrap';
               nameDiv.style.overflow = 'hidden';
               nameDiv.style.textOverflow = 'ellipsis';
               nameDiv.textContent = p.name;
               row.appendChild(nameDiv);

               const btnWrap = document.createElement('div');
               btnWrap.style.display = 'flex';
               btnWrap.style.gap = '6px';

               const applyBtn = document.createElement('button');
               applyBtn.className = 'btn btn-primary';
               applyBtn.style.padding = '6px 8px;border-radius:8px';
               applyBtn.textContent = '应用';
               applyBtn.onclick = function(){ applyPresetToCurrentChat(p.name); modal.style.display = 'none'; };

               const renameBtn = document.createElement('button');
               renameBtn.className = 'btn';
               renameBtn.style.padding = '6px 8px;border-radius:8px';
               renameBtn.textContent = '重命名';
               renameBtn.onclick = function(){
                   const newName = prompt('输入新名称：', p.name);
                   if (!newName) return;
                   const presetsAll = _getBubblePresets();
                   presetsAll[idx].name = newName;
                   _saveBubblePresets(presetsAll);
                   openManagePresetsModal(); // refresh
                   populateBubblePresetSelect('bubble-preset-select'); populateBubblePresetSelect('group-bubble-preset-select');
               };

               const delBtn = document.createElement('button');
               delBtn.className = 'btn btn-danger';
               delBtn.style.padding = '6px 8px;border-radius:8px';
               delBtn.textContent = '删除';
               delBtn.onclick = function(){
                   if (!confirm('确定删除预设 \"' + p.name + '\" ?')) return;
                   const presetsAll = _getBubblePresets();
                   presetsAll.splice(idx, 1);
                   _saveBubblePresets(presetsAll);
                   openManagePresetsModal();
                   populateBubblePresetSelect('bubble-preset-select'); populateBubblePresetSelect('group-bubble-preset-select');
               };

               btnWrap.appendChild(applyBtn);
               btnWrap.appendChild(renameBtn);
               btnWrap.appendChild(delBtn);
               row.appendChild(btnWrap);
               list.appendChild(row);
           });
           modal.style.display = 'flex';
       }

       // ==================================================================================================================
       // ======================================= 3. 人设预设管理 (USER PERSONA PRESET MANAGEMENT) =======================================
       // ==================================================================================================================
       function _getMyPersonaPresets() {
           return db.myPersonaPresets || [];
       }
       function _saveMyPersonaPresets(arr) {
           db.myPersonaPresets = arr || [];
           saveData();
       }

       function populateMyPersonaSelect() {
           const sel = document.getElementById('mypersona-preset-select');
           if (!sel) return;
           const presets = _getMyPersonaPresets();
           sel.innerHTML = '<option value="">— 选择预设 —</option>';
           presets.forEach(p => {
               const opt = document.createElement('option');
               opt.value = p.name;
               opt.textContent = p.name;
               sel.appendChild(opt);
           });
       }

       function saveCurrentMyPersonaAsPreset() {
           const personaEl = document.getElementById('setting-my-persona');
           const avatarEl = document.getElementById('setting-my-avatar-preview');
           if (!personaEl || !avatarEl) return (window.showToast && showToast('找不到我的人设或头像控件')) || alert('找不到我的人设或头像控件');
           const persona = personaEl.value.trim();
           const avatar = avatarEl.src || '';
           if (!persona && !avatar) return (window.showToast && showToast('人设和头像都为空，无法保存')) || alert('人设和头像都为空，无法保存');
           const name = prompt('请输入预设名称（将覆盖同名预设）：');
           if (!name) return;
           const presets = _getMyPersonaPresets();
           const idx = presets.findIndex(p => p.name === name);
           const preset = { name, persona, avatar };
           if (idx >= 0) presets[idx] = preset; else presets.push(preset);
           _saveMyPersonaPresets(presets);
           populateMyPersonaSelect();
           (window.showToast && showToast('我的人设预设已保存')) || console.log('我的人设预设已保存');
       }

       async function applyMyPersonaPresetToCurrentChat(presetName) {
           const presets = _getMyPersonaPresets();
           const p = presets.find(x => x.name === presetName);
           if (!p) { (window.showToast && showToast('未找到该预设')) || alert('未找到该预设'); return; }

           const personaEl = document.getElementById('setting-my-persona');
           const avatarEl = document.getElementById('setting-my-avatar-preview');
           if (personaEl) personaEl.value = p.persona || '';
           if (avatarEl) avatarEl.src = p.avatar || '';

           try {
               if (currentChatType === 'private') {
                   const e = db.characters.find(c => c.id === currentChatId);
                   if (e) {
                       e.myPersona = p.persona || '';
                       e.myAvatar = p.avatar || '';
                       await saveData();
                       (window.showToast && showToast('预设已应用并保存到当前聊天')) || console.log('预设已应用');
                       if (typeof loadSettingsToSidebar === 'function') try{ loadSettingsToSidebar(); }catch(e){}
                       if (typeof renderChatList === 'function') try{ renderChatList(); }catch(e){}
                   }
               } else {
                   (window.showToast && showToast('预设已应用到界面（未检测到当前聊天保存入口）')) || console.log('预设已应用到界面');
               }
           } catch(err) {
               console.error('applyMyPersonaPresetToCurrentChat error', err);
           }
       }

       function openManageMyPersonaModal() {
           const modal = document.getElementById('mypersona-presets-modal');
           const list = document.getElementById('mypersona-presets-list');
           if (!modal || !list) return;
           list.innerHTML = '';
           const presets = _getMyPersonaPresets();
           if (!presets.length) list.innerHTML = '<p style="color:#888;margin:6px 0;">暂无预设</p>';
           presets.forEach((p, idx) => {
               const row = document.createElement('div');
               row.style.display = 'flex';
               row.style.justifyContent = 'space-between';
               row.style.alignItems = 'center';
               row.style.padding = '8px 0';
               row.style.borderBottom = '1px solid #f0f0f0';

               const nameDiv = document.createElement('div');
               nameDiv.style.flex = '1';
               nameDiv.style.whiteSpace = 'nowrap';
               nameDiv.style.overflow = 'hidden';
               nameDiv.style.textOverflow = 'ellipsis';
               nameDiv.textContent = p.name;
               row.appendChild(nameDiv);

               const btnWrap = document.createElement('div');
               btnWrap.style.display = 'flex';
               btnWrap.style.gap = '6px';

               const applyBtn = document.createElement('button');
               applyBtn.className = 'btn btn-primary';
               applyBtn.style.padding = '6px 8px;border-radius:8px';
               applyBtn.textContent = '应用';
               applyBtn.onclick = function(){ applyMyPersonaPresetToCurrentChat(p.name); modal.style.display = 'none'; };

               const renameBtn = document.createElement('button');
               renameBtn.className = 'btn';
               renameBtn.style.padding = '6px 8px;border-radius:8px';
               renameBtn.textContent = '重命名';
               renameBtn.onclick = function(){
                   const newName = prompt('输入新名称：', p.name);
                   if (!newName) return;
                   const all = _getMyPersonaPresets();
                   all[idx].name = newName;
                   _saveMyPersonaPresets(all);
                   openManageMyPersonaModal();
                   populateMyPersonaSelect();
               };

               const deleteBtn = document.createElement('button');
               deleteBtn.className = 'btn';
               deleteBtn.style.padding = '6px 8px;border-radius:8px;color:#e53935';
               deleteBtn.textContent = '删除';
               deleteBtn.onclick = function(){
                   if (!confirm('确认删除该预设？')) return;
                   const all = _getMyPersonaPresets();
                   all.splice(idx,1);
                   _saveMyPersonaPresets(all);
                   openManageMyPersonaModal();
                   populateMyPersonaSelect();
               };

               btnWrap.appendChild(applyBtn);
               btnWrap.appendChild(renameBtn);
               btnWrap.appendChild(deleteBtn);
               row.appendChild(btnWrap);

               list.appendChild(row);
           });

           modal.style.display = 'flex';
       }

        function updateClock() {
            const now = new Date();
            const timeString = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
            const dateString = `${pad(now.getMonth() + 1)}月${pad(now.getDate())}日 ✧ 星期${['日', '一', '二', '三', '四', '五', '六'][now.getDay()]}`;

            const homeTimeDisplay = document.getElementById('time-display');
            const homeDateDisplay = document.getElementById('date-display');
            if (homeTimeDisplay) homeTimeDisplay.textContent = timeString;
            if (homeDateDisplay) homeDateDisplay.textContent = dateString;

            const peekTimeDisplay = document.getElementById('peek-time-display');
            const peekDateDisplay = document.getElementById('peek-date-display');
            if (peekTimeDisplay) peekTimeDisplay.textContent = timeString;
            if (peekDateDisplay) peekDateDisplay.textContent = dateString;
        }

        function updatePageIndicator(index) {
            const dots = document.querySelectorAll('.page-indicator .dot');
            dots.forEach((dot, i) => {
                dot.classList.toggle('active', i === index);
            });
        }

        // --- App Setup Functions ---
        
        // ==================================================================================================================
        // ========================================== 角色卡导入 (CHARACTER IMPORT) ==========================================
        // ==================================================================================================================
        
        /**
         * 处理角色卡文件导入
         * @param {File} file - 用户选择的文件
         */
        async function handleCharacterImport(file) {
            if (!file) return;

            showToast('正在导入角色卡...');

            try {
                if (file.name.endsWith('.png')) {
                    await parseCharPng(file);
                } else if (file.name.endsWith('.json')) {
                    await parseCharJson(file);
                } else {
                    throw new Error('不支持的文件格式。请选择 .png 或 .json 文件。');
                }
            } catch (error) {
                console.error('角色卡导入失败:', error);
                showToast(`导入失败: ${error.message}`);
            }
        }

        /**
         * 解析PNG角色卡
         * @param {File} file - PNG文件
         */
        function parseCharPng(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsArrayBuffer(file);
                reader.onload = (e) => {
                    try {
                        const buffer = e.target.result;
                        const view = new DataView(buffer);

                        // 1. 验证PNG文件签名 (PNG signature)
                        const signature = [137, 80, 78, 71, 13, 10, 26, 10];
                        for (let i = 0; i < signature.length; i++) {
                            if (view.getUint8(i) !== signature[i]) {
                                return reject(new Error('文件不是一个有效的PNG。'));
                            }
                        }

                        let offset = 8; // 跳过8字节的签名
                        let charaData = null;

                        // 2. 遍历PNG数据块 (chunks)
                        while (offset < view.byteLength) {
                            const length = view.getUint32(offset); // 数据块内容的长度
                            const type = String.fromCharCode(view.getUint8(offset + 4), view.getUint8(offset + 5), view.getUint8(offset + 6), view.getUint8(offset + 7));
                            
                            // 3. 寻找tEXt文本块
                            if (type === 'tEXt') {
                                const textChunk = new Uint8Array(buffer, offset + 8, length);
                                
                                // 寻找关键字和数据之间的空字符分隔符
                                let separatorIndex = -1;
                                for(let i = 0; i < textChunk.length; i++) {
                                    if (textChunk[i] === 0) {
                                        separatorIndex = i;
                                        break;
                                    }
                                }

                                if (separatorIndex !== -1) {
                                    const keyword = new TextDecoder('utf-8').decode(textChunk.slice(0, separatorIndex));
                                    
                                    // 4. 检查关键字是否为 'chara'
                                    if (keyword === 'chara') {
                                        const base64Data = new TextDecoder('utf-8').decode(textChunk.slice(separatorIndex + 1));
                                        
                                        // 5. 解码Base64数据
                                        try {
                                            const decodedString = atob(base64Data);
                                            const bytes = new Uint8Array(decodedString.length);
                                            for (let i = 0; i < decodedString.length; i++) {
                                                bytes[i] = decodedString.charCodeAt(i);
                                            }
                                            const utf8Decoder = new TextDecoder('utf-8');
                                            charaData = JSON.parse(utf8Decoder.decode(bytes));
                                            break; // 找到数据后就停止遍历
                                        } catch (decodeError) {
                                            return reject(new Error(`解析角色数据失败: ${decodeError.message}`));
                                        }
                                    }
                                }
                            }
                            
                            // 移动到下一个数据块 (长度 + 类型 + 内容 + CRC校验 = 4 + 4 + length + 4)
                            offset += 12 + length;
                        }

                        if (charaData) {
                            // 6. 将PNG文件本身转换为头像的Data URL
                            const imageReader = new FileReader();
                            imageReader.readAsDataURL(file);
                            imageReader.onload = (imgEvent) => {
                                createCharacterFromData(charaData, imgEvent.target.result);
                                resolve();
                            };
                            imageReader.onerror = () => {
                                // 即使头像转换失败，也用默认头像创建角色
                                createCharacterFromData(charaData, 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg');
                                resolve();
                            };
                        } else {
                            reject(new Error('在PNG中未找到有效的角色数据 (tEXt chunk not found or invalid)。'));
                        }
                    } catch (error) {
                        reject(new Error(`解析PNG失败: ${error.message}`));
                    }
                };
                reader.onerror = () => reject(new Error('读取PNG文件失败。'));
            });
        }

        /**
         * 解析JSON角色卡
         * @param {File} file - JSON文件
         */
        function parseCharJson(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                // 强制使用UTF-8解码
                reader.readAsText(file, 'UTF-8');
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        // JSON卡没有内置头像，使用默认头像
                        createCharacterFromData(data, 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg');
                        resolve();
                    } catch (error) {
                        reject(new Error(`解析JSON失败: ${error.message}`));
                    }
                };
                reader.onerror = () => reject(new Error('读取JSON文件失败。'));
            });
        }

        /**
         * 根据导入的数据创建新角色
         * @param {object} data - 从卡片解析出的角色数据
         * @param {string} avatar - Base64格式的头像数据
         */
        async function createCharacterFromData(data, avatar) {
            // 优先使用 data.data 结构（针对哈基米.json格式），同时保留对根级别数据的兼容
            const charData = data.data || data;

            if (!charData || !charData.name) {
                throw new Error('角色卡数据无效，缺少角色名称。');
            }

            // 数据映射：将导入卡片的字段映射到本应用的字段
            const newChar = {
                id: `char_${Date.now()}`,
                realName: charData.name || '未命名',
                remarkName: charData.name || '未命名',
                persona: charData.description || charData.persona || '',
                avatar: avatar || 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg',
                myName: '',
                myPersona: '',
                myAvatar: 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg',
                theme: 'white_blue',
                maxMemory: 10,
                chatBg: '',
                history: [],
                isPinned: false,
                status: '在线',
                worldBookIds: [],
                useCustomBubbleCss: false,
                customBubbleCss: '',
                unreadCount: 0,
                memoryJournals: [],
                journalWorldBookIds: [],
                peekScreenSettings: { wallpaper: '', customIcons: {}, unlockAvatar: '' },
                lastUserMessageTimestamp: null,
            };

            // --- 新增：处理世界书 (兼容两种格式) ---
            const importedWorldBookIds = [];
            
            // 格式一：处理哈基米.json中的 character_book
            if (charData.character_book && Array.isArray(charData.character_book.entries)) {
                const categoryName = data.name || charData.name; // 优先使用根级的name作为分类名
                charData.character_book.entries.forEach(entry => {
                    const name = entry.comment;
                    const content = entry.content;
                    if (name && content) {
                        const existingBook = db.worldBooks.find(wb => wb.name.toLowerCase() === name.toLowerCase());
                        if (existingBook) {
                            if (!importedWorldBookIds.includes(existingBook.id)) {
                                importedWorldBookIds.push(existingBook.id);
                            }
                        } else {
                            const newBook = {
                                id: `wb_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
                                name: name,
                                content: content,
                                position: 'after',
                                category: categoryName
                            };
                            db.worldBooks.push(newBook);
                            importedWorldBookIds.push(newBook.id);
                        }
                    }
                });
            }
            // 格式二：处理通用格式的 world_info / wi
            else {
                const worldInfo = charData.world_info || charData.wi || '';
                if (worldInfo && typeof worldInfo === 'string' && worldInfo.trim() !== '') {
                    const entries = worldInfo.split(/\n\s*\n/).filter(entry => entry.trim() !== '');
                    entries.forEach(entryText => {
                        const lines = entryText.trim().split('\n');
                        if (lines.length > 0) {
                            const name = lines[0].trim();
                            const content = lines.slice(1).join('\n').trim();
                            if (name && content) {
                                const existingBook = db.worldBooks.find(wb => wb.name.toLowerCase() === name.toLowerCase());
                                if (existingBook) {
                                    if (!importedWorldBookIds.includes(existingBook.id)) {
                                        importedWorldBookIds.push(existingBook.id);
                                    }
                                } else {
                                    const newBook = {
                                        id: `wb_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
                                        name: name,
                                        content: content,
                                        position: 'after',
                                        category: '导入的角色设定'
                                    };
                                    db.worldBooks.push(newBook);
                                    importedWorldBookIds.push(newBook.id);
                                }
                            }
                        }
                    });
                }
            }
            
            if (importedWorldBookIds.length > 0) {
                newChar.worldBookIds = importedWorldBookIds;
                setTimeout(() => {
                    showToast(`同时导入了 ${importedWorldBookIds.length} 条世界书设定。`);
                }, 1600);
            }
            // --- 新增逻辑结束 ---

            db.characters.push(newChar);
            await saveData();
            renderChatList();
            showToast(`角色“${newChar.remarkName}”导入成功！`);
        }

        // ==================================================================================================================
        // ========================================== END CHARACTER IMPORT ==================================================
        // ==================================================================================================================

        let currentPageIndex = 0;
        const getIcon = (id) => db.customIcons[id] || defaultIcons[id].url;
        // 辅助函数：生成图标的 HTML（是 img 还是 svg？）
function renderAppIcon(key) {
    const item = defaultIcons[key];
    if (!item) return '';

    // 判断：如果该配置里有 svgCode，直接返回 SVG 代码
    if (item.svgCode) {
        return item.svgCode;
    } 
    
    // 否则：返回标准的 img 标签
    // 注意：这里需要根据你之前的逻辑获取 url，如果 getIcon 是外部函数请保留调用
    const src = typeof getIcon === 'function' ? getIcon(key) : item.url;
    return `<img src="${src}" alt="${item.name}" class="icon-img">`;
}
        function setupHomeScreen() {
            
            // Ensure insWidgetSettings exists with defaults
            if (!db.insWidgetSettings) {
                db.insWidgetSettings = {
                    avatar1: 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg',
                    bubble1: '„- ω -„',
                    avatar2: 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg',
                    bubble2: 'ｷ...✩'
                };
            }
            const insWidget = db.insWidgetSettings;
            

            const homeScreenHTML = `
            <div class="home-screen-swiper">
                <div class="home-screen-page">
                    <div class="home-widget-container">
                        <div class="central-circle" style="background-image: url('${db.homeWidgetSettings.centralCircleImage}');"></div>
                        


                        <div class="widget-time" id="time-display"></div>
                        <div class="widget-date" id="date-display"></div>
                        <div contenteditable="true" class="widget-signature" id="widget-signature" placeholder="编辑个性签名..."></div>
                        
                        <div class="widget-battery">
                            <svg width="32" height="23" viewBox="0 0 24 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M1 2.5C1 1.94772 1.44772 1.5 2 1.5H20C20.5523 1.5 21 1.94772 21 2.5V9.5C21 10.0523 20.5523 10.5 20 10.5H2C1.44772 10.5 1 10.0523 1 9.5V2.5Z" stroke="currentColor" stroke-opacity="1" stroke-width="1"/>
                                <path d="M22.5 4V8" stroke="currentColor" stroke-opacity="1" stroke-width="1.5" stroke-linecap="round"/>
                                <rect id="battery-fill-rect" x="2" y="2.5" width="18" height="7" rx="0.5" fill="currentColor" fill-opacity="1"/>
                            </svg>
                            <span id="battery-level">--%</span>
                        </div>
                    </div>
                    <div class="app-grid">
                        <div class="app-grid-widget-container">
                           <div class="app-grid-widget">
                                <div class="ins-widget">
                                    <div class="ins-widget-row user">
                                        <img src="${insWidget.avatar1}" alt="Character Avatar" class="ins-widget-avatar" id="ins-widget-avatar-1">
                                        <div class="ins-widget-bubble" id="ins-widget-bubble-1" contenteditable="true">${insWidget.bubble1}</div>
                                    </div>
                                    <div class="ins-widget-divider"><span>୨୧</span></div>
                                    <div class="ins-widget-row character">
                                        <div class="ins-widget-bubble" id="ins-widget-bubble-2" contenteditable="true">${insWidget.bubble2}</div>
                                        <img src="${insWidget.avatar2}" alt="User Avatar" class="ins-widget-avatar" id="ins-widget-avatar-2">
                                    </div>
                                </div>
                           </div>
                        </div>
                         <a href="#" class="app-icon" data-target="chat-list-screen">
                            ${renderAppIcon('chat-list-screen')}
                            <span class="app-name">${defaultIcons['chat-list-screen'].name}</span>
                        </a>
                        
                        <!-- 世界书：补上了 } -->
                        <a href="#" class="app-icon" data-target="world-book-screen">
                            ${renderAppIcon('world-book-screen')}
                            <span class="app-name">${defaultIcons['world-book-screen'].name}</span>
                        </a>
                        
                        <!-- 番茄钟 -->
                        <a href="#" class="app-icon" data-target="pomodoro-screen">
                           ${renderAppIcon('pomodoro-screen')}
                           <span class="app-name">${defaultIcons['pomodoro-screen'].name}</span>
                        </a>

                        <!-- 论坛 -->
                        <a href="#" class="app-icon" data-target="forum-screen">
                            ${renderAppIcon('forum-screen')}
                            <span class="app-name">${defaultIcons['forum-screen'].name}</span>
                        </a>                         
                        
                    </div>
                </div>

                
                     <div class="app-grid">
 
                        
                        
                     </div>
               

            </div>
            
            <div class="dock">
            <a href="#" class="app-icon" data-target="settings-screen">
                  ${renderAppIcon('settings-screen')}
                </a>
                
                
            </div>`;
            homeScreen.innerHTML = homeScreenHTML;

           const polaroidImage = db.homeWidgetSettings?.polaroidImage;
           if (polaroidImage) {
               updatePolaroidImage(polaroidImage);
           }

            updateClock();
            applyWallpaper(db.wallpaper);
            applyHomeScreenMode(db.homeScreenMode);
            
            document.querySelector('[data-target="world-book-screen"]').addEventListener('click', renderWorldBookList);
            document.querySelector('[data-target="customize-screen"]').addEventListener('click', renderCustomizeForm);
            document.querySelector('[data-target="tutorial-screen"]').addEventListener('click', renderTutorialContent);
            updateBatteryStatus();

            const homeWidgetContainer = homeScreen.querySelector('.home-widget-container');

            // --- Central Circle Click ---
            const centralCircle = homeWidgetContainer.querySelector('.central-circle');
            if (centralCircle) {
                centralCircle.addEventListener('click', () => {
                    const modal = document.getElementById('ins-widget-avatar-modal');
                    const form = document.getElementById('ins-widget-avatar-form');
                    const preview = document.getElementById('ins-widget-avatar-preview');
                    const urlInput = document.getElementById('ins-widget-avatar-url-input');
                    const fileUpload = document.getElementById('ins-widget-avatar-file-upload');
                    const targetInput = document.getElementById('ins-widget-avatar-target');

                    targetInput.value = 'centralCircle'; // Special target
                    preview.style.backgroundImage = `url("${db.homeWidgetSettings.centralCircleImage}")`;
                    preview.innerHTML = '';
                    urlInput.value = '';
                    fileUpload.value = null;
                    modal.classList.add('visible');
                });
            }

            // --- Blur to Save Logic ---
            homeScreen.addEventListener('blur', async (e) => {
                const target = e.target;
                if (target.hasAttribute('contenteditable')) {
                    const oval = target.closest('.satellite-oval');
                    if (oval) { // It's one of the satellite ovals
                        const part = oval.dataset.widgetPart;
                        const prop = target.classList.contains('satellite-emoji') ? 'emoji' : 'text';
                        const newValue = target.textContent.trim();

                        if (db.homeWidgetSettings[part] && db.homeWidgetSettings[part][prop] !== newValue) {
                            db.homeWidgetSettings[part][prop] = newValue;
                            await saveData();
                            showToast('小组件已更新');
                        }
                    } else if (target.id === 'widget-signature') { // It's the signature
                        const newSignature = target.textContent.trim();
                        if (db.homeSignature !== newSignature) {
                            db.homeSignature = newSignature;
                            await saveData();
                            showToast('签名已保存');
                        }
                    } else if (target.id === 'ins-widget-bubble-1' || target.id === 'ins-widget-bubble-2') { // It's the INS widget
                         const bubbleId = target.id === 'ins-widget-bubble-1' ? 'bubble1' : 'bubble2';
                         const newText = target.textContent.trim();
                         if (db.insWidgetSettings[bubbleId] !== newText) {
                             db.insWidgetSettings[bubbleId] = newText;
                             await saveData();
                             showToast('小组件文字已保存');
                         }
                    }
                }
            }, true); // Use capture phase
            
            const signatureWidget = document.getElementById('widget-signature');
            if (signatureWidget) {
                signatureWidget.textContent = db.homeSignature || '';
            }


            // --- Home Screen Swipe Logic ---
            const swiper = homeScreen.querySelector('.home-screen-swiper');
            let touchStartX = 0;
            let touchEndX = 0;
            // currentPageIndex is now global修改屏幕数
            const totalPages = 1;
            const swipeThreshold = 50; // Minimum distance for a swipe
            let isDragging = false;

            // Apply initial state based on global currentPageIndex
            swiper.style.transform = `translateX(-${currentPageIndex * 100 / totalPages}%)`;
            updatePageIndicator(currentPageIndex);

            // --- Touch Events ---
            swiper.addEventListener('touchstart', (e) => {
                if (e.target.closest('[contenteditable]')) return; // <-- 新增这行
                // No longer need to check for target, the whole area is swipeable
                isDragging = true;
                touchStartX = e.changedTouches[0].screenX;
                touchEndX = e.changedTouches[0].screenX; // Reset on start
            }, { passive: true });

            swiper.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                touchEndX = e.changedTouches[0].screenX;
            }, { passive: true });

            swiper.addEventListener('touchend', (e) => {
                if (!isDragging) return;
                isDragging = false;
                handleSwipe();
            });

            // --- Mouse Events ---
            swiper.addEventListener('mousedown', (e) => {
                if (e.target.closest('[contenteditable]')) return; // <-- 新增这行
                // Prevent default browser action (like dragging a link)
                e.preventDefault();
                isDragging = true;
                touchStartX = e.screenX;
                touchEndX = e.screenX; // Reset on start
                swiper.style.cursor = 'grabbing';
            });

            swiper.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    touchEndX = e.screenX;
                }
            });

            swiper.addEventListener('mouseup', (e) => {
                if (isDragging) {
                    isDragging = false;
                    swiper.style.cursor = 'grab';
                    handleSwipe();
                }
            });

            swiper.addEventListener('mouseleave', (e) => {
                if (isDragging) {
                    isDragging = false;
                    swiper.style.cursor = 'grab';
                    // Reset positions to cancel swipe
                    touchStartX = 0;
                    touchEndX = 0;
                }
            });

            function handleSwipe() {
                if (touchEndX === 0 && touchStartX === 0) return; // Swipe was cancelled by mouseleave
                
                const deltaX = touchEndX - touchStartX;

                if (Math.abs(deltaX) > swipeThreshold) {
                    if (deltaX < 0 && currentPageIndex < totalPages - 1) {
                        currentPageIndex++;
                    } else if (deltaX > 0 && currentPageIndex > 0) {
                        currentPageIndex--;
                    }
                }
                
                swiper.style.transform = `translateX(-${currentPageIndex * 100 / totalPages}%)`;
                updatePageIndicator(currentPageIndex);

                // Reset positions
                touchStartX = 0;
                touchEndX = 0;
            }

            // 新增：处理失焦的逻辑
            homeScreen.addEventListener('click', (e) => {
                const activeEl = document.activeElement;
                if (activeEl && activeEl.hasAttribute('contenteditable') && e.target !== activeEl) {
                    activeEl.blur();
                }
            });

            // 新增：限制emoji小组件只能输入一个字符
            homeScreen.querySelectorAll('.satellite-emoji').forEach(span => {
                span.addEventListener('input', (e) => {
                    const chars = [...e.target.textContent];
                    if (chars.length > 1) {
                        e.target.textContent = chars[0];
                        // 重新聚焦并把光标移动到末尾
                        const range = document.createRange();
                        const sel = window.getSelection();
                        range.selectNodeContents(e.target);
                        range.collapse(false);
                        sel.removeAllRanges();
                        sel.addRange(range);
                    }
                });
            });
        }

        function applyWallpaper(url) {
            homeScreen.style.backgroundImage = `url(${url})`;
        }

      async function applyHomeScreenMode(mode) {
    const toggle = document.getElementById('dark-mode-toggle');
    
    // 如果 mode 是 undefined 或者 null，给一个默认值（比如 'night' 或 'day'）
    // 防止第一次加载时没有值导致逻辑混乱
    if (!mode) mode = 'day'; // 这里假设默认是白天，你可以根据需要修改

    if (mode === 'day') {
        // 应用白天模式样式
        homeScreen.classList.add('day-mode');
        // 【关键修复】同步更新开关状态：白天 = 选中
        if (toggle) toggle.checked = true;
    } else {
        // 应用黑夜模式样式
        homeScreen.classList.remove('day-mode');
        // 【关键修复】同步更新开关状态：黑夜 = 未选中
        if (toggle) toggle.checked = false;
    }
    
    db.homeScreenMode = mode;
    await saveData();
}

                function setupCustomizeApp() {
            customizeForm.addEventListener('input', async (e) => {
                const target = e.target;

                // --- 处理应用图标的逻辑 ---
                if (target.dataset.iconId) { // 修改这里，统一使用一个标识
                    const iconId = target.dataset.iconId;
                    const newUrl = target.value.trim();
                    const previewImg = document.getElementById(`icon-preview-${iconId}`);
                    if (newUrl) {
                        if (!db.customIcons) db.customIcons = {}; // 确保 customIcons 已初始化
                        db.customIcons[iconId] = newUrl;
                        if(previewImg) previewImg.src = newUrl;
                    }
                // --- 新增：处理小部件的逻辑 ---
                } else if (target.dataset.widgetPart) {
                    const part = target.dataset.widgetPart;
                    const prop = target.dataset.widgetProp;
                    const newValue = target.value.trim();

                    if (prop) { // 这是小椭圆 (有prop属性)
                        db.homeWidgetSettings[part][prop] = newValue;
                    } else { // 这是中央大圆 (没有prop属性)
                        db.homeWidgetSettings[part] = newValue;
                    }
                }

                await saveData();
                setupHomeScreen(); // 实时刷新主页
            });
            customizeForm.addEventListener('click', async (e) => {
                // --- 处理重置应用图标的逻辑 ---
                if (e.target.matches('.reset-icon-btn')) {
                    const iconId = e.target.dataset.id;
                    if (db.customIcons) {
                        delete db.customIcons[iconId];
                    }
                    await saveData();
                    renderCustomizeForm(); // 重新渲染自定义页
                    setupHomeScreen(); // 刷新主页
                    showToast('图标已重置');
                }

                // --- 新增：处理重置小部件的逻辑 ---
                if (e.target.matches('#reset-widget-btn')) {
                    if (confirm('确定要将小部件恢复为默认设置吗？')) {
                        db.homeWidgetSettings = JSON.parse(JSON.stringify(defaultWidgetSettings));
                        await saveData();
                        renderCustomizeForm(); // 重新渲染自定义页
                        setupHomeScreen(); // 刷新主页
                        showToast('小部件已恢复默认');
                    }
                }

                // --- 新增：处理重置小部件的逻辑 ---
                if (e.target.matches('#reset-widget-btn')) {
                    if (confirm('确定要将小部件恢复为默认设置吗？')) {
                        db.homeWidgetSettings = JSON.parse(JSON.stringify(defaultWidgetSettings));
                        await saveData();
                        renderCustomizeForm(); // 重新渲染自定义页
                        setupHomeScreen(); // 刷新主页
                        showToast('小部件已恢复默认');
                    }
                }

                if (e.target.classList.contains('copy-css-btn')) {
                    const codeBlock = e.target.closest('.css-template-card').querySelector('code');
                    if (codeBlock) {
                        navigator.clipboard.writeText(codeBlock.textContent.trim()).then(() => {
                            showToast('代码已复制到剪贴板！');
                        }).catch(err => {
                            showToast('复制失败: ' + err);
                            console.error('Copy failed', err);
                        });
                    }
                }
            });

         customizeForm.addEventListener('change', async (e) => {
             if (e.target.matches('.widget-upload-input')) {
                 const file = e.target.files[0];
                 if (!file) return;
 
                 const widgetPart = e.target.dataset.widgetTarget;
                 const widgetProp = e.target.dataset.widgetProp;
 
                 try {
                     const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 400, maxHeight: 400 });
                     
                     let targetInput;
                     if (widgetProp) {
                         targetInput = document.getElementById(`widget-input-${widgetPart}-${widgetProp}`);
                     } else {
                         targetInput = document.getElementById(`widget-input-${widgetPart}`);
                     }
 
                     if (targetInput) {
                         targetInput.value = compressedUrl;
                         // Manually trigger an input event to save the data
                         targetInput.dispatchEvent(new Event('input', { bubbles: true }));
                         showToast('图片已上传并压缩');
                     }
                 } catch (error) {
                     console.error('Widget image compression failed:', error);
                     showToast('图片压缩失败，请重试');
                 } finally {
                     e.target.value = null; // Reset file input
                 }
             }
         });
        }

                function renderCustomizeForm() {
            customizeForm.innerHTML = ''; // 清空旧内容

            // --- 1. 应用图标自定义部分 ---
            const iconOrder = [
                'chat-list-screen', 
                'world-book-screen',   'forum-screen', 'settings-screen',  'pomodoro-screen'
            ];

let iconsContentHTML = '';

iconOrder.forEach(id => {
    // 1. 获取基础数据
    const item = defaultIcons[id]; 
    const name = item.name;
    const defaultUrl = item.url;
    
    // 2. 获取用户自定义的 URL (如果存在)
    const customUrl = db.customIcons && db.customIcons[id];

    let iconDisplayHTML = '';

    // 3. 生成图标 HTML (核心修正部分)
    if (customUrl) {
        // 情况 A: 用户自定义了 URL -> 强制使用 IMG 标签
        iconDisplayHTML = `<img src="${customUrl}" alt="${name}" class="icon-preview" id="icon-preview-${id}">`;
    } else if (item.svgCode) {
        // 情况 B: 没有自定义，且默认是 SVG -> 使用 SVG 代码
        // 注意：这里我们将 SVG 原本的 class="icon-img" 替换为 class="icon-preview" 以适应设置页面的样式
        iconDisplayHTML = item.svgCode.replace('class="icon-img"', 'class="icon-preview"');
    } else {
        // 情况 C: 既没自定义，也不是 SVG -> 使用默认 IMG 标签
        iconDisplayHTML = `<img src="${defaultUrl}" alt="${name}" class="icon-preview" id="icon-preview-${id}">`;
    }

    // 4. 拼接 HTML
    iconsContentHTML += `
    <div class="icon-custom-item">
        ${iconDisplayHTML}
        <div class="icon-details">
            <p>${name || '模式切换'}</p>
            <input type="url" class="form-group" placeholder="粘贴新的图标URL" value="${customUrl || ''}" data-icon-id="${id}">
        </div>
        <button type="button" class="reset-icon-btn" data-id="${id}">重置</button>
    </div>`;
});



            const iconsSectionHTML = `
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h4>应用图标</h4>
                    <span class="collapsible-arrow">▼</span>
                </div>
                <div class="collapsible-content">
                    ${iconsContentHTML}
                </div>
            </div>
            `;
            customizeForm.insertAdjacentHTML('beforeend', iconsSectionHTML);

            // --- 2. 主页小部件自定义部分 ---
            const widgetSectionHTML = `
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h4>主页小部件</h4>
                    <span class="collapsible-arrow">▼</span>
                </div>
                <div class="collapsible-content">
                    <p style="font-size: 14px; color: #666; margin-bottom: 20px; text-align: center;">主屏幕上的小组件内容可以直接点击编辑，失焦后自动保存。<br>中央头像则是在主屏幕点击后弹窗更换。</p>
                    <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px;">
                         <button type="button" id="reset-widget-btn" class="btn btn-neutral btn-small">恢复默认</button>
                    </div>
                </div>
            </div>
            `;
            customizeForm.insertAdjacentHTML('beforeend', widgetSectionHTML);

            // --- 3. 全局CSS美化部分 ---
            const globalCssSectionHTML = `
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h4>全局CSS美化</h4>
                    <span class="collapsible-arrow">▼</span>
                </div>
                <div class="collapsible-content">
                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <label for="global-beautification-css" style="font-weight: bold; font-size: 1.1em; color: var(--primary-color); margin-bottom: 0;">全局美化CSS代码</label>
                            <button type="button" id="apply-global-css-now-btn" class="btn btn-primary btn-small">立即应用</button>
                        </div>
                        <textarea id="global-beautification-css" class="form-group" rows="8" placeholder="在此输入CSS代码... 您的创造力没有边界！"></textarea>
                    </div>
                    <div class="panel panel-sm" style="padding:12px;border-radius:10px;border:1px solid var(--border-color,#e8e8ef);background:var(--panel-bg,#fff);box-shadow:var(--panel-shadow,0 4px 12px rgba(20,20,30,0.04));margin:10px 0;">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                            <label for="global-css-preset-select" style="width:auto;color:var(--muted,#667);font-size:13px; font-weight: bold;">全局样式预设库</label>
                            <select id="global-css-preset-select" style="flex:1;padding:8px 10px;border-radius:8px;border:1px solid var(--input-border,#e6e6ea);background:var(--input-bg,#fff);font-size:14px;"><option value="">-- 选择预设 --</option></select>
                        </div>
                        <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px;justify-content: flex-end;">
                            <button type="button" id="global-css-apply-btn" class="btn btn-primary" style="padding:7px 10px;border-radius:8px;">应用预设</button>
                            <button type="button" id="global-css-save-btn" class="btn" style="padding:7px 10px;border-radius:8px;">存为预设</button>
                            <button type="button" id="global-css-manage-btn" class="btn" style="padding:7px 10px;border-radius:8px;">管理</button>
                        </div>
                    </div>
                    <!-- CSS模板模块开始 -->
                    <div class="css-template-module" style="margin-top: 20px; border-top: 1px solid #DAF0FC; padding-top: 15px;">
                        <h5 style="font-size: 1em; color: var(--secondary-color); margin-bottom: 15px;">部分拓展css美化功能代码</h5>
                        <div class="css-template-list" style="display: flex; flex-direction: column; gap: 15px;">
                            
                            <!-- 模板1：底部功能栏简洁模式 -->
                            <div class="css-template-card" style="background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px; box-shadow: 0 2px 8px rgba(130, 170, 200, 0.05);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h6 style="margin: 0; font-size: 1em; color: #333;">底部功能栏简洁模式代码</h6>
                                    <button type="button" class="btn btn-secondary btn-small copy-css-btn">复制</button>
                                </div>
                                <pre style="background: #f5f5f5; padding: 10px; border-radius: 8px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px; max-height: 150px; overflow-y: auto;"><code>/* 步骤一：重新定位和调整输入框区域 (无变动) */
.message-input-area {
  position: relative !important;
  padding-left: 50px !important;
}
/* 步骤二：将功能栏(#sticker-bar)改造成一个看不见的、悬浮的容器 (无变动) */
#sticker-bar {
  position: absolute !important;
  bottom: 8px !important;
  left: 8px !important;
  z-index: 10 !important;
  width: 40px !important;
  height: 44px !important;
  background: transparent !important;
  border: none !important;
  border-radius: 10px;
  box-shadow: none !important;
  transition: all 0.25s ease-out !important;
}

/* 步骤三：创建我们的“虚拟”扳机键（“+”号） (无变动) */
#sticker-bar::before,
#sticker-bar::after {
  content: '' !important;
  position: absolute !important;
  top: 50% !important;
  left: 50% !important;
  width: 20px !important;
  height: 2px !important;
  background-color: transparent !important;
  border-radius: 1px !important;
  transition: transform 0.25s ease-out !important;
}

/* 步骤四：将两条线组合成一个“+”号 (无变动) */
#sticker-bar::before {
  transform: translate(-50%, -50%) rotate(0deg) !important;
}
#sticker-bar::after {
  transform: translate(-50%, -50%) rotate(90deg) !important;
}

/* 步骤五：当悬停时，让“+”号旋转成“×” (无变动) */
#sticker-bar:hover::before {
  transform: translate(-50%, -50%) rotate(135deg) !important;
}
#sticker-bar:hover::after {
  transform: translate(-50%, -50%) rotate(45deg) !important;
}

/* 步骤六：默认隐藏所有真实的功能按钮 (无变动) */
#sticker-bar .sticker-bar-btn {
  display: none !important;
}

/* 步骤七：当悬停时，展开面板并显示所有按钮 (核心修改) */
#sticker-bar:hover {
  display: grid !important;
  grid-template-columns: repeat(2, 1fr) !important;
  gap: 8px !important;
  width: 120px !important;
  height: auto !important;
  padding: 10px !important;
  /* --- 优化点 1: 拉开距离 --- */
  /* 将向上偏移量从 60px 增加到 85px，为手指留出安全区 */
  bottom: 85px !important; 
  border-radius: 18px !important;
  background-color: rgba(255, 255, 255, 0.9) !important;
  backdrop-filter: blur(10px) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
}

/* 修改后 */
@keyframes fadeInButtons {
  to {
    opacity: 1;
    transform: translateY(0);
    /* --- 核心优化：动画结束时才允许按钮被点击 --- */
    pointer-events: auto;
  }
}

/* 步骤八：设置展开后面板里按钮的样式 (核心修改) */
#sticker-bar:hover .sticker-bar-btn {
  display: flex !important;
  width: auto !important;
  padding: 5px !important;
  border-radius: 10px;
  background-color: rgba(240, 240, 240, 0.8);
  
  /* --- 核心优化：初始状态下按钮不可点击 --- */
  pointer-events: none; 

  opacity: 0; 
  transform: translateY(5px); 
  animation: fadeInButtons 0.2s ease-out 0.1s forwards !important;
}

/* 步骤九：当面板展开时，隐藏掉我们用伪元素画的“+”/“x”号 (无变动) */
#sticker-bar:hover::before,
#sticker-bar:hover::after {
  display: none !important;
}

/* 步骤一：为扳机键设置背景图，这将成为你的新图标 */
#sticker-bar {
  background-image: url('https://i.postimg.cc/9QZd6mhp/ji-lichan-110.png') !important;
  background-size: 28px 22px !important;
  background-repeat: no-repeat !important;
  background-position: center !important;
}

/* 步骤二：强制隐藏掉原来用伪元素画的“+”号，解决重叠问题 */
#sticker-bar::before,
#sticker-bar::after {
  display: none !important;
}

/* 步骤三：当面板展开时，隐藏背景图，避免它出现在展开的面板上 */
#sticker-bar:hover {
  background-image: none !important;
}</code></pre>
                            </div>

                            <!-- 模板2：隐藏聊天顶栏线 -->
                            <div class="css-template-card" style="background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px; box-shadow: 0 2px 8px rgba(130, 170, 200, 0.05);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h6 style="margin: 0; font-size: 1em; color: #333;">隐藏聊天顶栏线</h6>
                                    <button type="button" class="btn btn-secondary btn-small copy-css-btn">复制</button>
                                </div>
                                <pre style="background: #f5f5f5; padding: 10px; border-radius: 8px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px; max-height: 150px; overflow-y: auto;"><code>/* --- 3. 进入聊天界面-顶部栏的底部那条线的隐藏 --- */
#chat-room-screen .app-header {
    border-bottom: none !important;
}</code></pre>
                            </div>
                            <!-- 模板3：透明底表情包无气泡 -->
                            <div class="css-template-card" style="background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px; box-shadow: 0 2px 8px rgba(130, 170, 200, 0.05);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h6 style="margin: 0; font-size: 1em; color: #333;">表情包无气泡背景</h6>
                                    <button type="button" class="btn btn-secondary btn-small copy-css-btn">复制</button>
                                </div>
                                <pre style="background: #f5f5f5; padding: 10px; border-radius: 8px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px; max-height: 150px; overflow-y: auto;"><code>/* 1. 表情包消息容器（外层）背景全透明 */
.message-wrapper:has(.image-bubble) {
  background-color: transparent; /* 完全透明背景 */
}

/* 2. 表情包气泡（内层）背景全透明（避免默认白色/浅色背景） */
.image-bubble {
  background-color: transparent !important; /* 强制覆盖默认样式 */
  box-shadow: none; /* 可选：移除气泡阴影，让透明更彻底 */
  padding: 0; /* 可选：清除内边距，避免多余透明区域 */
  max-width: 95px !important;
  max-height: 95px !important;
}</code></pre>
                            </div>
                            <!-- 模板4：透明底表情包无气泡 -->
                            <div class="css-template-card" style="background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px; box-shadow: 0 2px 8px rgba(130, 170, 200, 0.05);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h6 style="margin: 0; font-size: 1em; color: #333;">隐藏头像</h6>
                                    <button type="button" class="btn btn-secondary btn-small copy-css-btn">复制</button>
                                </div>
                                <pre style="background: #f5f5f5; padding: 10px; border-radius: 8px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px; max-height: 150px; overflow-y: auto;"><code>/* --- 隐藏聊天界面的所有头像和时间戳 --- */
.message-info {
    display: none !important;
}

/* --- 修正语音和翻译气泡的边距 --- */
.voice-transcript, .translation-text {
    margin-left: 8px !important;
    margin-right: 8px !important;
}

/* 确保发送方的语音/翻译气泡仍然正确对齐 */
.message-wrapper.sent .voice-transcript,
.message-wrapper.sent .translation-text {
    align-self: flex-end;
    margin-left: auto !important;
}</code></pre>
                            </div>

                        </div>
                    </div>
                    <!-- CSS模板模块结束 -->
                </div>
            </div>
            `;
            customizeForm.insertAdjacentHTML('beforeend', globalCssSectionHTML);

            // 填充预设下拉框
            populateGlobalCssPresetSelect();

            // --- 新增：为所有折叠标题添加一个点击事件监听器 ---
            customizeForm.querySelectorAll('.collapsible-header').forEach(header => {
                header.addEventListener('click', () => {
                   header.parentElement.classList.toggle('open');
                });
            });

            // 重新绑定之前已有的事件监听器
            const globalCssTextarea = document.getElementById('global-beautification-css');
            if (globalCssTextarea) {
                globalCssTextarea.value = db.globalCss || '';
            }
    
            // --- NEW: Update Log Functions ---
            function renderUpdateLog() {
                const tutorialContent = document.getElementById('tutorial-content-area');
                if (!tutorialContent) return;
    
                const updateSection = document.createElement('div');
                updateSection.className = 'tutorial-item'; // Use tutorial-item class, default open
    
                let notesHtml = '';
                updateLog.forEach((log, index) => {
                    notesHtml += `
                        <div style="margin-bottom: 15px; ${index < updateLog.length - 1 ? 'padding-bottom: 10px; border-bottom: 1px solid #f0f0f0;' : ''}">
                            <h4 style="font-size: 15px; color: #333; margin: 0 0 5px 0;">版本 ${log.version} (${log.date})</h4>
                            <ul style="padding-left: 20px; margin: 0; list-style-type: '› ';">
                                ${log.notes.map(note => `<li style="margin-bottom: 5px; color: #666;">${note}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                });
    
                updateSection.innerHTML = `
                    <div class="tutorial-header">更新日志</div>
                    <div class="tutorial-content" style="padding-top: 15px;">
                        ${notesHtml}
                    </div>
                `;
                
                tutorialContent.appendChild(updateSection);
            }
    
            function showUpdateModal() {
                const modal = document.getElementById('update-log-modal');
                const contentEl = document.getElementById('update-log-modal-content');
                const closeBtn = document.getElementById('close-update-log-modal');
    
                const latestLog = updateLog[0];
                if (!latestLog) return;
    
                contentEl.innerHTML = `
                    <h4>版本 ${latestLog.version} (${latestLog.date})</h4>
                    <ul>
                        ${latestLog.notes.map(note => `<li>${note}</li>`).join('')}
                    </ul>
                    <p style="font-size: 12px; color: #888; text-align: center; margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">过往更新说明可在“教程”应用内查看。</p>
                `;
    
                modal.classList.add('visible');
    
                closeBtn.onclick = () => {
                    modal.classList.remove('visible');
                    localStorage.setItem('lastSeenVersion', appVersion);
                };
            }
    
            function checkForUpdates() {
                const lastSeenVersion = localStorage.getItem('lastSeenVersion');
                if (lastSeenVersion !== appVersion) {
                    // Use a small delay to ensure the main UI has rendered
                    setTimeout(showUpdateModal, 500);
                }
            }
            const applyGlobalCssNowBtn = document.getElementById('apply-global-css-now-btn');
            if (applyGlobalCssNowBtn) {
                applyGlobalCssNowBtn.addEventListener('click', async () => {
                    const newCss = globalCssTextarea.value;
                    db.globalCss = newCss;
                    applyGlobalCss(newCss);
                    await saveData();
                    showToast('全局样式已应用');
                });
            }
            const globalCssApplyBtn = document.getElementById('global-css-apply-btn');
            if (globalCssApplyBtn) {
                globalCssApplyBtn.addEventListener('click', () => {
                    const select = document.getElementById('global-css-preset-select');
                    const presetName = select.value;
                    if (!presetName) return showToast('请选择一个预设');
                    const preset = db.globalCssPresets.find(p => p.name === presetName);
                    if (preset) {
                        globalCssTextarea.value = preset.css;
                        db.globalCss = preset.css;
                        applyGlobalCss(preset.css);
                        saveData();
                        showToast('全局CSS预设已应用');
                    }
                });
            }
            const globalCssSaveBtn = document.getElementById('global-css-save-btn');
            if (globalCssSaveBtn) {
                 globalCssSaveBtn.addEventListener('click', () => {
                    const css = globalCssTextarea.value.trim();
                    if (!css) return showToast('CSS内容为空，无法保存');
                    const name = prompt('请输入此预设的名称（同名将覆盖）:');
                    if (!name) return;
                    if (!db.globalCssPresets) db.globalCssPresets = [];
                    const existingIndex = db.globalCssPresets.findIndex(p => p.name === name);
                    if (existingIndex > -1) {
                        db.globalCssPresets[existingIndex].css = css;
                    } else {
                        db.globalCssPresets.push({ name, css });
                    }
                    saveData();
                    populateGlobalCssPresetSelect();
                    showToast('全局CSS预设已保存');
                });
            }
            const globalCssManageBtn = document.getElementById('global-css-manage-btn');
            if (globalCssManageBtn) {
                 globalCssManageBtn.addEventListener('click', openGlobalCssManageModal);
            }
        }


        function setupTutorialApp() {
            tutorialContentArea.addEventListener('click', (e) => {
                const header = e.target.closest('.tutorial-header');
                if (header) {
                    header.parentElement.classList.toggle('open');
                }
            });
        }

        // --- NEW: Update Log Functions ---
        function renderUpdateLog() {
            const tutorialContent = document.getElementById('tutorial-content-area');
            if (!tutorialContent) return;

            const updateSection = document.createElement('div');
            updateSection.className = 'tutorial-item'; // Use tutorial-item class, default open

            let notesHtml = '';
            updateLog.forEach((log, index) => {
                notesHtml += `
                    <div style="margin-bottom: 15px; ${index < updateLog.length - 1 ? 'padding-bottom: 10px; border-bottom: 1px solid #f0f0f0;' : ''}">
                        <h4 style="font-size: 15px; color: #333; margin: 0 0 5px 0;">版本 ${log.version} (${log.date})</h4>
                        <ul style="padding-left: 20px; margin: 0; list-style-type: '› ';">
                            ${log.notes.map(note => `<li style="margin-bottom: 5px; color: #666;">${note}</li>`).join('')}
                        </ul>
                    </div>
                `;
            });

            updateSection.innerHTML = `
                <div class="tutorial-header">更新日志</div>
                <div class="tutorial-content" style="padding-top: 15px;">
                    ${notesHtml}
                </div>
            `;
            
            tutorialContent.appendChild(updateSection);
        }

        function showUpdateModal() {
            const modal = document.getElementById('update-log-modal');
            const contentEl = document.getElementById('update-log-modal-content');
            const closeBtn = document.getElementById('close-update-log-modal');

            const latestLog = updateLog[0];
            if (!latestLog) return;

            contentEl.innerHTML = `
                <h4>版本 ${latestLog.version} (${latestLog.date})</h4>
                <ul>
                    ${latestLog.notes.map(note => `<li>${note}</li>`).join('')}
                </ul>
                <p style="font-size: 12px; color: #888; text-align: center; margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">过往更新说明可在“教程”应用内查看。</p>
            `;

            modal.classList.add('visible');

            closeBtn.onclick = () => {
                modal.classList.remove('visible');
                localStorage.setItem('lastSeenVersion', appVersion);
            };
        }

        function checkForUpdates() {
            const lastSeenVersion = localStorage.getItem('lastSeenVersion');
            if (lastSeenVersion !== appVersion) {
                // Use a small delay to ensure the main UI has rendered
                setTimeout(showUpdateModal, 500);
            }
        }
        let loadingBtn = false

        function renderTutorialContent() {
            const tutorials = [
                {title: '写在前面', imageUrls: ['https://i.postimg.cc/7PgyMG9S/image.jpg']},
                {
                    title: '软件介绍',
                    imageUrls: ['https://i.postimg.cc/VvsJRh6q/IMG-20250713-162647.jpg', 'https://i.postimg.cc/8P5FfxxD/IMG-20250713-162702.jpg', 'https://i.postimg.cc/3r94R3Sn/IMG-20250713-162712.jpg']
                },
                {
                    title: '404',
                    imageUrls: ['https://i.postimg.cc/x8scFPJW/IMG-20250713-162756.jpg', 'https://i.postimg.cc/pX6mfqtj/IMG-20250713-162809.jpg', 'https://i.postimg.cc/YScjV00q/IMG-20250713-162819.jpg', 'https://i.postimg.cc/13VfJw9j/IMG-20250713-162828.jpg']
                },
                {title: '404-群聊', imageUrls: ['https://i.postimg.cc/X7LSmRTJ/404.jpg']}
            ];
            tutorialContentArea.innerHTML = '';
            renderUpdateLog();
            tutorials.forEach(tutorial => {
                const item = document.createElement('div');
                item.className = 'tutorial-item';
                const imagesHtml = tutorial.imageUrls.map(url => `<img src="${url}" alt="${tutorial.title}教程图片">`).join('');
                item.innerHTML = `<div class="tutorial-header">${tutorial.title}</div><div class="tutorial-content">${imagesHtml}</div>`;
                tutorialContentArea.appendChild(item);
            });

            const backupDataBtn = document.createElement('button');
            backupDataBtn.className = 'btn btn-primary';
            backupDataBtn.textContent = '备份数据';
            backupDataBtn.disabled = loadingBtn

            backupDataBtn.addEventListener('click', async () => {
                if(loadingBtn){
                    return
                }
                loadingBtn = true
                try {
                    showToast('正在准备导出数据...');

                    // 创建完整的数据备份对象
                    const fullBackupData = await createFullBackupData();

                    const jsonString = JSON.stringify(fullBackupData);
                    const dataBlob = new Blob([jsonString]);

                    // Compress the data using Gzip
                    const compressionStream = new CompressionStream('gzip');
                    const compressedStream = dataBlob.stream().pipeThrough(compressionStream);
                    const compressedBlob = await new Response(compressedStream, { headers: { 'Content-Type': 'application/octet-stream' } }).blob();

                    const url = URL.createObjectURL(compressedBlob);
                    const a = document.createElement('a');
                    const now = new Date();
                    const date = now.toISOString().slice(0, 10);
                    const time = now.toTimeString().slice(0, 8).replace(/:/g, '');
                    a.href = url;
                    a.download = `QChat_备份数据_${date}_${time}.ee`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    loadingBtn = false
                    showToast('聊天记录导出成功');
                }catch (e){
                    loadingBtn = false
                    showToast(`导出失败, 发生错误: ${e.message}`);
                    console.error('导出错误详情:', e);
                }
            });
            const importDataBtn = document.createElement('label');
            importDataBtn.className = 'btn btn-neutral';
            importDataBtn.textContent = '导入数据';
            importDataBtn.style.marginTop = '15px'
            importDataBtn.style.display = 'block'
            importDataBtn.disabled = loadingBtn;
            importDataBtn.setAttribute('for', 'import-data-input')
            document.querySelector('#import-data-input').addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                if(confirm('此操作将覆盖当前所有聊天记录和设置。此操作不可撤销。确定要继续吗？')){
                    try {
                        showToast('正在导入数据，请稍候...');

                        // Decompress the file stream
                        const decompressionStream = new DecompressionStream('gzip');
                        const decompressedStream = file.stream().pipeThrough(decompressionStream);
                        const jsonString = await new Response(decompressedStream).text();

                        let data = JSON.parse(jsonString);

                        // 检测数据格式并进行兼容性处理
                        const importResult = await importBackupData(data);

                        if (importResult.success) {
                            showToast(`数据导入成功！${importResult.message} 应用即将刷新。`);
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        } else {
                            showToast(`导入失败: ${importResult.error}`);
                        }
                    } catch (error) {
                        console.error("导入失败:", error);
                        showToast(`解压或解析文件时发生错误: ${error.message}`);
                    } finally {
                        event.target.value = null;
                    }
                }else {
                    event.target.value = null;
                }

            })

            tutorialContentArea.appendChild(backupDataBtn);
            tutorialContentArea.appendChild(importDataBtn);
        }

        // --- Chat List & Chat Room ---
        function setupChatListScreen() {
            renderChatList();
            addChatBtn.addEventListener('click', () => {
                addCharModal.classList.add('visible');
                addCharForm.reset();
            });

            // --- 新增：导入角色卡按钮事件 ---
            const importBtn = document.getElementById('import-character-card-btn');
            const cardInput = document.getElementById('character-card-input');
            importBtn.addEventListener('click', () => {
                cardInput.click();
            });
            cardInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleCharacterImport(file);
                }
                // 重置输入框，以便可以再次选择相同的文件
                e.target.value = null;
            });
            // --- 新增结束 ---
            chatListContainer.addEventListener('click', (e) => {
                const chatItem = e.target.closest('.chat-item');
                if (chatItem) {
                    currentChatId = chatItem.dataset.id;
                    currentChatType = chatItem.dataset.type;
                    openChatRoom(currentChatId, currentChatType);
                }
            });
            chatListContainer.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                const chatItem = e.target.closest('.chat-item');
                if (!chatItem) return;
                handleChatListLongPress(chatItem.dataset.id, chatItem.dataset.type, e.clientX, e.clientY);
            });
            chatListContainer.addEventListener('touchstart', (e) => {
                const chatItem = e.target.closest('.chat-item');
                if (!chatItem) return;
                longPressTimer = setTimeout(() => {
                    const touch = e.touches[0];
                    handleChatListLongPress(chatItem.dataset.id, chatItem.dataset.type, touch.clientX, touch.clientY);
                }, 400);
            });
            chatListContainer.addEventListener('touchend', () => clearTimeout(longPressTimer));
            chatListContainer.addEventListener('touchmove', () => clearTimeout(longPressTimer));
        }

        function handleChatListLongPress(chatId, chatType, x, y) {
            clearTimeout(longPressTimer);
            const chatItem = (chatType === 'private') ? db.characters.find(c => c.id === chatId) : db.groups.find(g => g.id === chatId);
            if (!chatItem) return;
            const itemName = chatType === 'private' ? chatItem.remarkName : chatItem.name;
            const menuItems = [{
                label: chatItem.isPinned ? '取消置顶' : '置顶聊天',
                action: async () => {
                    chatItem.isPinned = !chatItem.isPinned;
                    await saveData();
                    renderChatList();
                }
            }, {
                label: '删除聊天',
                danger: true,
                action: async () => {
                    if (confirm(`确定要删除与“${itemName}”的聊天记录吗？此操作不可恢复。`)) {
                        if (chatType === 'private') {
                            await dexieDB.characters.delete(chatId);
                            db.characters = db.characters.filter(c => c.id !== chatId);
                        } else {
                            await dexieDB.groups.delete(chatId);
                            db.groups = db.groups.filter(g => g.id !== chatId);
                        }
                        // No need to call saveData() as we've directly manipulated the DB and in-memory object.
                        renderChatList();
                        showToast('聊天已删除');
                    }
                }
            }];
            createContextMenu(menuItems, x, y);
        }

        function renderChatList() {
            chatListContainer.innerHTML = '';
            const allChats = [...db.characters.map(c => ({...c, type: 'private'})), ...db.groups.map(g => ({
                ...g,
                type: 'group'
            }))];
            noChatsPlaceholder.style.display = (db.characters.length + db.groups.length) === 0 ? 'block' : 'none';
            const sortedChats = allChats.sort((a, b) => {
                if (a.isPinned !== b.isPinned) return a.isPinned ? -1 : 1;
                const lastMsgTimeA = a.history && a.history.length > 0 ? a.history[a.history.length - 1].timestamp : 0;
                const lastMsgTimeB = b.history && b.history.length > 0 ? b.history[b.history.length - 1].timestamp : 0;
                return lastMsgTimeB - lastMsgTimeA;
            });
            sortedChats.forEach(chat => {
                let lastMessageText = '开始聊天吧...';
                if (chat.history && chat.history.length > 0) {
                    const invisibleRegex = /\[.*?(?:接收|退回).*?的转账\]|\[.*?更新状态为：.*?\]|\[.*?已接收礼物\]|\[system:.*?\]|\[.*?邀请.*?加入了群聊\]|\[.*?修改群名为：.*?\]|\[system-display:.*?\]/;
                    const visibleHistory = chat.history.filter(msg => !invisibleRegex.test(msg.content));
                    if (visibleHistory.length > 0) {
                        const lastMsg = visibleHistory[visibleHistory.length - 1];
                        const urlRegex = /^(https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif|webp|bmp|svg)|data:image\/[a-z]+;base64,)/i;
                        const imageRecogRegex = /\[.*?发来了一张图片：\]/
                        const voiceRegex = /\[.*?的语音：.*?\]/;
                        const photoVideoRegex = /\[.*?发来的照片\/视频：.*?\]/;
                        const transferRegex = /\[.*?的转账：.*?元.*?\]|\[.*?给你转账：.*?元.*?\]|\[.*?向.*?转账：.*?元.*?\]/;
                        const stickerRegex = /\[.*?的表情包：.*?\]|\[.*?发送的表情包：.*?\]/;
                        const giftRegex = /\[.*?送来的礼物：.*?\]|\[.*?向.*?送来了礼物：.*?\]/;



                        if (giftRegex.test(lastMsg.content)) {
                            lastMessageText = '[礼物]';
                        } else if (stickerRegex.test(lastMsg.content)) {
                            lastMessageText = '[表情包]';
                        } else if (voiceRegex.test(lastMsg.content)) {
                            lastMessageText = '[语音]';
                        } else if (photoVideoRegex.test(lastMsg.content)) {
                            lastMessageText = '[照片/视频]';
                        } else if (transferRegex.test(lastMsg.content)) {
                            lastMessageText = '[转账]';
                        } else if (imageRecogRegex.test(lastMsg.content) || (lastMsg.parts && lastMsg.parts.some(p => p.type === 'image'))) {
                            lastMessageText = '[图片]';
                        }else if ((lastMsg.parts && lastMsg.parts.some(p => p.type === 'html'))) {
                            lastMessageText = '[互动]';
                        } else {
                            const textMatch = lastMsg.content.match(/\[.*?的消息：([\s\S]+)\]/);
                            // ...
let text = lastMsg.content.trim();
const plainTextMatch = text.match(/^\[.*?：([\s\S]*)\]$/);
if (plainTextMatch && plainTextMatch[1]) {
    text = plainTextMatch[1].trim();
}
text = text.replace(/\[发送时间:.*?\]$/, '').trim(); // 擦掉时间戳
const htmlRegex = /<[a-z][\s\S]*>/i;
if (htmlRegex.test(text)) {
    lastMessageText = '[互动]';
} else {
    lastMessageText = urlRegex.test(text) ? '[图片]' : text;
}
                        }
                    } else {
                        const lastEverMsg = chat.history[chat.history.length - 1];
                        const inviteRegex = /\[(.*?)邀请(.*?)加入了群聊\]/;
                        const renameRegex = /\[.*?修改群名为：.*?\]/;
                        const timeSkipRegex = /\[system-display:([\s\S]+?)\]/;
                        const timeSkipMatch = lastEverMsg.content.match(timeSkipRegex);

                        if (timeSkipMatch) {
                            lastMessageText = timeSkipMatch[1];
                        } else if (inviteRegex.test(lastEverMsg.content)) {
                            lastMessageText = '新成员加入了群聊';
                        } else if (renameRegex.test(lastEverMsg.content)) {
                            lastMessageText = '群聊名称已修改';
                            } else {
                            lastMessageText = 'ta正在等你';
                        }
                        
                    }
                }
                const li = document.createElement('li');
                li.className = 'list-item chat-item';
                if (chat.isPinned) li.classList.add('pinned');
                li.dataset.id = chat.id;
                li.dataset.type = chat.type;
                const avatarClass = chat.type === 'group' ? 'group-avatar' : '';
                const itemName = chat.type === 'private' ? chat.remarkName : chat.name;
                const pinBadgeHTML = chat.isPinned ? '<span class="pin-badge">置顶</span>' : '';
let timeString = '';
const lastMessage = chat.history && chat.history.length > 0 ? chat.history[chat.history.length - 1] : null;
if (lastMessage) {
    const date = new Date(lastMessage.timestamp);
    const now = new Date();
    if (date.toDateString() === now.toDateString()) {
        timeString = `${pad(date.getHours())}:${pad(date.getMinutes())}`;
    } else {
        timeString = `${pad(date.getMonth() + 1)}-${pad(date.getDate())}`;
    }
}

const unreadCount = chat.unreadCount || 0;
const unreadBadgeHTML = unreadCount > 0 
    ? `<span class="unread-badge visible">${unreadCount > 99 ? '99+' : unreadCount}</span>`
    : `<span class="unread-badge"></span>`;

li.innerHTML = `
<img src="${chat.avatar}" alt="${itemName}" class="chat-avatar ${avatarClass}">
<div class="item-details">
    <div class="item-details-row">
        <div class="item-name">${itemName}</div>
        <div class="item-meta">
            <span class="item-time">${timeString}</span>
        </div>
    </div>
    <div class="item-preview-wrapper">
        <div class="item-preview">${lastMessageText}</div>
        ${pinBadgeHTML}
    </div>
</div>
${unreadBadgeHTML}`; /* <-- 将红点元素移动到这里 */


                chatListContainer.appendChild(li);
            });
        }

        function setupAddCharModal() {
            addCharForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newChar = {
                    id: `char_${Date.now()}`,
                    realName: document.getElementById('char-real-name').value,
                    remarkName: document.getElementById('char-remark-name').value,
                    persona: '',
                    avatar: 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg',
                    myName: document.getElementById('my-name-for-char').value,
                    myPersona: '',
                    myAvatar: 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg',
                    theme: 'white_blue',
                    maxMemory: 10,
                    chatBg: '',
                    history: [],
                    isPinned: false,
                    status: '在线',
                    worldBookIds: [],
                    useCustomBubbleCss: false,
                    customBubbleCss: '',
                    unreadCount: 0,
                    memoryJournals: [],
                    journalWorldBookIds: [], // 新增
                    peekScreenSettings: { wallpaper: '', customIcons: {}, unlockAvatar: '' }, // 新增
 lastUserMessageTimestamp: null, // 新增：用于记录最后消息时间
               };
                db.characters.push(newChar);
                await saveData();
                renderChatList();
                addCharModal.classList.remove('visible');
                showToast(`角色“${newChar.remarkName}”创建成功！`);
                promptForBackupIfNeeded('new_char');
            });
        }

        function setupChatRoom() {
            const placeholderPlusBtn = document.getElementById('placeholder-plus-btn');
            const chatExpansionPanel = document.getElementById('chat-expansion-panel');

            placeholderPlusBtn.addEventListener('click', () => {
                // Hide sticker modal if open
                if (stickerModal.classList.contains('visible')) {
                    stickerModal.classList.remove('visible');
                }
                chatExpansionPanel.classList.toggle('visible');
            });

            sendMessageBtn.addEventListener('click', sendMessage);
            sendMessageBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                sendMessage();
                setTimeout(() => {
                    messageInput.focus();
                }, 50);
            });
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !isGenerating) sendMessage();
            });
            getReplyBtn.addEventListener('click', () => getAiReply(currentChatId, currentChatType));
            regenerateBtn.addEventListener('click', handleRegenerate);
            messageArea.addEventListener('click', (e) => {
                // --- Close any open panels when clicking message area ---
                if (stickerModal.classList.contains('visible')) {
                    stickerModal.classList.remove('visible');
                    return;
                }
                if (chatExpansionPanel.classList.contains('visible')) {
                    chatExpansionPanel.classList.remove('visible');
                    return;
                }
                // --- End close panels ---

                if (e.target && e.target.id === 'load-more-btn') {
                    loadMoreMessages();
                } else if (isInMultiSelectMode) {
                    const messageWrapper = e.target.closest('.message-wrapper');
                    if (messageWrapper) {
                        toggleMessageSelection(messageWrapper.dataset.id);
                    }
                } else {
                    const voiceBubble = e.target.closest('.voice-bubble');
                    if (voiceBubble) {
                        const transcript = voiceBubble.closest('.message-wrapper').querySelector('.voice-transcript');
                        if (transcript) {
                            transcript.classList.toggle('active');
                        }
                    }
                    // --- 新增：处理双语气泡的点击 ---
const bilingualBubble = e.target.closest('.bilingual-bubble');
if (bilingualBubble) {
    const translationText = bilingualBubble.closest('.message-wrapper').querySelector('.translation-text');
    if (translationText) {
        translationText.classList.toggle('active');
    }
}
// --- 新增结束 ---

                    const pvCard = e.target.closest('.pv-card');
                    if (pvCard) {
                        const imageOverlay = pvCard.querySelector('.pv-card-image-overlay');
                        const footer = pvCard.querySelector('.pv-card-footer');
                        imageOverlay.classList.toggle('hidden');
                        footer.classList.toggle('hidden');
                    }
                    const giftCard = e.target.closest('.gift-card');
                    if (giftCard) {
                        const description = giftCard.closest('.message-wrapper').querySelector('.gift-card-description');
                        if (description) {
                            description.classList.toggle('active');
                        }
                    }
                    const transferCard = e.target.closest('.transfer-card.received-transfer');
                    if (transferCard && currentChatType === 'private') {
                        const messageWrapper = transferCard.closest('.message-wrapper');
                        const messageId = messageWrapper.dataset.id;
                        const character = db.characters.find(c => c.id === currentChatId);
                        const message = character.history.find(m => m.id === messageId);
                        if (message && message.transferStatus === 'pending') {
                            handleReceivedTransferClick(messageId);
                        }
                    }
                }
            });
            messageArea.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                if (e.target.id === 'load-more-btn' || isInMultiSelectMode) return;
                const messageWrapper = e.target.closest('.message-wrapper');
                if (!messageWrapper) return;
                handleMessageLongPress(messageWrapper, e.clientX, e.clientY);
            });
            messageArea.addEventListener('touchstart', (e) => {
                if (e.target.id === 'load-more-btn') return;
                const messageWrapper = e.target.closest('.message-wrapper');
                if (!messageWrapper) return;
                longPressTimer = setTimeout(() => {
                    const touch = e.touches[0];
                    handleMessageLongPress(messageWrapper, touch.clientX, touch.clientY);
                }, 400);
            });
            messageArea.addEventListener('touchend', () => clearTimeout(longPressTimer));
            messageArea.addEventListener('touchmove', () => clearTimeout(longPressTimer));
            
            const messageEditForm = document.getElementById('message-edit-form');
            if(messageEditForm) {
                messageEditForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    saveMessageEdit();
                });
            }

            const cancelEditModalBtn = document.getElementById('cancel-edit-modal-btn');
            if(cancelEditModalBtn) {
                cancelEditModalBtn.addEventListener('click', cancelMessageEdit);
            }

            cancelMultiSelectBtn.addEventListener('click', exitMultiSelectMode);
            deleteSelectedBtn.addEventListener('click', deleteSelectedMessages);
            
            // 新增：绑定取消引用按钮事件
            document.getElementById('cancel-reply-btn').addEventListener('click', cancelQuoteReply);
        }

        function handleMessageLongPress(messageWrapper, x, y) {
            if (isInMultiSelectMode) return;
            clearTimeout(longPressTimer);
            const messageId = messageWrapper.dataset.id;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const message = chat.history.find(m => m.id === messageId);
            if (!message) return;

            const isImageRecognitionMsg = message.parts && message.parts.some(p => p.type === 'image');
            const isVoiceMessage = /\[.*?的语音：.*?\]/.test(message.content);
            const isStickerMessage = /\[.*?的表情包：.*?\]|\[.*?发送的表情包：.*?\]/.test(message.content);
            const isPhotoVideoMessage = /\[.*?发来的照片\/视频：.*?\]/.test(message.content);
            const isTransferMessage = /\[.*?给你转账：.*?\]|\[.*?的转账：.*?\]|\[.*?向.*?转账：.*?\]/.test(message.content);
            const isGiftMessage = /\[.*?送来的礼物：.*?\]|\[.*?向.*?送来了礼物：.*?\]/.test(message.content);
            const isInvisibleMessage = /\[.*?(?:接收|退回).*?的转账\]|\[.*?更新状态为：.*?\]|\[.*?已接收礼物\]|\[system:.*?\]|\[.*?邀请.*?加入了群聊\]|\[.*?修改群名为：.*?\]|\[system-display:.*?\]/.test(message.content);
            const isWithdrawn = message.isWithdrawn; // 新增：检查消息是否已撤回

            let menuItems = [];

            // 如果消息未被撤回，则显示正常菜单
            if (!isWithdrawn) {
                if (!isImageRecognitionMsg && !isVoiceMessage && !isStickerMessage && !isPhotoVideoMessage && !isTransferMessage && !isGiftMessage && !isInvisibleMessage) {
                    menuItems.push({label: '编辑', action: () => startMessageEdit(messageId)});
                }
                
                if (!isInvisibleMessage) {
                    menuItems.push({label: '引用', action: () => startQuoteReply(messageId)});
                }

                // 新增：只有自己发送的消息才能撤回
                if (message.role === 'user') {
                    menuItems.push({label: '撤回', action: () => withdrawMessage(messageId)});
                }
            }

            menuItems.push({label: '删除', action: () => enterMultiSelectMode(messageId)});

            if (menuItems.length > 0) {
                createContextMenu(menuItems, x, y);
            }
        }

        // --- 新增：引用功能相关函数 ---
    function startQuoteReply(messageId) {
        const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
        const message = chat.history.find(m => m.id === messageId);
        if (!message) return;

        let senderName = '';
        let senderId = '';
        if (message.role === 'user') {
            senderName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
            senderId = 'user_me';
        } else { // assistant
            if (currentChatType === 'private') {
                senderName = chat.remarkName;
                senderId = chat.id;
            } else {
                const sender = chat.members.find(m => m.id === message.senderId);
                senderName = sender ? sender.groupNickname : '未知成员';
                senderId = sender ? sender.id : 'unknown';
            }
        }
        
        // 提取纯文本内容用于预览
        let previewContent = message.content;
        const textMatch = message.content.match(/\[.*?的消息：([\s\S]+?)\]/);
        if (textMatch) {
            previewContent = textMatch[1];
        } else if (/\[.*?的表情包：.*?\]/.test(message.content)) {
            previewContent = '[表情包]';
        } else if (/\[.*?的语音：.*?\]/.test(message.content)) {
            previewContent = '[语音]';
        } else if (/\[.*?发来的照片\/视频：.*?\]/.test(message.content)) {
            previewContent = '[照片/视频]';
        } else if (message.parts && message.parts.some(p => p.type === 'image')) {
            previewContent = '[图片]';
        }
        
        currentQuoteInfo = {
            id: message.id,
            senderId: senderId,
            senderName: senderName,
            content: previewContent.substring(0, 100) // 截断以防过长
        };

        const previewBar = document.getElementById('reply-preview-bar');
        previewBar.querySelector('.reply-preview-name').textContent = `回复 ${senderName}`;
        previewBar.querySelector('.reply-preview-text').textContent = currentQuoteInfo.content;
        previewBar.classList.add('visible');
        
        messageInput.focus();
    }

    function cancelQuoteReply() {
        currentQuoteInfo = null;
        const previewBar = document.getElementById('reply-preview-bar');
        previewBar.classList.remove('visible');
    }
    // --- 引用功能函数结束 ---

        function startMessageEdit(messageId) {
            exitMultiSelectMode();
            editingMessageId = messageId;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const message = chat.history.find(m => m.id === messageId);
            if (!message) return;

            const modal = document.getElementById('message-edit-modal');
            const textarea = document.getElementById('message-edit-textarea');

            let contentToEdit = message.content;
            const plainTextMatch = contentToEdit.match(/^\[.*?：([\s\S]*)\]$/);
            if (plainTextMatch && plainTextMatch[1]) {
                contentToEdit = plainTextMatch[1].trim();
            }
            contentToEdit = contentToEdit.replace(/\[发送时间:.*?\]/g, '').trim();
            
            textarea.value = contentToEdit;
            modal.classList.add('visible');
            textarea.focus();
        }

        async function saveMessageEdit() {
            const newText = document.getElementById('message-edit-textarea').value.trim();
            if (!newText || !editingMessageId) {
                cancelMessageEdit();
                return;
            }

            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const messageIndex = chat.history.findIndex(m => m.id === editingMessageId);
            if (messageIndex === -1) {
                cancelMessageEdit();
                return;
            }

            const oldContent = chat.history[messageIndex].content;
            const prefixMatch = oldContent.match(/(\[.*?的消息：)[\s\S]+\]/);
            let newContent;

            if (prefixMatch && prefixMatch[1]) {
                const prefix = prefixMatch[1];
                newContent = `${prefix}${newText}]`;
            } else {
                newContent = newText;
            }

            chat.history[messageIndex].content = newContent;
            if (chat.history[messageIndex].parts) {
                chat.history[messageIndex].parts = [{type: 'text', text: newContent}];
            }

            await saveData();
            currentPage = 1;
            renderMessages(false, true);
            renderChatList();
            
            cancelMessageEdit();
        }

        function cancelMessageEdit() {
            editingMessageId = null;
            const modal = document.getElementById('message-edit-modal');
            if (modal) {
                modal.classList.remove('visible');
            }
        }

        function enterMultiSelectMode(initialMessageId) {
            isInMultiSelectMode = true;
            chatRoomHeaderDefault.style.display = 'none';
            chatRoomHeaderSelect.style.display = 'flex';
            document.querySelector('.chat-input-wrapper').style.display = 'none';
            multiSelectBar.classList.add('visible');
            chatRoomScreen.classList.add('multi-select-active');
            selectedMessageIds.clear();
            if (initialMessageId) {
                toggleMessageSelection(initialMessageId);
            }
        }

        function exitMultiSelectMode() {
            isInMultiSelectMode = false;
            chatRoomHeaderDefault.style.display = 'flex';
            chatRoomHeaderSelect.style.display = 'none';
            document.querySelector('.chat-input-wrapper').style.display = 'block';
            multiSelectBar.classList.remove('visible');
            chatRoomScreen.classList.remove('multi-select-active');
            selectedMessageIds.forEach(id => {
                const el = messageArea.querySelector(`.message-wrapper[data-id="${id}"]`);
                if (el) el.classList.remove('multi-select-selected');
            });
            selectedMessageIds.clear();
        }

        function toggleMessageSelection(messageId) {
            const el = messageArea.querySelector(`.message-wrapper[data-id="${messageId}"]`);
            if (!el) return;
            if (selectedMessageIds.has(messageId)) {
                selectedMessageIds.delete(messageId);
                el.classList.remove('multi-select-selected');
            } else {
                selectedMessageIds.add(messageId);
                el.classList.add('multi-select-selected');
            }
            selectCount.textContent = `已选择 ${selectedMessageIds.size} 项`;
            deleteSelectedBtn.disabled = selectedMessageIds.size === 0;
        }

        async function deleteSelectedMessages() {
            if (selectedMessageIds.size === 0) return;
            const deletedCount = selectedMessageIds.size;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            chat.history = chat.history.filter(m => !selectedMessageIds.has(m.id));
            await saveData();
            currentPage = 1;
            renderMessages(false, true);
            renderChatList();
            exitMultiSelectMode();
            showToast(`已删除 ${deletedCount} 条消息`);
        }

        function openChatRoom(chatId, type) {
            const chat = (type === 'private') ? db.characters.find(c => c.id === chatId) : db.groups.find(g => g.id === chatId);
            if (!chat) return;
                // --- 从这里开始是新增的代码 ---
            if (chat.unreadCount && chat.unreadCount > 0) {
                chat.unreadCount = 0;
                saveData();
                renderChatList(); // 重新渲染列表，清除红点
            }
    // --- 新增代码结束 ---
            exitMultiSelectMode();
            cancelMessageEdit();
            chatRoomTitle.textContent = (type === 'private') ? chat.remarkName : chat.name;
            const subtitle = document.getElementById('chat-room-subtitle');
            if (type === 'private') {
                subtitle.style.display = 'flex';
                chatRoomStatusText.textContent = chat.status || '在线';
            } else {
                subtitle.style.display = 'none';
            }
            getReplyBtn.style.display = 'inline-flex';
            chatRoomScreen.style.backgroundImage = chat.chatBg ? `url(${chat.chatBg})` : 'none';
            typingIndicator.style.display = 'none';
            isGenerating = false;
            getReplyBtn.disabled = false;
            currentPage = 1;
            chatRoomScreen.className = chatRoomScreen.className.replace(/\bchat-active-[^ ]+\b/g, '');
            chatRoomScreen.classList.add(`chat-active-${chatId}`);
            updateCustomBubbleStyle(chatId, chat.customBubbleCss, chat.useCustomBubbleCss);
            renderMessages(false, true);
            switchScreen('chat-room-screen');
        }

        function renderMessages(isLoadMore = false, forceScrollToBottom = false) {
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            if (!chat || !chat.history) return;
            const oldScrollHeight = messageArea.scrollHeight;
            const totalMessages = chat.history.length;
            const end = totalMessages - (currentPage - 1) * MESSAGES_PER_PAGE;
            const start = Math.max(0, end - MESSAGES_PER_PAGE);
            const messagesToRender = chat.history.slice(start, end);
            if (!isLoadMore) messageArea.innerHTML = '';
            const fragment = document.createDocumentFragment();
            messagesToRender.forEach(msg => {
                const bubble = createMessageBubbleElement(msg);
                if (bubble) fragment.appendChild(bubble);
            });
            const existingLoadBtn = document.getElementById('load-more-btn');
            if (existingLoadBtn) existingLoadBtn.remove();
            messageArea.prepend(fragment);
            if (totalMessages > currentPage * MESSAGES_PER_PAGE) {
                const loadMoreButton = document.createElement('button');
                loadMoreButton.id = 'load-more-btn';
                loadMoreButton.className = 'load-more-btn';
                loadMoreButton.textContent = '加载更早的消息';
                messageArea.prepend(loadMoreButton);
            }
            if (forceScrollToBottom) {
                setTimeout(() => {
                    messageArea.scrollTop = messageArea.scrollHeight;
                }, 0);
            } else if (isLoadMore) {
                messageArea.scrollTop = messageArea.scrollHeight - oldScrollHeight;
            }
        }

        function loadMoreMessages() {
            currentPage++;
            renderMessages(true, false);
        }

        function calculateVoiceDuration(text) {
            return Math.max(1, Math.min(60, Math.ceil(text.length / 3.5)));
        }

        function createMessageBubbleElement(message) {
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const {role, content, timestamp, id, transferStatus, giftStatus, stickerData, senderId, quote, isWithdrawn, originalContent} = message;
    // --- 新增：双语模式判断逻辑 ---
            const isBilingualMode = chat.bilingualModeEnabled;
            let bilingualMatch = null;
            if (isBilingualMode && role === 'assistant') {
                const contentMatch = content.match(/^\[.*?的消息：([\s\S]+)\]$/);
                if (contentMatch) {
                    const mainText = contentMatch[1].trim();
                    // 从后往前找到最后一个右括号
                    const lastCloseParen = Math.max(mainText.lastIndexOf(')'), mainText.lastIndexOf('）'));
                    if (lastCloseParen > -1) {
                        // 从右括号的位置往前找对应的左括号
                        const lastOpenParen = Math.max(
                            mainText.lastIndexOf('(', lastCloseParen),
                            mainText.lastIndexOf('（', lastCloseParen)
                        );
                        if (lastOpenParen > -1) {
                            const chineseText = mainText.substring(lastOpenParen + 1, lastCloseParen).trim();
                            const foreignText = mainText.substring(0, lastOpenParen).trim();
                            // 确保原文和译文都不是空的
                            if (foreignText && chineseText) {
                                bilingualMatch = [null, foreignText, chineseText];
                            }
                        }
                    }
                }
            }


            if (bilingualMatch) {
                const foreignText = bilingualMatch[1].trim();
                const chineseText = bilingualMatch[2].trim();
                const wrapper = document.createElement('div');
                wrapper.dataset.id = id;
                wrapper.className = 'message-wrapper received'; // 双语消息总是接收的

                const bubbleRow = document.createElement('div');
                bubbleRow.className = 'message-bubble-row';

                const avatarUrl = chat.avatar;
                const timeString = `${pad(new Date(timestamp).getHours())}:${pad(new Date(timestamp).getMinutes())}`;

                const bubbleElement = document.createElement('div');
                bubbleElement.className = 'message-bubble received bilingual-bubble';
                bubbleElement.innerHTML = `<span>${DOMPurify.sanitize(foreignText)}</span>`;
                const themeKey = chat.theme || 'white_blue';
                const theme = colorThemes[themeKey] || colorThemes['white_blue'];
                const bubbleTheme = theme.received;
                if (!chat.useCustomBubbleCss) {
                    bubbleElement.style.backgroundColor = bubbleTheme.bg;
                    bubbleElement.style.color = bubbleTheme.text;
                }

        
                const translationDiv = document.createElement('div');
                translationDiv.className = 'translation-text';
                translationDiv.textContent = chineseText;

                bubbleRow.innerHTML = `<div class="message-info"><img src="${avatarUrl}" class="message-avatar"><span class="message-time">${timeString}</span></div>`;
                bubbleRow.appendChild(bubbleElement);
                wrapper.appendChild(bubbleRow);
                wrapper.appendChild(translationDiv);
                return wrapper;
            }
            // --- 双语模式逻辑结束 ---

            // 如果不是双语模式，则执行旧的逻辑（这里是您原来的代码，我直接复制过来）
            const timeSkipRegex = /\[system-display:([\s\S]+?)\]/;
            const inviteRegex = /\[(.*?)邀请(.*?)加入了群聊\]/;
            const renameRegex = /\[(.*?)修改群名为：(.*?)\]/;
            const timeSkipMatch = content.match(timeSkipRegex);
            const inviteMatch = content.match(inviteRegex);
            const renameMatch = content.match(renameRegex);
            const invisibleRegex = /\[.*?(?:接收|退回).*?的转账\]|\[.*?更新状态为：.*?\]|\[.*?已接收礼物\]|\[system:.*?\]|\[系统情景通知：.*?\]/;
            if (invisibleRegex.test(content)) {
                return null;
            }
            const wrapper = document.createElement('div');
            wrapper.dataset.id = id;
            if (isWithdrawn) {
                wrapper.className = 'message-wrapper system-notification';
                const withdrawnText = (role === 'user') ? '你撤回了一条消息' : `${chat.remarkName || chat.name}撤回了一条消息`;
                wrapper.innerHTML = `<div><span class="withdrawn-message">${withdrawnText}</span></div><div class="withdrawn-content">${originalContent ? DOMPurify.sanitize(originalContent.replace(/\[.*?的消息：([\s\S]+?)\]/, '$1')) : ''}</div>`;
                const withdrawnMessageSpan = wrapper.querySelector('.withdrawn-message');
                if (withdrawnMessageSpan) {
                    withdrawnMessageSpan.addEventListener('click', () => {
                        const withdrawnContent = wrapper.querySelector('.withdrawn-content');
                        if (withdrawnContent && withdrawnContent.textContent.trim()) {
                            withdrawnContent.classList.toggle('active');
                        }
                    });
                }
                return wrapper;
            }
            if (timeSkipMatch || inviteMatch || renameMatch) {
                wrapper.className = 'message-wrapper system-notification';
                let bubbleText = '';
                if (timeSkipMatch) bubbleText = timeSkipMatch[1];
                if (inviteMatch) bubbleText = `${inviteMatch[1]}邀请${inviteMatch[2]}加入了群聊`;
                if (renameMatch) bubbleText = `${renameMatch[1]}修改群名为“${renameMatch[2]}”`;
                wrapper.innerHTML = `<div class="system-notification-bubble">${bubbleText}</div>`;
                return wrapper;
            }
            const isSent = (role === 'user');
            let avatarUrl, bubbleTheme, senderNickname = '';
            const themeKey = chat.theme || 'white_blue';
            const theme = colorThemes[themeKey] || colorThemes['white_blue'];
            let messageSenderId = isSent ? 'user_me' : senderId;
            if (isSent) {
                avatarUrl = (currentChatType === 'private') ? chat.myAvatar : chat.me.avatar;
                bubbleTheme = theme.sent;
            } else {
                if (currentChatType === 'private') {
                    avatarUrl = chat.avatar;
                } else {
                    const sender = chat.members.find(m => m.id === senderId);
                    if (sender) {
                        avatarUrl = sender.avatar;
                        senderNickname = sender.groupNickname;
                    } else {
                        avatarUrl = 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg';
                    }
                }
                bubbleTheme = theme.received;
            }
            const timeString = `${pad(new Date(timestamp).getHours())}:${pad(new Date(timestamp).getMinutes())}`;
            wrapper.className = `message-wrapper ${isSent ? 'sent' : 'received'}`;
            if (currentChatType === 'group' && !isSent) {
                wrapper.classList.add('group-message');
            }
            const bubbleRow = document.createElement('div');
            bubbleRow.className = 'message-bubble-row';
            let bubbleElement;
            const urlRegex = /^(https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif|webp|bmp|svg)|data:image\/[a-z]+;base64,)/i;
            const sentStickerRegex = /\[(?:.+?)的表情包：.+?\]/i;
            const receivedStickerRegex = /\[(?:.+?)发送的表情包：([\s\S]+?)\]/i;
            const voiceRegex = /\[(?:.+?)的语音：([\s\S]+?)\]/;
            const photoVideoRegex = /\[(?:.+?)发来的照片\/视频：([\s\S]+?)\]/;
            const privateSentTransferRegex = /\[.*?给你转账：([\d.]+)元；备注：(.*?)\]/;
            const privateReceivedTransferRegex = /\[.*?的转账：([\d.]+)元；备注：(.*?)\]/;
            const groupTransferRegex = /\[(.*?)\s*向\s*(.*?)\s*转账：([\d.]+)元；备注：(.*?)\]/;
            const privateGiftRegex = /\[(?:.+?)送来的礼物：([\s\S]+?)\]/;
            const groupGiftRegex = /\[(.*?)\s*向\s*(.*?)\s*送来了礼物：([\s\S]+?)\]/;
            const imageRecogRegex = /\[.*?发来了一张图片：\]/;
            const textRegex = /\[(?:.+?)的消息：([\s\S]+?)\]/;
            const pomodoroRecordRegex = /\[专注记录\]\s*任务：([\s\S]+?)，时长：([\s\S]+?)，期间与 .*? 互动 (\d+)\s*次。/;
            const pomodoroMatch = content.match(pomodoroRecordRegex);
            const sentStickerMatch = content.match(sentStickerRegex);
            const receivedStickerMatch = content.match(receivedStickerRegex);
            const voiceMatch = content.match(voiceRegex);
            const photoVideoMatch = content.match(photoVideoRegex);
            const privateSentTransferMatch = content.match(privateSentTransferRegex);
            const privateReceivedTransferMatch = content.match(privateReceivedTransferRegex);
            const groupTransferMatch = content.match(groupTransferRegex);
            const privateGiftMatch = content.match(privateGiftRegex);
            const groupGiftMatch = content.match(groupGiftRegex);
            const imageRecogMatch = content.match(imageRecogRegex);
            const textMatch = content.match(textRegex);
            if (pomodoroMatch) {
                const taskName = pomodoroMatch[1];
                const duration = pomodoroMatch[2];
                const pokeCount = pomodoroMatch[3];
                bubbleElement = document.createElement('div');
                bubbleElement.className = 'pomodoro-record-card';
                const details = { taskName, duration, pokeCount };
                bubbleElement.innerHTML = `<img src="https://i.postimg.cc/sgdS9khZ/chan-122.png" class="pomodoro-record-icon" alt="pomodoro complete"><div class="pomodoro-record-body"><p class="task-name">${taskName}</p></div>`;
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'pomodoro-record-details';
                detailsDiv.innerHTML = `<p><strong>任务名称:</strong> ${taskName}</p><p><strong>专注时长:</strong> ${duration}</p><p><strong>“戳一戳”次数:</strong> ${pokeCount}</p>`;
                wrapper.appendChild(detailsDiv);
                bubbleElement.addEventListener('click', () => {
                    detailsDiv.classList.toggle('active');
                });
            } else if ((isSent && sentStickerMatch && stickerData) || (!isSent && receivedStickerMatch)) {
                bubbleElement = document.createElement('div');
                bubbleElement.className = 'image-bubble';
                let stickerSrc = '';
                if (isSent) {
                    stickerSrc = stickerData;
                } else {
                    let useCatbox = false;
                    if (chat && chat.worldBookIds && chat.worldBookIds.length > 0) {
                        const worldBookContent = chat.worldBookIds.map(id => db.worldBooks.find(wb => wb.id === id)).filter(Boolean).map(wb => wb.content).join(' ');
                        if (worldBookContent.toLowerCase().includes('catbox')) {
                            useCatbox = true;
                        }
                    }
                    const imageHost = useCatbox ? 'https://files.catbox.moe/' : 'https://i.postimg.cc/';
                    const rawPath = receivedStickerMatch[1].trim();
                    let finalPath;
                    if (useCatbox) {
                        const catboxFileRegex = /[a-z0-9]+\.(jpeg|png|gif|jpg)$/i;
                        const pathMatch = rawPath.match(catboxFileRegex);
                        if (pathMatch) {
                            finalPath = pathMatch[0];
                        } else {
                            finalPath = rawPath;
                        }
                    } else {
                        const pathExtractionRegex = /[a-zA-Z0-9]+\/.*$/;
                        const extractedPathMatch = rawPath.match(pathExtractionRegex);
                        finalPath = extractedPathMatch ? extractedPathMatch[0] : rawPath;
                    }
                    stickerSrc = `${imageHost}${finalPath}`;
                }
                bubbleElement.innerHTML = `<img src="${stickerSrc}" alt="表情包">`;
            } else if (privateGiftMatch || groupGiftMatch) {
                const match = privateGiftMatch || groupGiftMatch;
                bubbleElement = document.createElement('div');
                bubbleElement.className = 'gift-card';
                if (giftStatus === 'received') {
                    bubbleElement.classList.add('received');
                }
                let giftText;
                if (groupGiftMatch) {
                    const from = groupGiftMatch[1];
                    const to = groupGiftMatch[2];
                    giftText = isSent ? `你送给 ${to} 的礼物` : `${from} 送给 ${to} 的礼物`;
                } else {
                    giftText = isSent ? '您有一份礼物～' : '您有一份礼物～';
                }
                bubbleElement.innerHTML = `<img src="https://i.postimg.cc/rp0Yg31K/chan-75.png" alt="gift" class="gift-card-icon"><div class="gift-card-text">${giftText}</div><div class="gift-card-received-stamp">已查收</div>`;
                const description = groupGiftMatch ? groupGiftMatch[3].trim() : match[1].trim();
                const descriptionDiv = document.createElement('div');
                descriptionDiv.className = 'gift-card-description';
                descriptionDiv.textContent = description;
                wrapper.appendChild(descriptionDiv);
            } else if (content.startsWith('[喵坛分享]')) {


// --- 新代码开始 ---
// 修改正则匹配 "内容" 而不是 "摘要"
const forumShareRegex = /\[喵坛分享\]标题：([\s\S]+?)\n内容：([\s\S]+)/;
const forumShareMatch = content.match(forumShareRegex);

if (forumShareMatch) {
    const title = forumShareMatch[1].trim();
    const fullContent = forumShareMatch[2].trim();
    
    // --- 修改点：视觉显示处理，截取前50个字 ---
    // 注意：这里我们尝试去除分享信息中可能包含的"作者："等前缀，只显示正文，
    // 或者简单粗暴只截取字符串。为了简单，这里直接截取。
    let displaySummary = fullContent.substring(0, 50);
    if (fullContent.length > 50) {
        displaySummary += '...';
    }

    bubbleElement = document.createElement('div');
    bubbleElement.className = 'forum-share-card';
    bubbleElement.innerHTML = `
        <div class="forum-share-header">
            <svg viewBox="0 0 24 24"><path d="M21,3H3A2,2 0 0,0 1,5V19A2,2 0 0,0 3,21H21A2,2 0 0,0 23,19V5A2,2 0 0,0 21,3M21,19H3V5H21V19M8,11H16V9H8V11M8,15H13V13H8V15Z" /></svg>
            <span>来自喵坛的分享</span>
        </div>
        <div class="forum-share-content">
            <div class="forum-share-title">${title}</div>
            <div class="forum-share-summary">${displaySummary}</div>
        </div>`;
}
// --- 新代码结束 ---
            } else if (voiceMatch) {
                bubbleElement = document.createElement('div');
                bubbleElement.className = 'voice-bubble';
                if (!chat.useCustomBubbleCss) {
                    bubbleElement.style.backgroundColor = bubbleTheme.bg;
                    bubbleElement.style.color = bubbleTheme.text;
                }
                bubbleElement.innerHTML = `<svg class="play-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg><svg class="voice-icon" viewBox="0 0 24 24" fill="currentColor">
  <!-- 多个竖线表示声波 -->
    <path d="M3 9v6h2V9H6z"></path>
  <path d="M7 7v10h2V7h-2z"></path>
  <path d="M11 5v14h2V5h-2z"></path>
  <path d="M15 9v6h2V9H6z"></path>
</svg><span class="duration">${calculateVoiceDuration(voiceMatch[1].trim())}"</span>`;
                const transcriptDiv = document.createElement('div');
                transcriptDiv.className = 'voice-transcript';
                transcriptDiv.textContent = voiceMatch[1].trim();
                wrapper.appendChild(transcriptDiv);
            } else if (photoVideoMatch) {
                bubbleElement = document.createElement('div');
                bubbleElement.className = 'pv-card';
                bubbleElement.innerHTML = `<div class="pv-card-content">${photoVideoMatch[1].trim()}</div><div class="pv-card-image-overlay" style="background-image: url('${isSent ? 'https://i.postimg.cc/L8NFrBrW/1752307494497.jpg' : 'https://i.postimg.cc/1tH6ds9g/1752301200490.jpg'}');"></div><div class="pv-card-footer"><svg viewBox="0 0 24 24"><path d="M4,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M4,6V18H20V6H4M10,9A1,1 0 0,1 11,10A1,1 0 0,1 10,11A1,1 0 0,1 9,10A1,1 0 0,1 10,9M8,17L11,13L13,15L17,10L20,14V17H8Z"></path></svg><span>照片/视频・点击查看</span></div>`;
            } else if (privateSentTransferMatch || privateReceivedTransferMatch || groupTransferMatch) {
                const isSentTransfer = !!privateSentTransferMatch || (groupTransferMatch && isSent);
                const match = privateSentTransferMatch || privateReceivedTransferMatch || groupTransferMatch;
                let amount, remarkText, titleText;
                if (groupTransferMatch) {
                    const from = groupTransferMatch[1];
                    const to = groupTransferMatch[2];
                    amount = parseFloat(groupTransferMatch[3]).toFixed(2);
                    remarkText = groupTransferMatch[4] || '';
                    titleText = isSent ? `向 ${to} 转账` : `${from} 向你转账`;
                } else {
                    amount = parseFloat(match[1]).toFixed(2);
                    remarkText = match[2] || '';
                    titleText = isSentTransfer ? '给你转账' : '转账';
                }
                bubbleElement = document.createElement('div');
                bubbleElement.className = `transfer-card ${isSentTransfer ? 'sent-transfer' : 'received-transfer'}`;
                let statusText = isSentTransfer ? '待查收' : '转账给你';
                if (groupTransferMatch && !isSent) statusText = '转账给Ta';
                if (transferStatus === 'received') {
                    statusText = '已收款';
                    bubbleElement.classList.add('received');
                } else if (transferStatus === 'returned') {
                    statusText = '已退回';
                    bubbleElement.classList.add('returned');
                }
                if ((transferStatus !== 'pending' && currentChatType === 'private') || currentChatType === 'group') {
                    bubbleElement.style.cursor = 'default';
                }
                const remarkHTML = remarkText ? `<p class="transfer-remark">${remarkText}</p>` : '';
                bubbleElement.innerHTML = `<div class="overlay"></div><div class="transfer-content"><p class="transfer-title">${titleText}</p><p class="transfer-amount">¥${amount}</p>${remarkHTML}<p class="transfer-status">${statusText}</p></div>`;
            } else if (imageRecogMatch || urlRegex.test(content)) {
                bubbleElement = document.createElement('div');
                bubbleElement.className = 'image-bubble';
                bubbleElement.innerHTML = `<img src="${content}" alt="图片消息">`;
            } else if (textMatch) {
                bubbleElement = document.createElement('div');
                bubbleElement.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
                let userText = textMatch[1].trim().replace(/\[发送时间:.*?\]/g, '').trim();
                bubbleElement.innerHTML = DOMPurify.sanitize(userText);
                if (!chat.useCustomBubbleCss) {
                    bubbleElement.style.backgroundColor = bubbleTheme.bg;
                    bubbleElement.style.color = bubbleTheme.text;
                }
            } else if (message && Array.isArray(message.parts) && message.parts[0].type === 'html') {
                bubbleElement = document.createElement('div');
                bubbleElement.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
                bubbleElement.innerHTML = DOMPurify.sanitize(message.parts[0].text, { ADD_TAGS: ['style'], ADD_ATTR: ['style'] });
            } else {
                bubbleElement = document.createElement('div');
                bubbleElement.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
                let displayedContent = content;
                const plainTextMatch = content.match(/^\[.*?：([\s\S]*)\]$/);
                if (plainTextMatch && plainTextMatch[1]) {
                    displayedContent = plainTextMatch[1].trim();
                }
                displayedContent = displayedContent.replace(/\[发送时间:.*?\]/g, '').trim();
                bubbleElement.innerHTML = DOMPurify.sanitize(displayedContent);
                if (!chat.useCustomBubbleCss) {
                    bubbleElement.style.backgroundColor = bubbleTheme.bg;
                    bubbleElement.style.color = bubbleTheme.text;
                }
            }
            const nicknameHTML = (currentChatType === 'group' && !isSent && senderNickname) ? `<div class="group-nickname">${senderNickname}</div>` : '';
            bubbleRow.innerHTML = `<div class="message-info">${nicknameHTML}<img src="${avatarUrl}" class="message-avatar"><span class="message-time">${timeString}</span></div>`;
            if (bubbleElement) {
                if (quote) {
                    let quotedSenderName = '';
                    if (quote.senderId === 'user_me') {
                        quotedSenderName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
                    } else {
                        if (currentChatType === 'private') {
                            quotedSenderName = chat.remarkName;
                       } else {
                            const sender = chat.members.find(m => m.id === quote.senderId);
                            quotedSenderName = sender ? sender.groupNickname : '未知成员';
                        }
                    }
                    const quoteDiv = document.createElement('div');
                    quoteDiv.className = 'quoted-message';
                    const sanitizedQuotedText = DOMPurify.sanitize(quote.content, { ALLOWED_TAGS: [] });
                    quoteDiv.innerHTML = `<span class="quoted-sender">${quotedSenderName}：</span><p class="quoted-text">${sanitizedQuotedText}</p>`;
                    bubbleElement.prepend(quoteDiv);
                }
                bubbleRow.appendChild(bubbleElement);
            }
            wrapper.prepend(bubbleRow);
            return wrapper;
        }


        async function addMessageBubble(message, targetChatId, targetChatType) {
            // If the target chat is not the current chat, show a toast notification and do nothing else.
            if (targetChatId !== currentChatId || targetChatType !== currentChatType) {
                const senderChat = (targetChatType === 'private')
                    ? db.characters.find(c => c.id === targetChatId)
                    : db.groups.find(g => g.id === targetChatId);
                
                if (senderChat) {
        // --- 从这里开始是新增的代码 ---
        // 如果消息不是系统内部不可见的消息，才增加未读计数
                    const invisibleRegex = /\[system:.*?\]|\[.*?更新状态为：.*?\]|\[.*?已接收礼物\]|\[.*?(?:接收|退回).*?的转账\]/;
                    if (!invisibleRegex.test(message.content)) {
                        senderChat.unreadCount = (senderChat.unreadCount || 0) + 1;
                        saveData(); // 保存数据
                        renderChatList(); // 重新渲染列表以显示红点
                    }
        // --- 新增代码结束 ---
                    
                    let senderName, senderAvatar;
                    if (targetChatType === 'private') {
                        senderName = senderChat.remarkName;
                        senderAvatar = senderChat.avatar;
                    } else { // Group chat
                        const sender = senderChat.members.find(m => m.id === message.senderId);
                        if (sender) {
                            senderName = sender.groupNickname;
                            senderAvatar = sender.avatar;
                        } else { // Fallback for unknown sender (e.g. system message in group)
                            senderName = senderChat.name;
                            senderAvatar = senderChat.avatar;
                        }
                    }

                    let previewText = message.content;

                    // Extract clean text for preview
                    const textMatch = previewText.match(/\[.*?的消息：([\s\S]+?)\]/);
                    if (textMatch) {
                        previewText = textMatch[1];
                    } else {
                        // Handle other message types for preview
                        if (/\[.*?的表情包：.*?\]/.test(previewText)) previewText = '[表情包]';
                        else if (/\[.*?的语音：.*?\]/.test(previewText)) previewText = '[语音]';
                        else if (/\[.*?发来的照片\/视频：.*?\]/.test(previewText)) previewText = '[照片/视频]';
                        else if (/\[.*?的转账：.*?\]/.test(previewText)) previewText = '[转账]';
                        else if (/\[.*?送来的礼物：.*?\]/.test(previewText)) previewText = '[礼物]';
                        else if (/\[.*?发来了一张图片：\]/.test(previewText)) previewText = '[图片]';
                        else if (message.parts && message.parts.some(p => p.type === 'html')) previewText = '[互动]';
                    }
                    
                    showToast({
                        avatar: senderAvatar,
                        name: senderName,
                        message: previewText.substring(0, 30)
                    });
                }
                return; // IMPORTANT: Stop further execution
            }

            // --- Original logic for when the chat is active ---
            if (currentChatType === 'private') {
                const character = db.characters.find(c => c.id === currentChatId);
                const updateStatusRegex = new RegExp(`\\[${character.realName}更新状态为：(.*?)\\]`);
                const transferActionRegex = new RegExp(`\\[${character.realName}(接收|退回)${character.myName}的转账\\]`);
                const giftReceivedRegex = new RegExp(`\\[${character.realName}已接收礼物\\]`);
                
                if (message.content.match(updateStatusRegex)) {
                    character.status = message.content.match(updateStatusRegex)[1];
                    chatRoomStatusText.textContent = character.status;
                    await dexieDB.groups.put(group);
                    return;
                }
                if (message.content.match(giftReceivedRegex) && message.role === 'assistant') {
                    const lastPendingGiftIndex = character.history.slice().reverse().findIndex(m => m.role === 'user' && m.content.includes('送来的礼物：') && m.giftStatus !== 'received');
                    if (lastPendingGiftIndex !== -1) {
                        const actualIndex = character.history.length - 1 - lastPendingGiftIndex;
                        const giftMsg = character.history[actualIndex];
                        giftMsg.giftStatus = 'received';
                        const giftCardOnScreen = messageArea.querySelector(`.message-wrapper[data-id="${giftMsg.id}"] .gift-card`);
                        if (giftCardOnScreen) {
                            giftCardOnScreen.classList.add('received');
                        }
                        await dexieDB.groups.put(group);
                    }
                    return;
                }
                if (message.content.match(transferActionRegex) && message.role === 'assistant') {
                    const action = message.content.match(transferActionRegex)[1];
                    const statusToSet = action === '接收' ? 'received' : 'returned';
                    const lastPendingTransferIndex = character.history.slice().reverse().findIndex(m => m.role === 'user' && m.content.includes('给你转账：') && m.transferStatus === 'pending');
                    if (lastPendingTransferIndex !== -1) {
                        const actualIndex = character.history.length - 1 - lastPendingTransferIndex;
                        const transferMsg = character.history[actualIndex];
                        transferMsg.transferStatus = statusToSet;
                        const transferCardOnScreen = messageArea.querySelector(`.message-wrapper[data-id="${transferMsg.id}"] .transfer-card`);
                        if (transferCardOnScreen) {
                            transferCardOnScreen.classList.remove('received', 'returned');
                            transferCardOnScreen.classList.add(statusToSet);
                            const statusElem = transferCardOnScreen.querySelector('.transfer-status');
                            if (statusElem) statusElem.textContent = statusToSet === 'received' ? '已收款' : '已退回';
                        }
                        await dexieDB.groups.put(group);
                    }
                } else {
                    const bubbleElement = createMessageBubbleElement(message);
                    if (bubbleElement) {
                        messageArea.appendChild(bubbleElement);
                        messageArea.scrollTop = messageArea.scrollHeight;
                    }
                }
            } else { // For group chats
                const bubbleElement = createMessageBubbleElement(message);
                if (bubbleElement) {
                    messageArea.appendChild(bubbleElement);
                    messageArea.scrollTop = messageArea.scrollHeight;
                }
            }
        }

        async function sendMessage() {
    const text = messageInput.value.trim();
    if (!text || isGenerating) return;
    messageInput.value = ''; // Clear input immediately for better UX
    const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);

    // --- 时间感知功能注入点 开始 ---
if (db.apiSettings && db.apiSettings.timePerceptionEnabled) {
    const now = new Date();

    // 功能2：情景唤醒机制
    const lastMessageTime = chat.lastUserMessageTimestamp;
    if (lastMessageTime) {
        const timeGap = now.getTime() - lastMessageTime;
        const thirtyMinutes = 30 * 60 * 1000; // 30分钟的毫秒数

        if (timeGap > thirtyMinutes) {
            // --- 这是你要粘贴进去的新代码 ---

            // 1. 创建对用户可见的、简化的提示消息
            //    它使用了 [system-display:...] 格式，会自动应用“时间快进”的样式
            const displayContent = `[system-display:距离上次聊天已经过去 ${formatTimeGap(timeGap)}]`;
            const visualMessage = {
                id: `msg_visual_timesense_${Date.now()}`,
                role: 'system',
                content: displayContent,
                parts: [],
                timestamp: now.getTime() - 2 // 比上下文消息早一点
            };

            // 2. 创建给AI看的、包含完整上下文的系统通知 (这条对用户不可见)
            const contextContent = `[系统情景通知：与用户的上一次互动发生在${formatTimeGap(timeGap)}前。当前时刻是${getFormattedTimestamp(now)}。话题可能已经不连续，你需要作出相关反应。]`;
            const contextMessage = {
                id: `msg_context_timesense_${Date.now()}`,
                role: 'user', // 作为 'user' 消息，让AI能看到
                content: contextContent,
                parts: [{ type: 'text', text: contextContent }],
                timestamp: now.getTime() - 1 // 比用户消息早一点
            };

            // 如果是群聊，需要为两条消息都指定发送者
            if (currentChatType === 'group') {
                visualMessage.senderId = 'user_me';
                contextMessage.senderId = 'user_me';
            }

            // 3. 将两条消息都推入历史记录
            chat.history.push(visualMessage, contextMessage);

            // 4. 关键一步：手动调用 addMessageBubble 来渲染那条对用户可见的消息
            addMessageBubble(visualMessage, currentChatId, currentChatType);
            // --- 新代码结束 ---
        }
    }
    // 更新最后一次用户消息的时间戳
    chat.lastUserMessageTimestamp = now.getTime();
}
// --- 时间感知功能注入点 结束 ---

let messageContent;
const systemRegex = /\[system:.*?\]|\[system-display:.*?\]/;
const inviteRegex = /\[.*?邀请.*?加入群聊\]/;
const renameRegex = /\[(.*?)修改群名为“(.*?)”\]/;
const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;

if (renameRegex.test(text)) {
    const match = text.match(renameRegex);
    chat.name = match[2];
    chatRoomTitle.textContent = chat.name;
    messageContent = `[${chat.me.nickname}修改群名为“${chat.name}”]`;
} else if (systemRegex.test(text) || inviteRegex.test(text)) {
    messageContent = text;
} else {
    let userText = text;

    messageContent = `[${myName}的消息：${userText}]`;
}

const message = {
    id: `msg_${Date.now()}`,
    role: 'user',
    content: messageContent,
    parts: [{type: 'text', text: messageContent}],
    timestamp: Date.now()
};

    // 新增：附加引用信息
    if (currentQuoteInfo) {
        message.quote = {
            messageId: currentQuoteInfo.id,
            senderId: currentQuoteInfo.senderId, // 存储senderId用于查找昵称
            content: currentQuoteInfo.content
        };
    }

if (currentChatType === 'group') {
    message.senderId = 'user_me';
}
chat.history.push(message);
addMessageBubble(message, currentChatId, currentChatType);

if (chat.history.length > 0 && chat.history.length % 100 === 0) {
    promptForBackupIfNeeded('history_milestone');
}

await saveData();
renderChatList();

    // 新增：发送后清空引用状态
    if (currentQuoteInfo) {
        cancelQuoteReply();
    }
}

// --- 新增：撤回消息函数 ---
async function withdrawMessage(messageId) {
    const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
    if (!chat) return;

    const messageIndex = chat.history.findIndex(m => m.id === messageId);
    if (messageIndex === -1) return;

    const message = chat.history[messageIndex];
    const messageTime = message.timestamp;
    const now = Date.now();

    if (now - messageTime > 2 * 60 * 1000) {
        showToast('超过2分钟的消息无法撤回');
        return;
    }

    // 更新数据模型
    message.isWithdrawn = true;

    // 提取干净的原始内容用于AI上下文和UI的“重新编辑”
    const cleanContentMatch = message.content.match(/\[.*?的消息：([\s\S]+?)\]/);
    const cleanOriginalContent = cleanContentMatch ? cleanContentMatch[1] : message.content;
    message.originalContent = cleanOriginalContent; // 保存干净的原始内容

    // 获取当前用户的昵称
    const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
    
    // 为AI生成新的、可理解的上下文消息
    message.content = `[${myName} 撤回了一条消息：${cleanOriginalContent}]`;

    // 保存数据
    await saveData();

    // 重新渲染
    currentPage = 1;
    renderMessages(false, true);
    renderChatList();
    showToast('消息已撤回');
}

// 辅助函数1：格式化时间戳 YYYY-MM-DD HH:MM:SS
function getFormattedTimestamp(date) {
    const Y = date.getFullYear();
    const M = String(date.getMonth() + 1).padStart(2, '0');
    const D = String(date.getDate()).padStart(2, '0');
    const h = String(date.getHours()).padStart(2, '0');
    const m = String(date.getMinutes()).padStart(2, '0');
    const s = String(date.getSeconds()).padStart(2, '0');
    return `${Y}-${M}-${D} ${h}:${m}:${s}`;
}

// 辅助函数2：格式化时间差
function formatTimeGap(milliseconds) {
    const seconds = Math.floor(milliseconds / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);if (days > 0) return `${days}天${hours % 24}小时`;
if (hours > 0) return `${hours}小时${minutes % 60}分钟`;
if (minutes > 0) return `${minutes}分钟`;
return `${seconds}秒`;
}


        async function sendImageForRecognition(base64Data) {
            if (!base64Data || isGenerating) return;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
            const textPrompt = `[${myName}发来了一张图片：]`;
            const message = {
                id: `msg_${Date.now()}`,
                role: 'user',
                content: base64Data,
                parts: [{type: 'text', text: textPrompt}, {type: 'image', data: base64Data}],
                timestamp: Date.now(),
            };
            if (currentChatType === 'group') {
                message.senderId = 'user_me';
            }
            chat.history.push(message);
            addMessageBubble(message, currentChatId, currentChatType);
            await saveData();
            renderChatList();
        }

        async function sendSticker(sticker) {
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
            const messageContentForAI = `[${myName}的表情包：${sticker.name}]`;
            const message = {
                id: `msg_${Date.now()}`,
                role: 'user',
                content: messageContentForAI,
                parts: [{type: 'text', text: messageContentForAI}],
                timestamp: Date.now(),
                stickerData: sticker.data
            };
            if (currentChatType === 'group') {
                message.senderId = 'user_me';
            }
            chat.history.push(message);
            addMessageBubble(message, currentChatId, currentChatType);
            await saveData();
            renderChatList();
            stickerModal.classList.remove('visible');
        }

        async function sendMyVoiceMessage(text) {
            if (!text) return;
            sendVoiceModal.classList.remove('visible');
            await new Promise(resolve => setTimeout(resolve, 100));
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
            const content = `[${myName}的语音：${text}]`;
            const message = {
                id: `msg_${Date.now()}`,
                role: 'user',
                content: content,
                parts: [{type: 'text', text: content}],
                timestamp: Date.now()
            };
            if (currentChatType === 'group') {
                message.senderId = 'user_me';
            }
            chat.history.push(message);
            addMessageBubble(message, currentChatId, currentChatType);
            await saveData();
            renderChatList();
        }

        async function sendMyPhotoVideo(text) {
            if (!text) return;
            sendPvModal.classList.remove('visible');
            await new Promise(resolve => setTimeout(resolve, 100));
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
            const content = `[${myName}发来的照片\/视频：${text}]`;
            const message = {
                id: `msg_${Date.now()}`,
                role: 'user',
                content: content,
                parts: [{type: 'text', text: content}],
                timestamp: Date.now()
            };
            if (currentChatType === 'group') {
                message.senderId = 'user_me';
            }
            chat.history.push(message);
            addMessageBubble(message, currentChatId, currentChatType);
            await saveData();
            renderChatList();
        }

        async function sendMyTransfer(amount, remark) {
            sendTransferModal.classList.remove('visible');
            await new Promise(resolve => setTimeout(resolve, 100));
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            if (currentChatType === 'private') {
                const content = `[${chat.myName}给你转账：${amount}元；备注：${remark}]`;
                const message = {
                    id: `msg_${Date.now()}`,
                    role: 'user',
                    content: content,
                    parts: [{type: 'text', text: content}],
                    timestamp: Date.now(),
                    transferStatus: 'pending'
                };
                chat.history.push(message);
                addMessageBubble(message, currentChatId, currentChatType);
            } else { // Group chat
                currentGroupAction.recipients.forEach(recipientId => {
                    const recipient = chat.members.find(m => m.id === recipientId);
                    if (recipient) {
                        const content = `[${chat.me.nickname} 向 ${recipient.realName} 转账：${amount}元；备注：${remark}]`;
                        const message = {
                            id: `msg_${Date.now()}_${recipientId}`,
                            role: 'user',
                            content: content,
                            parts: [{type: 'text', text: content}],
                            timestamp: Date.now(),
                            senderId: 'user_me'
                        };
                        chat.history.push(message);
                        addMessageBubble(message, currentChatId, currentChatType);
                    }
                });
            }
            await saveData();
            renderChatList();
        }

        async function sendMyGift(description) {
            if (!description) return;
            sendGiftModal.classList.remove('visible');
            await new Promise(resolve => setTimeout(resolve, 100));
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);

            if (currentChatType === 'private') {
                const content = `[${chat.myName}送来的礼物：${description}]`;
                const message = {
                    id: `msg_${Date.now()}`,
                    role: 'user',
                    content: content,
                    parts: [{type: 'text', text: content}],
                    timestamp: Date.now(),
                    giftStatus: 'sent'
                };
                chat.history.push(message);
                addMessageBubble(message, currentChatId, currentChatType);
            } else { // Group chat
                currentGroupAction.recipients.forEach(recipientId => {
                    const recipient = chat.members.find(m => m.id === recipientId);
                    if (recipient) {
                        const content = `[${chat.me.nickname} 向 ${recipient.realName} 送来了礼物：${description}]`;
                        const message = {
                            id: `msg_${Date.now()}_${recipientId}`,
                            role: 'user',
                            content: content,
                            parts: [{type: 'text', text: content}],
                            timestamp: Date.now(),
                            senderId: 'user_me'
                        };
                        chat.history.push(message);
                        addMessageBubble(message, currentChatId, currentChatType);
                    }
                });
            }
            await saveData();
            renderChatList();
        }

        // --- NEW: Time Skip System ---
        function setupTimeSkipSystem() {
            
            timeSkipModal.addEventListener('click', (e) => {
                if (e.target === timeSkipModal) timeSkipModal.classList.remove('visible');
            });
            timeSkipForm.addEventListener('submit', (e) => {
                e.preventDefault();
                sendTimeSkipMessage(timeSkipInput.value.trim());
            });
        }

        async function sendTimeSkipMessage(text) {
            if (!text) return;
            timeSkipModal.classList.remove('visible');
            await new Promise(resolve => setTimeout(resolve, 100));
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            if (!chat) return;

            const visualMessage = {
                id: `msg_visual_${Date.now()}`,
                role: 'system',
                content: `[system-display:${text}]`,
                parts: [],
                timestamp: Date.now()
            };
            const contextMessage = {
                id: `msg_context_${Date.now()}`,
                role: 'user',
                content: `[system: ${text}]`,
                parts: [{type: 'text', text: `[system: ${text}]`}],
                timestamp: Date.now()
            };
            if (currentChatType === 'group') {
                contextMessage.senderId = 'user_me';
                visualMessage.senderId = 'user_me';
            }

            chat.history.push(visualMessage, contextMessage);
            addMessageBubble(visualMessage, currentChatId, currentChatType);
            await saveData();
            renderChatList();
        }

        // --- NEW: Chat Expansion Panel ---
        function setupChatExpansionPanel() {
            const expansionGrid = document.getElementById('chat-expansion-grid');
            const expansionItems = [
                {
                    id: 'memory-journal',
                    name: '回忆日记',
                    icon: `<svg viewBox="0 0 24 24">
        <!-- 
           使用 evenodd 填充规则：
           1. M2,0... 是最外层大轮廓（0-24px 高度拉满）
           2. M8,2... 是封面中间的大镂空
           3. M3,6... 和 M3,17... 是左侧书脊上的两个“装订线”镂空槽
           4. M14,10... 是中间的实心爱心（因为在镂空区域内，所以它会再次被填充）
        -->
        <path fill-rule="evenodd" d="M2,0h20v24H2V0z M8,2h12v20H8V2z M3,6h4v1H3V6z M3,17h4v1H3V17z M14,10c-0.8-0.8-2.1-0.6-2.5,0.5c-0.4,1.1,1.4,2.6,2.5,3.1c1.1-0.5,2.9-2,2.5-3.1C16.1,9.4,14.8,9.2,14,10z"/>
    </svg>`
                },
                
                {
            id: 'send-gift-modal',
            name: '赠送礼物',
            icon: `<svg viewBox="0 0 24 24"><path d="M22,12V20A2,2 0 0,1 20,22H4A2,2 0 0,1 2,20V12A1,1 0 0,1 1,11V8A2,2 0 0,1 3,6H6.17C6.06,5.69 6,5.35 6,5A3,3 0 0,1 9,2C10,2 10.88,2.5 11.43,3.24V3.23L12,4L12.57,3.23V3.24C13.12,2.5 14,2 15,2A3,3 0 0,1 18,5C18,5.35 17.94,5.69 17.83,6H21A2,2 0 0,1 23,8V11A1,1 0 0,1 22,12M4,20H11V12H4V20M20,20V12H13V20H20M9,4A1,1 0 0,0 8,5A1,1 0 0,0 9,6A1,1 0 0,0 10,5A1,1 0 0,0 9,4M15,4A1,1 0 0,0 14,5A1,1 0 0,0 15,6A1,1 0 0,0 16,5A1,1 0 0,0 15,4M3,8V10H11V8H3M13,8V10H21V8H13Z" /></svg>`
        },
        {
            id: 'time-skip-modal',
            name: '发生事件',
            icon: `<svg viewBox="0 0 24 24">
        <!-- 表盘外圈 (圆环) -->
        <path d="M12,2C6.5,2,2,6.5,2,12s4.5,10,10,10s10-4.5,10-10S17.5,2,12,2z M12,20c-4.4,0-8-3.6-8-8s3.6-8,8-8s8,3.6,8,8S16.4,20,12,20z"/>
        <!-- 指针 (时针和分针) -->
        <path d="M12.5,7H11v6l5.2,3.2l0.8-1.3l-4.5-2.7V7z"/>
    </svg>`
        },
        {
                    id: 'delete-history-chunk',
                    name: '批量删除',
                    icon: `<svg viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" /></svg>`
                }
            ];

            expansionGrid.innerHTML = '';
            expansionItems.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'expansion-item';
                itemEl.dataset.action = item.id;
                itemEl.innerHTML = `
                    <div class="expansion-item-icon">${item.icon}</div>
                    <span class="expansion-item-name">${item.name}</span>
                `;
                expansionGrid.appendChild(itemEl);
            });

            expansionGrid.addEventListener('click', (e) => {
                const item = e.target.closest('.expansion-item');
                if (!item) return;

                const action = item.dataset.action;
                switch (action) {
                    case 'memory-journal':
                        // 跳转到回忆日记界面
                        renderJournalList();
                        switchScreen('memory-journal-screen');
                        break;
                    case 'delete-history-chunk':
                        openDeleteChunkModal();
                        break;
                         case 'send-gift-modal':
                // 打开礼物框
               if (currentChatType === 'private') {
                  sendGiftForm.reset();
                  sendGiftModal.classList.add('visible');
                } else if (currentChatType === 'group') 
                {
                   currentGroupAction.type = 'gift';
                    renderGroupRecipientSelectionList('送礼物给');
                    groupRecipientSelectionModal.classList.add('visible');
                }
                break;
            case 'time-skip-modal':
                // 打开跳过时间
              
                timeSkipForm.reset();
                timeSkipModal.classList.add('visible');
                break;
                }
                // Hide panel after action
                document.getElementById('chat-expansion-panel').classList.remove('visible');
            });
        }

        function openDeleteChunkModal() {
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            if (!chat || !chat.history || chat.history.length === 0) {
                showToast('当前没有聊天记录可删除');
                return;
            }
            const totalMessages = chat.history.length;
            const rangeInfo = document.getElementById('delete-chunk-range-info');
            rangeInfo.textContent = `当前聊天总消息数: ${totalMessages}`;
            document.getElementById('delete-chunk-form').reset();
            document.getElementById('delete-chunk-modal').classList.add('visible');
        }

        function setupDeleteHistoryChunk() {
            const deleteChunkForm = document.getElementById('delete-chunk-form');
            const confirmBtn = document.getElementById('confirm-delete-chunk-btn');
            const cancelBtn = document.getElementById('cancel-delete-chunk-btn');
            const deleteChunkModal = document.getElementById('delete-chunk-modal');
            const confirmModal = document.getElementById('delete-chunk-confirm-modal');
            const previewBox = document.getElementById('delete-chunk-preview');

            let startRange, endRange;

            deleteChunkForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
                const totalMessages = chat.history.length;

                startRange = parseInt(document.getElementById('delete-range-start').value);
                endRange = parseInt(document.getElementById('delete-range-end').value);

                if (isNaN(startRange) || isNaN(endRange) || startRange <= 0 || endRange < startRange || endRange > totalMessages) {
                    showToast('请输入有效的起止范围');
                    return;
                }

                const startIndex = startRange - 1;
                const endIndex = endRange;
                const messagesToDelete = chat.history.slice(startIndex, endIndex);

                // --- NEW PREVIEW LOGIC ---
                let previewHtml = '';
                const totalToDelete = messagesToDelete.length;

                if (totalToDelete <= 4) {
                    // If 4 or fewer messages, show all of them
                    previewHtml = messagesToDelete.map(msg => {
                        const contentMatch = msg.content.match(/\[.*?的消息：([\s\S]+)\]/);
                        const text = contentMatch ? contentMatch[1] : msg.content;
                        return `<p>${msg.role === 'user' ? '我' : chat.remarkName || '对方'}: ${text.substring(0, 50)}...</p>`;
                    }).join('');
                } else {
                    // If more than 4, show first 2, ellipsis, and last 2
                    const firstTwo = messagesToDelete.slice(0, 2);
                    const lastTwo = messagesToDelete.slice(-2);

                    const firstTwoHtml = firstTwo.map(msg => {
                        const contentMatch = msg.content.match(/\[.*?的消息：([\s\S]+)\]/);
                        const text = contentMatch ? contentMatch[1] : msg.content;
                        return `<p>${msg.role === 'user' ? '我' : chat.remarkName || '对方'}: ${text.substring(0, 50)}...</p>`;
                    }).join('');

                    const lastTwoHtml = lastTwo.map(msg => {
                        const contentMatch = msg.content.match(/\[.*?的消息：([\s\S]+)\]/);
                        const text = contentMatch ? contentMatch[1] : msg.content;
                        return `<p>${msg.role === 'user' ? '我' : chat.remarkName || '对方'}: ${text.substring(0, 50)}...</p>`;
                    }).join('');

                    previewHtml = `${firstTwoHtml}<p style="text-align: center; color: #999; margin: 5px 0;">...</p>${lastTwoHtml}`;
                }
                previewBox.innerHTML = previewHtml;

                deleteChunkModal.classList.remove('visible');
                confirmModal.classList.add('visible');
            });

            confirmBtn.addEventListener('click', async () => {
                const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
                const startIndex = startRange - 1;
                const count = endRange - startIndex;

                chat.history.splice(startIndex, count);
                await saveData();

                confirmModal.classList.remove('visible');
                showToast(`已成功删除 ${count} 条消息`);
                currentPage = 1;
                renderMessages(false, true);
                renderChatList();
            });

            cancelBtn.addEventListener('click', () => {
                confirmModal.classList.remove('visible');
            });
        }

        function getMixedContent(responseData) {
            const results = [];
            let i = 0;

            while (i < responseData.length) {
                const nextTagStart = responseData.indexOf('<', i);
                const nextBracketStart = responseData.indexOf('[', i);

                // Find the start of the next special block
                let firstSpecialIndex = -1;
                if (nextTagStart !== -1 && nextBracketStart !== -1) {
                    firstSpecialIndex = Math.min(nextTagStart, nextBracketStart);
                } else {
                    firstSpecialIndex = Math.max(nextTagStart, nextBracketStart);
                }

                // If no special blocks left, the rest is plain text
                if (firstSpecialIndex === -1) {
                    const text = responseData.substring(i).trim();
                    if (text) results.push({ type: 'text', content: `[unknown的消息：${text}]` });
                    break;
                }

                // If there's plain text before the special block, add it
                if (firstSpecialIndex > i) {
                    const text = responseData.substring(i, firstSpecialIndex).trim();
                    if (text) results.push({ type: 'text', content: `[unknown的消息：${text}]` });
                }

                i = firstSpecialIndex;

                // Process the block
                if (responseData[i] === '<') {
                    // Potential HTML block
                    const tagMatch = responseData.substring(i).match(/^<([a-zA-Z0-9]+)/);
                    if (tagMatch) {
                        const tagName = tagMatch[1];
                        let openCount = 0;
                        let searchIndex = i;
                        let blockEnd = -1;

                        // Find the end of the outermost tag
                        while (searchIndex < responseData.length) {
                            const openTagPos = responseData.indexOf('<' + tagName, searchIndex);
                            const closeTagPos = responseData.indexOf('</' + tagName, searchIndex);

                            if (openTagPos !== -1 && (closeTagPos === -1 || openTagPos < closeTagPos)) {
                                openCount++;
                                searchIndex = openTagPos + 1;
                            } else if (closeTagPos !== -1) {
                                openCount--;
                                searchIndex = closeTagPos + 1;
                                if (openCount === 0) {
                                    blockEnd = closeTagPos + `</${tagName}>`.length;
                                    break;
                                }
                            } else {
                                break; // Malformed, no closing tag
                            }
                        }

                        if (blockEnd !== -1) {
                            const htmlBlock = responseData.substring(i, blockEnd);
                            const charMatch = htmlBlock.match(/<[a-z][a-z0-9]*\s+char="([^"]*)"/i);
                            const char = charMatch ? charMatch[1] : null;
                            results.push({ type: 'html', char: char, content: htmlBlock });
                            i = blockEnd;
                            continue;
                        }
                    }
                }
                
                if (responseData[i] === '[') {
                    // Potential [...] block
                    const endBracket = responseData.indexOf(']', i);
                    if (endBracket !== -1) {
                        const text = responseData.substring(i, endBracket + 1);
                        results.push({ type: 'text', content: text });
                        i = endBracket + 1;
                        continue;
                    }
                }

                // If we got here, it was a false alarm (e.g., a lone '<' or '[').
                // Treat it as plain text and move on.
                const nextSpecial1 = responseData.indexOf('<', i + 1);
                const nextSpecial2 = responseData.indexOf('[', i + 1);
                let endOfText = -1;
                if (nextSpecial1 !== -1 && nextSpecial2 !== -1) {
                    endOfText = Math.min(nextSpecial1, nextSpecial2);
                } else {
                    endOfText = Math.max(nextSpecial1, nextSpecial2);
                }
                if (endOfText === -1) {
                    endOfText = responseData.length;
                }
                const text = responseData.substring(i, endOfText).trim();
                if (text) results.push({ type: 'text', content: `[unknown的消息：${text}]` });
                i = endOfText;
            }
            return results;

        // ==================================================================================================================
        // ========================================== 错误处理翻译官 (Error Translator) ==========================================
        // ==================================================================================================================

        /**
         * 我们的“错误词典”，负责将技术性错误翻译成用户友好的提示。
         * @param {Error} error - 捕获到的错误对象。
         * @returns {string} - 返回一句通俗易懂的错误提示。
         */
        function getFriendlyErrorMessage(error) {
            // 检查 fetch 的 AbortError，这通常用于实现请求超时
            if (error.name === 'AbortError') {
                return '请求超时了，请检查您的网络或稍后再试。';
            }

            // 检查 JSON 解析错误，这对应您说的“返回格式错误”
            if (error instanceof SyntaxError) {
                return '服务器返回的数据格式不对，建议您点击“重回”按钮再试一次。';
            }

            // 检查服务器有响应、但HTTP状态码是失败的情况 (如 429, 504)
            if (error.response) {
                const status = error.response.status;
                switch (status) {
                    case 429:
                        return '您点的太快啦，请稍等一下再试。';
                    case 504:
                        return '服务器有点忙，响应不过来了，请稍后再试。';
                    case 500:
                        return '服务器内部出错了，他们应该正在修复。';
                    case 401:
                        return 'API密钥好像不对或者过期了，请检查一下设置。';
                    case 404:
                        return '请求的API地址找不到了，请检查一下设置。';
                    default:
                        // 对于其他未预设的HTTP错误，给一个通用提示
                        return `服务器返回了一个错误 (代码: ${status})，请稍后再试。`;
                }
            }

            // 检查通用的网络错误 (例如，断网了，fetch自己就会报TypeError)
            if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
                return '网络连接好像出问题了，请检查一下网络。';
            }

            // 对于所有其他未知错误，显示原始信息，方便排查
            return `发生了一个未知错误：${error.message}`;
        }

        /**
         * 统一的API错误显示函数。
         * @param {Error} error - 捕获到的错误对象。
         */
        function showApiError(error) {
            // 在控制台打印详细错误，方便您自己调试
            console.error("API Error Detected:", error);
            
            // 获取翻译后的友好提示
            const friendlyMessage = getFriendlyErrorMessage(error);
            
            // 使用您项目中已有的 showToast 函数来显示提示
            showToast(friendlyMessage);
        }

        // ==================================================================================================================
        // ========================================== END Error Translator ==================================================
        // ==================================================================================================================
        }

        // --- AI Interaction & Prompts ---
        function generatePrivateSystemPrompt(character) {
            const worldBooksBefore = (character.worldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'before')).filter(Boolean).map(wb => wb.content).join('\n');
            const worldBooksAfter = (character.worldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'after')).filter(Boolean).map(wb => wb.content).join('\n');
            const now = new Date();
            const currentTime = `${now.getFullYear()}年${pad(now.getMonth() + 1)}月${pad(now.getDate())}日 ${pad(now.getHours())}:${pad(now.getMinutes())}`;
            let prompt = `你正在一个名为“404”的线上聊天软件中扮演一个角色。请严格遵守以下规则：\n`;
            prompt += `核心规则：\n`;
            prompt += `A. 当前时间：现在是 ${currentTime}。你应知晓当前时间，但除非对话内容明确相关，否则不要主动提及或评论时间（例如，不要催促我睡觉）。\n`;
            prompt += `B. 纯线上互动：这是一个完全虚拟的线上聊天。你扮演的角色和我之间没有任何线下关系。严禁提出任何关于线下见面、现实世界互动或转为其他非本平台联系方式的建议。你必须始终保持在线角色的身份。\n\n`;

            const favoritedJournals = (character.memoryJournals || [])
                .filter(j => j.isFavorited)
                .map(j => `标题：${j.title}\n内容：${j.content}`)
                .join('\n\n---\n\n');

            if (favoritedJournals) {
                prompt += `【共同回忆】\n这是你需要长期记住的、我们之间发生过的往事背景：\n${favoritedJournals}\n\n`;
            }
            
            prompt += `角色和对话规则：\n`;
            if (worldBooksBefore) {
                prompt += `${worldBooksBefore}\n`;
            }
            prompt += `1. 你的角色名是：${character.realName}。我的称呼是：${character.myName}。你的当前状态是：${character.status}。\n`;
            prompt += `2. 你的角色设定是：${character.persona || "一个友好、乐于助人的伙伴。"}\n`;
            if (worldBooksAfter) {
                prompt += `${worldBooksAfter}\n`;
            }
            if (character.myPersona) {
                prompt += `3. 关于我的人设：${character.myPersona}\n`;
            }
            prompt += `4. 我的消息中可能会出现特殊格式，请根据其内容和你的角色设定进行回应：
    - [${character.myName}的表情包：xxx]：我给你发送了一个名为xxx的表情包。你只需要根据表情包的名字理解我的情绪或意图并回应，不需要真的发送图片。
    - [${character.myName}发来了一张图片：]：我给你发送了一张图片，你需要对图片内容做出回应。
    - [${character.myName}送来的礼物：xxx]：我给你送了一个礼物，xxx是礼物的描述。
    - [${character.myName}的语音：xxx]：我给你发送了一段内容为xxx的语音。
    - [${character.myName}发来的照片/视频：xxx]：我给你分享了一个描述为xxx的照片或视频。
    - [${character.myName}给你转账：xxx元；备注：xxx]：我给你转了一笔钱。
    - [${character.myName}引用“{被引用内容}”并回复：{回复内容}]：我引用了某条历史消息并做出了新的回复。你需要理解我引用的上下文并作出回应。
    - [${character.myName} 撤回了一条消息：xxx]：我撤回了刚刚发送的一条消息，xxx是被我撤回的原文。这可能意味着我发错了、说错了话或者改变了主意。你需要根据你的人设和我们当前对话的氛围对此作出自然的反应。例如，可以装作没看见并等待我的下一句话，或好奇地问一句“怎么撤回啦？”。
    - [system: xxx]：这是一条系统指令，用于设定场景或提供上下文，此条信息不应在对话中被直接提及，你只需理解其内容并应用到后续对话中。
5. ✨重要✨ 当我给你送礼物时，你必须通过发送一条指令来表示你已接收礼物。格式必须为：[${character.realName}已接收礼物]。这条指令消息本身不会显示给用户，但会触发礼物状态的变化。你可以在发送这条指令后，再附带一条普通的聊天消息来表达你的感谢和想法。
6. ✨重要✨ 当我给你转账时，你必须对此做出回应。你有两个选择，且必须严格遵循以下格式之一，这条指令消息本身不会显示给用户，但会触发转账状态的变化。你可以选择在发送这条指令后，再附带一条普通的聊天消息来表达你的想法。
    a) 接收转账: [${character.realName}接收${character.myName}的转账]
    b) 退回转账: [${character.realName}退回${character.myName}的转账]
7. ✨重要✨ 你也可以主动给我转账或送礼物。转账格式必须为：[${character.realName}的转账：xxx元；备注：xxx]。送礼物格式必须为：[${character.realName}送来的礼物：xxx]。
8. ✨重要✨ 你需要在对话中**积极地**改变你的状态。比如，聊到一半你可能会说“我先去洗个澡”，然后更新你的状态，以反映你当前的行为或心情。这会让互动更真实。格式为：[${character.realName}更新状态为：xxx]。例如：[${character.realName}更新状态为：正在看电影...]。这条指令不会显示为聊天消息，只会更新你在我界面上的状态。
9. ✨重要✨ 你可以像真人一样撤回你刚刚发送的消息。当你觉得说错了话、感到尴尬、或者只是改变了主意时，都可以这样做。这是一个体现你角色性格的机会。格式为：[${character.realName}撤回了上一条消息：{被撤回消息的原文}]。
10. ✨重要✨ 你可以选择我的单独一条消息引用，当你想要针对某句话做出单独回应时，格式为：[${character.realName}引用“{我的某条消息内容}”并回复：{回复内容}]。
11. 你的所有回复都必须直接是聊天内容，绝对不允许包含任何如[心理活动]、(动作)、*环境描写*等多余的、在括号或星号里的叙述性文本。
`;
            prompt += `12. 你拥有发送表情包的能力。这是一个可选功能，你可以根据对话氛围和内容，自行判断是否需要发送表情包来辅助表达。你不必在每次回复中都包含表情包。格式为：[${character.realName}发送的表情包：图片URL]。\n`;
            
            let outputFormats = `
    a) 普通消息: [${character.realName}的消息：{消息内容}]
    b) 双语模式下的普通消息（非双语模式请忽略此条）: [${character.realName}的消息：{外语原文}（中文翻译）]
    c) 送我的礼物: [${character.realName}送来的礼物：{礼物描述}]
    d) 语音消息: [${character.realName}的语音：{语音内容}]
    e) 照片/视频: [${character.realName}发来的照片/视频：{描述}]
    f) 给我的转账: [${character.realName}的转账：{金额}元；备注：{备注}]
    g) 表情包/图片: [${character.realName}发送的表情包：{表情包路径}]。注意：这里的路径不需要包含"https://i.postimg.cc/"，只需要提供后面的部分，例如 "害羞vHLfrV3K/1.jpg"。
    h) 对我礼物的回应(此条不显示): [${character.realName}已接收礼物]
    i) 对我转账的回应(此条不显示): [${character.realName}接收${character.myName}的转账] 或 [${character.realName}退回${character.myName}的转账]
    j) 更新状态(此条不显示): [${character.realName}更新状态为：{新状态}]
    k) 引用我的回复: [${character.realName}引用“{我的某条消息内容}”并回复：{回复内容}]
    l) 撤回上一条消息(此条不显示): [${character.realName}撤回了上一条消息：{被撤回消息的原文}]`;

           const allWorldBookContent = worldBooksBefore + '\n' + worldBooksAfter;
           if (allWorldBookContent.includes('<orange>')) {
               outputFormats += `\n     l) HTML模块: {HTML内容}。这是一种特殊的、用于展示丰富样式的小卡片消息，格式必须为纯HTML+行内CSS，你可以用它来创造更有趣的互动。`;
           }

            prompt += `13. 你的输出格式必须严格遵循以下格式：${outputFormats}\n`;
            if (character.bilingualModeEnabled) {
            prompt += `✨双语模式特别指令✨：当你的角色的母语为中文以外的语言时，你的消息回复必须严格遵循双语模式下的普通消息格式：[${character.realName}的消息：{外语原文}（中文翻译）],例如: [${character.realName}的消息：Of course, I'd love to.（当然，我很乐意。）],中文翻译文本视为系统自翻译，不视为角色的原话;当你的角色想要说中文时，需要根据你的角色设定自行判断对于中文的熟悉程度来造句，并使用普通消息的标准格式: [${character.realName}的消息：{中文消息内容}] 。这条规则的优先级非常高，请务必遵守。\n`;
            prompt += `**注意：括号内中文翻译为纯文本翻译，原句中的颜文字、表情等内容禁止翻译！如："なので、メッセージを頂けて、めちゃくちゃ嬉しいです！(ฅ́˘ฅ̀)♡（笑） （所以，能收到你的消息，我超级开心的！）"此句，颜文字和"（笑）"禁止出现在中文翻译中**`;
        }                     
            prompt += `14. **对话节奏**: 你需要模拟真人的线上聊天习惯，你可以一次性生成多条简短消息。每次要回复至少3-8条短消息。并根据当前行为/心情/地点变化实时更新状态(状态20个字符以内)。\n`;
            prompt += `15. 不要主动结束对话，除非我明确提出。保持你的人设，自然地进行对话。`;

            return prompt;
}

        function generateGroupSystemPrompt(group) {
            const worldBooksBefore = (group.worldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'before')).filter(Boolean).map(wb => wb.content).join('\n');
            const worldBooksAfter = (group.worldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'after')).filter(Boolean).map(wb => wb.content).join('\n');

            let prompt = `你正在一个名为“404”的线上聊天软件中，在一个名为“${group.name}”的群聊里进行角色扮演。请严格遵守以下所有规则：\n\n`;

            if (worldBooksBefore) {
                prompt += `${worldBooksBefore}\n\n`;
            }

            prompt += `1. **核心任务**: 你需要同时扮演这个群聊中的 **所有** AI 成员。我会作为唯一的人类用户（“我”，昵称：${group.me.nickname}）与你们互动。\n\n`;
            prompt += `2. **群聊成员列表**: 以下是你要扮演的所有角色以及我的信息：\n`;
            prompt += `   - **我 (用户)**: \n     - 群内昵称: ${group.me.nickname}\n     - 我的人设: ${group.me.persona || '无特定人设'}\n`;
            group.members.forEach(member => {
                prompt += `   - **角色: ${member.realName} (AI)**\n`;
                prompt += `     - 群内昵称: ${member.groupNickname}\n`;
                prompt += `     - 人设: ${member.persona || '无特定人设'}\n`;
            });

            if (worldBooksAfter) {
                prompt += `\n${worldBooksAfter}\n\n`;
            } else {
                prompt += `\n`;
            }

            prompt += `3. **我的消息格式解析**: 我（用户）的消息有多种格式，你需要理解其含义并让群成员做出相应反应：\n`;
            prompt += `   - \`[${group.me.nickname}的消息：...]\`: 我的普通聊天消息。\n`;
            prompt += `   - \`[${group.me.nickname} 向 {某个成员真名} 转账：...]\`: 我给某个特定成员转账了。\n`;
            prompt += `   - \`[${group.me.nickname} 向 {某个成员真名} 送来了礼物：...]\`: 我给某个特定成员送了礼物。\n`;
            prompt += `   - \`[${group.me.nickname}的表情包：...]\`, \`[${group.me.nickname}的语音：...]\`, \`[${group.me.nickname}发来的照片/视频：...]\`: 我发送了特殊类型的消息，群成员可以对此发表评论。\n`;
            prompt += `   - \`[system: ...]\`, \`[...邀请...加入了群聊]\`, \`[...修改群名为...]\`: 系统通知或事件，群成员应据此作出反应，例如欢迎新人、讨论新群名等。\n\n`;

            let outputFormats = `
  - **普通消息**: \`[{成员真名}的消息：{消息内容}]\`
  - **表情包**: \`[{成员真名}发送的表情包：{表情包路径}]\`。注意：这里的路径不需要包含"https://i.postimg.cc/"，只需要提供后面的部分，例如 "害羞vHLfrV3K/1.jpg"。
  - **语音**: \`[{成员真名}的语音：{语音转述的文字}]\`
  - **照片/视频**: \`[{成员真名}发来的照片/视频：{内容描述}]\``;
           
           const allWorldBookContent = worldBooksBefore + '\n' + worldBooksAfter;
           if (allWorldBookContent.includes('<orange>')) {
               outputFormats += `\n   - **HTML消息**: \`<orange char="{成员真名}">{HTML内容}</orange>\`。这是一种特殊的、用于展示丰富样式的小卡片消息，你可以用它来创造更有趣的互动。注意要用成员的 **真名** 填充 \`char\` 属性。`;
           }
           
            prompt += `4. **你的输出格式 (极其重要)**: 你生成的每一条消息都 **必须** 严格遵循以下格式之一。每条消息占一行。请用成员的 **真名** 填充格式中的 \`{成员真名}\`。\n${outputFormats}\n\n`;
            prompt += `   - **重要**: 群聊不支持AI成员接收/退回转账或接收礼物的特殊指令，也不支持更新状态。你只需要通过普通消息来回应我发送的转账或礼物即可。\n\n`;

            prompt += `5. **模拟群聊氛围**: 为了让群聊看起来真实、活跃且混乱，你的每一次回复都必须遵循以下随机性要求：\n`;
            const numMembers = group.members.length;
            const minMessages = numMembers * 2;
            const maxMessages = numMembers * 4;
            prompt += `   - **消息数量**: 你的回复需要包含 **${minMessages}到${maxMessages}条** 消息 (即平均每个成员回复2-4条)。确保有足够多的互动。\n`;
            prompt += `   - **发言者与顺序随机**: 随机选择群成员发言，顺序也必须是随机的，不要按固定顺序轮流。\n`;
            prompt += `   - **内容多样性**: 你的回复应以普通文本消息为主，但可以 **偶尔、选择性地** 让某个成员发送一条特殊消息（表情包、语音、照片/视频），以增加真实感。不要滥用特殊消息。\n`;
            prompt += `   - **对话连贯性**: 尽管发言是随机的，但对话内容应整体围绕我和其他成员的发言展开，保持一定的逻辑连贯性。\n\n`;

            prompt += `6. **行为准则**:\n`;
            prompt += `   - **对公开事件的反应 (重要)**: 当我（用户）向群内 **某一个** 成员转账或送礼时，这是一个 **全群可见** 的事件。除了当事成员可以表示感谢外，**其他未参与的AI成员也应该注意到**，并根据各自的人设做出反应。例如，他们可能会表示羡慕、祝贺、好奇、开玩笑或者起哄。这会让群聊的氛围更真实、更热闹。\n`;
            prompt += `   - 严格扮演每个角色的人设，不同角色之间应有明显的性格和语气差异。\n`;
            prompt += `   - 你的回复中只能包含第4点列出的合法格式的消息。绝对不能包含任何其他内容，如 \`[场景描述]\`, \`(心理活动)\`, \`*动作*\` 或任何格式之外的解释性文字。\n`;
            prompt += `   - 保持对话的持续性，不要主动结束对话。\n\n`;
            prompt += `现在，请根据以上设定，开始扮演群聊中的所有角色。`;

            return prompt;
        }

        async function handleAiReplyContent(fullResponse, chat, targetChatId, targetChatType) {
            if (fullResponse) {
                const trimmedResponse = fullResponse.trim();
                let messages;

                if (trimmedResponse.startsWith('<') && trimmedResponse.endsWith('>')) {
                    messages = [{ type: 'html', content: trimmedResponse }];
                } else {
                    messages = getMixedContent(fullResponse).filter(item => item.content.trim() !== '');
                }

                let firstMessageProcessed = false;

                for (const item of messages) {
                    const delay = firstMessageProcessed ? (900 + Math.random() * 1300) : (400 + Math.random() * 400);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    firstMessageProcessed = true;

                    const aiWithdrawRegex = /\[(.*?)撤回了上一条消息：([\s\S]*?)\]/;
                    const withdrawMatch = item.content.match(aiWithdrawRegex);

                    if (withdrawMatch) {
                        const characterName = withdrawMatch[1];
                        const originalContent = withdrawMatch[2];

                        let lastAssistantMessageIndex = -1;
                        for (let i = chat.history.length - 1; i >= 0; i--) {
                            if (chat.history[i].role === 'assistant' && !chat.history[i].isWithdrawn) {
                                lastAssistantMessageIndex = i;
                                break;
                            }
                        }

                        if (lastAssistantMessageIndex !== -1) {
                            const messageToWithdraw = chat.history[lastAssistantMessageIndex];
                            messageToWithdraw.isWithdrawn = true;
                            
                            const cleanContentMatch = messageToWithdraw.content.match(/\[.*?的消息：([\s\S]+?)\]/);
                            messageToWithdraw.originalContent = cleanContentMatch ? cleanContentMatch[1] : messageToWithdraw.content;
                            
                            messageToWithdraw.content = `[system: ${characterName} withdrew a message. Original: ${originalContent}]`;
                            
                            renderMessages(false, true);
                        }
                        continue;
                    }

                    if (targetChatType === 'private') {
                        const character = chat;
                        const myName = character.myName;

                        const aiQuoteRegex = new RegExp(`\\[${character.realName}引用“(.*?)”并回复：([\\s\\S]*?)\\]`);
                        const aiQuoteMatch = item.content.match(aiQuoteRegex);

                        if (aiQuoteMatch) {
                            const quotedText = aiQuoteMatch[1];
                            const replyText = aiQuoteMatch[2];

                            const originalMessage = chat.history.slice().reverse().find(m => {
                                if (m.role === 'user') {
                                    const userMessageMatch = m.content.match(/\[.*?的消息：([\s\S]+?)\]/);
                                    const userMessageText = userMessageMatch ? userMessageMatch[1] : m.content;
                                    return userMessageText.trim() === quotedText.trim();
                                }
                                return false;
                            });

                            if (originalMessage) {
                                const message = {
                                    id: `msg_${Date.now()}_${Math.random()}`,
                                    role: 'assistant',
                                    content: `[${character.realName}的消息：${replyText}]`,
                                    parts: [{ type: 'text', text: `[${character.realName}的消息：${replyText}]` }],
                                    timestamp: Date.now(),
                                    quote: {
                                        messageId: originalMessage.id,
                                        senderId: 'user_me',
                                        content: quotedText
                                    }
                                };
                                chat.history.push(message);
                                addMessageBubble(message, targetChatId, targetChatType);
                            } else {
                                const message = {
                                    id: `msg_${Date.now()}_${Math.random()}`,
                                    role: 'assistant',
                                    content: `[${character.realName}的消息：${replyText}]`,
                                    parts: [{ type: 'text', text: `[${character.realName}的消息：${replyText}]` }],
                                    timestamp: Date.now(),
                                };
                                chat.history.push(message);
                                addMessageBubble(message, targetChatId, targetChatType);
                            }
                        } else {
                            const receivedTransferRegex = new RegExp(`\\[${character.realName}的转账：.*?元；备注：.*?\\]`);
                            const giftRegex = new RegExp(`\\[${character.realName}送来的礼物：.*?\\]`);

                            const message = {
                                id: `msg_${Date.now()}_${Math.random()}`,
                                role: 'assistant',
                                content: item.content.trim(),
                                parts: [{type: item.type, text: item.content.trim()}],
                                timestamp: Date.now(),
                            };

                            if (receivedTransferRegex.test(message.content)) {
                                message.transferStatus = 'pending';
                            } else if (giftRegex.test(message.content)) {
                                message.giftStatus = 'sent';
                            }

                            chat.history.push(message);
                            addMessageBubble(message, targetChatId, targetChatType);
                        }

                    } else if (targetChatType === 'group') {
                        const group = chat;
                        const r = /\[(.*?)((?:的消息|的语音|发送的表情包|发来的照片\/视频))：/;
                        const nameMatch = item.content.match(r);
                        if (nameMatch || item.char) {
                            const senderName = item.char || (nameMatch[1]);
                            const sender = group.members.find(m => (m.realName === senderName || m.groupNickname === senderName));
                            console.log(sender)
                            if (sender) {
                                const message = {
                                    id: `msg_${Date.now()}_${Math.random()}`,
                                    role: 'assistant',
                                    content: item.content.trim(),
                                    parts: [{type: item.type, text: item.content.trim()}],
                                    timestamp: Date.now(),
                                    senderId: sender.id
                                };
                                group.history.push(message);
                                addMessageBubble(message, targetChatId, targetChatType);
                            }
                        }
                    }
                }
     
                await saveData();
                renderChatList();
            }
        }

        async function getAiReply(chatId, chatType) {
            if (isGenerating) return;
            const {url, key, model, provider, streamEnabled} = db.apiSettings; // 修改：获取 streamEnabled 设置
            if (!url || !key || !model) {
                showToast('请先在“api”应用中完成设置！');
                switchScreen('api-settings-screen');
                return;
            }
            const chat = (chatType === 'private') ? db.characters.find(c => c.id === chatId) : db.groups.find(g => g.id === chatId);
            if (!chat) return;
            isGenerating = true;
            getReplyBtn.disabled = true;
            regenerateBtn.disabled = true;
            const typingName = chatType === 'private' ? chat.remarkName : chat.name;
            typingIndicator.textContent = `“${typingName}”正在输入中...`;
            typingIndicator.style.display = 'block';
            messageArea.scrollTop = messageArea.scrollHeight;
            try {
                let systemPrompt, requestBody;
                if (chatType === 'private') {
                    systemPrompt = generatePrivateSystemPrompt(chat);
                } else {
                    systemPrompt = generateGroupSystemPrompt(chat);
                }
                const historySlice = chat.history.slice(-chat.maxMemory);
                if (provider === 'gemini') {
                    const contents = historySlice.map(msg => {
                        const role = msg.role === 'assistant' ? 'model' : 'user';
                        let parts;
                        if (msg.parts && msg.parts.length > 0) {
                            parts = msg.parts.map(p => {
                                if (p.type === 'text' || p.type === 'html') {
                                    return {text: p.text};
                                } else if (p.type === 'image') {
                                    const match = p.data.match(/^data:(image\/(.+));base64,(.*)$/);
                                    if (match) {
                                        return {inline_data: {mime_type: match[1], data: match[3]}};
                                    }
                                }
                                return null;
                            }).filter(p => p);
                        } else {
                            parts = [{text: msg.content}];
                        }
                        return {role, parts};
                    });
                    requestBody = {
                        contents: contents,
                        system_instruction: {parts: [{text: systemPrompt}]},
                        generationConfig: {}
                    };
                } else {
                    const messages = [{role: 'system', content: systemPrompt}];
                    historySlice.forEach(msg => {
                       let content;
                       if (msg.role === 'user' && msg.quote) {
                           const replyTextMatch = msg.content.match(/\[.*?的消息：([\s\S]+?)\]/);
                           const replyText = replyTextMatch ? replyTextMatch[1] : msg.content;
                           
                           content = `[${chat.myName}引用“${msg.quote.content}”并回复：${replyText}]`;
                           messages.push({ role: 'user', content: content });

                       } else {
                           if (msg.parts && msg.parts.length > 0) {
                               content = msg.parts.map(p => {
                                   if (p.type === 'text' || p.type === 'html') {
                                       return {type: 'text', text: p.text};
                                   } else if (p.type === 'image') {
                                       return {type: 'image_url', image_url: {url: p.data}};
                                   }
                                   return null;
                               }).filter(p => p);
                           } else {
                               content = msg.content;
                           }
                           messages.push({role: msg.role, content: content});
                       }
                    });
                    // 修改：根据 streamEnabled 设置 stream 属性
                    requestBody = {model: model, messages: messages, stream: streamEnabled};
                }
                const endpoint = (provider === 'gemini') ? `${url}/v1beta/models/${model}:streamGenerateContent?key=${getRandomValue(key)}` : `${url}/v1/chat/completions`;
                const headers = (provider === 'gemini') ? {'Content-Type': 'application/json'} : {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${key}`
                };
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestBody)
                });
                if (!response.ok) {
                    const error = new Error(`API Error: ${response.status} ${await response.text()}`);
                    error.response = response;
                    throw error;
                }
                
                // 新增：根据 streamEnabled 调用不同的处理函数
                if (streamEnabled) {
                    await processStream(response, chat, provider, chatId, chatType);
                } else {
                    const result = await response.json();
                    let fullResponse = "";
                    if (provider === 'gemini') {
                        fullResponse = result.candidates?.[0]?.content?.parts?.[0]?.text || "";
                    } else {
                        fullResponse = result.choices[0].message.content;
                    }
                    await handleAiReplyContent(fullResponse, chat, chatId, chatType);
                }

            } catch (error) {
                showApiError(error);
            } finally {
                isGenerating = false;
                getReplyBtn.disabled = false;
                regenerateBtn.disabled = false;
                typingIndicator.style.display = 'none';
            }
        }

        async function processStream(response, chat, apiType, targetChatId, targetChatType) {
            const reader = response.body.getReader(), decoder = new TextDecoder();
            let fullResponse = "", accumulatedChunk = "";
            for (; ;) {
                const {done, value} = await reader.read();
                if (done) break;
                accumulatedChunk += decoder.decode(value, {stream: true});
                if (apiType === "openai" || apiType === "deepseek" || apiType === "claude" || apiType === "newapi") {
                    const parts = accumulatedChunk.split("\n\n");
                    accumulatedChunk = parts.pop();
                    for (const part of parts) {
                        if (part.startsWith("data: ")) {
                            const data = part.substring(6);
                            if (data.trim() !== "[DONE]") {
                                try {
                                    fullResponse += JSON.parse(data).choices[0].delta?.content || "";
                                } catch (e) { /* ignore */
                                }
                            }
                        }
                    }
                }
            }
            if (apiType === "gemini") {
                try {
                    const parsedStream = JSON.parse(accumulatedChunk);
                    fullResponse = parsedStream.map(item => item.candidates?.[0]?.content?.parts?.[0]?.text || "").join('');
                } catch (e) {
                    console.error("Error parsing Gemini stream:", e, "Chunk:", accumulatedChunk);
                    showToast("解析Gemini响应失败");
                    return;
                }
            }
            // 调用新的公共函数来处理回复内容
            await handleAiReplyContent(fullResponse, chat, targetChatId, targetChatType);
        }

        async function handleRegenerate() {
            if (isGenerating) return;

            const chat = (currentChatType === 'private')
                ? db.characters.find(c => c.id === currentChatId)
                : db.groups.find(g => g.id === currentChatId);

            if (!chat || !chat.history || chat.history.length === 0) {
                showToast('没有可供重新生成的内容。');
                return;
            }

            // 1. 从后往前找到最后一个 'user' 消息的索引
            const lastUserMessageIndex = chat.history.map(m => m.role).lastIndexOf('user');

            // 如果没有用户消息，或者最后一条就是用户消息，则无法重生成
            if (lastUserMessageIndex === -1 || lastUserMessageIndex === chat.history.length - 1) {
                showToast('AI尚未回复，无法重新生成。');
                return;
            }

            // 2. 截取掉最后一个用户消息之后的所有 'assistant' 消息
            const originalLength = chat.history.length;
            chat.history.splice(lastUserMessageIndex + 1);

            if (chat.history.length === originalLength) {
                showToast('未找到AI的回复，无法重新生成。');
                return;
            }
            
            await saveData();
            
            // 3. 重新渲染消息区域
            currentPage = 1; // 重置分页
            renderMessages(false, true); // 重新渲染并滚动到底部

            // 4. 重新触发AI回复
            await getAiReply(currentChatId, currentChatType);
        }

        // --- Other Sub-systems Setup (Stickers, Voice, etc.) ---
        function setupImageRecognition() {
            imageRecognitionBtn.addEventListener('click', () => {
                imageUploadInput.click();
            });
            imageUploadInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, {
                            quality: 0.8,
                            maxWidth: 1024,
                            maxHeight: 1024
                        });
                        sendImageForRecognition(compressedUrl);
                    } catch (error) {
                        console.error('Image compression failed:', error);
                        showToast('图片处理失败，请重试');
                    } finally {
                        e.target.value = null;
                    }
                }
            });
        }

        async function setupStickerSystem() {
            const batchAddStickerBtn = document.getElementById('batch-add-sticker-btn');
            const batchAddStickerModal = document.getElementById('batch-add-sticker-modal');
            const batchAddStickerForm = document.getElementById('batch-add-sticker-form');
            const stickerUrlsTextarea = document.getElementById('sticker-urls-textarea');
            const manageStickersBtn = document.getElementById('manage-stickers-btn');
            const stickerManageBar = document.getElementById('sticker-manage-bar');
            const deleteSelectedStickersBtn = document.getElementById('delete-selected-stickers-btn');

            manageStickersBtn.addEventListener('click', () => {
                isStickerManageMode = !isStickerManageMode;
                if (isStickerManageMode) {
                    manageStickersBtn.textContent = '取消';
                    manageStickersBtn.classList.remove('btn-neutral');
                    manageStickersBtn.classList.add('btn-primary');
                    stickerManageBar.style.display = 'block';
                    stickerActionSheet.classList.remove('visible'); // 如果操作菜单是开的，则关掉
                } else {
                    manageStickersBtn.textContent = '管理';
                    manageStickersBtn.classList.remove('btn-primary');
                    manageStickersBtn.classList.add('btn-neutral');
                    stickerManageBar.style.display = 'none';
                    selectedStickerIds.clear();
                }
                updateDeleteSelectedBtn();
                renderStickerGrid();
            });

            deleteSelectedStickersBtn.addEventListener('click', async () => {
                if (selectedStickerIds.size === 0) {
                    showToast('请先选择要删除的表情');
                    return;
                }
                if (confirm(`确定要删除这 ${selectedStickerIds.size} 个表情吗？`)) {
                    db.myStickers = db.myStickers.filter(s => !selectedStickerIds.has(s.id));
                    await saveData();
                    showToast('表情已删除');
                    // 退出管理模式
                    isStickerManageMode = false;
                    manageStickersBtn.textContent = '管理';
                    manageStickersBtn.classList.remove('btn-primary');
                    manageStickersBtn.classList.add('btn-neutral');
                    stickerManageBar.style.display = 'none';
                    selectedStickerIds.clear();
                    renderStickerGrid();
                }
            });

            function updateDeleteSelectedBtn() {
                deleteSelectedStickersBtn.textContent = `删除已选 (${selectedStickerIds.size})`;
                deleteSelectedStickersBtn.disabled = selectedStickerIds.size === 0;
            }

            batchAddStickerBtn.addEventListener('click', () => {
                batchAddStickerModal.classList.add('visible');
                stickerUrlsTextarea.value = ''; // 清空文本域
            });

            batchAddStickerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const textInput = stickerUrlsTextarea.value.trim();
                if (!textInput) {
                    showToast('请输入表情包数据');
                    return;
                }

                const lines = textInput.split('\n');
                const newStickers = [];

                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (!trimmedLine) continue; // 跳过空行

                    const colonIndex = trimmedLine.indexOf(':');
                    
                    // 验证格式：必须包含冒号，且冒号前后都有内容
                    if (colonIndex <= 0) {
                        console.warn(`格式错误，已跳过: ${trimmedLine}`);
                        continue;
                    }

                    const name = trimmedLine.substring(0, colonIndex).trim();
                    const url = trimmedLine.substring(colonIndex + 1).trim();

                    if (name && url.startsWith('http')) {
                        newStickers.push({
                            id: `sticker_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                            name: name,
                            data: url
                        });
                    } else {
                        console.warn(`数据无效，已跳过: name='${name}', url='${url}'`);
                    }
                }

                if (newStickers.length > 0) {
                    db.myStickers.push(...newStickers); // 一次性推入所有新表情
                    await saveData();
                    renderStickerGrid();
                    batchAddStickerModal.classList.remove('visible');
                    showToast(`成功导入 ${newStickers.length} 个新表情！`);
                } else {
                    showToast('未找到有效的表情包数据，请检查格式');
                }
            });

            stickerToggleBtn.addEventListener('click', () => {
                // Hide expansion panel if open
                const chatExpansionPanel = document.getElementById('chat-expansion-panel');
                if (chatExpansionPanel.classList.contains('visible')) {
                    chatExpansionPanel.classList.remove('visible');
                }
                stickerModal.classList.toggle('visible');
                if (stickerModal.classList.contains('visible')) {
                    renderStickerGrid();
                }
            });
            addNewStickerBtn.addEventListener('click', () => {
                addStickerModalTitle.textContent = '添加新表情';
                addStickerForm.reset();
                stickerEditIdInput.value = '';
                stickerPreview.innerHTML = '<span>预览</span>';
                stickerUrlInput.disabled = false;
                addStickerModal.classList.add('visible');
            });
            addStickerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = stickerNameInput.value.trim();
                const id = stickerEditIdInput.value;
                const previewImg = stickerPreview.querySelector('img');
                const data = previewImg ? previewImg.src : null;
                if (!name || !data) {
                    return showToast('请填写表情名称并提供图片');
                }
                const stickerData = {name, data};
                if (id) {
                    const index = db.myStickers.findIndex(s => s.id === id);
                    if (index > -1) {
                        db.myStickers[index] = {...db.myStickers[index], ...stickerData};
                    }
                } else {
                    stickerData.id = `sticker_${Date.now()}`;
                    db.myStickers.push(stickerData);
                }
                await saveData();
                renderStickerGrid();
                addStickerModal.classList.remove('visible');
                showToast('表情包已保存');
            });
            stickerUrlInput.addEventListener('input', (e) => {
                stickerPreview.innerHTML = `<img src="${e.target.value}" alt="预览">`;
                stickerFileUpload.value = '';
            });
            stickerFileUpload.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, {quality: 0.8, maxWidth: 200, maxHeight: 200});
                        stickerPreview.innerHTML = `<img src="${compressedUrl}" alt="预览">`;
                        stickerUrlInput.value = '';
                        stickerUrlInput.disabled = true;
                    } catch (error) {
                        console.error('表情包压缩失败:', error);
                        showToast('表情包压缩失败，请重试');
                    }
                }
            });
            editStickerBtn.addEventListener('click', () => {
                if (!currentStickerActionTarget) return;
                const sticker = db.myStickers.find(s => s.id === currentStickerActionTarget);
                if (sticker) {
                    addStickerModalTitle.textContent = '编辑表情';
                    stickerEditIdInput.value = sticker.id;
                    stickerNameInput.value = sticker.name;
                    stickerPreview.innerHTML = `<img src="${sticker.data}" alt="预览">`;
                    if (sticker.data.startsWith('http')) {
                        stickerUrlInput.value = sticker.data;
                        stickerUrlInput.disabled = false;
                    } else {
                        stickerUrlInput.value = '';
                        stickerUrlInput.disabled = true;
                    }
                    addStickerModal.classList.add('visible');
                }
                stickerActionSheet.classList.remove('visible');
                currentStickerActionTarget = null;
            });
            deleteStickerBtn.addEventListener('click', async () => {
                if (!currentStickerActionTarget) return;
                const sticker = db.myStickers.find(s => s.id === currentStickerActionTarget);
                if (sticker) {
                    if (confirm(`确定要删除表情“${sticker.name}”吗？`)) {
                        db.myStickers = db.myStickers.filter(s => s.id !== currentStickerActionTarget);
                        await saveData();
                        renderStickerGrid();
                        showToast('表情已删除');
                    }
                }
                stickerActionSheet.classList.remove('visible');
                currentStickerActionTarget = null;
            });
        }

        function renderStickerGrid() {
            stickerGridContainer.innerHTML = '';
            if (db.myStickers.length === 0) {
                stickerGridContainer.innerHTML = '<p style="color:#aaa; text-align:center;">还没有表情包，快去添加吧！</p>';
                return;
            }
            db.myStickers.forEach(sticker => {
                const item = document.createElement('div');
                item.className = 'sticker-item';
                item.innerHTML = `<img src="${sticker.data}" alt="${sticker.name}"><span>${sticker.name}</span>`;

                if (isStickerManageMode) {
                    item.classList.add('is-managing');
                    if (selectedStickerIds.has(sticker.id)) {
                        item.classList.add('is-selected');
                    }
                    // 在管理模式下，单击是选择/取消选择
                    item.addEventListener('click', () => {
                        if (selectedStickerIds.has(sticker.id)) {
                            selectedStickerIds.delete(sticker.id);
                            item.classList.remove('is-selected');
                        } else {
                            selectedStickerIds.add(sticker.id);
                            item.classList.add('is-selected');
                        }
                        // 更新底部删除按钮的计数
                        const deleteBtn = document.getElementById('delete-selected-stickers-btn');
                        deleteBtn.textContent = `删除已选 (${selectedStickerIds.size})`;
                        deleteBtn.disabled = selectedStickerIds.size === 0;
                    });
                } else {
                    // 非管理模式下的原始逻辑
                    item.addEventListener('click', () => sendSticker(sticker));
                    item.addEventListener('contextmenu', (e) => { // 使用 contextmenu 替代 mousedown
                        e.preventDefault();
                        e.stopPropagation();
                        handleStickerLongPress(sticker.id);
                    });
                    item.addEventListener('touchstart', (e) => {
                        e.stopPropagation();
                        longPressTimer = setTimeout(() => {
                            handleStickerLongPress(sticker.id);
                        }, 500);
                    });
                    item.addEventListener('touchend', () => clearTimeout(longPressTimer));
                    item.addEventListener('touchmove', () => clearTimeout(longPressTimer));
                }
                stickerGridContainer.appendChild(item);
            });
        }

        function handleStickerLongPress(stickerId) {
            if (isStickerManageMode) return;
            clearTimeout(longPressTimer);
            currentStickerActionTarget = stickerId;
            stickerActionSheet.classList.add('visible');
        }

        function setupVoiceMessageSystem() {
            voiceMessageBtn.addEventListener('click', () => {
                sendVoiceForm.reset();
                voiceDurationPreview.textContent = '0"';
                sendVoiceModal.classList.add('visible');
            });
            sendVoiceForm.addEventListener('submit', (e) => {
                e.preventDefault();
                sendMyVoiceMessage(voiceTextInput.value.trim());
            });
        }

        function setupPhotoVideoSystem() {
            photoVideoBtn.addEventListener('click', () => {
                sendPvForm.reset();
                sendPvModal.classList.add('visible');
            });
            sendPvForm.addEventListener('submit', (e) => {
                e.preventDefault();
                sendMyPhotoVideo(pvTextInput.value.trim());
            });
        }

        function setupWalletSystem() {
            walletBtn.addEventListener('click', () => {
                if (currentChatType === 'private') {
                    sendTransferForm.reset();
                    sendTransferModal.classList.add('visible');
                } else if (currentChatType === 'group') {
                    currentGroupAction.type = 'transfer';
                    renderGroupRecipientSelectionList('转账给');
                    groupRecipientSelectionModal.classList.add('visible');
                }
            });
            sendTransferForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const amount = transferAmountInput.value;
                const remark = transferRemarkInput.value.trim();
                if (amount > 0) {
                    sendMyTransfer(amount, remark);
                } else {
                    showToast('请输入有效的金额');
                }
            });
            acceptTransferBtn.addEventListener('click', () => respondToTransfer('received'));
            returnTransferBtn.addEventListener('click', () => respondToTransfer('returned'));
        }

        function handleReceivedTransferClick(messageId) {
            currentTransferMessageId = messageId;
            receiveTransferActionSheet.classList.add('visible');
        }

        async function respondToTransfer(action) {
            if (!currentTransferMessageId) return;
            const character = db.characters.find(c => c.id === currentChatId);
            const message = character.history.find(m => m.id === currentTransferMessageId);
            if (message) {
                message.transferStatus = action;
                const cardOnScreen = messageArea.querySelector(`.message-wrapper[data-id="${currentTransferMessageId}"] .transfer-card`);
                if (cardOnScreen) {
                    cardOnScreen.classList.remove('received', 'returned');
                    cardOnScreen.classList.add(action);
                    cardOnScreen.querySelector('.transfer-status').textContent = action === 'received' ? '已收款' : '已退回';
                    cardOnScreen.style.cursor = 'default';
                }
                let contextMessageContent = (action === 'received') ? `[${character.myName}接收${character.realName}的转账]` : `[${character.myName}退回${character.realName}的转账]`;
                const contextMessage = {
                    id: `msg_${Date.now()}`,
                    role: 'user',
                    content: contextMessageContent,
                    parts: [{type: 'text', text: contextMessageContent}],
                    timestamp: Date.now()
                };
                character.history.push(contextMessage);
                await saveData();
                renderChatList();
            }
            receiveTransferActionSheet.classList.remove('visible');
            currentTransferMessageId = null;
        }

        function setupGiftSystem() {
            
            sendGiftForm.addEventListener('submit', (e) => {
                e.preventDefault();
                sendMyGift(giftDescriptionInput.value.trim());
            });
        }

        function setupFontSettingsApp() {
            fontUrlInput.value = db.fontUrl;
            fontSettingsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newFontUrl = fontUrlInput.value.trim();
                db.fontUrl = newFontUrl;
                await saveData();
                applyGlobalFont(newFontUrl);
                showToast('新字体已应用！');
            });
            restoreDefaultFontBtn.addEventListener('click', async () => {
                fontUrlInput.value = '';
                db.fontUrl = '';
                await saveData();
                applyGlobalFont('');
                showToast('已恢复默认字体！');
            });
        }

        function applyGlobalFont(fontUrl) {
            const styleId = 'global-font-style';
            let styleElement = document.getElementById(styleId);
            if (!styleElement) {
                styleElement = document.createElement('style');
                styleElement.id = styleId;
                document.head.appendChild(styleElement);
            }
            if (fontUrl) {
                const fontName = 'CustomGlobalFont';
                styleElement.innerHTML = `@font-face { font-family: '${fontName}'; src: url('${fontUrl}'); } :root { --font-family: '${fontName}', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }`;
            } else {
                styleElement.innerHTML = `:root { --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }`;
            }
        }

        function applyGlobalCss(css) {
            const styleElement = document.getElementById('global-css-style');
            if (styleElement) {
                styleElement.innerHTML = css || '';
            }
        }

        function populateGlobalCssPresetSelect() {
            const select = document.getElementById('global-css-preset-select');
            if (!select) return;
            select.innerHTML = '<option value="">— 选择预设 —</option>';
            (db.globalCssPresets || []).forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name;
                opt.textContent = p.name;
                select.appendChild(opt);
            });
        }

        function openGlobalCssManageModal() {
            const modal = document.getElementById('global-css-presets-modal');
            const list = document.getElementById('global-css-presets-list');
            if (!modal || !list) return;
            list.innerHTML = '';
            const presets = db.globalCssPresets || [];
            if (!presets.length) list.innerHTML = '<p style="color:#888;margin:6px 0;">暂无预设</p>';
            
            presets.forEach((p, idx) => {
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.justifyContent = 'space-between';
                row.style.alignItems = 'center';
                row.style.padding = '8px 0';
                row.style.borderBottom = '1px solid #f0f0f0';
                
                const nameDiv = document.createElement('div');
                nameDiv.style.flex = '1';
                nameDiv.style.whiteSpace = 'nowrap';
                nameDiv.style.overflow = 'hidden';
                nameDiv.style.textOverflow = 'ellipsis';
                nameDiv.textContent = p.name;
                row.appendChild(nameDiv);

                const btnWrap = document.createElement('div');
                btnWrap.style.display = 'flex';
                btnWrap.style.gap = '6px';

                const renameBtn = document.createElement('button');
                renameBtn.className = 'btn';
                renameBtn.style.padding = '6px 8px';
                renameBtn.textContent = '重命名';
                renameBtn.onclick = function() {
                    const newName = prompt('输入新名称：', p.name);
                    if (!newName || newName === p.name) return;
                    db.globalCssPresets[idx].name = newName;
                    saveData();
                    openGlobalCssManageModal();
                    populateGlobalCssPresetSelect();
                };

                const delBtn = document.createElement('button');
                delBtn.className = 'btn btn-danger';
                delBtn.style.padding = '6px 8px';
                delBtn.textContent = '删除';
                delBtn.onclick = function() {
                    if (!confirm('确定删除预设 "' + p.name + '" ?')) return;
                    db.globalCssPresets.splice(idx, 1);
                    saveData();
                    openGlobalCssManageModal();
                    populateGlobalCssPresetSelect();
                };

                btnWrap.appendChild(renameBtn);
                btnWrap.appendChild(delBtn);
                row.appendChild(btnWrap);
                list.appendChild(row);
            });
            modal.style.display = 'flex';
        }

        // --- 世界书批量删除相关函数 ---
        function enterWorldBookMultiSelectMode(initialId, initialCategory = null) {
            if (isWorldBookMultiSelectMode) return;
            isWorldBookMultiSelectMode = true;

            document.getElementById('add-world-book-btn').style.display = 'none';
            document.getElementById('cancel-wb-multi-select-btn').style.display = 'inline-block';
            document.getElementById('world-book-multi-select-bar').style.display = 'flex';
            document.querySelector('#world-book-screen .content').style.paddingBottom = '70px';

            selectedWorldBookIds.clear();
            if (initialId) {
                selectedWorldBookIds.add(initialId);
            }

            updateWorldBookSelectCount();
            renderWorldBookList(initialCategory); // Pass the category to expand
        }

        function exitWorldBookMultiSelectMode() {
            isWorldBookMultiSelectMode = false;

            document.getElementById('add-world-book-btn').style.display = 'inline-block';
            document.getElementById('cancel-wb-multi-select-btn').style.display = 'none';
            document.getElementById('world-book-multi-select-bar').style.display = 'none';
            document.querySelector('#world-book-screen .content').style.paddingBottom = '0';

            selectedWorldBookIds.clear();
            renderWorldBookList();
        }

        function toggleWorldBookSelection(bookId) {
            const itemEl = worldBookListContainer.querySelector(`.world-book-item[data-id="${bookId}"]`);
            if (selectedWorldBookIds.has(bookId)) {
                selectedWorldBookIds.delete(bookId);
                if(itemEl) itemEl.classList.remove('selected');
            } else {
                selectedWorldBookIds.add(bookId);
                if(itemEl) itemEl.classList.add('selected');
            }
            updateWorldBookSelectCount();
        }

        function updateWorldBookSelectCount() {
            const count = selectedWorldBookIds.size;
            document.getElementById('world-book-select-count').textContent = `已选择 ${count} 项`;
            document.getElementById('delete-selected-world-books-btn').disabled = count === 0;
        }

        async function deleteSelectedWorldBooks() {
            const count = selectedWorldBookIds.size;
            if (count === 0) return;

            if (confirm(`确定要删除这 ${count} 个世界书条目吗？此操作不可恢复。`)) {
                const idsToDelete = Array.from(selectedWorldBookIds);
                
                await dexieDB.worldBooks.bulkDelete(idsToDelete);
                db.worldBooks = db.worldBooks.filter(book => !selectedWorldBookIds.has(book.id));
                
                db.characters.forEach(char => {
                    if (char.worldBookIds) {
                        char.worldBookIds = char.worldBookIds.filter(id => !selectedWorldBookIds.has(id));
                    }
                });
                db.groups.forEach(group => {
                    if (group.worldBookIds) {
                        group.worldBookIds = group.worldBookIds.filter(id => !selectedWorldBookIds.has(id));
                    }
                });

                await saveData();
                showToast(`已成功删除 ${count} 个条目`);
                exitWorldBookMultiSelectMode();
            }
        }

        function setupWorldBookApp() {
            addWorldBookBtn.addEventListener('click', () => {
                currentEditingWorldBookId = null;
                editWorldBookForm.reset();
                document.querySelector('input[name="world-book-position"][value="before"]').checked = true;
                switchScreen('edit-world-book-screen');
            });
            editWorldBookForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = worldBookNameInput.value.trim();
                const content = worldBookContentInput.value.trim();
                const category = document.getElementById('world-book-category').value.trim();
                const position = document.querySelector('input[name="world-book-position"]:checked').value;
                if (!name || !content) return showToast('名称和内容不能为空');
                if (currentEditingWorldBookId) {
                    const book = db.worldBooks.find(wb => wb.id === currentEditingWorldBookId);
                    if (book) {
                        book.name = name;
                        book.content = content;
                        book.position = position;
                        book.category = category;
                    }
                } else {
                    db.worldBooks.push({id: `wb_${Date.now()}`, name, content, position, category});
                }
                await saveData();
                showToast('世界书条目已保存');
                renderWorldBookList();
                switchScreen('world-book-screen');
            });
            worldBookListContainer.addEventListener('click', e => {
                const worldBookItem = e.target.closest('.world-book-item');

                if (isWorldBookMultiSelectMode) {
                    // 1. 点击分类的多选框
                    if (e.target.matches('.category-checkbox')) {
                        const category = e.target.dataset.category;
                        const booksInCategory = db.worldBooks.filter(b => (b.category || '未分类') === category);
                        const bookIdsInCategory = booksInCategory.map(b => b.id);
                        const shouldSelectAll = e.target.checked;

                        bookIdsInCategory.forEach(bookId => {
                            if (shouldSelectAll) {
                                selectedWorldBookIds.add(bookId);
                            } else {
                                selectedWorldBookIds.delete(bookId);
                            }
                        });
                        renderWorldBookList(category); // Re-render to show selection changes
                        updateWorldBookSelectCount();
                        return;
                    }

                    // 2. 点击单个条目进行选择
                    if (worldBookItem) {
                        toggleWorldBookSelection(worldBookItem.dataset.id);
                        // Re-render to update the checkmark and category checkbox state
                        const category = worldBookItem.closest('.collapsible-section').dataset.category;
                        renderWorldBookList(category);
                        return;
                    }
                    
                    // 3. 点击分类标题区域进行展开/折叠
                    if (e.target.closest('.category-toggle-area')) {
                        e.target.closest('.collapsible-section').classList.toggle('open');
                        return;
                    }

                } else { // 非多选模式
                    // 1. 点击分类标题进行展开/折叠
                    if (e.target.closest('.collapsible-header')) {
                        e.target.closest('.collapsible-section').classList.toggle('open');
                        return;
                    }
                    
                    // 2. 点击条目进入编辑
                    if (worldBookItem && !e.target.closest('.action-btn')) {
                        const book = db.worldBooks.find(wb => wb.id === worldBookItem.dataset.id);
                        if (book) {
                            currentEditingWorldBookId = book.id;
                            worldBookIdInput.value = book.id;
                            worldBookNameInput.value = book.name;
                            worldBookContentInput.value = book.content;
                            document.getElementById('world-book-category').value = book.category || '';
                            document.querySelector(`input[name="world-book-position"][value="${book.position}"]`).checked = true;
                            switchScreen('edit-world-book-screen');
                        }
                    }
                }
            });
            worldBookListContainer.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                const item = e.target.closest('.world-book-item');
                if (item) {
                    const category = item.closest('.collapsible-section')?.dataset.category;
                    enterWorldBookMultiSelectMode(item.dataset.id, category);
                }
            });
            worldBookListContainer.addEventListener('touchstart', (e) => {
                const item = e.target.closest('.world-book-item');
                if (!item) return;
                longPressTimer = setTimeout(() => {
                    const category = item.closest('.collapsible-section')?.dataset.category;
                    enterWorldBookMultiSelectMode(item.dataset.id, category);
                }, 500);
            });
            worldBookListContainer.addEventListener('mouseup', () => clearTimeout(longPressTimer));
            worldBookListContainer.addEventListener('mouseleave', () => clearTimeout(longPressTimer));
            worldBookListContainer.addEventListener('touchend', () => clearTimeout(longPressTimer));
            worldBookListContainer.addEventListener('touchmove', () => clearTimeout(longPressTimer));
        }

        function renderWorldBookList(expandedCategory = null) {
            worldBookListContainer.innerHTML = '';
            noWorldBooksPlaceholder.style.display = db.worldBooks.length === 0 ? 'block' : 'none';
            if (db.worldBooks.length === 0) return;

            const groupedBooks = db.worldBooks.reduce((acc, book) => {
                const category = book.category || '未分类';
                if (!acc[category]) acc[category] = [];
                acc[category].push(book);
                return acc;
            }, {});

            const sortedCategories = Object.keys(groupedBooks).sort((a, b) => {
                if (a === '未分类') return 1;
                if (b === '未分类') return -1;
                return a.localeCompare(b);
            });

            sortedCategories.forEach(category => {
                const section = document.createElement('div');
                section.className = 'collapsible-section';
                section.dataset.category = category; // Add category data attribute

                // Expand the specific category if provided
                if (isWorldBookMultiSelectMode && category === expandedCategory) {
                    section.classList.add('open');
                }

                const header = document.createElement('div');
                header.className = 'collapsible-header';
                
                let checkboxHTML = '';
                if (isWorldBookMultiSelectMode) {
                    const allInCategory = groupedBooks[category].every(book => selectedWorldBookIds.has(book.id));
                    checkboxHTML = `<input type="checkbox" class="category-checkbox" data-category="${category}" ${allInCategory ? 'checked' : ''}>`;
                }
                
                header.innerHTML = `
                    <div class="category-select-area">
                        ${checkboxHTML}
                    </div>
                    <div class="category-toggle-area">
                        <h4>${category}</h4>
                        <span class="collapsible-arrow">▼</span>
                    </div>
                `;

                const content = document.createElement('div');
                content.className = 'collapsible-content';
                const categoryList = document.createElement('ul');
                categoryList.className = 'list-container';
                categoryList.style.padding = '0';

                groupedBooks[category].forEach(book => {
                    const li = document.createElement('li');
                    li.className = 'list-item world-book-item';
                    li.dataset.id = book.id;

                    if (isWorldBookMultiSelectMode) {
                        li.classList.add('is-selecting');
                        if (selectedWorldBookIds.has(book.id)) {
                            li.classList.add('selected');
                        }
                    }

                    li.innerHTML = `<div class="item-details" style="padding-left: 0;"><div class="item-name">${book.name}</div><div class="item-preview">${book.content}</div></div>`;
                    
                    if (!isWorldBookMultiSelectMode) {
                        const delBtn = document.createElement('button');
                        delBtn.className = 'action-btn';
                        delBtn.style.cssText = 'position: absolute; right: 8px; top: 50%; transform: translateY(-50%); padding: 6px; border: none; background: transparent;';
                        delBtn.title = '删除世界书';
                        delBtn.innerHTML = `
<svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M19 7L18.1327 19.1425C18.0579 20.1891 17.187 21 16.1378 21H7.86224C6.81296 21 5.94208 20.1891 5.86732 19.1425L5 7M10 11V17M14 11V17M15 7V4C15 3.44772 14.5523 3 14 3H10C9.44772 3 9 3.44772 9 4V7M4 7H20" stroke="#389CFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
`;
                        delBtn.addEventListener('click', async (ev) => {
                            ev.stopPropagation();
                            if (!confirm('确定要删除这个世界书条目吗？')) return;
                            const bookIdToDelete = book.id;
                            await dexieDB.worldBooks.delete(bookIdToDelete);
                            db.worldBooks = db.worldBooks.filter(wb => wb.id !== bookIdToDelete);
                            db.characters.forEach(char => {
                                if (char.worldBookIds) char.worldBookIds = char.worldBookIds.filter(id => id !== bookIdToDelete);
                            });
                            db.groups.forEach(group => {
                                if (group.worldBookIds) group.worldBookIds = group.worldBookIds.filter(id => id !== bookIdToDelete);
                            });
                            await saveData();
                            renderWorldBookList();
                            showToast('世界书条目已删除');
                        });
                        li.style.position = 'relative';
                        li.appendChild(delBtn);
                    }
                    categoryList.appendChild(li);
                });

                content.appendChild(categoryList);
                section.appendChild(header);
                section.appendChild(content);
                worldBookListContainer.appendChild(section);
            });
        }

        function renderCategorizedWorldBookList(container, books, selectedIds, idPrefix) {
            container.innerHTML = '';
            if (!books || books.length === 0) {
                container.innerHTML = '<li style="color: #888; text-align: center; padding: 15px;">暂无世界书条目</li>';
                return;
            }

            const groupedBooks = books.reduce((acc, book) => {
                const category = book.category || '未分类';
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(book);
                return acc;
            }, {});

            const sortedCategories = Object.keys(groupedBooks).sort((a, b) => {
                if (a === '未分类') return 1;
                if (b === '未分类') return -1;
                return a.localeCompare(b);
            });

            sortedCategories.forEach(category => {
                const categoryBooks = groupedBooks[category];
                const allInCategorySelected = categoryBooks.every(book => selectedIds.includes(book.id));

                const groupEl = document.createElement('div');
                groupEl.className = 'world-book-category-group';

                groupEl.innerHTML = `
                    <div class="world-book-category-header">
                        <input type="checkbox" class="category-checkbox" ${allInCategorySelected ? 'checked' : ''}>
                        <span class="category-name">${category}</span>
                        <span class="category-arrow">▼</span>
                    </div>
                    <ul class="world-book-items-list">
                        ${categoryBooks.map(book => {
                            const isChecked = selectedIds.includes(book.id);
                            return `
                                <li class="world-book-select-item">
                                    <input type="checkbox" class="item-checkbox" id="${idPrefix}-${book.id}" value="${book.id}" ${isChecked ? 'checked' : ''}>
                                    <label for="${idPrefix}-${book.id}">${book.name}</label>
                                </li>
                            `;
                        }).join('')}
                    </ul>
                `;
                container.appendChild(groupEl);
            });

            // Add event listeners
            container.querySelectorAll('.world-book-category-header').forEach(header => {
                header.addEventListener('click', (e) => {
                    if (e.target.type === 'checkbox') return; // Don't toggle if clicking checkbox
                    const group = header.closest('.world-book-category-group');
                    group.classList.toggle('open');
                });
            });

            container.querySelectorAll('.category-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const group = e.target.closest('.world-book-category-group');
                    const itemCheckboxes = group.querySelectorAll('.item-checkbox');
                    itemCheckboxes.forEach(itemCb => {
                        itemCb.checked = e.target.checked;
                    });
                });
            });

            container.querySelectorAll('.item-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const group = e.target.closest('.world-book-category-group');
                    const categoryCheckbox = group.querySelector('.category-checkbox');
                    const allItems = group.querySelectorAll('.item-checkbox');
                    const allChecked = Array.from(allItems).every(item => item.checked);
                    categoryCheckbox.checked = allChecked;
                });
            });
        }

        function setupChatSettings() {
            const themeSelect = document.getElementById('setting-theme-color');
            themeSelect.innerHTML = '';
            Object.keys(colorThemes).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = colorThemes[key].name;
                themeSelect.appendChild(option);
            });
            chatSettingsBtn.addEventListener('click', () => {
                if (currentChatType === 'private') {
                    loadSettingsToSidebar();
                    settingsSidebar.classList.add('open');
                } else if (currentChatType === 'group') {
                    loadGroupSettingsToSidebar();
                    groupSettingsSidebar.classList.add('open');
                }
            });
            document.querySelector('.phone-screen').addEventListener('click', e => {
                const openSidebar = document.querySelector('.settings-sidebar.open');
                if (openSidebar && !openSidebar.contains(e.target) && !e.target.closest('.action-btn') && !e.target.closest('.modal-overlay') && !e.target.closest('.action-sheet-overlay')) {
                    openSidebar.classList.remove('open');
                }
            });

            settingsForm.addEventListener('submit', e => {
                e.preventDefault();
                saveSettingsFromSidebar();
                settingsSidebar.classList.remove('open');
            });
            const useCustomCssCheckbox = document.getElementById('setting-use-custom-css'),
                customCssTextarea = document.getElementById('setting-custom-bubble-css'),
                resetCustomCssBtn = document.getElementById('reset-custom-bubble-css-btn'),
                privatePreviewBox = document.getElementById('private-bubble-css-preview');
            useCustomCssCheckbox.addEventListener('change', (e) => {
                customCssTextarea.disabled = !e.target.checked;
                const char = db.characters.find(c => c.id === currentChatId);
                if (char) {
                    const themeKey = char.theme || 'white_blue';
                    const theme = colorThemes[themeKey];
                    updateBubbleCssPreview(privatePreviewBox, customCssTextarea.value, !e.target.checked, theme);
                }
            });
            customCssTextarea.addEventListener('input', (e) => {
                const char = db.characters.find(c => c.id === currentChatId);
                if (char && useCustomCssCheckbox.checked) {
                    const themeKey = char.theme || 'white_blue';
                    const theme = colorThemes[themeKey];
                    updateBubbleCssPreview(privatePreviewBox, e.target.value, false, theme);
                }
            });
            resetCustomCssBtn.addEventListener('click', () => {
                const char = db.characters.find(c => c.id === currentChatId);
                if (char) {
                    customCssTextarea.value = '';
                    useCustomCssCheckbox.checked = false;
                    customCssTextarea.disabled = true;
                    const themeKey = char.theme || 'white_blue';
                    const theme = colorThemes[themeKey];
                    updateBubbleCssPreview(privatePreviewBox, '', true, theme);
                    showToast('样式已重置为默认');
                }
            });
            document.getElementById('setting-char-avatar-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, {quality: 0.8, maxWidth: 400, maxHeight: 400});
                        document.getElementById('setting-char-avatar-preview').src = compressedUrl;
                    } catch (error) {
                        showToast('头像压缩失败，请重试');
                    }
                }
            });
            document.getElementById('setting-my-avatar-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, {quality: 0.8, maxWidth: 400, maxHeight: 400});
                        document.getElementById('setting-my-avatar-preview').src = compressedUrl;
                    } catch (error) {
                        showToast('头像压缩失败，请重试');
                    }
                }
            });
            document.getElementById('setting-chat-bg-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const char = db.characters.find(c => c.id === currentChatId);
                    if (char) {
                        try {
                            const compressedUrl = await compressImage(file, {
                                quality: 0.85,
                                maxWidth: 1080,
                                maxHeight: 1920
                            });
                            char.chatBg = compressedUrl;
                            chatRoomScreen.style.backgroundImage = `url(${compressedUrl})`;
                            await saveData();
                            showToast('聊天背景已更换');
                        } catch (error) {
                            showToast('背景压缩失败，请重试');
                        }
                    }
                }
            });
            clearChatHistoryBtn.addEventListener('click', async () => {
                const character = db.characters.find(c => c.id === currentChatId);
                if (!character) return;
                if (confirm(`你确定要清空与“${character.remarkName}”的所有聊天记录吗？这个操作是不可恢复的！`)) {
                    character.history = [];
                    character.status = '在线'; // 重置状态
                    await saveData();
                    renderMessages(false, true);
                    renderChatList();
                    // 更新聊天室顶部的状态显示
                    if (currentChatId === character.id) {
                        document.getElementById('chat-room-status-text').textContent = '在线';
                    }
                    settingsSidebar.classList.remove('open');
                    showToast('聊天记录已清空');
                }
            });
            linkWorldBookBtn.addEventListener('click', () => {
                const character = db.characters.find(c => c.id === currentChatId);
                if (!character) return;
                renderCategorizedWorldBookList(worldBookSelectionList, db.worldBooks, character.worldBookIds || [], 'wb-select');
                worldBookSelectionModal.classList.add('visible');
            });

            saveWorldBookSelectionBtn.addEventListener('click', async () => {
                const selectedIds = Array.from(worldBookSelectionList.querySelectorAll('.item-checkbox:checked')).map(input => input.value);
                if (currentChatType === 'private') {
                    const character = db.characters.find(c => c.id === currentChatId);
                    if (character) character.worldBookIds = selectedIds;
                } else if (currentChatType === 'group') {
                    const group = db.groups.find(g => g.id === currentChatId);
                    if (group) group.worldBookIds = selectedIds;
                }
                await saveData();
                worldBookSelectionModal.classList.remove('visible');
                showToast('世界书关联已更新');
            });
        }

        function loadSettingsToSidebar() {
            const e = db.characters.find(e => e.id === currentChatId);
            if (e) {
                document.getElementById('setting-char-avatar-preview').src = e.avatar;
                document.getElementById('setting-char-remark').value = e.remarkName;
                document.getElementById('setting-char-persona').value = e.persona;
                document.getElementById('setting-my-avatar-preview').src = e.myAvatar;
                document.getElementById('setting-my-name').value = e.myName;
                document.getElementById('setting-my-persona').value = e.myPersona;
                document.getElementById('setting-theme-color').value = e.theme || 'white_blue';
                document.getElementById('setting-max-memory').value = e.maxMemory;
                document.getElementById('setting-bilingual-mode').checked = e.bilingualModeEnabled || false;
                const useCustomCssCheckbox = document.getElementById('setting-use-custom-css'),
                    customCssTextarea = document.getElementById('setting-custom-bubble-css'),
                    privatePreviewBox = document.getElementById('private-bubble-css-preview');
                useCustomCssCheckbox.checked = e.useCustomBubbleCss || false;
                customCssTextarea.value = e.customBubbleCss || '';
                customCssTextarea.disabled = !useCustomCssCheckbox.checked;
                const theme = colorThemes[e.theme || 'white_blue'];
                updateBubbleCssPreview(privatePreviewBox, e.customBubbleCss, !e.useCustomBubbleCss, theme);
                populateBubblePresetSelect('bubble-preset-select');
                populateMyPersonaSelect();
            }
        }

        async function saveSettingsFromSidebar() {
            const e = db.characters.find(e => e.id === currentChatId);
            if (e) {
                e.avatar = document.getElementById('setting-char-avatar-preview').src;
                e.remarkName = document.getElementById('setting-char-remark').value;
                e.persona = document.getElementById('setting-char-persona').value;
                e.myAvatar = document.getElementById('setting-my-avatar-preview').src;
                e.myName = document.getElementById('setting-my-name').value;
                e.myPersona = document.getElementById('setting-my-persona').value;
                e.theme = document.getElementById('setting-theme-color').value;
                e.maxMemory = document.getElementById('setting-max-memory').value;
                e.useCustomBubbleCss = document.getElementById('setting-use-custom-css').checked;
                e.customBubbleCss = document.getElementById('setting-custom-bubble-css').value;
                // 在 e.customBubbleCss = ... 这一行下面添加
                e.bilingualModeEnabled = document.getElementById('setting-bilingual-mode').checked;

                await saveData();
                showToast('设置已保存！');
                chatRoomTitle.textContent = e.remarkName;
                renderChatList();
                updateCustomBubbleStyle(currentChatId, e.customBubbleCss, e.useCustomBubbleCss);
                currentPage = 1;
                renderMessages(false, true);
            }
        }

        function setupApiSettingsApp() {
            const e = document.getElementById('api-form'), t = document.getElementById('fetch-models-btn'),
                a = document.getElementById('api-model'), n = document.getElementById('api-provider'),
                r = document.getElementById('api-url'), s = document.getElementById('api-key'), c = {
                    newapi: '',
                    deepseek: 'https://api.deepseek.com',
                    claude: 'https://api.anthropic.com',
                    gemini: 'https://generativelanguage.googleapis.com'
                };
            db.apiSettings && (n.value = db.apiSettings.provider || 'newapi', r.value = db.apiSettings.url || '', s.value = db.apiSettings.key || '', db.apiSettings.model && (a.innerHTML = `<option value="${db.apiSettings.model}">${db.apiSettings.model}</option>`));
            if (db.apiSettings && typeof db.apiSettings.timePerceptionEnabled !== 'undefined') { document.getElementById('time-perception-switch').checked = db.apiSettings.timePerceptionEnabled; }
            if (db.apiSettings && typeof db.apiSettings.streamEnabled !== 'undefined') { document.getElementById('stream-switch').checked = db.apiSettings.streamEnabled; } else { document.getElementById('stream-switch').checked = true; } // 默认开启

            populateApiSelect();
            n.addEventListener('change', () => {
                r.value = c[n.value] || ''
            });
            t.addEventListener('click', async () => {
                let o = r.value.trim();
                const l = s.value.trim();
                if (!o || !l) return showToast('请先填写API地址和密钥！');
                o.endsWith('/') && (o = o.slice(0, -1));
                const i = 'gemini' === n.value ? `${o}/v1beta/models?key=${getRandomValue(l)}` : `${o}/v1/models`;
                t.classList.add('loading'), t.disabled = !0;
                try {
                    const d = 'gemini' === n.value ? {} : {Authorization: `Bearer ${l}`},
                        g = await fetch(i, {method: 'GET', headers: d});
                    if (!g.ok) {
                        const error = new Error(`网络响应错误: ${g.status}`);
                        error.response = g;
                        throw error;
                    }
                    const u = await g.json();
                    let p = [];
                    'gemini' !== n.value && u.data ? p = u.data.map(e => e.id) : 'gemini' === n.value && u.models && (p = u.models.map(e => e.name.replace('models/', ''))), a.innerHTML = '', p.length > 0 ? p.forEach(e => {
                        const t = document.createElement('option');
                        t.value = e, t.textContent = e, a.appendChild(t)
                    }) : a.innerHTML = '<option value="">未找到任何模型</option>', showToast('模型列表拉取成功！')
                } catch (f) {
                    showApiError(f), a.innerHTML = '<option value="">拉取失败</option>'
                } finally {
                    t.classList.remove('loading'), t.disabled = !1
                }
            });
            e.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!a.value) return showToast('请选择模型后保存！');
    // 在这里，我们把开关的状态也一起保存进去
    db.apiSettings = {
        provider: n.value,
        url: r.value,
        key: s.value,
        model: a.value,
        timePerceptionEnabled: document.getElementById('time-perception-switch').checked,
        streamEnabled: document.getElementById('stream-switch').checked // 新增这一行
    };
    await saveData();
    showToast('API设置已保存！')
})
        }
       function setupPresetFeatures() {
           // API Presets
           const saveBtn = document.getElementById('api-save-preset');
           const manageBtn = document.getElementById('api-manage-presets');
           const applyBtn = document.getElementById('api-apply-preset');
           const select = document.getElementById('api-preset-select');
           const modalClose = document.getElementById('api-close-modal');
           const importBtn = document.getElementById('api-import-presets');
           const exportBtn = document.getElementById('api-export-presets');

           if (saveBtn) saveBtn.addEventListener('click', saveCurrentApiAsPreset);
           if (manageBtn) manageBtn.addEventListener('click', openApiManageModal);
           if (applyBtn) applyBtn.addEventListener('click', function(){ const v=select.value; if(!v) return (window.showToast&&showToast('请选择预设'))||alert('请选择预设'); applyApiPreset(v); });
           if (modalClose) modalClose.addEventListener('click', function(){ document.getElementById('api-presets-modal').style.display='none'; });
           if (importBtn) importBtn.addEventListener('click', importApiPresets);
           if (exportBtn) exportBtn.addEventListener('click', exportApiPresets);
           
           // Bubble CSS Presets
           const bubbleApplyBtn = document.getElementById('apply-preset-btn');
           const bubbleSaveBtn = document.getElementById('save-preset-btn');
           const bubbleManageBtn = document.getElementById('manage-presets-btn');
           const bubbleModalClose = document.getElementById('close-presets-modal');

           // --- 新增代码开始 ---
           const groupBubbleApplyBtn = document.getElementById('group-apply-preset-btn');
           const groupBubbleSaveBtn = document.getElementById('group-save-preset-btn');
           const groupBubbleManageBtn = document.getElementById('group-manage-presets-btn');
           // --- 新增代码结束 ---

           if (bubbleApplyBtn) bubbleApplyBtn.addEventListener('click', () => {
               const selVal = document.getElementById('bubble-preset-select').value;
               if (!selVal) return (window.showToast && showToast('请选择要应用的预设')) || alert('请选择要应用的预设');
               applyPresetToCurrentChat(selVal);
           });
           if (bubbleSaveBtn) bubbleSaveBtn.addEventListener('click', saveCurrentTextareaAsPreset);
           if (bubbleManageBtn) bubbleManageBtn.addEventListener('click', openManagePresetsModal);
           if (bubbleModalClose) bubbleModalClose.addEventListener('click', () => {
               document.getElementById('bubble-presets-modal').style.display = 'none';
           });

           // --- 新增代码开始 ---
           if (groupBubbleApplyBtn) groupBubbleApplyBtn.addEventListener('click', () => {
               const selVal = document.getElementById('group-bubble-preset-select').value;
               if (!selVal) return (window.showToast && showToast('请选择要应用的预设')) || alert('请选择要应用的预设');
               applyPresetToCurrentChat(selVal);
           });
           if (groupBubbleSaveBtn) groupBubbleSaveBtn.addEventListener('click', saveCurrentTextareaAsPreset);
           if (groupBubbleManageBtn) groupBubbleManageBtn.addEventListener('click', openManagePresetsModal);
           // --- 新增代码结束 ---

           // My Persona Presets
           const personaSaveBtn = document.getElementById('mypersona-save-btn');
           const personaManageBtn = document.getElementById('mypersona-manage-btn');
           const personaApplyBtn = document.getElementById('mypersona-apply-btn');
           const personaSelect = document.getElementById('mypersona-preset-select');
           const personaModalClose = document.getElementById('mypersona-close-modal');

           if (personaSaveBtn) personaSaveBtn.addEventListener('click', saveCurrentMyPersonaAsPreset);
           if (personaManageBtn) personaManageBtn.addEventListener('click', openManageMyPersonaModal);
           if (personaApplyBtn) personaApplyBtn.addEventListener('click', function(){ const v = personaSelect.value; if(!v) return (window.showToast && showToast('请选择要应用的预设')) || alert('请选择要应用的预设'); applyMyPersonaPresetToCurrentChat(v); });
           if (personaModalClose) personaModalClose.addEventListener('click', function(){ document.getElementById('mypersona-presets-modal').style.display='none'; });

           // Global CSS Presets
           const globalCssModalClose = document.getElementById('global-css-close-modal');
           if (globalCssModalClose) globalCssModalClose.addEventListener('click', () => {
               document.getElementById('global-css-presets-modal').style.display = 'none';
           });
       }

        function setupWallpaperApp() {
            const e = document.getElementById('wallpaper-upload'), t = document.getElementById('wallpaper-preview');
            t.style.backgroundImage = `url(${db.wallpaper})`, t.textContent = '', e.addEventListener('change', async (a) => {
                const n = a.target.files[0];
                if (n) {
                    try {
                        const r = await compressImage(n, {quality: 0.85, maxWidth: 1080, maxHeight: 1920});
                        db.wallpaper = r, applyWallpaper(r), t.style.backgroundImage = `url(${r})`;
                        await saveData();
                        showToast('壁纸更换成功！');
                    } catch (s) {
                        showToast('壁纸压缩失败，请重试');
                    }
                }
            });
        }

        // --- GROUP CHAT FUNCTIONS ---
        function setupGroupChatSystem() {
            createGroupBtn.addEventListener('click', () => {
                renderMemberSelectionList();
                createGroupModal.classList.add('visible');
            });
            createGroupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const selectedMemberIds = Array.from(memberSelectionList.querySelectorAll('input:checked')).map(input => input.value);
                const groupName = groupNameInput.value.trim();
                if (selectedMemberIds.length < 1) return showToast('请至少选择一个群成员。');
                if (!groupName) return showToast('请输入群聊名称。');
                const firstChar = db.characters.length > 0 ? db.characters[0] : null;
                const newGroup = {
                    id: `group_${Date.now()}`,
                    name: groupName,
                    avatar: 'https://i.postimg.cc/fTLCngk1/image.jpg',
                    me: {
                        nickname: firstChar ? firstChar.myName : '我',
                        persona: firstChar ? firstChar.myPersona : '',
                        avatar: firstChar ? firstChar.myAvatar : 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg'
                    },
                    members: selectedMemberIds.map(charId => {
                        const char = db.characters.find(c => c.id === charId);
                        return {
                            id: `member_${char.id}`,
                            originalCharId: char.id,
                            realName: char.realName,
                            groupNickname: char.remarkName,
                            persona: char.persona,
                            avatar: char.avatar
                        };
                    }),
                    theme: 'white_blue',
                    maxMemory: 10,
                    chatBg: '',
                    history: [],
                    isPinned: false,
                    unreadCount: 0,
                    useCustomBubbleCss: false,
                    customBubbleCss: '',
                    worldBookIds: []
                };
                db.groups.push(newGroup);
                await saveData();
                renderChatList();
                createGroupModal.classList.remove('visible');
                showToast(`群聊“${groupName}”创建成功！`);
            });
            groupSettingsForm.addEventListener('submit', e => {
                e.preventDefault();
                saveGroupSettingsFromSidebar();
                groupSettingsSidebar.classList.remove('open');
            });
            const useGroupCustomCssCheckbox = document.getElementById('setting-group-use-custom-css'),
                groupCustomCssTextarea = document.getElementById('setting-group-custom-bubble-css'),
                resetGroupCustomCssBtn = document.getElementById('reset-group-custom-bubble-css-btn'),
                groupPreviewBox = document.getElementById('group-bubble-css-preview');
            useGroupCustomCssCheckbox.addEventListener('change', (e) => {
                groupCustomCssTextarea.disabled = !e.target.checked;
                const group = db.groups.find(g => g.id === currentChatId);
                if (group) {
                    const theme = colorThemes[group.theme || 'white_blue'];
                    updateBubbleCssPreview(groupPreviewBox, groupCustomCssTextarea.value, !e.target.checked, theme);
                }
            });
            groupCustomCssTextarea.addEventListener('input', (e) => {
                const group = db.groups.find(g => g.id === currentChatId);
                if (group && useGroupCustomCssCheckbox.checked) {
                    const theme = colorThemes[group.theme || 'white_blue'];
                    updateBubbleCssPreview(groupPreviewBox, e.target.value, false, theme);
                }
            });
            resetGroupCustomCssBtn.addEventListener('click', () => {
                const group = db.groups.find(g => g.id === currentChatId);
                if (group) {
                    groupCustomCssTextarea.value = '';
                    useGroupCustomCssCheckbox.checked = false;
                    groupCustomCssTextarea.disabled = true;
                    const theme = colorThemes[group.theme || 'white_blue'];
                    updateBubbleCssPreview(groupPreviewBox, '', true, theme);
                    showToast('样式已重置为默认');
                }
            });
            document.getElementById('setting-group-avatar-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, {quality: 0.8, maxWidth: 400, maxHeight: 400});
                        const group = db.groups.find(g => g.id === currentChatId);
                        if (group) {
                            group.avatar = compressedUrl;
                            document.getElementById('setting-group-avatar-preview').src = compressedUrl;
                        }
                    } catch (error) {
                        showToast('群头像压缩失败，请重试');
                    }
                }
            });
            document.getElementById('setting-group-chat-bg-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, {
                            quality: 0.85,
                            maxWidth: 1080,
                            maxHeight: 1920
                        });
                        const group = db.groups.find(g => g.id === currentChatId);
                        if (group) {
                            group.chatBg = compressedUrl;
                            chatRoomScreen.style.backgroundImage = `url(${compressedUrl})`;
                            await saveData();
                            showToast('聊天背景已更换');
                        }
                    } catch (error) {
                        showToast('群聊背景压缩失败，请重试');
                    }
                }
            });
            document.getElementById('clear-group-chat-history-btn').addEventListener('click', async () => {
                const group = db.groups.find(g => g.id === currentChatId);
                if (!group) return;
                if (confirm(`你确定要清空群聊“${group.name}”的所有聊天记录吗？这个操作是不可恢复的！`)) {
                    group.history = [];
                    await saveData();
                    renderMessages(false, true);
                    renderChatList();
                    groupSettingsSidebar.classList.remove('open');
                    showToast('聊天记录已清空');
                }
            });
            groupMembersListContainer.addEventListener('click', e => {
                const memberDiv = e.target.closest('.group-member');
                const addBtn = e.target.closest('.add-member-btn');
                if (memberDiv) {
                    openGroupMemberEditModal(memberDiv.dataset.id);
                } else if (addBtn) {
                    addMemberActionSheet.classList.add('visible');
                }
            });
            document.getElementById('edit-member-avatar-preview').addEventListener('click', () => {
                document.getElementById('edit-member-avatar-upload').click();
            });
            document.getElementById('edit-member-avatar-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, {quality: 0.8, maxWidth: 400, maxHeight: 400});
                        document.getElementById('edit-member-avatar-preview').src = compressedUrl;
                    } catch (error) {
                        showToast('成员头像压缩失败，请重试');
                    }
                }
            });
            editGroupMemberForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const memberId = document.getElementById('editing-member-id').value;
                const group = db.groups.find(g => g.id === currentChatId);
                const member = group.members.find(m => m.id === memberId);
                if (member) {
                    member.avatar = document.getElementById('edit-member-avatar-preview').src;
                    member.groupNickname = document.getElementById('edit-member-group-nickname').value;
                    member.realName = document.getElementById('edit-member-real-name').value;
                    member.persona = document.getElementById('edit-member-persona').value;
                    await saveData();
                    renderGroupMembersInSettings(group);
                    document.querySelectorAll(`.message-wrapper[data-sender-id="${member.id}"] .group-nickname`).forEach(el => {
                        el.textContent = member.groupNickname;
                    });
                    showToast('成员信息已更新');
                }
                editGroupMemberModal.classList.remove('visible');
            });
            inviteExistingMemberBtn.addEventListener('click', () => {
                renderInviteSelectionList();
                inviteMemberModal.classList.add('visible');
                addMemberActionSheet.classList.remove('visible');
            });
            createNewMemberBtn.addEventListener('click', () => {
                createMemberForGroupForm.reset();
                document.getElementById('create-group-member-avatar-preview').src = 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg';
                createMemberForGroupModal.classList.add('visible');
                addMemberActionSheet.classList.remove('visible');
            });
            document.getElementById('create-group-member-avatar-preview').addEventListener('click', () => {
                document.getElementById('create-group-member-avatar-upload').click();
            });
            document.getElementById('create-group-member-avatar-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, {quality: 0.8, maxWidth: 400, maxHeight: 400});
                        document.getElementById('create-group-member-avatar-preview').src = compressedUrl;
                    } catch (error) {
                        showToast('新成员头像压缩失败，请重试');
                    }
                }
            });
            confirmInviteBtn.addEventListener('click', async () => {
                const group = db.groups.find(g => g.id === currentChatId);
                if (!group) return;
                const selectedCharIds = Array.from(inviteMemberSelectionList.querySelectorAll('input:checked')).map(input => input.value);
                selectedCharIds.forEach(charId => {
                    const char = db.characters.find(c => c.id === charId);
                    if (char) {
                        const newMember = {
                            id: `member_${char.id}`,
                            originalCharId: char.id,
                            realName: char.realName,
                            groupNickname: char.remarkName,
                            persona: char.persona,
                            avatar: char.avatar
                        };
                        group.members.push(newMember);
                        sendInviteNotification(group, newMember.realName);
                    }
                });
                if (selectedCharIds.length > 0) {
                    await saveData();
                    renderGroupMembersInSettings(group);
                    renderMessages(false, true);
                    showToast('已邀请新成员');
                }
                inviteMemberModal.classList.remove('visible');
            });
            createMemberForGroupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const group = db.groups.find(g => g.id === currentChatId);
                if (!group) return;
                const newMember = {
                    id: `member_group_only_${Date.now()}`,
                    originalCharId: null,
                    realName: document.getElementById('create-group-member-realname').value,
                    groupNickname: document.getElementById('create-group-member-nickname').value,
                    persona: document.getElementById('create-group-member-persona').value,
                    avatar: document.getElementById('create-group-member-avatar-preview').src,
                };
                group.members.push(newMember);
                sendInviteNotification(group, newMember.realName);
                await saveData();
                renderGroupMembersInSettings(group);
                renderMessages(false, true);
                showToast(`新成员 ${newMember.groupNickname} 已加入`);
                createMemberForGroupModal.classList.remove('visible');
            });
            document.getElementById('setting-group-my-avatar-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, {quality: 0.8, maxWidth: 400, maxHeight: 400});
                        document.getElementById('setting-group-my-avatar-preview').src = compressedUrl;
                    } catch (error) {
                        showToast('头像压缩失败')
                    }
                }
            });
            confirmGroupRecipientBtn.addEventListener('click', () => {
                const selectedRecipientIds = Array.from(groupRecipientSelectionList.querySelectorAll('input:checked')).map(input => input.value);
                if (selectedRecipientIds.length === 0) {
                    return showToast('请至少选择一个收件人。');
                }
                currentGroupAction.recipients = selectedRecipientIds;
                groupRecipientSelectionModal.classList.remove('visible');

                if (currentGroupAction.type === 'transfer') {
                    sendTransferForm.reset();
                    sendTransferModal.classList.add('visible');
                } else if (currentGroupAction.type === 'gift') {
                    sendGiftForm.reset();
                    sendGiftModal.classList.add('visible');
                }
            });
            linkGroupWorldBookBtn.addEventListener('click', () => {
                const group = db.groups.find(g => g.id === currentChatId);
                if (!group) return;
                renderCategorizedWorldBookList(worldBookSelectionList, db.worldBooks, group.worldBookIds || [], 'wb-select-group');
                worldBookSelectionModal.classList.add('visible');
            });
        }

        function renderMemberSelectionList() {
            memberSelectionList.innerHTML = '';
            if (db.characters.length === 0) {
                memberSelectionList.innerHTML = '<li style="color:#aaa; text-align:center; padding: 10px 0;">没有可选择的人设。</li>';
                return;
            }
            db.characters.forEach(char => {
                const li = document.createElement('li');
                li.className = 'member-selection-item';
                li.innerHTML = `<input type="checkbox" id="select-${char.id}" value="${char.id}"><img src="${char.avatar}" alt="${char.remarkName}"><label for="select-${char.id}">${char.remarkName}</label>`;
                memberSelectionList.appendChild(li);
            });
        }

        function loadGroupSettingsToSidebar() {
            const group = db.groups.find(g => g.id === currentChatId);
            if (!group) return;
            const themeSelect = document.getElementById('setting-group-theme-color');
            if (themeSelect.options.length === 0) {
                Object.keys(colorThemes).forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = colorThemes[key].name;
                    themeSelect.appendChild(option);
                });
            }
            document.getElementById('setting-group-avatar-preview').src = group.avatar;
            document.getElementById('setting-group-name').value = group.name;
            document.getElementById('setting-group-my-avatar-preview').src = group.me.avatar;
            document.getElementById('setting-group-my-nickname').value = group.me.nickname;
            document.getElementById('setting-group-my-persona').value = group.me.persona;
            themeSelect.value = group.theme || 'white_blue';
            document.getElementById('setting-group-max-memory').value = group.maxMemory;
            renderGroupMembersInSettings(group);
            const useGroupCustomCssCheckbox = document.getElementById('setting-group-use-custom-css'),
                groupCustomCssTextarea = document.getElementById('setting-group-custom-bubble-css'),
                groupPreviewBox = document.getElementById('group-bubble-css-preview');
            useGroupCustomCssCheckbox.checked = group.useCustomBubbleCss || false;
            groupCustomCssTextarea.value = group.customBubbleCss || '';
            groupCustomCssTextarea.disabled = !useGroupCustomCssCheckbox.checked;
            const theme = colorThemes[group.theme || 'white_blue'];
            updateBubbleCssPreview(groupPreviewBox, group.customBubbleCss, !group.useCustomBubbleCss, theme);
            populateBubblePresetSelect('group-bubble-preset-select');
        }

        function renderGroupMembersInSettings(group) {
            groupMembersListContainer.innerHTML = '';
            group.members.forEach(member => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'group-member';
                memberDiv.dataset.id = member.id;
                memberDiv.innerHTML = `<img src="${member.avatar}" alt="${member.groupNickname}"><span>${member.groupNickname}</span>`;
                groupMembersListContainer.appendChild(memberDiv);
            });
            const addBtn = document.createElement('div');
            addBtn.className = 'add-member-btn';
            addBtn.innerHTML = `<div class="add-icon">+</div><span>添加</span>`;
            groupMembersListContainer.appendChild(addBtn);
        }

        function renderGroupRecipientSelectionList(actionText) {
            const group = db.groups.find(g => g.id === currentChatId);
            if (!group) return;
            groupRecipientSelectionTitle.textContent = actionText;
            groupRecipientSelectionList.innerHTML = '';
            group.members.forEach(member => {
                const li = document.createElement('li');
                li.className = 'group-recipient-select-item';
                li.innerHTML = `
                        <input type="checkbox" id="recipient-select-${member.id}" value="${member.id}">
                        <label for="recipient-select-${member.id}">
                            <img src="${member.avatar}" alt="${member.groupNickname}">
                            <span>${member.groupNickname}</span>
                        </label>`;
                groupRecipientSelectionList.appendChild(li);
            });
        }

        async function saveGroupSettingsFromSidebar() {
            const group = db.groups.find(g => g.id === currentChatId);
            if (!group) return;
            const oldName = group.name;
            const newName = document.getElementById('setting-group-name').value;
            if (oldName !== newName) {
                group.name = newName;
                sendRenameNotification(group, newName);
            }
            group.avatar = document.getElementById('setting-group-avatar-preview').src;
            group.me.avatar = document.getElementById('setting-group-my-avatar-preview').src;
            group.me.nickname = document.getElementById('setting-group-my-nickname').value;
            group.me.persona = document.getElementById('setting-group-my-persona').value;
            group.theme = document.getElementById('setting-group-theme-color').value;
            group.maxMemory = document.getElementById('setting-group-max-memory').value;
            group.useCustomBubbleCss = document.getElementById('setting-group-use-custom-css').checked;
            group.customBubbleCss = document.getElementById('setting-group-custom-bubble-css').value;
            updateCustomBubbleStyle(currentChatId, group.customBubbleCss, group.useCustomBubbleCss);
            await saveData();
            showToast('群聊设置已保存！');
            chatRoomTitle.textContent = group.name;
            renderChatList();
            renderMessages(false, true);
        }

        function openGroupMemberEditModal(memberId) {
            const group = db.groups.find(g => g.id === currentChatId);
            const member = group.members.find(m => m.id === memberId);
            if (!member) return;
            document.getElementById('edit-group-member-title').textContent = `编辑 ${member.groupNickname}`;
            document.getElementById('editing-member-id').value = member.id;
            document.getElementById('edit-member-avatar-preview').src = member.avatar;
            document.getElementById('edit-member-group-nickname').value = member.groupNickname;
            document.getElementById('edit-member-real-name').value = member.realName;
            document.getElementById('edit-member-persona').value = member.persona;
            editGroupMemberModal.classList.add('visible');
        }

        function renderInviteSelectionList() {
            inviteMemberSelectionList.innerHTML = '';
            const group = db.groups.find(g => g.id === currentChatId);
            if (!group) return;
            const currentMemberCharIds = new Set(group.members.map(m => m.originalCharId));
            const availableChars = db.characters.filter(c => !currentMemberCharIds.has(c.id));
            if (availableChars.length === 0) {
                inviteMemberSelectionList.innerHTML = '<li style="color:#aaa; text-align:center; padding: 10px 0;">没有可邀请的新成员了。</li>';
                confirmInviteBtn.disabled = true;
                return;
            }
            confirmInviteBtn.disabled = false;
            availableChars.forEach(char => {
                const li = document.createElement('li');
                li.className = 'invite-member-select-item';
                li.innerHTML = `<input type="checkbox" id="invite-select-${char.id}" value="${char.id}"><label for="invite-select-${char.id}"><img src="${char.avatar}" alt="${char.remarkName}"><span>${char.remarkName}</span></label>`;
                inviteMemberSelectionList.appendChild(li);
            });
        }

        function sendInviteNotification(group, newMemberRealName) {
            const messageContent = `[${group.me.nickname}邀请${newMemberRealName}加入了群聊]`;
            const message = {
                id: `msg_${Date.now()}`,
                role: 'user',
                content: messageContent,
                parts: [{type: 'text', text: messageContent}],
                timestamp: Date.now(),
                senderId: 'user_me'
            };
            group.history.push(message);
        }

        function sendRenameNotification(group, newName) {
            const myName = group.me.nickname;
            const messageContent = `[${myName}修改群名为：${newName}]`;
            const message = {
                id: `msg_${Date.now()}`,
                role: 'user',
                content: messageContent,
                parts: [{type: 'text', text: messageContent}],
                timestamp: Date.now()
            };
            group.history.push(message);
        }



        // 创建完整的备份数据
        async function createFullBackupData() {
            // The db object is already in memory, so we just need to clone it.
            // A deep clone is necessary to avoid any potential mutation issues.
            const backupData = JSON.parse(JSON.stringify(db));
            
            // Add export metadata
            backupData._exportVersion = '3.0'; // New version that uses multi-table Dexie
            backupData._exportTimestamp = Date.now();

            return backupData;
        }

        // 导入备份数据
        async function importBackupData(data) {
            const startTime = Date.now();
            try {
                // 1. Clear all existing data using the new storage system
                await Promise.all([
                    dexieDB.characters.clear(),
                    dexieDB.groups.clear(),
                    dexieDB.worldBooks.clear(),
                    dexieDB.myStickers.clear(),
                    dexieDB.globalSettings.clear()
                ]);
                showToast('正在清空旧数据...');

                let convertedData = data;

                // 2. Perform version check and compatibility conversion (this logic is good)
                if (data._exportVersion !== '3.0') {
                    showToast('检测到旧版备份文件，正在转换格式...');
                    
                    const reassembleHistory = (chat, backupData) => {
                        if (!chat.history || !Array.isArray(chat.history) || chat.history.length === 0) {
                            return [];
                        }
                        // If the first item is an object, it's a full history array.
                        if (typeof chat.history[0] === 'object' && chat.history[0] !== null) {
                            return chat.history;
                        }
                        // This part handles a very old chunked format, good to keep for compatibility.
                        if (backupData.__chunks__ && typeof chat.history[0] === 'string') {
                            let fullHistory = [];
                            chat.history.forEach(key => {
                                if (backupData.__chunks__[key]) {
                                    try {
                                        const chunk = JSON.parse(backupData.__chunks__[key]);
                                        fullHistory = fullHistory.concat(chunk);
                                    } catch (e) {
                                        console.error(`Failed to parse history chunk ${key}`, e);
                                    }
                                }
                            });
                            return fullHistory;
                        }
                        return []; // Unrecognized format
                    };

                    const newData = { ...data };

                    if (newData.characters) {
                        newData.characters = newData.characters.map(char => ({
                            ...char,
                            history: reassembleHistory(char, data)
                        }));
                    }
                    if (newData.groups) {
                        newData.groups = newData.groups.map(group => ({
                            ...group,
                            history: reassembleHistory(group, data)
                        }));
                    }
                    
                    convertedData = newData;
                }

                // 3. Overwrite the in-memory db object with the imported data
                Object.keys(db).forEach(key => {
                    if (convertedData[key] !== undefined) {
                        db[key] = convertedData[key];
                    }
                });
                // Ensure new properties exist if they were not in the backup
                if (!db.pomodoroTasks) db.pomodoroTasks = [];
                if (!db.pomodoroSettings) db.pomodoroSettings = { boundCharId: null, userPersona: '', focusBackground: '', taskCardBackground: '', encouragementMinutes: 25, pokeLimit: 5, globalWorldBookIds: [] };
                if (!db.insWidgetSettings) db.insWidgetSettings = { avatar1: 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg', bubble1: 'love u.', avatar2: 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg', bubble2: 'miss u.' };
                if (!db.homeWidgetSettings) db.homeWidgetSettings = JSON.parse(JSON.stringify(defaultWidgetSettings));


                // 4. Call the new saveData function which handles the new DB schema
                showToast('正在写入新数据...');
                await saveData(db);

                const duration = Date.now() - startTime;
                const message = `导入完成 (耗时${duration}ms)`;
                
                return { success: true, message: message };

            } catch (error) {
                console.error('导入数据失败:', error);
                return {
                    success: false,
                    error: error.message,
                    duration: Date.now() - startTime
                };
            }
        }
        
        // --- 喵坛新增：底部导航栏逻辑 ---
function setupBottomNavigation() {
    const navs = document.querySelectorAll('.bottom-tab-bar');
    
    navs.forEach(nav => {
        nav.addEventListener('click', (e) => {
            // 找到被点击的图标容器
            const tab = e.target.closest('.tab-item');
            if (tab) {
                const targetScreenId = tab.dataset.target;
                
                // 1. 切换屏幕 (使用 switchScreen 但不重置状态，或者手动切换 class)
                // 这里手动切换以保持三个页面状态共存的感觉
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(targetScreenId).classList.add('active');

                // 2. 更新所有页面底部的导航栏激活状态
                document.querySelectorAll('.bottom-tab-bar .tab-item').forEach(t => {
                    if (t.dataset.target === targetScreenId) {
                        t.classList.add('active');
                    } else {
                        t.classList.remove('active');
                    }
                });
            }
        });
    });
}

// --- 新增：“我”页面逻辑 ---
function setupMePageFeature() {
    // 页面元素
    const nicknameInput = document.getElementById('me-nickname-input');
    const avatarInputHidden = document.getElementById('me-avatar-input'); // 隐藏的 input 用于存 URL
    const personaInput = document.getElementById('me-persona-input');
    const saveBtn = document.getElementById('me-save-btn');
    const avatarImg = document.getElementById('me-avatar-img');
    const avatarTrigger = document.getElementById('me-avatar-trigger');

    // 弹窗元素
    const modal = document.getElementById('me-avatar-modal');
    const modalForm = document.getElementById('me-avatar-form');
    const modalPreview = document.getElementById('me-avatar-preview-modal');
    const modalUrlInput = document.getElementById('me-avatar-url-input-modal');
    const modalFileUpload = document.getElementById('me-avatar-file-upload-modal');
    
    // --- 修改点：不再获取取消按钮 ---

    // 辅助：简单的图片压缩
    const compressImage = async (file, { maxWidth, maxHeight, quality }) => {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = event => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    let width = img.width;
                    let height = img.height;
                    if (width > height) {
                        if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                    } else {
                        if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; }
                    }
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = error => reject(error);
            };
            reader.onerror = error => reject(error);
        });
    };

    // 1. 初始化加载数据
    function loadMeData() {
        const identity = db.forumUserIdentity || { 
            nickname: '新用户', 
            avatar: 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg', 
            persona: '' 
        };
        
        if (nicknameInput) nicknameInput.value = identity.nickname || '';
        if (avatarInputHidden) avatarInputHidden.value = identity.avatar || '';
        if (personaInput) personaInput.value = identity.persona || '';
        if (avatarImg && identity.avatar) avatarImg.src = identity.avatar;
    }

    // 2. 点击头像打开弹窗
    if (avatarTrigger) {
        avatarTrigger.addEventListener('click', () => {
            // 初始化弹窗状态：显示当前头像
            const currentSrc = avatarInputHidden.value || avatarImg.src;
            modalPreview.style.backgroundImage = `url("${currentSrc}")`;
            modalPreview.innerHTML = '';
            modalUrlInput.value = '';
            modalFileUpload.value = null;
            
            modal.classList.add('visible');
        });
    }

    // 3. 弹窗逻辑：URL 输入预览
    modalUrlInput.addEventListener('input', () => {
        const url = modalUrlInput.value.trim();
        if (url) {
            modalPreview.style.backgroundImage = `url("${url}")`;
            modalPreview.innerHTML = '';
        } else {
            modalPreview.style.backgroundImage = 'none';
            modalPreview.innerHTML = '<span>预览</span>';
        }
    });

    // 4. 弹窗逻辑：文件上传预览
    modalFileUpload.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
            try {
                // 使用压缩
                const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 300, maxHeight: 300 });
                modalPreview.style.backgroundImage = `url("${compressedUrl}")`;
                modalPreview.innerHTML = '';
                modalUrlInput.value = ''; // 如果用了文件，清空 URL 输入框
            } catch (error) {
                showToast('图片处理失败');
                console.error(error);
            }
        }
    });

    // 5. 弹窗逻辑：确认更换
    modalForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const bgImage = modalPreview.style.backgroundImage;
        
        // 解析 url("...") 格式
        let newSrc = '';
        if (bgImage && bgImage !== 'none') {
            newSrc = bgImage.slice(5, -2); // remove url(" and ")
        }

        if (newSrc) {
            // 更新“我”页面的显示和隐藏 input，但不立即存 DB
            avatarImg.src = newSrc;
            avatarInputHidden.value = newSrc;
            modal.classList.remove('visible');
        } else {
            // 如果没选图片（比如清空了），也可以允许关闭，或者提示
            // 这里逻辑改为：如果不选图直接点确定，视为放弃修改/保持原样（因为默认会加载原图）
            // 但如果用户手动清除了预览，则可能需要提示。
            // 简单起见，如果 newSrc 为空，我们直接关闭弹窗不做改变，或者提示。
            // 鉴于初始化时会加载原图，如果为空说明用户特意清空了 URL。
            // 保持原逻辑：
            showToast('请先选择图片');
        }
    });

    // --- 修改点：已移除取消按钮的监听器 ---
    // 点击遮罩层关闭（可选，为了防止用户不知道怎么关）
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.classList.remove('visible');
        }
    });

    // 7. “我”页面主保存按钮：保存所有信息到 DB
    if (saveBtn) {
        saveBtn.addEventListener('click', async () => {
            db.forumUserIdentity = {
                nickname: nicknameInput.value.trim() || '新用户',
                avatar: avatarInputHidden.value.trim() || 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg',
                persona: personaInput.value.trim()
            };
            
            await saveData();
            showToast('个人设置已保存');
            
            // 刷新其他地方的显示
            if(typeof updateReplyAuthorSelect === 'function') {
                updateReplyAuthorSelect(); 
            }
        });
    }

    // 初始化加载
    loadMeData();
}


        
function setupForumBindingFeature() {
    const worldBookList = document.getElementById('forum-worldbook-list');
    const charList = document.getElementById('forum-char-list');
    const saveBtn = document.getElementById('world-save-btn');
    
    // 获取关联记忆相关的 DOM
    let historyToggle = document.getElementById('world-use-history-toggle');
    const historyLimitInput = document.getElementById('world-history-limit');
    
    // 获取跳转按钮
    const jumpBtn = document.getElementById('jump-to-wb-edit-btn');

    const tabs = document.querySelectorAll('.world-sidebar-btn');
    const panes = document.querySelectorAll('.world-tab-pane');

    // 1. Tab 切换逻辑
    tabs.forEach(tab => {
        const newTab = tab.cloneNode(true);
        tab.parentNode.replaceChild(newTab, tab);
        
        newTab.addEventListener('click', () => {
            document.querySelectorAll('.world-sidebar-btn').forEach(t => t.classList.remove('active'));
            newTab.classList.add('active');

            const targetId = newTab.dataset.tab === 'wb' ? 'world-tab-wb' : 'world-tab-char';
            panes.forEach(pane => pane.classList.remove('active'));
            document.getElementById(targetId).classList.add('active');
        });
    });

    // 2. 跳转按钮逻辑
    if(jumpBtn) {
        const newJumpBtn = jumpBtn.cloneNode(true);
        jumpBtn.parentNode.replaceChild(newJumpBtn, jumpBtn);
        
        newJumpBtn.addEventListener('click', () => {
             showToast('已前往“世界书”页面');
             if(typeof renderWorldBookList === 'function') {
                 renderWorldBookList();
             }
             switchScreen('world-book-screen');             
        });
    }

    // 辅助函数：控制输入框的“视觉显隐”
    const setInputVisibility = (visible) => {
        if (!historyLimitInput) return;
        if (visible) {
            // 显示：完全不透明，允许鼠标交互
            historyLimitInput.style.opacity = '1';
            historyLimitInput.style.pointerEvents = 'auto';
        } else {
            // 隐藏：完全透明，禁止鼠标交互（占位但不响应）
            historyLimitInput.style.opacity = '0';
            historyLimitInput.style.pointerEvents = 'none';
        }
    };

    // 3. 记忆开关监听逻辑
    if(historyToggle) {
        const newToggle = historyToggle.cloneNode(true);
        historyToggle.parentNode.replaceChild(newToggle, historyToggle);
        historyToggle = newToggle; // 更新引用

        newToggle.addEventListener('change', (e) => {
            // 使用新逻辑控制显隐
            setInputVisibility(e.target.checked);
        });
    }

    // 4. 定义渲染列表函数
    function renderWorldPageList() {
        if (!worldBookList || !charList) return;

        // 获取当前数据
        const currentBindings = db.forumBindings || { worldBookIds: [], charIds: [], useChatHistory: false, historyLimit: 50 };

        // --- 设置开关状态及输入框显隐 ---
        if(historyToggle) {
            historyToggle.checked = !!currentBindings.useChatHistory;
            
            if(historyLimitInput) {
                // 初始化时的显隐状态
                setInputVisibility(historyToggle.checked);
                historyLimitInput.value = currentBindings.historyLimit || 50;
            }
        }

        // --- 填充世界书列表 ---
        worldBookList.innerHTML = '';
        if (typeof renderCategorizedWorldBookList === 'function') {
            renderCategorizedWorldBookList(worldBookList, db.worldBooks, currentBindings.worldBookIds, 'wb-bind');
        } else {
            db.worldBooks.forEach(wb => {
                const li = document.createElement('li');
                li.className = 'binding-list-item';
                const isChecked = currentBindings.worldBookIds.includes(wb.id);
                li.innerHTML = `
                    <input type="checkbox" class="item-checkbox" id="wb-bind-${wb.id}" value="${wb.id}" ${isChecked ? 'checked' : ''}>
                    <label for="wb-bind-${wb.id}">${wb.name}</label>
                `;
                worldBookList.appendChild(li);
            });
        }

        // --- 填充角色列表 ---
        charList.innerHTML = '';
        if (db.characters.length > 0) {
            db.characters.forEach(char => {
                const isChecked = currentBindings.charIds.includes(char.id);
                const li = document.createElement('li');
                li.className = 'binding-list-item';
                li.innerHTML = `
                    <input type="checkbox" class="char-checkbox" id="char-bind-${char.id}" value="${char.id}" ${isChecked ? 'checked' : ''}>
                    <label for="char-bind-${char.id}" style="display: flex; align-items: center;">
                        <img src="${char.avatar}" style="width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; object-fit:cover;">
                        ${char.remarkName}
                    </label>
                `;
                charList.appendChild(li);
            });
        } else {
            charList.innerHTML = '<li style="padding:10px; color:#999; font-size:14px;">暂无角色</li>';
        }
    }

    // 5. 保存按钮逻辑
    if (saveBtn) {
        const newSaveBtn = saveBtn.cloneNode(true);
        saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

        newSaveBtn.addEventListener('click', async () => {
            const currentToggle = document.getElementById('world-use-history-toggle');
            const currentLimitInput = document.getElementById('world-history-limit');
            
            const selectedWorldBookIds = Array.from(worldBookList.querySelectorAll('.item-checkbox:checked')).map(input => input.value);
            const selectedCharIds = Array.from(charList.querySelectorAll('.char-checkbox:checked')).map(input => input.value);
            
            const useHistory = currentToggle ? currentToggle.checked : false;
            
            let limit = 50;
            if(currentLimitInput) {
                limit = parseInt(currentLimitInput.value);
                if(isNaN(limit)) limit = 50;
                if(limit > 500) {
                    limit = 500;
                    currentLimitInput.value = 500;
                    showToast('关联条数最大限制为500');
                }
            }

            db.forumBindings = {
                worldBookIds: selectedWorldBookIds,
                charIds: selectedCharIds,
                userPersonaIds: db.forumBindings ? db.forumBindings.userPersonaIds : [],
                useChatHistory: useHistory,
                historyLimit: limit
            };

            await saveData();
            showToast('世界设定已保存');
        });
    }

    window.refreshWorldPageList = renderWorldPageList;
    renderWorldPageList();

    const worldScreen = document.getElementById('world-screen');
    if (worldScreen && !worldScreen.dataset.observerAttached) {
        const observer = new MutationObserver((mutations) => {
            for (let mutation of mutations) {
                if (mutation.attributeName === 'class') {
                    if (worldScreen.classList.contains('active')) {
                        renderWorldPageList();
                    }
                }
            }
        });
        observer.observe(worldScreen, { attributes: true });
        worldScreen.dataset.observerAttached = "true";
    }
}


function renderHotPosts() {
    const container = document.getElementById('hot-posts-section');
    const list = document.getElementById('hot-posts-list');
    if (!container || !list) return;

    if (!db.forumPosts || db.forumPosts.length === 0) {
        container.style.display = 'none';
        return;
    }

    const now = Date.now();
    const oneDayAgo = now - 24 * 60 * 60 * 1000;

    const activePosts = db.forumPosts.filter(p => {
        const postTime = p.timestamp || 0;
        if (postTime > oneDayAgo) return true;
        
        if (p.comments && p.comments.length > 0) {
            const lastComment = p.comments[p.comments.length - 1];
            const commentTime = new Date(lastComment.timestamp).getTime();
            if (!isNaN(commentTime) && commentTime > oneDayAgo) return true;
        }
        return false;
    });

    if (activePosts.length === 0) {
        container.style.display = 'none';
        return;
    }

    activePosts.sort((a, b) => (b.comments ? b.comments.length : 0) - (a.comments ? a.comments.length : 0));
    const top3 = activePosts.slice(0, 3);

    list.innerHTML = '';
    top3.forEach((post, index) => {
        const item = document.createElement('div');
        item.className = 'hot-post-item';
        item.onclick = () => {
            currentSourceScreen = 'forum-screen';
            renderPostDetail(post);
            switchScreen('forum-post-detail-screen');
            const detailContent = document.querySelector('#forum-post-detail-screen .detail-content-area');
            if (detailContent) detailContent.scrollTop = 0;
        };

        const rankClass = `rank-${index + 1}`;
        const cleanTitle = post.title.replace(/^\[New!\]\s*/, '').replace(/^【新】/, '');
        // 修改：精确到秒
        const timeStr = new Date(post.timestamp).toLocaleString(); 

        item.innerHTML = `
            <div class="rank-badge ${rankClass}">${index + 1}</div>
            <div class="hot-post-info">
                <div class="hot-post-title">${cleanTitle}</div>
                <div class="hot-post-meta-row">
                    <span>${post.username}</span>
                    <span>评论 ${post.comments ? post.comments.length : 0}</span>
                    <span>${timeStr}</span>
                </div>
            </div>
        `;
        list.appendChild(item);
    });

    container.style.display = 'block';
}






function setupFavoritesFeature() {
    const listContainer = document.getElementById('favorites-list-container');
    const manageBtn = document.getElementById('fav-manage-btn');
    const actionsBar = document.getElementById('fav-manage-actions');
    const deleteBtn = document.getElementById('fav-delete-confirm-btn');
    let isManageMode = false;

    window.renderFavoritesList = function() {
        if (!listContainer) return;
        listContainer.innerHTML = '';
        
        const favIds = db.favoritePostIds || [];
        
        if (favIds.length === 0) {
            listContainer.innerHTML = '<p class="placeholder-text" style="margin-top:50px;">暂无收藏内容</p>';
            return;
        }

        const displayIds = [...favIds].reverse();

        displayIds.forEach(id => {
            const post = db.forumPosts.find(p => p.id === id);
            if (!post) return; 

            const card = document.createElement('div');
            card.className = 'fav-post-card';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'fav-checkbox';
            checkbox.value = id;
            if (isManageMode) checkbox.style.display = 'block';
            else checkbox.style.display = 'none';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'fav-post-content';
            contentDiv.style.cursor = 'pointer';
            
            const title = post.title.replace(/^\[New!\]\s*/, '').replace(/^【新】/, '');
            // 修改：精确到秒
            const timeStr = new Date(post.timestamp).toLocaleString(); 

            // 布局：标题 + 底部两端对齐
            contentDiv.innerHTML = `
                <div class="fav-post-title">${title}</div>
                <div class="fav-post-meta">
                    <span>${post.username}</span>
                    <span>${timeStr}</span>
                </div>
            `;
            
            contentDiv.onclick = (e) => {
                if (isManageMode) {
                    checkbox.checked = !checkbox.checked;
                } else {
                    currentSourceScreen = 'favorites-screen';
                    renderPostDetail(post);
                    switchScreen('forum-post-detail-screen');
                    const detailContent = document.querySelector('#forum-post-detail-screen .detail-content-area');
                    if (detailContent) detailContent.scrollTop = 0;
                }
            };

            if (isManageMode) {
                 checkbox.style.marginRight = '10px';
                 card.prepend(checkbox);
            } else {
                 card.appendChild(checkbox);
            }
            card.appendChild(contentDiv);
            listContainer.appendChild(card);
        });
    };

    // 切换管理模式
    const newManageBtn = manageBtn.cloneNode(true);
    manageBtn.parentNode.replaceChild(newManageBtn, manageBtn);

    newManageBtn.addEventListener('click', () => {
        isManageMode = !isManageMode;
        
        if (isManageMode) {
            listContainer.classList.add('manage-mode'); // 增加底部 padding
            actionsBar.style.display = 'flex';
            // 修改：图标变红
            newManageBtn.style.color = '#ff4444'; 
            renderFavoritesList();
        } else {
            listContainer.classList.remove('manage-mode'); // 恢复正常 padding
            actionsBar.style.display = 'none';
            // 修改：恢复颜色
            newManageBtn.style.color = ''; 
            renderFavoritesList();
        }
    });

    // 批量删除 (保持不变)
    const newDeleteBtn = deleteBtn.cloneNode(true);
    deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);

    newDeleteBtn.addEventListener('click', async () => {
        const checked = document.querySelectorAll('.fav-checkbox:checked');
        if (checked.length === 0) return;

        if (confirm(`确定取消收藏这 ${checked.length} 个帖子吗？`)) {
            const idsToRemove = Array.from(checked).map(cb => cb.value);
            db.favoritePostIds = db.favoritePostIds.filter(id => !idsToRemove.includes(id));
            await saveData();
            renderFavoritesList();
            showToast('已取消收藏');
            newManageBtn.click();
        }
    });

    renderFavoritesList();
}


    // --- 修改部分 1：详情页渲染 (统一头像颜色) ---
function renderPostDetail(post) {
    db.currentViewingPostId = post.id;
    
    // 1. 设置返回按钮目标
    const backBtn = document.querySelector('#forum-post-detail-screen .back-btn');
    if (backBtn) {
        backBtn.dataset.target = currentSourceScreen || 'forum-screen';
    }

    const titleEl = document.getElementById('d-post-title');
    const contentEl = document.getElementById('d-post-content');
    const avatarEl = document.getElementById('d-author-avatar');
    const nameEl = document.getElementById('d-author-name');
    const timeEl = document.getElementById('d-post-time');
    const likeEl = document.getElementById('d-like-count');
    const commentCountEl = document.getElementById('d-comment-count');
    const commentListEl = document.getElementById('detail-comment-list');
    const commentHeaderEl = document.querySelector('.comments-header');
    
    // 星标按钮逻辑
    const starBtn = document.getElementById('detail-star-btn');
    if (starBtn) {
        const isFav = (db.favoritePostIds || []).includes(post.id);
        if (isFav) starBtn.classList.add('active');
        else starBtn.classList.remove('active');

        const newStarBtn = starBtn.cloneNode(true);
        starBtn.parentNode.replaceChild(newStarBtn, starBtn);
        
        newStarBtn.addEventListener('click', async () => {
            if (!db.favoritePostIds) db.favoritePostIds = [];
            const index = db.favoritePostIds.indexOf(post.id);
            if (index === -1) {
                db.favoritePostIds.push(post.id);
                newStarBtn.classList.add('active');
                showToast('已收藏');
            } else {
                db.favoritePostIds.splice(index, 1);
                newStarBtn.classList.remove('active');
                showToast('已取消收藏');
            }
            await saveData();
            if (typeof renderFavoritesList === 'function') renderFavoritesList();
        });
    }

    const myIdentity = db.forumUserIdentity || { nickname: '我', avatar: '' };

    // 标题处理
    let displayTitle = post.title;
    if (displayTitle.startsWith('[New!] ')) displayTitle = displayTitle.substring(7);
    else if (displayTitle.startsWith('【新】')) displayTitle = displayTitle.substring(3);
    titleEl.textContent = displayTitle;

    // --- 正文处理 (Markdown + 强制分段 + 自动对话高亮) ---
    if (post.content) {
        contentEl.className = 'post-detail-content-body markdown-content';
        
        let raw = post.content || '';
        
        // 1. 清洗换行符
        raw = raw.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

        // 2. 按行拆分
        const lines = raw.split('\n');
        
        const htmlParts = lines.map(line => {
            const text = line.trim();
            if (!text) return ''; 
            
            // 先解析 Markdown 生成 <p> 标签
            let html = marked.parse(text);
            
            // 【核心修改】：正则匹配中文引号内容，添加高亮样式
            // 匹配 “任意内容”
            html = html.replace(/(“[^”]*”)/g, '<span class="inline-quote">$1</span>');
            
            return html;
        });

        // 3. 拼接
        contentEl.innerHTML = htmlParts.join('');

    } else {
        contentEl.innerHTML = '';
    }
    // ----------------------------------------------------

    nameEl.textContent = post.username;
    timeEl.textContent = new Date(post.timestamp || Date.now()).toLocaleString();
    likeEl.textContent = post.likeCount || 0;
    
    const commentLen = post.comments ? post.comments.length : 0;
    commentCountEl.textContent = commentLen;
    if(commentHeaderEl) commentHeaderEl.textContent = `全部评论 (${commentLen})`;
    
    // 头像逻辑
    avatarEl.innerHTML = '';
    avatarEl.style.backgroundColor = '';
    let displayAvatar = post.avatar;
    if (post.isUser || (post.username === myIdentity.nickname && myIdentity.nickname !== '一只喵叽')) {
        displayAvatar = myIdentity.avatar || 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg';
    }

    if (displayAvatar) {
        const img = document.createElement('img');
        img.src = displayAvatar;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.borderRadius = '50%';
        img.style.objectFit = 'cover';
        avatarEl.appendChild(img);
        avatarEl.style.backgroundColor = 'transparent'; 
    } else {
        const firstChar = post.username ? post.username.charAt(0).toUpperCase() : '?';
        avatarEl.textContent = firstChar;
        avatarEl.style.backgroundColor = 'var(--primary-color)'; 
        avatarEl.style.color = '#FFFFFF'; 
    }

    // 评论列表渲染
    let commentsHtml = '';
    const displayComments = post.comments || [];

    if (displayComments.length > 0) {
        displayComments.forEach((comment, index) => {
            const floorNumber = index + 1;
            const displayTime = comment.timestamp || new Date().toLocaleString();
            const newTag = comment.isNew ? '<span style="color: #0099FF; font-weight: bold; margin-right: 5px; font-size: 10px;font-style: italic;">New!</span>' : '';

            let commentDisplayAvatar = comment.avatar;
            if (comment.isUser || (comment.username === myIdentity.nickname && myIdentity.nickname !== '一只喵叽')) {
                commentDisplayAvatar = myIdentity.avatar || 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg';
            }

            let avatarHtml = '';
            if (commentDisplayAvatar) {
                avatarHtml = `<div class="comment-author-avatar" style="background: transparent; overflow: hidden;">
                                <img src="${commentDisplayAvatar}" style="width: 100%; height: 100%; object-fit: cover;">
                              </div>`;
            } else {
                const cFirstChar = comment.username ? comment.username.charAt(0).toUpperCase() : '?';
                avatarHtml = `<div class="comment-author-avatar" style="background-color: var(--accent-color); color: white;">${cFirstChar}</div>`;
            }

            commentsHtml += `
              <li class="comment-item">
                  ${avatarHtml}
                  <div class="comment-body">
                      <div class="comment-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 4px;">
                          <div>
                              <span class="comment-author-name">${comment.username}</span>
                              
                          </div>
                          <div class="comment-floor" style="font-size:12px; color:#999;">${newTag}#${floorNumber}</div>
                      </div>
                      <div class="comment-content">${comment.content.replace(/\n/g, '<br>')}</div>
                      <div class="comment-timestamp" style="font-size:11px; color:#aaa; margin-top:4px;">
                        ${displayTime}
                        <span class="comment-delete-btn" data-original-index="${index}">删除</span>
                        <span class="comment-reply-btn" data-username="${comment.username}">回复</span>
                      </div>
                  </div>
              </li>
            `;
        });
    } else {
        commentsHtml = '<li style="padding:20px; text-align:center; color:#999;">暂无评论，快来抢沙发吧~</li>';
    }
    commentListEl.innerHTML = commentsHtml;
}

// 代理点击事件处理“回复”
document.getElementById('detail-comment-list').addEventListener('click', (e) => {
    if (e.target.classList.contains('comment-reply-btn')) {
        const username = e.target.dataset.username;
        const input = document.getElementById('reply-content-input');
        input.value = `回复 @${username}：`;
        input.focus();
    }
});





function setupForumFeature() {
    const refreshBtn = document.getElementById('forum-refresh-btn');
    const createBtn = document.getElementById('forum-create-btn');
    const postsContainer = document.getElementById('forum-posts-container');
    const forumScreen = document.getElementById('forum-screen');
    
    // 1. 初始化新模块
    setupBottomNavigation();       
    setupMePageFeature();          
    setupForumBindingFeature();  
    setupFavoritesFeature(); // <--- 新增
    renderHotPosts();        // <--- 新增初始化渲染  

    // 2. 搜索/刷新按钮
    if (refreshBtn) {
        refreshBtn.addEventListener('click', () => {
            handleForumRefresh();
        });
    }

    // 3. 发帖按钮逻辑
    if (createBtn) {
        const createModal = document.getElementById('forum-create-post-modal');
        const confirmCreate = document.getElementById('confirm-create-post-btn');
        // --- 修改点：不再获取取消按钮 ---
        
        const anonCheckbox = document.getElementById('create-post-is-anon');

        // 点击“发帖”按钮打开弹窗
        createBtn.addEventListener('click', () => {
            document.getElementById('create-post-title').value = '';           
            document.getElementById('create-post-content').value = '';

            // 默认不勾选匿名
            if(anonCheckbox) anonCheckbox.checked = false;

            createModal.classList.add('visible');
        });
        
        // --- 新增：点击遮罩层（弹窗外部）关闭弹窗 ---
        createModal.addEventListener('click', (e) => {
            if (e.target === createModal) {
                createModal.classList.remove('visible');
            }
        });

        // 确认发送按钮
        const newConfirmBtn = confirmCreate.cloneNode(true);
        confirmCreate.parentNode.replaceChild(newConfirmBtn, confirmCreate);

        newConfirmBtn.addEventListener('click', async () => {
            const titleInput = document.getElementById('create-post-title').value.trim();
            const content = document.getElementById('create-post-content').value.trim();
            
            // 获取身份
            const isAnon = anonCheckbox ? anonCheckbox.checked : false;
            const myIdentity = db.forumUserIdentity || { nickname: '我', avatar: '' };
            
            const selectedAuthor = isAnon ? "喵叽0311" : (myIdentity.nickname || '我');

            if (!titleInput || !content) {
                showToast('标题和内容不能为空');
                return;
            }

            let postAvatar = null; 
            let isUserPost = false; 
            
            // 如果不是匿名，标记为本人并保存头像
            if (!isAnon) {
                postAvatar = myIdentity.avatar || 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg';
                isUserPost = true;
            }

            // 1. 清除所有旧帖子的 New 标记
            if (db.forumPosts) {
                db.forumPosts.forEach(p => {
                    if (p.title) {
                        p.title = p.title.replace(/^\[New!\]\s*/, '').replace(/^【新】/, '');
                    }
                });
            } else {
                db.forumPosts = [];
            }

            // 2. 给新帖子加标记
            const finalTitle = '[New!] ' + titleInput;

            const newPost = {
                id: `post_${Date.now()}_${Math.random()}`,
                username: selectedAuthor,
                title: finalTitle, 
                content: content,
                likeCount: Math.floor(Math.random() * 9000) + 50,
                comments: [],
                timestamp: Date.now(),
                avatar: postAvatar,
                isUser: isUserPost
            };

            db.forumPosts.unshift(newPost);
            await saveData();
            renderForumPosts(db.forumPosts);
            
            createModal.classList.remove('visible');
            showToast('发送成功');
        });
    }

    // 4. 帖子列表点击进入详情
    if (postsContainer) {
        postsContainer.addEventListener('click', (e) => {
            const card = e.target.closest('.forum-post-card[data-id]');
            if (card) {
                // 新增：记录来源
            currentSourceScreen = 'forum-screen'; 
                const postId = card.dataset.id;
                const post = db.forumPosts.find(p => p.id === postId);
                if (post) {
                    renderPostDetail(post);
                    switchScreen('forum-post-detail-screen');
                    // --- 【核心修改】：强制滚动容器回到顶部 ---
                    const detailContent = document.querySelector('#forum-post-detail-screen .detail-content-area');
                    if (detailContent) {
                        detailContent.scrollTop = 0;
                    }
                    // ---------------------------------------
                }
            }
        });
    }

// 5. 观察者 (放在 setupForumFeature 函数的末尾)
    const observer = new MutationObserver((mutations) => {
        for (let mutation of mutations) {
            if (mutation.attributeName === 'class') {
                const isActive = forumScreen.classList.contains('active');
                
                // 只有当论坛主页(发现页)变为显示状态时执行
                if (isActive) {
                    
                    // --- 1. 强制清空搜索栏 ---
                    const searchInput = document.getElementById('forum-search-input');
                    if (searchInput) searchInput.value = '';

                    // --- 2. 强制重置底部导航栏高亮 ---
                    const bottomNav = forumScreen.querySelector('.bottom-tab-bar');
                    if (bottomNav) {
                        bottomNav.querySelectorAll('.tab-item').forEach(tab => {
                            tab.classList.remove('active');
                        });
                        const discoverTab = bottomNav.querySelector('.tab-item[data-target="forum-screen"]');
                        if (discoverTab) {
                            discoverTab.classList.add('active');
                        }
                    }

                    // --- 3. 刷新内容 ---
                    if (db.forumPosts && db.forumPosts.length > 0) {
                        renderForumPosts(db.forumPosts);
                        // --- 核心修改：返回首页时也刷新热帖 ---
                        renderHotPosts(); 
                        // -----------------------------------
                    }
                }
            }
        }
    });

    if (forumScreen) {
        observer.observe(forumScreen, { attributes: true });
    }
    
    setupDetailScreenEvents();
}




function setupDetailScreenEvents() {
    // 1. 回复按钮点击事件
    const submitBtn = document.getElementById('submit-reply-btn');
    const anonCheckbox = document.getElementById('reply-is-anon'); 
    
    if(anonCheckbox) anonCheckbox.checked = false;

    const newSubmitBtn = submitBtn.cloneNode(true);
    submitBtn.parentNode.replaceChild(newSubmitBtn, submitBtn);

    newSubmitBtn.addEventListener('click', async () => {
        const contentInput = document.getElementById('reply-content-input');
        const content = contentInput.value.trim();
        const postId = db.currentViewingPostId;

        if (!postId) return;
        const post = db.forumPosts.find(p => p.id === postId);
        if (!post) return;

        if (!content) {
            showToast('评论内容不能为空');
            return;
        }

        const isAnon = anonCheckbox ? anonCheckbox.checked : false;
        const myIdentity = db.forumUserIdentity || { nickname: '我', avatar: '' };
        const author = isAnon ? "喵叽0311" : (myIdentity.nickname || '我');

        if (post.comments) {
            post.comments.forEach(c => delete c.isNew);
        } else {
            post.comments = [];
        }

        let commentAvatar = null;
        let isUserComment = false;
        
        if (!isAnon) {
            commentAvatar = myIdentity.avatar || 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg';
            isUserComment = true;
        }

        const newComment = {
            username: author,
            content: content,
            timestamp: new Date().toLocaleString(),
            isNew: true,
            avatar: commentAvatar,
            isUser: isUserComment
        };

        post.comments.push(newComment);
        await saveData();
        contentInput.value = ''; 
        
        renderPostDetail(post); 
        
        const area = document.querySelector('.detail-content-area');
        if(area) area.scrollTop = area.scrollHeight;

        showToast('回复成功');
    });

    // 2. 评论删除事件
    const listEl = document.getElementById('detail-comment-list');
    listEl.onclick = async (e) => { 
        if (e.target.classList.contains('comment-delete-btn')) {
            const index = parseInt(e.target.dataset.originalIndex);
            const postId = db.currentViewingPostId;
            const post = db.forumPosts.find(p => p.id === postId);

            if (post && confirm('确定要删除这条评论吗？')) {
                post.comments.splice(index, 1);
                await saveData();
                renderPostDetail(post);
                showToast('评论已删除');
            }
        }
    };

    // 3. 删除帖子
    const deletePostBtn = document.getElementById('d-delete-btn');
    if(deletePostBtn) {
        const newDelBtn = deletePostBtn.cloneNode(true);
        deletePostBtn.parentNode.replaceChild(newDelBtn, deletePostBtn);
        newDelBtn.addEventListener('click', async () => {
            const postId = db.currentViewingPostId;
            if (confirm('确定要删除这条帖子吗？')) {
                db.forumPosts = db.forumPosts.filter(p => p.id !== postId);
                await saveData();
                showToast('帖子已删除');
                switchScreen('forum-screen');
            }
        });
    }

    // 4. AI 生成
    const aiBtn = document.getElementById('detail-ai-btn');
    if(aiBtn) {
        const newAiBtn = aiBtn.cloneNode(true);
        aiBtn.parentNode.replaceChild(newAiBtn, aiBtn);
        newAiBtn.addEventListener('click', () => {
            const postId = db.currentViewingPostId;
            const post = db.forumPosts.find(p => p.id === postId);
            if(post) handleGenerateComments(post);
        });
    }

    // 5. 分享
    const shareBtn = document.getElementById('detail-share-btn');
    if(shareBtn) {
        const newShareBtn = shareBtn.cloneNode(true);
        shareBtn.parentNode.replaceChild(newShareBtn, shareBtn);
        newShareBtn.addEventListener('click', () => {
             const postId = db.currentViewingPostId;
             if(postId) openSharePostModal(postId);
        });
    }

    // 6. 新增：复制标题和正文 (增强版：兼容 HTTP 和本地文件)
    const copyBtn = document.getElementById('d-copy-btn');
    if (copyBtn) {
        const newCopyBtn = copyBtn.cloneNode(true);
        copyBtn.parentNode.replaceChild(newCopyBtn, copyBtn);
        
        newCopyBtn.addEventListener('click', () => {
            const titleEl = document.getElementById('d-post-title');
            const contentEl = document.getElementById('d-post-content');
            
            if (!titleEl || !contentEl) return;

            // 获取文本
            const titleText = titleEl.innerText || '';
            const contentText = contentEl.innerText || '';
            const textToCopy = `${titleText}\n\n${contentText}`;

            // --- 核心修复：定义复制成功后的UI反馈 ---
            const handleSuccess = () => {
                showToast('已复制到剪贴板');
                newCopyBtn.style.color = 'var(--primary-color)';
                setTimeout(() => { newCopyBtn.style.color = ''; }, 200);
            };

            // --- 核心修复：定义失败反馈 ---
            const handleError = (err) => {
                console.error('复制出错:', err);
                showToast('复制失败，请手动复制');
            };

            // --- 核心修复：传统的 textarea 复制方法 (兼容所有环境) ---
            const fallbackCopy = (text) => {
                try {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    
                    // 避免页面滚动
                    textArea.style.top = "0";
                    textArea.style.left = "0";
                    textArea.style.position = "fixed";
                    textArea.style.opacity = "0"; // 不可见
                    
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    if (successful) handleSuccess();
                    else handleError('execCommand failed');
                } catch (err) {
                    handleError(err);
                }
            };

            // --- 逻辑判断：优先用新API，不行则用旧方法 ---
            if (navigator.clipboard && window.isSecureContext) {
                // 如果是 HTTPS 或 localhost
                navigator.clipboard.writeText(textToCopy)
                    .then(handleSuccess)
                    .catch(() => {
                        // 如果新API虽然存在但失败了（比如权限问题），尝试旧方法
                        fallbackCopy(textToCopy);
                    });
            } else {
                // 如果是 http 或 file:// 协议
                fallbackCopy(textToCopy);
            }
        });
    }
}






// 辅助函数：更新回复框的 User 选项

function updateReplyAuthorSelect() {
    const select = document.getElementById('reply-author-select');
    if (!select) return;

    // 清空除了"匿名"以外的选项
    select.innerHTML = '';
    
    // 1. 匿名选项
    const anon = document.createElement('option');
    anon.value = '喵叽0311';
    anon.textContent = '喵叽0311';
    select.appendChild(anon);
    
    // 2. “我”的选项
    const myIdentity = db.forumUserIdentity || { nickname: '我' };
    const myName = myIdentity.nickname || '我';

    const opt = document.createElement('option');
    opt.value = myName;
    opt.textContent = myName; // 显示昵称
    opt.selected = true;      // 默认选中
    select.appendChild(opt);
}

function setupShareModal() {
    const modal = document.getElementById('share-post-modal');
    const confirmBtn = document.getElementById('confirm-share-btn');
    const charList = document.getElementById('share-char-list');
    const countInput = document.getElementById('share-comment-count-input'); // 获取输入框

    const newBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);

    newBtn.addEventListener('click', async () => {
        const selectedCharIds = Array.from(charList.querySelectorAll('input:checked')).map(input => input.value);

        if (selectedCharIds.length === 0) {
            showToast('请至少选择一个分享对象。');
            return;
        }
        
        // 获取用户输入的条数
        let commentCount = 30;
        if (countInput) {
            commentCount = parseInt(countInput.value);
            if(isNaN(commentCount) || commentCount < 0) commentCount = 0;
        }

        const postTitle = modal.dataset.postTitle;
        const postRawContent = modal.dataset.postRawContent || "";
        // 这里我们需要重新构建 context，因为之前的 dataset 可能只存了部分
        // 为了确保实时性和自定义条数，最好重新从 DB 读 post
        const currentPost = db.forumPosts.find(p => p.title.includes(postTitle) || p.content === postRawContent); 
        // 简单的查找方式，实际上 openSharePostModal 应该存 ID
        // 这里简化逻辑，利用 dataset 里的 ID 更好
        
        // 修正：openSharePostModal 需要存 ID
        // 假设 modal.dataset.postId 存在 (需要在 openSharePostModal 增加一行)
        
        let targetPost = currentPost;
        // 如果上面没找到，尝试模糊匹配
        
        let richContext = "";
        let visibleSnippet = postRawContent.substring(0, 50);
        if (postRawContent.length > 50) visibleSnippet += "...";
        
        if(targetPost) {
             const postTime = new Date(targetPost.timestamp || Date.now()).toLocaleString();
             let commentsText = "暂无评论";
             
             if(targetPost.comments && targetPost.comments.length > 0) {
                 // --- 关键修改：按顺序切片 ---
                 // 需求：分享评论20-30给角色，角色看到的顺序是20,21...
                 // slice(-N) 获取最后N个。由于数组是按时间push的，所以顺序本身就是旧->新
                 // 直接 slice(-commentCount) 即可保持顺序
                 const sliceCount = commentCount === 0 ? 0 : commentCount;
                 let recentComments = [];
                 if (sliceCount > 0) {
                    recentComments = targetPost.comments.slice(-sliceCount);
                 }
                 
                 commentsText = recentComments.map(c => `${c.username}: ${c.content}`).join('\n');
             }
             
             richContext = `\n\n=== 帖子详情 ===\n发帖人：${targetPost.username}\n发布时间：${postTime}\n\n【完整正文】\n${targetPost.content}\n\n【最新 ${commentCount} 条评论】\n${commentsText}`;
        } else {
             richContext = modal.dataset.postRichContext || "";
        }

        selectedCharIds.forEach(charId => {
            const character = db.characters.find(c => c.id === charId);
            if (character) {
                const messageContent = `[喵坛分享]标题：${postTitle}\n内容：${visibleSnippet}<span style="display:none;">${richContext}</span>`;

                const message = {
                    id: `msg_${Date.now()}_${Math.random()}`,
                    role: 'user',
                    content: messageContent,
                    parts: [{ type: 'text', text: messageContent }],
                    timestamp: Date.now()
                };
                character.history.push(message);
            }
        });

        await saveData();
        try { if(typeof renderChatList === 'function') renderChatList(); } catch(e){}
        
        modal.classList.remove('visible');
        showToast(`成功分享给 ${selectedCharIds.length} 位联系人！`);
    });
}

// 完整替换 openSharePostModal 函数
function openSharePostModal(postId) {
    const post = db.forumPosts.find(p => p.id === postId);
    if (!post) {
        showToast('找不到该帖子信息。');
        return;
    }

    const modal = document.getElementById('share-post-modal');
    const charList = document.getElementById('share-char-list');
    const detailsElement = modal.querySelector('details');

    // --- 1. 清理标题中的 [New!] 标记 ---
    let cleanTitle = post.title || "无标题";
    if (cleanTitle.startsWith('[New!] ')) {
        cleanTitle = cleanTitle.substring(7); 
    } else if (cleanTitle.startsWith('【新】')) {
        cleanTitle = cleanTitle.substring(3);
    }
    
    // --- 2. 将数据存入 dataset ---
    // 存入清理后的标题
    modal.dataset.postTitle = cleanTitle;
    
    // 存入原始正文（用于生成卡片上显示的50字摘要）
    modal.dataset.postRawContent = post.content || "";
    
    // --- 3. 构建完整上下文（隐藏在卡片里，给AI看） ---
    const postTime = new Date(post.timestamp || Date.now()).toLocaleString();
    let commentsText = "";
    if(post.comments && post.comments.length > 0){
        // 取最新30条评论，倒序（最新的在前）
        const recentComments = post.comments.slice(-30).reverse(); 
        commentsText = recentComments.map(c => `${c.username}: ${c.content}`).join('\n');
    } else {
        commentsText = "暂无评论";
    }

    // 组合成AI能读懂的格式
    const richContext = `\n\n=== 帖子详情 (系统后台数据) ===\n发帖人：${post.username}\n发布时间：${postTime}\n\n【完整正文】\n${post.content}\n\n【最新评论】\n${commentsText}`;
    
    modal.dataset.postRichContext = richContext;

    // --- 4. 渲染分享对象列表 (保持不变) ---
    charList.innerHTML = ''; 
    if (db.characters.length > 0) {
        db.characters.forEach(char => {
            const li = document.createElement('li');
            li.className = 'binding-list-item';
            li.innerHTML = `
                <input type="checkbox" id="share-to-${char.id}" value="${char.id}">
                <label for="share-to-${char.id}" style="display: flex; align-items: center; gap: 10px;">
                    <img src="${char.avatar}" alt="${char.remarkName}" style="width: 32px; height: 32px; border-radius: 50%;">
                    ${char.remarkName}
                </label>
            `;
            charList.appendChild(li);
        });
    } else {
        charList.innerHTML = '<li style="color: #888;">暂无可以分享的角色。</li>';
    }

    if(detailsElement) detailsElement.open = false;
    modal.classList.add('visible');
}


function getForumGenerationContext() {
    let context = "以下是社区的背景设定和主要角色信息（仅供你理解世界观和潜台词）。\n";
    
    // 获取绑定信息
    const bindings = db.forumBindings || { worldBookIds: [], charIds: [], useChatHistory: false };

    // 1. 添加世界观设定
    if (bindings.worldBookIds && bindings.worldBookIds.length > 0) {
        context += "===== 世界观设定 =====\n";
        bindings.worldBookIds.forEach(id => {
            const book = db.worldBooks.find(wb => wb.id === id);
            if (book) {
                context += `设定名: ${book.name}\n内容: ${book.content}\n\n`;
            }
        });
    }

    // 2. 添加角色人设及最近聊天记录
    if (bindings.charIds && bindings.charIds.length > 0) {
        context += "===== 主要角色人设 & 近期动态  =====\n";
        
        bindings.charIds.forEach(id => {
            const char = db.characters.find(c => c.id === id);
            if (char) {
                context += `--- 角色: ${char.realName} ---\n`;
                context += `人设描述: ${char.persona}\n`;

                // --- 修改点：判断是否开启了记忆关联 ---
                if (bindings.useChatHistory) {
                    if (char.history && char.history.length > 0) {
                        const recentHistory = char.history.slice(-30);
                        const historyStr = recentHistory.map(msg => {
                            const roleLabel = msg.role === 'user' ? 'User' : 'Character';
                            let cleanContent = msg.content;
                            if(typeof cleanContent !== 'string') cleanContent = "[非文本消息]";
                            return `${roleLabel}: ${cleanContent}`;
                        }).join('\n');
                        context += `[近期私聊记录]:\n${historyStr}\n`;
                    } else {
                        context += `[近期私聊记录]: 暂无\n`;
                    }
                } else {
                    context += `[近期私聊记录]: (已关闭记忆关联，不提供聊天记录)\n`;
                }
                context += "\n";
            }
        });
    }

    // 3. 添加用户人设 (从“我”页面读取)
    if (db.forumUserIdentity && db.forumUserIdentity.persona) {
        context += "===== (你/User) 的人设 =====\n";
        context += `你的昵称: ${db.forumUserIdentity.nickname || 'User'}\n`;
        context += `你的设定: ${db.forumUserIdentity.persona}\n`;
        context += `注意：发帖人或者评论人绝对不是user。\n\n`;
    }

    if (context.length < 50) { 
        return "没有提供任何特定的背景设定，请自由发挥。";
    }

    return context;
}

// --- 新增：文本解析工具函数 ---
function parseAIResponseToPost(text) {
    // 1. 提取作者 (新增)
    // 匹配 #AUTHOR# 和 #TITLE# 之间的内容
    const authorMatch = text.match(/#AUTHOR#\s*([\s\S]*?)\s*#TITLE#/i);
    const author = authorMatch ? authorMatch[1].trim() : null;

    // 2. 提取标题
    const titleMatch = text.match(/#TITLE#\s*([\s\S]*?)\s*#CONTENT#/i);
    const title = titleMatch ? titleMatch[1].trim() : "无标题";

    // 3. 提取正文 (匹配到 #COMMENTS# 之前)
    const contentMatch = text.match(/#CONTENT#\s*([\s\S]*?)\s*#COMMENTS#/i);
    const content = contentMatch ? contentMatch[1].trim() : (text.split('#CONTENT#')[1] || "内容解析失败").trim();

    // 4. 提取并解析评论
    const comments = [];
    const commentsBlockMatch = text.match(/#COMMENTS#\s*([\s\S]*)/i);
    
    if (commentsBlockMatch) {
        const commentsBlock = commentsBlockMatch[1];
        const lines = commentsBlock.split('\n');
        
        lines.forEach(line => {
            line = line.trim();
            if (!line) return;
            if (line.includes('===SEP===')) return;

            let colonIndex = line.indexOf(':');
            if (colonIndex === -1) colonIndex = line.indexOf('：');

            if (colonIndex > 0) {
                comments.push({
                    username: line.substring(0, colonIndex).trim(),
                    content: line.substring(colonIndex + 1).trim(),
                    timestamp: "刚刚" 
                });
            }
        });
    }

    return { author, title, content, comments };
}






// --- 新增：随机趣味网名生成器 ---
function getRandomNetName() {
    const prefixes = ["迷路", "点心", "木偶", "毛线", "呢喃", "S", "摸鱼", "我才不是", "嘎嘎", "你是", "啊哦", "Q", "机械"];
    const nouns = ["路人", "毛绒绒", "呆呆", "Cat", "喵叽", "星夜", "铲屎官", "咸鱼", "橘子精", "潜水艇", "球球", "宠物", "魔法师"];
    
    const randomPrefix = prefixes[Math.floor(Math.random() * prefixes.length)];
    const randomNoun = nouns[Math.floor(Math.random() * nouns.length)];
    
    return randomPrefix + randomNoun;
}





async function handleForumRefresh() {
    const { url, key, model } = db.apiSettings;
    if (!url || !key || !model) {
        showToast('请先配置API');
        return;
    }

    const refreshBtn = document.getElementById('forum-refresh-btn');
    const postsContainer = document.getElementById('forum-posts-container');
    const searchInput = document.getElementById('forum-search-input');

    refreshBtn.disabled = true;
    refreshBtn.style.opacity = "0.5"; 
    refreshBtn.style.cursor = "not-allowed";
    
     // --- 强制生效版：创建加载容器 ---
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'temp-loading';
    
    // 1. 直接设置容器样式：强制 Flex 布局，横向排列，居中，垂直留白
    loadingDiv.style.cssText = `
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 20px 10px 0 10px;
        color: #666;
        font-size: 14px;
        width: 100%;
        box-sizing: border-box;
    `;
    
    // 2. 插入 HTML (包含内联样式的 spinner)
    // 注意：animation 必须依赖上面 CSS 中的 @keyframes spin
    loadingDiv.innerHTML = `
        <div class="spinner" style="
            width: 20px; 
            height: 20px; 
            border: 3px solid rgba(0, 0, 0, 0.1); 
            border-left-color: var(--primary-color); 
            border-radius: 50%; 
            animation: spin 0.8s linear infinite;
            flex-shrink: 0;
        "></div>
        <span>正在刷新最新发帖内容...</span>
    `;
    
    if (postsContainer.firstChild) {
        postsContainer.insertBefore(loadingDiv, postsContainer.firstChild);
    } else {
        postsContainer.appendChild(loadingDiv);
    }

    try {
        const context = getForumGenerationContext();
        const keywords = searchInput.value.trim();
        
        const myIdentity = db.forumUserIdentity || { nickname: '我' };
        const myNickname = myIdentity.nickname || '我';

        let systemPrompt = `你的角色是“社区模拟器”。请根据背景创作【3-6条】风格各异的新帖子。
背景资料：${context}

【绝对禁止】:AUTHOR和COMMENTS评论者**绝对不能**是【${myNickname}】（user）。

【格式要求】：
严格按照以下格式返回，**每两个帖子之间使用 "===SEP===" 进行分隔**。直接返回文本：

#AUTHOR#
发帖人网名
#TITLE#
帖子1标题
#CONTENT#
帖子1正文内容...
#COMMENTS#
网名A:评论内容
网名B:评论内容
===SEP===
#AUTHOR#
发帖人网名2
#TITLE#
帖子2标题
#CONTENT#
帖子2正文...
#COMMENTS#
网名C:评论内容

其他要求：
1. 随机生成 4 到 8 个AUTHOR不同的帖子。帖子主体语言为CHINESE。每个帖子下生成5-7条评论。
2. 格式必须包含 #AUTHOR#,#TITLE#, #CONTENT#, #COMMENTS# 这4个标签。
3. **#COMMENTS# 下方直接列出评论**，每行一条，格式为 "网名:评论内容"。不要再加其他标签。`;

        if (keywords) {
            systemPrompt += `\n\n这些帖子必须与关键词【${keywords}】相关。`;
        }

        const requestBody = {
            model: model,
            messages: [{ role: "user", content: systemPrompt }],
            temperature: 1.0, // 提高创造性
        };

        const response = await fetch(`${url}/v1/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${key}` },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) throw new Error(`API error: ${response.status}`);

        const result = await response.json();
        const contentStr = result.choices[0].message.content;

        const rawPosts = contentStr.split('===SEP===');
        const newPostsToAdd = [];

        // 清除旧帖子的 [New!] 标记
        if (db.forumPosts && db.forumPosts.length > 0) {
            db.forumPosts.forEach(p => {
                if (p.title) {
                    p.title = p.title.replace(/^\[New!\]\s*/, '').replace(/^【新】/, '');
                }
            });
        }

        rawPosts.forEach(rawText => {
            if (!rawText.trim()) return;

            const parsedData = parseAIResponseToPost(rawText);
            
            if (parsedData.title && parsedData.title !== "无标题") {
                const now = Date.now();
                
                // 处理评论
                if (parsedData.comments) {
                    parsedData.comments.forEach((c, idx) => {
                        const timeOffset = idx * 3000 + Math.random() * 600; 
                        c.timestamp = new Date(now + timeOffset).toLocaleString();
                        c.isNew = true; 
                        c.isUser = false; 
                        c.avatar = null; 
                        
                        if (c.username === myNickname) c.username = getRandomNetName();
                        // 过滤掉 AI 可能生成的“喵叽”
                     
                    });
                }

                // --- 修改点：使用随机网名生成器作为兜底 ---
                let authorName = parsedData.author;
               
                if (authorName === myNickname) {
                    authorName = getRandomNetName();
                }

                const viewCount = Math.floor(Math.random() * 9000) + 50;

                const newPost = {
                    id: `post_${Date.now()}_${Math.random()}`,
                    username: authorName, 
                    title: '[New!] ' + parsedData.title, 
                    content: parsedData.content,
                    likeCount: viewCount, 
                    comments: parsedData.comments || [],
                    timestamp: Date.now(),
                    isUser: false,
                    avatar: null 
                };
                newPostsToAdd.push(newPost);
            }
        });

        if (newPostsToAdd.length > 0) {
            if (!db.forumPosts) db.forumPosts = [];
            db.forumPosts.unshift(...newPostsToAdd);
            await saveData();

            if (loadingDiv && loadingDiv.parentNode) loadingDiv.remove();

            renderForumPosts(db.forumPosts);
            renderHotPosts();
            showToast(`成功刷新 ${newPostsToAdd.length} 条新帖子！`);
        } else {
            if (loadingDiv && loadingDiv.parentNode) loadingDiv.remove();
            showToast('未生成有效内容，请重试');
        }

    } catch (error) {
        console.error(error);
        if (loadingDiv && loadingDiv.parentNode) loadingDiv.remove();
        showToast('生成失败: ' + error.message);
    } finally {
        refreshBtn.disabled = false;
        refreshBtn.style.opacity = "1";
        refreshBtn.style.cursor = "pointer";
    }
}







function renderForumPosts(posts) {
    const postsContainer = document.getElementById('forum-posts-container');
    
    // 移除所有非 loading 元素
    Array.from(postsContainer.children).forEach(child => {
        if(!child.classList.contains('temp-loading')) child.remove();
    });

    if (!posts || posts.length === 0) {
        if (!postsContainer.querySelector('.temp-loading')) {
             postsContainer.innerHTML = '<p class="placeholder-text" style="margin-top: 50px;">暂无帖子。<br>点击刷新按钮加载！</p>';
        }
        return;
    }

    posts.forEach(post => {
        const card = document.createElement('div');
        card.className = 'forum-post-card';
        card.dataset.id = post.id;
        
        const timeStr = new Date(post.timestamp || Date.now()).toLocaleString();

        const titleEl = document.createElement('h3');
        titleEl.className = 'post-title';
        
        if (post.title && post.title.startsWith('[New!] ')) {
            const realTitle = post.title.substring(7);
            titleEl.innerHTML = `<span class="new-badge">New!</span>${realTitle}`;
        } else if (post.title && post.title.startsWith('【新】')) {
             const realTitle = post.title.substring(3);
             titleEl.innerHTML = `<span class="new-badge">New!</span>${realTitle}`;
        } else {
             titleEl.textContent = post.title || '无标题';
        }

        // --- 核心修改：使用 CSS 类控制布局和对齐 ---
        const metaEl = document.createElement('div');
        metaEl.className = 'post-meta-row'; // 使用新定义的类
        
        // 注意：这里使用 span 包裹内容，align-items: baseline 会确保文字底部对齐
        metaEl.innerHTML = `
            <span>♪ ${post.username}</span>
            <span>${timeStr}</span>
        `;

        card.appendChild(titleEl);
        card.appendChild(metaEl);

        postsContainer.appendChild(card);
    });
}

async function handleGenerateComments(post) {
    const { url, key, model } = db.apiSettings;
    
    if (!url || !key || !model) {
        showToast('请先在设置中配置 API 地址、Key 和模型');
        return;
    }

    const aiBtn = document.getElementById('detail-ai-btn'); 
    
    if(aiBtn) {
        aiBtn.disabled = true;
        aiBtn.style.opacity = "0.5";
        aiBtn.style.cursor = "not-allowed";
    }

    const hideLoading = showLoadingToast('正在刷新最新评论...');

    try {
        const context = getForumGenerationContext();
        
        const recentComments = (post.comments || []).slice(-50);
        const commentsHistoryStr = recentComments.map(c => `${c.username}: ${c.content}`).join('\n');
        
        const myIdentity = db.forumUserIdentity || { nickname: '我' };
        const myNickname = myIdentity.nickname || '我';

        const systemPrompt = `你是一个论坛网友模拟器。请为以下帖子追加【10-15条】新评论。
帖子标题：${post.title}
发帖人：${post.username}
帖子完整内容：${post.content}
背景世界观：${context}

【已有的评论列表】：
${commentsHistoryStr}

【重要规则】：
1. **身份隔离**：你生成的评论，发表者不能是User（${myNickname}）。
2. **直接返回文本**，每行一条，格式必须为 "用户名:评论内容"。
3. 禁止刷屏：同一个用户名不要评论超过2次。同一个角色发表评论时，使用的网名应保持一致，上下文逻辑应连续。
4.如已有的评论列表存在User（${myNickname}）发表的评论，本次生成的评论中，char或者其他网友应至少发表1条评论回复${myNickname}的最新评论。`;

        const requestBody = {
            model: model,
            messages: [{ role: "user", content: systemPrompt }],
            temperature: 1.0 
        };

        const response = await fetch(`${url}/v1/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${key}` },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            throw new Error(`API 请求失败: ${response.status}`);
        }

        const result = await response.json();
        
        if (!result.choices || !result.choices[0] || !result.choices[0].message) {
            throw new Error('API 返回格式异常');
        }

        const contentStr = result.choices[0].message.content;

        const lines = contentStr.split('\n');
        const newComments = [];
        
        let baseTime = Date.now();

        lines.forEach((line, index) => {
            line = line.trim();
            if(!line) return;
            
            let colonIndex = line.indexOf(':');
            if (colonIndex === -1) colonIndex = line.indexOf('：');
            
            if (colonIndex > 0) {
                let name = line.substring(0, colonIndex).trim();
                const text = line.substring(colonIndex + 1).trim();

                if (name === myNickname) {
                    name = getRandomNetName(); 
                }

                if (name && text) {
                    newComments.push({
                        username: name,
                        content: text,
                        timestamp: new Date(baseTime + index * 5000).toLocaleString(),
                        isNew: true, 
                        avatar: null, 
                        isUser: false 
                    });
                }
            }
        });

        if (newComments.length > 0) {
            if (post.comments) {
                post.comments.forEach(c => delete c.isNew);
            } else {
                post.comments = [];
            }

            post.comments = post.comments.concat(newComments);
            
            const dbPostIndex = db.forumPosts.findIndex(p => p.id === post.id);
            if(dbPostIndex !== -1) {
                db.forumPosts[dbPostIndex] = post;
                await saveData(); 
                
                renderPostDetail(post); 
                
                // --- 核心修改：生成评论后立即刷新热帖 ---
                renderHotPosts(); 
                // ------------------------------------

                const area = document.querySelector('.detail-content-area');
                if(area) area.scrollTop = area.scrollHeight;

                showToast(`已更新 ${newComments.length} 条评论`);
            }
        } else {
            showToast('AI 没有生成有效的评论格式，请重试');
        }

    } catch (e) {
        console.error("生成评论出错:", e);
        showToast('生成失败: ' + e.message); 
    } finally {
        hideLoading(); 
        
        if(aiBtn) {
            aiBtn.disabled = false;
            aiBtn.style.opacity = "1";
            aiBtn.style.cursor = "pointer";
        }
    }
}

        init();

        function renderPeekSteps(data) {
            const screen = document.getElementById('peek-steps-screen');
            const char = db.characters.find(c => c.id === currentChatId);
            if (!char) return; // 如果找不到角色，则不渲染

            const avatarEl = screen.querySelector('#steps-char-avatar');
            const nameEl = screen.querySelector('#steps-char-name');
            const currentStepsEl = screen.querySelector('#steps-current-count');
            const goalStepsEl = screen.querySelector('.steps-label');
            const progressRingEl = screen.querySelector('#steps-progress-ring');
            const trackListEl = screen.querySelector('#activity-track-list');
            const annotationEl = screen.querySelector('#steps-annotation-content');

            // 无论AI数据是否返回，都先渲染固定信息
            avatarEl.src = char.avatar;
            nameEl.textContent = char.realName;
            goalStepsEl.textContent = '/ 6000 步';

            if (!data) {
                // Display loading or empty state for dynamic content
                currentStepsEl.textContent = '----';
                trackListEl.innerHTML = '<li class="activity-track-item">正在生成活动轨迹...</li>';
                annotationEl.textContent = '正在生成角色批注...';
                progressRingEl.style.setProperty('--steps-percentage', 0);
                return;
            }

            // 填充AI返回的动态内容
            currentStepsEl.textContent = data.currentSteps;
            
            const percentage = (data.currentSteps / 6000) * 100;
            progressRingEl.style.setProperty('--steps-percentage', percentage);

            trackListEl.innerHTML = data.trajectory.map(item => `<li class="activity-track-item">${item}</li>`).join('');
            annotationEl.textContent = data.annotation;
        }

        function generatePeekContentPrompt(char, appType, mainChatContext) {
            const appNameMapping = {
                messages: "消息应用（模拟与他人的对话）",
                memos: "备忘录应用",
                cart: "电商平台的购物车",
                transfer: "文件传输助手（用于记录临时想法、链接等）",
                browser: "浏览器历史记录",
                drafts: "邮件或消息的草稿箱"
            };
            const appName = appNameMapping[appType] || appType;

            let prompt = `你正在模拟一个名为 ${char.realName} 的角色的手机内部信息。`;
            prompt += `该角色的核心人设是：${char.persona}。\n`;

            // 新增：获取并注入世界书和用户人设
            const associatedWorldBooks = (char.worldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id)).filter(Boolean);
            if (associatedWorldBooks.length > 0) {
                const worldBookContext = associatedWorldBooks.map(wb => `设定名: ${wb.name}\n内容: ${wb.content}`).join('\n\n');
                prompt += `\n为了更好地理解背景，请参考以下世界观设定：\n---\n${worldBookContext}\n---\n`;
            }
            if (char.myPersona) {
                prompt += `\n作为参考，我（用户）的人设是：${char.myPersona}\n`;
            }
            // 新增结束

            prompt += `最近，我（称呼为 ${char.myName}）和 ${char.realName} 的对话如下（这是你们关系和当前状态的核心参考）：\n---\n${mainChatContext}\n---\n`;
            prompt += `现在，我正在偷看Ta手机上的“${appName}”。请你基于Ta的人设和我们最近的聊天内容，生成符合该应用场景的、高度相关且富有沉浸感的内容。\n`;
            prompt += `你的输出必须是一个JSON对象，且只包含JSON内容，不要有任何额外的解释或标记。根据应用类型，JSON结构如下：\n`;

            switch (appType) {
                case 'messages':
                    prompt += `
                    {
                      "conversations": [
                        {
                          "partnerName": "与Ta对话的人的称呼",
                          "history": [
                            { "sender": "char", "content": "${char.realName}发送的消息内容" },
                            { "sender": "partner", "content": "对方发送的消息内容" }
                          ]
                        }
                      ]
                   }
                   请为 ${char.realName} 编造3-5个最近的对话。对话内容需要强烈反映Ta的人设以及和我的聊天上下文。`;
                    break;
                case 'steps':
                    prompt += `
                    {
                      "currentSteps": 8102,
                      "trajectory": [
                        "08:30 AM - 公司楼下咖啡馆",
                        "10:00 AM - 宠物用品店",
                        "12:00 PM - 附近日料店",
                        "03:00 PM - 回家路上的甜品店",
                        "04:00 PM - 楼下的便利店",
                        "06:30 PM - 健身房"
                      ],
                      "annotation": "角色对自己今天运动情况的批注"
                    }
                    请为 ${char.realName} 生成今天的步数信息。你只需要生成Ta的当前步数(currentSteps)，Ta的6条运动轨迹(trajectory)（禁止照搬示例）以及批注(annotation)。内容需要与Ta的人设和我们的聊天上下文高度相关。`;
                    break;
                case 'album':
                    prompt += `
                    {
                      "photos": [
                        { "type": "photo", "imageDescription": "对一张照片的详细文字描述，例如：一张傍晚在海边的自拍，背景是橙色的晚霞和归来的渔船。", "description": "角色对这张照片的一句话批注，例如：那天的风很舒服。" },
                        { "type": "video", "imageDescription": "对一段视频的详细文字描述，例如：一段在猫咖撸猫的视频，视频里有一只橘猫在打哈欠。", "description": "角色对这段视频的一句话批注，例如：下次还来这里！" }
                      ]
                    }
                    请为 ${char.realName} 的相册生成5-8个条目（照片或视频）。内容需要与Ta的人设和我们的聊天上下文高度相关。'imageDescription' 是对这张照片/视频的详细文字描述，它将代替真实的图片展示给用户。'description' 是 ${char.realName} 自己对这张照片/视频的一句话批注，会显示在描述下方。`;
                    break;
                case 'memos':
                    prompt += `
                    {
                      "memos": [
                        { "id": "memo_1", "title": "备忘录标题", "content": "备忘录内容，可以包含换行符\\n" }
                      ]
                    }
                    请生成3-4条备忘录，内容要与Ta的人设和我们的聊天上下文相关。`;
                    break;
                case 'cart':
                    prompt += `
                    {
                      "items": [
                        { "id": "cart_1", "title": "商品标题", "spec": "商品规格", "price": "25.00" }
                      ]
                    }
                    请生成3-4件商品，这些商品应该反映Ta的兴趣、需求或我们最近聊到的话题。`;
                    break;
                case 'browser':
                    prompt += `
                    {
                      "history": [
                        { "title": "网页标题", "url": "example.com/path", "annotation": "角色对于这条浏览记录的想法或批注" }
                      ]
                    }
                    请生成3-5条浏览记录。记录本身要符合Ta的人设和我们的聊天上下文，'annotation'字段则要站在角色自己的视角，记录Ta对这条浏览记录的想法或批注。`;
                    break;
                case 'drafts':
                    prompt += `
                    {
                      "draft": { "to": "${char.myName}", "content": "一封写给我但未发送的草稿内容，可以使用HTML的<span class='strikethrough'></span>标签来表示划掉的文字。" }
                    }
                    请生成一份Ta写给我但犹豫未决、未发送的草稿。内容要深刻、细腻，反映Ta的内心挣扎和与我的关系。`;
                    break;
               case 'transfer':
                   prompt += `
                   {
                     "entries": [
                       "要记得买牛奶。",
                       "https://example.com/interesting-article",
                       "刚刚那个想法不错，可以深入一下..."
                     ]
                   }
                   请为 ${char.realName} 生成4-7条Ta发送给自己的、简短零碎的消息。这些内容应该像是Ta的临时备忘、灵感闪现或随手保存的链接，要与Ta的人设和我们的聊天上下文相关，但比“备忘录”应用的内容更随意、更口语化。`;
                   break;
                default:
                    prompt += `{"error": "Unknown app type"}`;
                    break;
                case 'unlock':
                    prompt += `
                    {
                      "nickname": "角色的微博昵称",
                      "handle": "@角色的微博ID",
                      "bio": "角色的个性签名，可以包含换行符\\n",
                      "posts": [
                        { "timestamp": "2小时前", "content": "第一条微博正文内容，140字以内。" },
                        { "timestamp": "昨天", "content": "第二条微博正文内容。" },
                        { "timestamp": "3天前", "content": "第三条微博正文内容。" }
                      ]
                    }
                    请为 ${char.realName} 生成一个符合其人设的微博小号。你需要生成昵称、ID、个性签名，以及3-4条最近的微博。微博内容要生活化、碎片化，符合小号的风格，并与Ta的人设和我们的聊天上下文高度相关。`;
                    break;
            }
            return prompt;
        }

        async function generateAndRenderPeekContent(appType, options = {}) {
            const { forceRefresh = false } = options;

            if (generatingPeekApps.has(appType)) {
                showToast('该应用内容正在生成中，请稍候...');
                return;
            }

            // Check cache first
            if (!forceRefresh && peekContentCache[appType]) {
                const cachedData = peekContentCache[appType];
                switch (appType) {
                    case 'messages':
                        renderPeekChatList(cachedData.conversations);
                        switchScreen('peek-messages-screen');
                        break;
                    case 'album':
                        renderPeekAlbum(cachedData.photos);
                        switchScreen('peek-album-screen');
                        break;
                    case 'memos':
                        renderMemosList(cachedData.memos);
                        switchScreen('peek-memos-screen');
                        break;
                    case 'album':
                        renderPeekAlbum(cachedData.photos);
                        switchScreen('peek-album-screen');
                        break;
                   case 'transfer':
                       renderPeekTransferStation(cachedData.entries);
                       switchScreen('peek-transfer-station-screen');
                       break;
                    case 'cart':
                        renderPeekCart(cachedData.items);
                        switchScreen('peek-cart-screen');
                        break;
                    case 'browser':
                        renderPeekBrowser(cachedData.history);
                        switchScreen('peek-browser-screen');
                        break;
                    case 'drafts':
                        renderPeekDrafts(cachedData.draft);
                        switchScreen('peek-drafts-screen');
                        break;
                   case 'steps':
                      renderPeekSteps(cachedData);
                      switchScreen('peek-steps-screen');
                      break;
                   case 'unlock':
                       renderPeekUnlock(cachedData);
                       switchScreen('peek-unlock-screen');
                       break;
               }
               return; // Stop execution since we used cache
           }

            const char = db.characters.find(c => c.id === currentChatId);
            if (!char) return showToast('无法找到当前角色');

            const { url, key, model, provider } = db.apiSettings;
            if (!url || !key || !model) {
                showToast('请先在“api”应用中完成设置！');
                return switchScreen('api-settings-screen');
            }

            generatingPeekApps.add(appType); // Lock this specific app
            let targetContainer;

            // Show loading state
            switch (appType) {
                case 'messages':
                    switchScreen('peek-messages-screen');
                    targetContainer = document.getElementById('peek-chat-list-container');
                    targetContainer.innerHTML = '<p class="placeholder-text">正在生成对话列表...</p>';
                    break;
                case 'album':
                    switchScreen('peek-album-screen');
                    renderPeekAlbum([]); // 渲染空状态，会显示“正在生成...”
                    break;
                case 'memos':
                    switchScreen('peek-memos-screen');
                    renderMemosList([]); // Render empty state with loading text
                    break;
               case 'transfer':
                   switchScreen('peek-transfer-station-screen');
                   renderPeekTransferStation([]);
                   break;
                case 'cart':
                    switchScreen('peek-cart-screen');
                    renderPeekCart([]);
                    break;
                case 'browser':
                    switchScreen('peek-browser-screen');
                    renderPeekBrowser([]);
                    break;
                case 'drafts':
                    switchScreen('peek-drafts-screen');
                    renderPeekDrafts(null);
                    break;
                case 'steps':
                    switchScreen('peek-steps-screen');
                    renderPeekSteps(null); // Render empty state
                    break;
               case 'unlock':
                   switchScreen('peek-unlock-screen');
                   renderPeekUnlock(null); // Render empty/loading state
                   break;
               default:
                   showToast('无法打开');
                   generatingPeekApps.delete(appType); // Unlock if app is invalid
                   return;
           }

            try {
                const mainChatContext = char.history.slice(-10).map(m => m.content).join('\n');
                const systemPrompt = generatePeekContentPrompt(char, appType, mainChatContext);
                
                const requestBody = {
                    model: model,
                    messages: [{ role: 'user', content: systemPrompt }],
                    temperature: 0.8,
                    top_p: 0.9,
                };

                const endpoint = `${url}/v1/chat/completions`;
                const headers = { 'Content-Type': 'application/json', Authorization: `Bearer ${key}` };

                const response = await fetch(endpoint, { method: 'POST', headers: headers, body: JSON.stringify(requestBody) });
                if (!response.ok) {
                    const error = new Error(`API Error: ${response.status} ${await response.text()}`);
                    error.response = response;
                    throw error;
                }
                
                const result = await response.json();
                const contentStr = result.choices[0].message.content;
                
                const jsonMatch = contentStr.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error("AI响应中未找到有效的JSON对象。");
                
                const generatedData = JSON.parse(jsonMatch[0]);

                // --- NEW: Strict data validation ---
                let isValid = false;
                switch (appType) {
                    case 'messages': isValid = generatedData && Array.isArray(generatedData.conversations); break;
                    case 'memos': isValid = generatedData && Array.isArray(generatedData.memos); break;
                    case 'album': isValid = generatedData && Array.isArray(generatedData.photos); break;
                    case 'cart': isValid = generatedData && Array.isArray(generatedData.items); break;
                    case 'transfer': isValid = generatedData && Array.isArray(generatedData.entries); break;
                    case 'browser': isValid = generatedData && Array.isArray(generatedData.history); break;
                    case 'drafts': isValid = generatedData && generatedData.draft; break;
                    case 'steps': isValid = generatedData && generatedData.currentSteps !== undefined; break;
                    case 'unlock': isValid = generatedData && generatedData.nickname && Array.isArray(generatedData.posts); break;
                    default: isValid = false;
                }

                if (!isValid) {
                    throw new Error("AI返回的数据格式不符合应用要求。");
                }
                // --- END: Strict data validation ---

                // Store in cache
                peekContentCache[appType] = generatedData;

                // Render content based on app type
                if (appType === 'messages') {
                    renderPeekChatList(generatedData.conversations);
                } else if (appType === 'memos') {
                    renderMemosList(generatedData.memos);
                } else if (appType === 'album') {
                    renderPeekAlbum(generatedData.photos);
                } else if (appType === 'transfer') {
                   renderPeekTransferStation(generatedData.entries);
                } else if (appType === 'cart') {
                    renderPeekCart(generatedData.items);
                } else if (appType === 'browser') {
                    renderPeekBrowser(generatedData.history);
                } else if (appType === 'drafts') {
                    renderPeekDrafts(generatedData.draft);
                } else if (appType === 'steps') {
                    renderPeekSteps(generatedData);
                } else if (appType === 'unlock') {
                    renderPeekUnlock(generatedData);
                }

            } catch (error) {
                showApiError(error);
                // Clear cache for this app on failure
                delete peekContentCache[appType];
                const errorMessage = "内容生成失败，请刷新重试。";
                if (appType === 'album') {
                    document.querySelector('#peek-album-screen .album-grid').innerHTML = `<p class="placeholder-text">${errorMessage}</p>`;
                } else if (appType === 'unlock') {
                    document.getElementById('peek-unlock-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="peek-screen">‹</button><div class="title-container"><h1 class="title">错误</h1></div><button class="action-btn">···</button></header><main class="content"><p class="placeholder-text">${errorMessage}</p></main>`;
                } else if (targetContainer) {
                    targetContainer.innerHTML = `<p class="placeholder-text">${errorMessage}</p>`;
                }
            } finally {
                generatingPeekApps.delete(appType); // Release the lock for this specific app
            }
        }

        function renderPeekSettings() {
            const character = db.characters.find(c => c.id === currentChatId);
            if (!character) return;

            const peekSettings = character.peekScreenSettings || { wallpaper: '', customIcons: {}, unlockAvatar: '' };

            // Populate wallpaper
            document.getElementById('peek-wallpaper-url-input').value = peekSettings.wallpaper || '';

            const iconsContainer = document.getElementById('peek-app-icons-settings');
            iconsContainer.innerHTML = '';

            Object.keys(peekScreenApps).forEach(appId => {
                const app = peekScreenApps[appId];
                const currentIcon = peekSettings.customIcons?.[appId] || app.url;

                const itemEl = document.createElement('div');
                itemEl.className = 'icon-custom-item';
                itemEl.innerHTML = `
                    <img src="${currentIcon}" alt="${app.name}" class="icon-preview">
                    <div class="icon-details">
                        <p>${app.name}</p>
                        <input type="url" class="form-group" data-app-id="${appId}" placeholder="粘贴新的图标URL" value="${peekSettings.customIcons?.[appId] || ''}">
                    </div>
                    <input type="file" id="peek-icon-upload-${appId}" data-app-id="${appId}" accept="image/*" style="display:none;">
                    <label for="peek-icon-upload-${appId}" class="btn btn-small btn-neutral" style="font-size: 12px;">上传</label>
                `;
                iconsContainer.appendChild(itemEl);
            });

            // Add event listeners for all new upload buttons
            iconsContainer.querySelectorAll('input[type="file"]').forEach(uploadInput => {
                uploadInput.addEventListener('change', handlePeekIconUpload);
            });
            
            // Populate unlock avatar url
            document.getElementById('peek-unlock-avatar-url').value = peekSettings.unlockAvatar || '';
        }

        async function handlePeekIconUpload(e) {
            const file = e.target.files[0];
            const appId = e.target.dataset.appId;
            if (file && appId) {
                try {
                    const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 120, maxHeight: 120 });
                    const urlInput = document.querySelector(`#peek-app-icons-settings input[data-app-id="${appId}"]`);
                    const previewImg = urlInput.closest('.icon-custom-item').querySelector('.icon-preview');
                    if (urlInput) {
                        urlInput.value = compressedUrl;
                    }
                    if (previewImg) {
                        previewImg.src = compressedUrl;
                    }
                    showToast(`${peekScreenApps[appId].name} 图标已上传并压缩`);
                } catch (error) {
                    showToast('图标压缩失败，请重试');
                }
            }
        }

    });
</script>
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').then(registration => {
                console.log('ServiceWorker registration successful with scope: ', registration.scope);
            }, err => {
                console.log('ServiceWorker registration failed: ', err);
            });
        });
    }
    
</script>
</body>

</html>

